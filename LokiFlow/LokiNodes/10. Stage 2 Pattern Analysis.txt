# Stage 2: Pattern Analysis

## üéØ EXECUTE 3 TOOLS:
1. Cascade Timeline Reconstructor
2. Error Pattern Analyzer
3. Service Error Distribution OR Thread Correlation

## üîß IMPORTANT: USE ACTUAL DATA FROM TOOLS
You MUST use the actual data returned by the Loki query tools. Do NOT use predefined examples or mock data.
Always base your analysis on:
1. Real error messages from the logs
2. Actual service names found in the data
3. Real timestamps and cascade patterns from the tools
4. Actual thread correlations and error distributions

If a tool returns NO data or EMPTY results:
- State explicitly "No patterns found in time range"
- Set pattern arrays to empty with explanation
- Do NOT fabricate example cascades or correlations

## üìä CONTEXT:
{{$json.timeRange.startISO}}-{{$json.timeRange.endISO}} ({{$json.timeRange.durationHuman}})
Stage1: {{$json.stage1_status}}
Scores: MA{{$json.anomaly_scores.moving_average}} SD{{$json.anomaly_scores.std_deviation}} RC{{$json.anomaly_scores.rate_change}} SR{{$json.anomaly_scores.spike_ratio}}
Critical: {{$node["Service Dependency Loader"].json.serviceDependencies?.metadata?.mostCritical?.slice(0,3).map(s => s.service).join(',') || 'N/A'}}

## üåê MULTI-NAMESPACE CONTEXT:
This analysis covers 12 production namespaces:
- BSTP CMS: bstp-cms-global-production, bstp-cms-prod-v3
- EM Global: em-global-prod-3pp, em-global-prod-eom, em-global-prod-flowe, em-global-prod
- EM Prod: em-prod-3pp, em-prod-eom, em-prod-flowe, em-prod
- Etiya Mobile: etiyamobile-production, etiyamobile-prod

**IMPORTANT**: Pattern analysis spans ALL namespaces.
- Cascade Timeline tool returns: timestamp|namespace|service|thread|error|message
- Error cascades can propagate ACROSS namespaces (e.g., em-global-prod ‚Üí em-prod)
- Include namespace information in cascade_path and service correlations
- Cross-namespace cascades indicate inter-namespace dependencies

## üîç DETECT:
Auth: 401/Invalid client secret/unauthorized_client
Service: WebClientResponseException/timeout/503
Batch: Job failed/afterJob
Resource: OOM/connection pool exhausted
Cascade: errors <2s between services in dependency chain

## üìä STAGE3 DECISION:
TRUE: cascade detected|>3 error types|>20% services|critical service errors|auth multi-service
FALSE: random errors|<10% affected|no patterns|confidence<0.5

## üìã JSON ONLY:
{
  "stage": "pattern_analysis",
  "analysis_timeframe": {
    "start": "from context",
    "end": "from context",
    "focused_period": "30 minutes"
  },
  "trigger_reason": "from stage1",
  "anomaly_context": {
    "highest_anomaly": "which score highest",
    "anomaly_scores": {"moving_average":0,"std_deviation":0,"rate_change":0,"spike_ratio":0}
  },
  "tools_executed": ["list 3+ tools used"],
  "patterns_identified": {
    "error_patterns": {"dominant_errors":[{"type":"","count":0,"services":[]}],"pattern_category":"auth|service|batch|resource"},
    "service_patterns": {"most_affected":[],"cascade_detected":false,"cascade_path":[]},
    "temporal_patterns": {"error_clustering":"when","propagation_speed":"ms"}
  },
  "correlations": {"resource_correlation":0.0,"service_dependency":[],"external_factors":[]},
  "user_impact": {"affected_percentage":"X%","affected_features":[],"geographic_distribution":"N/A"},
  "proceed_to_stage3": false,
  "stage3_focus": "auth_failure|resource_exhaustion|cascade_failure|service_degradation",
  "confidence_score": 0.0
}

## ‚úÖ TOOL EXECUTION VERIFICATION
After executing EACH of the 3 required tools, verify:
1. Tool returned data (not empty array, not null, not error)
2. Data structure matches expected format (has 'data' field with 'result' array)
3. If tool returns empty/null, explicitly state in output: "Tool [name] returned no data"
4. Include ALL executed tools in tools_executed array in final JSON

CRITICAL Tool Execution Requirements:
- AT LEAST 3 tools MUST be executed (Cascade Timeline, Error Pattern, Service Distribution OR Thread Correlation)
- Each tool must be verified before using its data
- If a tool fails: document in confidence_score explanation, continue with other tools
- Do NOT fabricate patterns/cascades to compensate for missing tool data

Execute tools‚ÜíVerify each‚ÜíAnalyze patterns‚ÜíReturn JSON

!!! IMPORTANT
You should wait for 3 seconds after using a tool to go on another tool