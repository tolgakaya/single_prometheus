{
  "name": "Scheduled Cluster Health Checker",
  "nodes": [
    {
      "parameters": {},
      "id": "06d930e9-f9bd-478b-9fa1-11d2d899c477",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        800,
        -256
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "88909d4f-c1d8-419e-b335-84cdb8e9e512",
      "name": "Scheduled Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        816,
        176
      ],
      "typeVersion": 1.1,
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        800,
        -80
      ],
      "id": "9e91fc24-e98d-4c4d-a758-8b1c7ff418ed",
      "name": "When chat message received",
      "webhookId": "0e174fa6-89e0-4e54-b544-4f869ab04fed"
    },
    {
      "parameters": {
        "path": "53adcc16-6fcc-494f-9264-06eeb33cdc7d",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "ad39fa8c-5927-42f9-b1c6-38ed219b3c8a",
      "name": "AlertManager Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        816,
        448
      ],
      "typeVersion": 2,
      "webhookId": "53adcc16-6fcc-494f-9264-06eeb33cdc7d",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Unified Entry Point - Orchestrator Request Handler with Enhanced Context\n\n// Default production namespaces to monitor (matches Alert-Driven flow)\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\n// Default production services to monitor (from kubectl get service -A)\nconst DEFAULT_SERVICES = [\n  'bss-mc-crm-search-integrator', 'bss-mc-crm-customer-information', 'bss-mc-crm-customer-search',\n  'bss-mc-crm-mash-up', 'bss-mc-crm-ntf-integrator', 'bss-mc-activity', 'bss-mc-asset-management',\n  'bss-mc-cpq', 'bss-mc-cpq-batch', 'bss-mc-cpq-ntf-integrator', 'bss-mc-csr', 'bss-mc-domain-config',\n  'bss-mc-id-service', 'bss-mc-message-relay', 'bss-mc-ntf-engine', 'bss-mc-ntf-history', 'bss-mc-rim',\n  'bss-mc-ui-authz', 'bss-mc-user-management', 'bss-mc-wsc-new', 'bss-crm-batch', 'bss-ntf-batch',\n  'bss-mc-pcm-cfm', 'bss-mc-pcm-cms-integrator', 'bss-mc-pcm-product-catalog', 'bss-mc-pcm-product-offer-detail',\n  'bss-mc-pcm-next-gen-admintoolbox-config-manager', 'bss-mc-pcm-next-gen-admintoolbox-ui',\n  'eom-micro-flows', 'eom-operate', 'eom-scheduler', 'eom-ui', 'eom-activemqqueueoperations',\n  'eom-postgresqldboperations', 'eom-zeebe', 'eom-castlemock', 'bss-services-service',\n  'external-services-service', 'loyalty-services-service', 'om-services-service', 'fstp-bpmn-ms',\n  'fstp-configuration-ms', 'fstp-dashboard-ms', 'fstp-frontend', 'fstp-orchestra-ms', 'fstp-scheduler-ms',\n  'fstp-eca', 'eca', 'wso2am-gw-service', 'wso2am-cp-service', 'bss-saas-control-plane',\n  'bss-saas-control-plane-ui', 'bss-tenant-control-plane-batch'\n];\n\nconst input = $input.first().json;\n\n// Detect source and extract parameters\nlet source = {};\nlet analysisParams = {};\n\nif (input.orchestratorId && input.startTime && input.endTime) {\n  // From orchestrator - DEƒûƒ∞≈ûƒ∞KLƒ∞K YOK\n  source = {\n    type: 'orchestrator',\n    orchestratorId: input.orchestratorId,\n    requestId: input.requestId || `req-${Date.now()}`,\n    priority: input.priority || 'normal'\n  };\n  \n  analysisParams = {\n    startTime: input.startTime,\n    endTime: input.endTime,\n    namespaces: (input.namespaces && input.namespaces.length > 0) ? input.namespaces : DEFAULT_NAMESPACES,\n    focusAreas: input.focusAreas || [],\n    analysisType: input.analysisType || 'general',\n    context: input.context || {}\n  };\n  \n} else if (input.chatInput || input.sessionId) {\n  // From chat - SERVICE EXTRACTION EKLENDƒ∞\n  source = {\n    type: 'chat',\n    sessionId: input.sessionId,\n    priority: 'normal'\n  };\n  \n  const message = input.chatInput || '';\n  const timeRange = parseTimeFromMessage(message);\n  \n  analysisParams = {\n    startTime: Math.floor(new Date(timeRange.start).getTime() / 1000),\n    endTime: Math.floor(new Date(timeRange.end).getTime() / 1000),\n    namespaces: DEFAULT_NAMESPACES,\n    userMessage: message,\n    keywords: extractKeywords(message)\n  };\n  \n  // YENƒ∞: Service extraction for chat messages\n  const services = extractServicesFromMessage(message);\n  if (services.length > 0) {\n    analysisParams.services = services;\n  } else {\n    analysisParams.services = DEFAULT_SERVICES;\n  }\n  \n} else if (input.webhookUrl && input.body) {\n  // From webhook - DEƒûƒ∞≈ûƒ∞KLƒ∞K YOK\n  source = {\n    type: 'webhook',\n    url: input.webhookUrl,\n    priority: input.body.severity === 'critical' ? 'high' : 'normal'\n  };\n  \n  analysisParams = {\n    startTime: Math.floor(Date.now() / 1000) - 3600,\n    endTime: Math.floor(Date.now() / 1000),\n    alerts: input.body.alerts || [],\n    incidentId: input.body.incident_id\n  };\n  \n} else {\n  // Manual or unknown trigger - G√úNCELLEME: searchParams kontrol√º eklendi\n  source = {\n    type: 'manual',\n    priority: input.priority || 'normal'\n  };\n  \n  analysisParams = {\n    startTime: input.startTime || Math.floor(Date.now() / 1000) - 3600,\n    endTime: input.endTime || Math.floor(Date.now() / 1000),\n    namespaces: (input.namespaces && input.namespaces.length > 0) ? input.namespaces : DEFAULT_NAMESPACES,\n    services: (input.searchParams?.services && input.searchParams.services.length > 0)\n      ? input.searchParams.services\n      : DEFAULT_SERVICES,\n    focusAreas: input.focusAreas || [],\n    analysisType: input.analysisType || 'general',\n    context: input.context || {}\n  };\n\n  // G√úNCELLEME: Orchestrator'dan gelen servis bilgisini al\n  if (source.type === 'manual' && input.searchParams?.services) {\n    analysisParams.services = input.searchParams.services;\n    console.log(\"Services from orchestrator:\", analysisParams.services);\n  }\n}\n\n// G√úNCELLEME: forceDeepAnalysis mantƒ±ƒüƒ±nƒ± ekle\nconst forceDeepAnalysis = source.priority === 'critical' || \n                         input.forceDeepAnalysis || \n                         input.analysisConfig?.forceDeepAnalysis ||\n                         false;\n\n// Stage configuration based on priority - G√úNCELLENDƒ∞\nlet stageConfig = {\n  maxStages: 1,\n  enablePatternAnalysis: false,\n  enableAnomalyDetection: false,\n  enablePredictiveAnalysis: false,\n  forceDeepAnalysis: forceDeepAnalysis  // YENƒ∞\n};\n\nif (source.priority === 'critical' || forceDeepAnalysis) {\n  stageConfig = {\n    maxStages: 3,\n    enablePatternAnalysis: true,\n    enableAnomalyDetection: true,\n    enablePredictiveAnalysis: true,\n    forceDeepAnalysis: true  // YENƒ∞\n  };\n} else if (source.priority === 'high') {\n  stageConfig = {\n    maxStages: 2,\n    enablePatternAnalysis: true,\n    enableAnomalyDetection: true,\n    enablePredictiveAnalysis: false,\n    forceDeepAnalysis: false\n  };\n}\n\n// Helper functions - MEVCUT FONKSƒ∞YONLAR AYNEN KALIYOR\n// Helper functions\nfunction parseTimeFromMessage(message) {\n  const now = Date.now();\n  const msgLower = message.toLowerCase();\n  \n  if (msgLower.includes('last hour') || msgLower.includes('son 1 saat')) {\n    return {\n      start: new Date(now - 3600000).toISOString(),\n      end: new Date(now).toISOString()\n    };\n  } else if (msgLower.includes('last 2 hours') || msgLower.includes('son 2 saat')) {\n    return {\n      start: new Date(now - 7200000).toISOString(),\n      end: new Date(now).toISOString()\n    };\n  } else if (msgLower.includes('today') || msgLower.includes('bug√ºn')) {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    return {\n      start: today.toISOString(),\n      end: new Date(now).toISOString()\n    };\n  }\n  \n  return {\n    start: new Date(now - 3600000).toISOString(),\n    end: new Date(now).toISOString()\n  };\n}\n\nfunction extractKeywords(message) {\n  const keywords = [];\n  const msgLower = message.toLowerCase();\n  \n  if (msgLower.includes('cpu')) keywords.push('cpu_usage');\n  if (msgLower.includes('memory')) keywords.push('memory_usage');\n  if (msgLower.includes('disk')) keywords.push('disk_usage');\n  if (msgLower.includes('network')) keywords.push('network_traffic');\n  if (msgLower.includes('error')) keywords.push('error_rate');\n  if (msgLower.includes('latency')) keywords.push('response_time');\n  \n  const services = message.match(/(payment|order|user|auth|inventory)/gi);\n  if (services) keywords.push(...services.map(s => s.toLowerCase()));\n  \n  return [...new Set(keywords)];\n}\n\n// YENƒ∞ FONKSƒ∞YON: Service extraction helper\nfunction extractServicesFromMessage(message) {\n  const services = [];\n  \n  // Pattern 1: Kubernetes service name pattern\n  const k8sServicePattern = /\\b([a-z0-9]+(?:-[a-z0-9]+){2,})(?:-service|-api|-svc)?\\b/gi;\n  const k8sMatches = message.matchAll(k8sServicePattern);\n  for (const match of k8sMatches) {\n    const serviceName = match[0].toLowerCase();\n    if (!serviceName.endsWith('-i√ßin') && \n        !serviceName.endsWith('-analiz') && \n        !serviceName.endsWith('-servisi') &&\n        !serviceName.includes('saatlik')) {\n      services.push(serviceName);\n    }\n  }\n  \n  // Pattern 2: \"service: xxx\" veya \"servis: xxx\" formatƒ±\n  const explicitPattern = /(?:service|servis):\\s*([a-zA-Z0-9-]+)/gi;\n  const explicitMatches = message.matchAll(explicitPattern);\n  for (const match of explicitMatches) {\n    services.push(match[1].toLowerCase());\n  }\n  \n  // Pattern 3: \" servisi\" kelimesinden √∂nceki kelime\n  const turkishPattern = /([a-zA-Z0-9-]+)\\s+servisi/gi;\n  const turkishMatches = message.matchAll(turkishPattern);\n  for (const match of turkishMatches) {\n    if (!services.includes(match[1].toLowerCase())) {\n      services.push(match[1].toLowerCase());\n    }\n  }\n  \n  return [...new Set(services)];\n}\n\n// YENƒ∞: Enhanced context structure\nconst contextId = `ctx-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n// Output format - CONTEXT ENHANCED\nreturn [{\n  json: {\n    timestamp: new Date().toISOString(),\n    source: source,\n    analysisParams: analysisParams,\n    stageConfig: stageConfig,\n    priority: source.priority,\n    forceDeepAnalysis: forceDeepAnalysis,\n    metadata: {\n      workflowId: $workflow.id,\n      executionId: $execution.id,\n      orchestratorId: source.orchestratorId || null,\n      requestId: source.requestId || `req-${Date.now()}`\n    },\n    // YENƒ∞: Master context object\n    _context: {\n      contextId: contextId,\n      createdAt: new Date().toISOString(),\n      source: source,\n      initialParams: analysisParams,\n      stageConfig: stageConfig,\n      priority: source.priority,\n      forceDeepAnalysis: forceDeepAnalysis,\n      workflowMetadata: {\n        workflowId: $workflow.id,\n        executionId: $execution.id,\n        orchestratorId: source.orchestratorId || null,\n        requestId: source.requestId || `req-${Date.now()}`\n      },\n      stageResults: {}, // Will be populated by each stage\n      decisions: {},    // Will store decision points\n      debug: {\n        contextVersion: '1.0',\n        createdBy: 'Unified Entry Point'\n      }\n    }\n  }\n}];"
      },
      "id": "a616a01b-235d-4e23-a5be-75ccf2004595",
      "name": "Unified Entry Point",
      "type": "n8n-nodes-base.code",
      "position": [
        1200,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 1: Ultra-Fast Kubernetes Health Assessment - CONTEXT AWARE\n\nYou are a specialized AI agent for rapid Kubernetes cluster health check using Prometheus metrics.\n\n## üéØ YOUR MISSION: INSTANT HEALTH SNAPSHOT\n\nExecute ONLY these tools in sequence:\n1. `Quick Cluster Health` - Overall cluster status\n2. `Active Alerts Count` - Current firing alerts\n\nComplete in <5 seconds and determine if deeper investigation needed.\n\n**NOTE**: You are analyzing {{ $json.analysisParams?.services?.length || 0 }} pre-configured services across {{ $json._context.initialParams.namespaces.length }} namespaces. These services are defined in the system configuration.\n\n## üïê TIME PARAMETERS:\nUse these EXACT timestamps from context:\n- Start Time: {{ $json._context.initialParams.startTime }}\n- End Time: {{ $json._context.initialParams.endTime }}\n\nIMPORTANT: \n- These are Unix timestamps in seconds\n- Convert them properly for display: new Date(timestamp * 1000).toISOString()\n- DO NOT use hardcoded dates like \"2024-01-15\"\n- Use actual data from Prometheus queries, not mock data\n\nWhen calling Prometheus tools, ALWAYS use:\n{\n  \"start\": {{ $json._context.initialParams.startTime }},\n  \"end\": {{ $json._context.initialParams.endTime }},\n  \"step\": 60\n}\n\n## üéØ NAMESPACE & SERVICE FILTERING:\n\n**CRITICAL: Use these READY-TO-USE query filters in ALL Prometheus queries:**\n\nNamespace regex pattern (use in all queries): {{ $json.namespaceRegex }}\nService regex pattern (use if filtering services): {{ $json.serviceRegex }}\n\n**COPY THESE EXACT FILTERS INTO YOUR PROMETHEUS QUERIES:**\n1. Namespace filter only: {{ $json.queryHelpers?.namespaceFilter }}\n2. Combined namespace + service: {{ $json.queryHelpers?.combinedFilter }}\n\n**READY-TO-USE EXAMPLE QUERIES (COPY EXACTLY):**\n- Pod count query: {{ $json.queryHelpers?.exampleQueries?.podCount }}\n- Service list query: {{ $json.queryHelpers?.exampleQueries?.serviceList }}\n- Alert count query: {{ $json.queryHelpers?.exampleQueries?.alertCount }}\n\n**CRITICAL RULES:**\n- NEVER use hardcoded namespaces like \"etiyamobile-production\"\n- COPY the ready-to-use queries shown above\n- DO NOT construct your own namespace regex - use {{ $json.namespaceRegex }}\n- The filters above are pre-validated and ready to paste\n\n**For reference, target namespaces:**\n{{ JSON.stringify($json._context.initialParams.namespaces) }}\n\n## üö® CRITICAL OUTPUT REQUIREMENT:\n**YOU MUST RETURN ONLY VALID JSON - NO MARKDOWN, NO CODE BLOCKS, NO EXTRA TEXT**\n**DO NOT WRAP YOUR RESPONSE IN ```json``` TAGS**\n**RETURN RAW JSON ONLY**\n\n## üéØ DECISION LOGIC - HOW TO SET proceed_to_stage2:\n\n**Set proceed_to_stage2 = true IF ANY OF THESE CONDITIONS:**\n1. Quick Cluster Health tool returns non-empty result (issues detected)\n   - Tool returns array with data = Problems found\n2. Active Alerts Count > 0 (any firing alerts)\n   - Any alerts present = Needs investigation\n\n**Set proceed_to_stage2 = false ONLY IF ALL CONDITIONS MET:**\n1. Quick Cluster Health returns empty [] (no node/pod issues)\n   AND\n2. Active Alerts Count = 0 (no firing alerts)\n   AND\n3. forceDeepAnalysis flag is NOT set to true\n\n**CRITICAL**: Default to true if uncertain. Better to investigate than miss issues.\n\n## üìä SCORING LOGIC - HOW TO CONVERT TOOL RESPONSES TO SCORES (1-5):\n\n**Quick Cluster Health ‚Üí cluster_health score:**\n- Empty result [] = No issues detected ‚Üí Score: 5 (excellent)\n- Non-empty result with data = Issues found ‚Üí Score: 1 (critical)\n- Tool error or no response = Unknown state ‚Üí Score: 3 (degraded)\n\n**Quick Cluster Health ‚Üí node_availability score:**\n- Check kube_node_status_condition in result\n- No failing nodes ‚Üí Score: 5\n- 1-2 failing nodes ‚Üí Score: 3\n- 3+ failing nodes ‚Üí Score: 1\n- No data available ‚Üí Score: 3\n\n**Quick Cluster Health ‚Üí pod_stability score:**\n- Check kube_pod_container_status_restarts_total in result\n- No restarts (< 0.1 rate) ‚Üí Score: 5\n- Low restart rate (0.1-0.5) ‚Üí Score: 3\n- High restart rate (> 0.5) ‚Üí Score: 1\n- No data available ‚Üí Score: 3\n\n**Active Alerts Count ‚Üí api_reliability score:**\n- 0 alerts ‚Üí Score: 5 (excellent)\n- 1-3 alerts ‚Üí Score: 3 (degraded)\n- 4+ alerts ‚Üí Score: 1 (critical)\n- Tool error or no response ‚Üí Score: 3 (unknown)\n\n**overall_status determination:**\n- All scores 4-5 ‚Üí \"healthy\"\n- Any score 2-3 ‚Üí \"degraded\"\n- Any score 1 ‚Üí \"critical\"\n- All scores 3 (no data) ‚Üí \"unknown\"\n\n## üìã CRITICAL CONTEXT PRESERVATION:\nIn your JSON output, you MUST include a \"_context\" field.\nSimply copy the _context object from your input to your output WITHOUT any modifications.\nDo NOT create your own context values, use the exact context you received.\n\n## üíæ OUTPUT FORMAT (MUST BE PURE JSON):\n\n## üîß JSON FORMAT VALIDATION RULES:\n\n1. Start your response with { and end with }\n2. Do not include any text before or after the JSON\n3. Ensure all string values are in double quotes\n4. Ensure all numbers are unquoted (not \"5\" but 5)\n5. Ensure booleans are unquoted (not \"true\" but true)\n6. For _context field, copy the exact object from $json._context (no modification)\n7. Arrays must use square brackets []\n8. Empty arrays are valid: []\n9. Validate JSON mentally before returning\n\n## ‚úÖ FINAL CHECK:\nBefore returning, ensure your response:\n- Starts with { (no backticks, no ```json)\n- Ends with } (no backticks, no ```)\n- Contains valid JSON that can be parsed by JSON.parse()\n- Has all required fields from the template above\n- Uses actual tool data, not placeholder values\n\nReturn ONLY this JSON structure with NO markdown formatting:\n\n{\n  \"stage\": \"health_snapshot\",\n  \"timestamp\": \"<use actual current ISO timestamp from new Date().toISOString()>\",\n  \"cluster\": \"etiyamobile-production\",\n  \"overall_status\": \"<one of: healthy|degraded|critical>\",\n  \"scores\": {\n    \"cluster_health\": <actual number from tool response>,\n    \"node_availability\": <actual number from tool response>,\n    \"pod_stability\": <actual number from tool response>,\n    \"api_reliability\": <actual number from tool response>\n  },\n  \"services_analyzed\": {{ JSON.stringify($json.analysisParams?.services || $json.initialParams?.services || []) }},\n  \"services_count\": {{ ($json.analysisParams?.services || $json.initialParams?.services || []).length }},\n  \"namespaces_analyzed\": {{ JSON.stringify($json._context.initialParams.namespaces) }},\n  \"alerts\": {\n    \"total\": <actual count from tool response>,\n    \"critical\": <actual count from tool response>,\n    \"warning\": <actual count from tool response>,\n    \"top_alerts\": [<actual alert names from tool response>]\n  },\n  \"quick_findings\": [<findings based on actual tool responses>],\n  \"proceed_to_stage2\": <true or false>,\n  \"urgency\": \"<one of: normal|high|critical>\",\n  \"reason\": \"<your analysis reason>\",\n  \"forceDeepAnalysis\": false,\n  \"overridden\": false,\n  \"_context\": <copy the exact _context object from input>,\n  \"_debug\": {\n    \"nodeType\": \"Stage 1: Health Snapshot\",\n    \"processedAt\": \"<current ISO timestamp from new Date().toISOString()>\",\n    \"contextId\": \"{{ $json.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromSource\": \"{{ $json.source.type }}\",\n    \"priority\": \"{{ $json.priority }}\",\n    \"timeRangeUsed\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    }\n  }\n}\n\n## ‚ö†Ô∏è FINAL REMINDER:\n- **RETURN ONLY JSON - NO MARKDOWN FORMATTING**\n- **USE ACTUAL TOOL RESPONSE DATA - NO MOCK DATA**\n- **USE PROVIDED TIMESTAMPS - NO HARDCODED DATES**\n- For _context field: copy $json._context object exactly as-is",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a Kubernetes cluster health analyzer. Analyze the cluster state and provide a structured health assessment.\n\nYou MUST return a valid JSON object with this exact structure:\n\n{\n  \"stage\": \"health_snapshot\",\n  \"timestamp\": \"<current ISO timestamp>\",\n  \"overall_status\": \"<one of: healthy, degraded, critical, unknown>\",\n  \"proceed_to_stage2\": <boolean>,\n  \"urgency\": \"<one of: low, medium, high, critical>\",\n  \"reason\": \"<brief explanation>\",\n  \"alerts\": {\n    \"total\": <number>,\n    \"critical\": <number>,\n    \"warning\": <number>,\n    \"top_alerts\": [<array of alert names>]\n  },\n  \"scores\": {\n    \"cluster_health\": <1-5>,\n    \"node_availability\": <1-5>,\n    \"pod_stability\": <1-5>,\n    \"api_reliability\": <1-5>\n  },\n  \"quick_findings\": [<array of findings>],\n  \"forceDeepAnalysis\": false,\n  \"overridden\": false,\n  \"_context\": <context object>,\n  \"_debug\": {\n    \"nodeType\": \"Stage 1: Health Snapshot\",\n    \"processedAt\": \"<ISO timestamp>\",\n    \"contextId\": \"<context ID>\"\n  }\n}\n\nIMPORTANT: Return ONLY the JSON object, no markdown, no explanations, no code blocks."
        }
      },
      "id": "a9bbeca4-b931-4ba5-bc88-0cd7269befb8",
      "name": "Stage 1: Health Snapshot",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        1648,
        192
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "jsCode": "// Stage 2 Decision - Code Node ile karar verme - CONTEXT ENHANCED & ERROR HANDLING ADDED\nconst stage1Output = $input.first().json;\nconst unifiedConfig = $node[\"Unified Entry Point\"].json;\n\n// Stage 1 output'u d√ºzg√ºn parse et\nlet stage1ProceedDecision = false;\nlet stage1ActualData = null;\n\n// Nested output kontrol√º - Stage 1'in yapƒ±sƒ± karma≈üƒ±k olabilir\nif (stage1Output.output && typeof stage1Output.output === 'object') {\n  // Output i√ßinde output var mƒ±?\n  if (stage1Output.output.output && typeof stage1Output.output.output === 'object') {\n    stage1ActualData = stage1Output.output.output;\n    stage1ProceedDecision = stage1ActualData.proceed_to_stage2;\n  } else {\n    stage1ActualData = stage1Output.output;\n    stage1ProceedDecision = stage1ActualData.proceed_to_stage2;\n  }\n} else if (stage1Output.proceed_to_stage2 !== undefined) {\n  stage1ActualData = stage1Output;\n  stage1ProceedDecision = stage1Output.proceed_to_stage2;\n} else {\n  console.error(\"Cannot find proceed_to_stage2 in Stage 1 output!\");\n  stage1ActualData = stage1Output;\n}\n\nconsole.log(\"=== STAGE 2 DECISION DEBUG ===\");\nconsole.log(\"Stage 1 output structure:\", JSON.stringify(stage1Output, null, 2).substring(0, 500) + \"...\");\nconsole.log(\"Stage 1 actual data extracted:\", stage1ActualData ? \"Yes\" : \"No\");\nconsole.log(\"Stage 1 proceed_to_stage2 value:\", stage1ProceedDecision);\nconsole.log(\"Stage 1 overall_status:\", stage1ActualData?.overall_status);\nconsole.log(\"Stage 1 alerts total:\", stage1ActualData?.alerts?.total);\n\n// Context'i al veya olu≈ütur - nested structure'ƒ± kontrol et\nlet masterContext = null;\n\n// √ñnce Stage 1'in actual data'sƒ±ndan context'i almayƒ± dene\nif (stage1ActualData && stage1ActualData._context) {\n  masterContext = stage1ActualData._context;\n  console.log(\"Context found in Stage 1 actual data\");\n} else if (stage1Output._context) {\n  masterContext = stage1Output._context;\n  console.log(\"Context found in Stage 1 output root\");\n} else if (unifiedConfig._context) {\n  masterContext = unifiedConfig._context;\n  console.log(\"Context found in Unified Config\");\n} else {\n  console.error(\"No context found! Creating fallback\");\n  masterContext = {\n    contextId: `ctx-fallback-${Date.now()}`,\n    createdAt: new Date().toISOString(),\n    stageResults: {},\n    decisions: {},\n    debug: { warnings: ['Context not found, created fallback'] }\n  };\n}\n\n// Context ID kontrol√º\nconsole.log(\"Master Context ID:\", masterContext.contextId);\nconsole.log(\"Expected Context ID:\", unifiedConfig._context?.contextId);\n\n// Context ID uyumsuzluƒüunu d√ºzelt\nif (masterContext.contextId !== unifiedConfig._context?.contextId && unifiedConfig._context) {\n  console.warn(\"Context ID mismatch! Using Unified Entry Point context\");\n  masterContext = unifiedConfig._context;\n}\n\n// Unified Entry Point'ten gelen config'i kontrol et\nconsole.log(\"Config source type:\", unifiedConfig.source?.type);\nconsole.log(\"Config priority:\", unifiedConfig.priority);\nconsole.log(\"Config forceDeepAnalysis:\", unifiedConfig.forceDeepAnalysis);\nconsole.log(\"Config stageConfig.forceDeepAnalysis:\", unifiedConfig.stageConfig?.forceDeepAnalysis);\n\n// Karar mantƒ±ƒüƒ± - √ñNEMLƒ∞: forceDeepAnalysis kontrol√º ekle\nconst shouldProceedStage1 = stage1ProceedDecision === true;\nconst forceDeepAnalysisFromConfig = \n  unifiedConfig.forceDeepAnalysis === true || \n  unifiedConfig.priority === 'critical' ||\n  unifiedConfig.stageConfig?.forceDeepAnalysis === true;\n\n// Override logic: Eƒüer config'den force geliyorsa, Stage 1'in kararƒ±nƒ± override et\nconst shouldProceed = shouldProceedStage1 || forceDeepAnalysisFromConfig;\n\nconsole.log(\"=== DECISION SUMMARY ===\");\nconsole.log(\"Stage 1 said proceed:\", shouldProceedStage1);\nconsole.log(\"Force deep analysis from config:\", forceDeepAnalysisFromConfig);\nconsole.log(\"Final decision - proceed to Stage 2?\", shouldProceed);\nconsole.log(\"=======================\");\n\n// Stage 1 sonu√ßlarƒ±nƒ± context'e kaydet - actual data'yƒ± kullan\nmasterContext.stageResults.stage1 = {\n  output: stage1ActualData || stage1Output,\n  completedAt: new Date().toISOString(),\n  decision: stage1ProceedDecision,\n  rawOutput: stage1Output // Debug i√ßin raw output'u da sakla\n};\n\n// Decision bilgisini context'e kaydet\nmasterContext.decisions.stage2Decision = {\n  timestamp: new Date().toISOString(),\n  shouldProceed: shouldProceed,\n  stage1Said: shouldProceedStage1,\n  forcedDeep: forceDeepAnalysisFromConfig,\n  forceSource: forceDeepAnalysisFromConfig ? \n    (unifiedConfig.priority === 'critical' ? 'critical priority' : 'explicit force flag') : \n    'none',\n  reason: shouldProceed && !shouldProceedStage1 ? \n    \"Forced deep analysis by user request\" : \n    (stage1ActualData?.reason || \"Based on Stage 1 analysis\")\n};\n\n// Output data hazƒ±rla - Stage 1'in actual data'sƒ±nƒ± kullan\nconst outputData = {\n  // Stage 1'in t√ºm verilerini koru\n  ...(stage1ActualData || stage1Output),\n  \n  // Stage 1 results'ƒ± ayrƒ±ca sakla\n  stage1Results: stage1ActualData || stage1Output,\n  \n  // Decision bilgisi\n  _decision: {\n    shouldProceed: shouldProceed,\n    stage1Said: shouldProceedStage1,\n    forcedDeep: forceDeepAnalysisFromConfig,\n    forceSource: forceDeepAnalysisFromConfig ? \n      (unifiedConfig.priority === 'critical' ? 'critical priority' : 'explicit force flag') : \n      'none',\n    reason: shouldProceed && !shouldProceedStage1 ? \n      \"Forced deep analysis by user request\" : \n      (stage1ActualData?.reason || \"Based on Stage 1 analysis\")\n  },\n  \n  // Context'i ta≈üƒ± ve g√ºncelle\n  _context: masterContext,\n  \n  // Debug bilgisi\n  _debug: {\n    nodeType: 'Stage 2 Decision',\n    processedAt: new Date().toISOString(),\n    contextPreserved: true,\n    contextId: masterContext.contextId,\n    stage1Structure: stage1Output.output ? 'nested' : 'flat',\n    stage1ProceedValue: stage1ProceedDecision,\n    stage1Status: stage1ActualData?.overall_status,\n    stage1Alerts: stage1ActualData?.alerts?.total\n  }\n};\n\n// Final validation\nif (shouldProceed && stage1ActualData?.overall_status === 'degraded' && stage1ActualData?.alerts?.total > 0) {\n  console.log(\"‚úÖ Decision validated: Degraded cluster with alerts, proceeding to Stage 2\");\n} else if (!shouldProceed && stage1ActualData?.overall_status === 'healthy') {\n  console.log(\"‚úÖ Decision validated: Healthy cluster, stopping here\");\n} else if (shouldProceed && forceDeepAnalysisFromConfig) {\n  console.log(\"‚úÖ Decision validated: Deep analysis forced by configuration\");\n} else {\n  console.warn(\"‚ö†Ô∏è Unexpected decision state - please verify\");\n}\n\nreturn [outputData];"
      },
      "id": "9fb5b548-ddb0-41e2-8f7c-e610bbb8a75d",
      "name": "Stage 2 Decision",
      "type": "n8n-nodes-base.code",
      "position": [
        2192,
        144
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json._decision.shouldProceed }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "4a8f54c8-a3d2-4eb3-b133-085ad6a72a40"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "94e6ef31-14db-4c56-8b8e-8d709d7a99d3",
      "name": "Route After Decision",
      "type": "n8n-nodes-base.if",
      "position": [
        2416,
        144
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 2: Deep Kubernetes Analysis - CONTEXT AWARE\n\nExecute comprehensive analysis based on Stage 1 findings.\n\n## üïê TIME PARAMETERS:\nUse these EXACT timestamps from context:\n- Start Time: {{ $json._context.initialParams.startTime }}\n- End Time: {{ $json._context.initialParams.endTime }}\n\nIMPORTANT: \n- These are Unix timestamps in seconds\n- Convert for display: new Date(timestamp * 1000).toISOString()\n- DO NOT use mock dates like \"2024-06-01\"\n- ALL tool calls must use these timestamps\n\n## üéØ NAMESPACE & SERVICE FILTERING:\n\n**CRITICAL: Use these READY-TO-USE query filters in ALL Prometheus queries:**\n\nNamespace regex pattern: {{ $json.namespaceRegex }}\nService regex pattern: {{ $json.serviceRegex }}\n\n**COPY THESE EXACT FILTERS INTO YOUR PROMETHEUS QUERIES:**\n1. Namespace filter: {{ $json.queryHelpers?.namespaceFilter }}\n2. Combined filter: {{ $json.queryHelpers?.combinedFilter }}\n\n**READY-TO-USE EXAMPLE QUERIES (COPY EXACTLY):**\n- Pod count: {{ $json.queryHelpers?.exampleQueries?.podCount }}\n- Service list: {{ $json.queryHelpers?.exampleQueries?.serviceList }}\n- Alert count: {{ $json.queryHelpers?.exampleQueries?.alertCount }}\n- CPU usage: {{ $json.queryHelpers?.exampleQueries?.cpuUsage }}\n- Memory usage: {{ $json.queryHelpers?.exampleQueries?.memoryUsage }}\n\n**CRITICAL RULES:**\n- NEVER use hardcoded namespaces - use {{ $json.namespaceRegex }} pattern\n- COPY the ready-to-use queries shown above\n- The filters are pre-validated and ready to use\n\n**Analysis scope:** {{ $json.stage2Instructions?.message }}\n\n## üìã CONTEXT PRESERVATION:\nIn your JSON output, you MUST include a \"_context\" field.\nSimply copy the _context object from your input WITHOUT modifications.\nStage 1 data is available in $json.stage1Data for your analysis.\n\n## üîß TOOL EXECUTION:\n\nWhen calling ANY Prometheus tool, use these timestamps and filters:\n{\n  \"start\": {{ $json._context.initialParams.startTime }},\n  \"end\": {{ $json._context.initialParams.endTime }},\n  \"query\": \"<use ready-to-use queries from above with namespace/service filters>\"\n}\n\nExample tool call:\n{\n  \"start\": {{ $json.startTime }},\n  \"end\": {{ $json.endTime }},\n  \"query\": \"{{ $json.queryHelpers?.exampleQueries?.podCount }}\"\n}\n\n## üéØ DECISION LOGIC - HOW TO SET proceed_to_stage3:\n\n**Set proceed_to_stage3 = true IF ANY OF THESE CONDITIONS:**\n1. root_cause.identified = false (still need alert correlation to find root cause)\n   - You found symptoms but unclear what's causing them\n2. Active alerts > 0 AND no clear single root cause from metrics alone\n   - Metrics show issues but need alert context to understand full picture\n3. Multiple symptoms detected but unclear relationship between them\n   - Example: High memory + restarts + network errors, but which is the cause?\n4. Stage 1 + Stage 2 findings show issues but you're uncertain about root cause\n   - When confidence < 0.7 even after deep analysis\n\n**Set proceed_to_stage3 = false ONLY IF ALL CONDITIONS MET:**\n1. root_cause.identified = true with confidence > 0.7\n   - Clear evidence from multiple tools pointing to same root cause\n   AND\n2. Blast radius well understood (clear affected_services list)\n   AND\n3. Either:\n   - No active alerts AND no issues found in metrics\n   - OR: Root cause clearly identified without needing alert correlation\n\n**CRITICAL**: Default to true if uncertain. Better to correlate alerts than miss root cause.\n\n## üìä CONFIDENCE CALCULATION - HOW TO CALCULATE root_cause.confidence:\n\nRoot cause confidence score (0.0 - 1.0) is calculated as SUM of these factors:\n\n**1. Multiple Tools Agreement (+0.3):**\n- 3+ tools show same issue (e.g., all point to memory pressure) = +0.3\n- 2 tools agree = +0.2\n- Only 1 tool shows issue = +0.1\n- No tools show clear issue = 0.0\n\n**2. Evidence Depth (+0.2):**\n- Evidence from 3+ different metric types (e.g., restarts + memory + CPU) = +0.2\n- Evidence from 2 metric types = +0.1\n- Evidence from 1 metric type = +0.05\n\n**3. Stage 1 Correlation (+0.2):**\n- Stage 2 findings MATCH Stage 1 quick_findings (validates Stage 1 suspicions) = +0.2\n- Partial match = +0.1\n- No match (found different issues) = 0.0\n\n**4. Historical Pattern (+0.2):**\n- Historical Comparison 24h shows clear trend (growing problem) = +0.2\n- Some historical data but unclear trend = +0.1\n- No historical data or contradicts current findings = 0.0\n\n**5. Blast Radius Clarity (+0.1):**\n- Clear affected_services list with 1+ services identified = +0.1\n- AND clear kubernetes_impact numbers (evicted_pods, pending_pods, etc.)\n- Unclear blast radius = 0.0\n\n**EXAMPLES:**\n- 4 tools show memory issue (+0.3) + Memory+CPU+restart evidence (+0.2) + Matches Stage 1 memory_pressure (+0.2) + 24h shows growing memory (+0.2) + 5 affected services (+0.1) = **Confidence: 1.0** (very confident)\n- 2 tools show restarts (+0.2) + Only restart evidence (+0.05) + Matches Stage 1 (+0.2) + No historical data (+0.0) + Services unclear (+0.0) = **Confidence: 0.45** (uncertain, need Stage 3)\n\n## üéØ ANALYSIS PHASES:\n\n### Phase 1: INSTANT (0-10s) - Execute based on Stage 1 findings:\n\n**Available Tools**: Node Resource Status, Node Conditions, Pod Status Check, Node Network Health, Container Restarts, Application Metrics, HTTP Error Rates, Pod Resource Usage, Resource Exhaustion Prediction, Kubernetes PVC Status, Kubernetes HPA Status\n\n**IF Stage 1 scores.pod_stability is LOW** (pod restart issues detected):\n1. Call \"Pod Status Check\" ‚Üí Get current pod phases + waiting reasons\n2. Call \"Container Restarts\" ‚Üí Get restart counts + last terminated reasons\n3. Call \"Pod Resource Usage\" ‚Üí Check if hitting resource limits (memory/CPU)\n\n**IF Stage 1 scores.node_availability is LOW** (node issues detected):\n1. Call \"Node Resource Status\" ‚Üí Get memory/CPU/disk usage per node\n2. Call \"Node Conditions\" ‚Üí Get Ready/MemoryPressure/DiskPressure/PIDPressure status\n3. Call \"Node Network Health\" ‚Üí Check network errors and packet drops\n\n**IF Stage 1 scores.cluster_health is LOW** (general cluster issues):\n1. Call \"Pod Status Check\" ‚Üí Overall pod health across namespaces\n2. Call \"Kubernetes HPA Status\" ‚Üí Check if autoscaling is working/maxed out\n3. Call \"Kubernetes PVC Status\" ‚Üí Check storage issues (>80% usage, unbound PVCs)\n\n**IF Stage 1 scores.api_reliability is LOW** (API/service issues):\n1. Call \"HTTP Error Rates\" ‚Üí Pod failures as proxy for service errors\n2. Call \"Application Metrics\" ‚Üí Container network metrics (traffic patterns)\n3. Call \"Pod Resource Usage\" ‚Üí Check if resource constraints affecting API\n\n**CRITICAL**: Call 3-5 tools in Phase 1 based on Stage 1 findings, not all 12 tools.\n\n### Phase 2: TREND (10-20s) - Historical analysis:\n\n**Use \"Historical Comparison 24h\" tool for trend analysis:**\n\nThis tool requires you to pass a `metric_query` parameter. Call it MULTIPLE TIMES with different queries based on Phase 1 findings:\n\n**1. For restart trends** (if Phase 1 found pod restarts):\n```\nTool: Historical Comparison 24h\nParameters: {\n  \"metric_query\": \"kube_pod_container_status_restarts_total{namespace=~\\\"{{ $json.namespaceRegex }}\\\", pod=~\\\".*<pod_name_from_phase1>.*\\\"}\"\n}\n```\n\n**2. For memory growth** (if Phase 1 found high memory):\n```\nTool: Historical Comparison 24h\nParameters: {\n  \"metric_query\": \"container_memory_working_set_bytes{namespace=~\\\"{{ $json.namespaceRegex }}\\\", pod=~\\\".*<pod_name_from_phase1>.*\\\"}\"\n}\n```\n\n**3. For CPU trends** (if Phase 1 found high CPU):\n```\nTool: Historical Comparison 24h\nParameters: {\n  \"metric_query\": \"rate(container_cpu_usage_seconds_total{namespace=~\\\"{{ $json.namespaceRegex }}\\\", pod=~\\\".*<pod_name_from_phase1>.*\\\"}[5m])\"\n}\n```\n\n**Compare current values vs 24h ago to identify:**\n- memory_growth: \"Memory increased 40% in 24h\" or \"Stable\"\n- restart_pattern: \"Restarting every 2 hours\" or \"No pattern\"\n- peak_times: [\"2024-06-01T14:00:00Z\", \"2024-06-01T16:00:00Z\"] (when issues occurred)\n\n### Phase 3: ANOMALY (20-30s) - Predictive analysis:\n**Use \"Resource Exhaustion Prediction\" tool:**\n- Predicts if resources will be exhausted in next 4 hours\n- Uses predict_linear to forecast disk/memory/PVC exhaustion\n\n**Look for anomalies in Phase 1 data:**\n- Sudden spikes in metrics (not gradual growth)\n- Unusual patterns (e.g., restarts only at specific times)\n- Cascading failures (one failure triggering others)\n\n## üîß JSON FORMAT VALIDATION RULES:\n\n1. Start your response with { and end with }\n2. Do not include any text before or after the JSON\n3. Do not use any code block formatting or markdown. No triple backticks before or after the JSON\n4. Ensure all string values are in double quotes\n5. Ensure all numbers are unquoted (5 not \"5\")\n6. Ensure booleans are unquoted (true not \"true\")\n7. For _context field, copy the exact object from your input (no modification needed)\n8. Empty arrays are valid: []\n9. All arrays must use square brackets []\n10. All objects must use curly braces {}\n\n## ‚úÖ RESPONSE VALIDATION:\nYour complete response must:\n- Be valid JSON that starts with { and ends with }\n- Include all required fields from the template\n- Use actual tool response data, not placeholders\n- Have proper nesting for execution_phases, correlation_matrix, and root_cause objects\n- Contain real timestamps and data from Prometheus\n\n## üìù FINAL REMINDER:\nRETURN RAW JSON ONLY - NO EXPLANATIONS, NO MARKDOWN, NO CODE BLOCKS\n\n## üö® CRITICAL OUTPUT REQUIREMENT:\n**RETURN ONLY VALID JSON - NO MARKDOWN**\n\n{\n  \"stage\": \"deep_analysis\",\n  \"investigation_id\": \"{{ $json._context.contextId }}-stage2\",\n  \"triggered_by\": \"Stage 1: {{ $json.stage1Results.alerts.total }} alerts\",\n  \"execution_phases\": {\n    \"instant\": {\n      \"tools_used\": [\"<actual tools used>\"],\n      \"duration\": \"<actual duration>\",\n      \"findings\": {\n        \"critical_pods\": [\"<from actual tool responses>\"],\n        \"resource_pressure\": [\"<from actual tool responses>\"],\n        \"workload_issues\": [\"<from actual tool responses>\"],\n        \"scaling_issues\": [\"<from actual tool responses>\"]\n      }\n    },\n    \"trend\": {\n      \"tools_used\": [\"<actual tools used>\"],\n      \"findings\": {\n        \"memory_growth\": \"<from actual 24h comparison>\",\n        \"restart_pattern\": \"<from actual data>\",\n        \"peak_times\": [\"<actual timestamps if found>\"],\n        \"pvc_growth\": \"<from actual metrics>\"\n      }\n    },\n    \"anomaly\": {\n      \"tools_used\": [\"<actual tools used>\"],\n      \"findings\": {\n        \"predictions\": [\"<from actual analysis>\"],\n        \"anomalies\": [\"<from actual detection>\"]\n      }\n    }\n  },\n  \"correlation_matrix\": {\n    \"primary_chain\": \"<actual correlation found>\",\n    \"affected_services\": [\"<from actual findings>\"],\n    \"blast_radius\": \"<actual impact>\",\n    \"kubernetes_impact\": {\n      \"evicted_pods\": 0,\n      \"pending_pods\": 0,\n      \"failed_schedules\": 0\n    }\n  },\n  \"root_cause\": {\n    \"identified\": false,\n    \"component\": \"<actual component from findings>\",\n    \"issue\": \"<actual issue description>\",\n    \"evidence\": [\"<actual evidence from tools>\"],\n    \"confidence\": 0.0\n  },\n  \"proceed_to_stage3\": false,\n  \"alert_correlation_needed\": false,\n  \"_context\": <copy from input>,\n  \"_debug\": {\n    \"nodeType\": \"Stage 2: Deep Analysis\",\n    \"processedAt\": \"<current ISO timestamp>\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromStage\": \"\",\n    \"stageSequence\": {{ JSON.stringify($json._debug.stageSequence) }},\n    \"timeRangeUsed\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    }\n  }\n}\n\n## ‚ö†Ô∏è CRITICAL FINAL INSTRUCTION:\nYour ENTIRE response must be ONLY the JSON object above. Do NOT add any text before the opening { or after the closing }. Do NOT use markdown code blocks or backticks. Start with { and end with }",
        "options": {
          "systemMessage": "You are a Kubernetes cluster analyzer. You MUST return ONLY raw JSON without any formatting, markdown, TEXT or code blocks. Do not use triple backticks or any other wrapper around your response. Your entire response must be valid JSON that starts with { and ends with }. Never include explanatory text before or after the JSON."
        }
      },
      "id": "968ecd70-55a1-4802-844b-2773cedee30c",
      "name": "Stage 2: Deep Analysis",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        2384,
        304
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {},
      "id": "89d3bd0e-4bd1-4d38-aad7-4f37fe9afa1a",
      "name": "Wait 3s",
      "type": "n8n-nodes-base.wait",
      "position": [
        2656,
        -96
      ],
      "typeVersion": 1.1,
      "webhookId": "c1df24e6-b60a-4413-9229-aab90bb5d955"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 3: Alert Intelligence & Correlation - CONTEXT AWARE\n\nAnalyze alerts and correlate with Stage 2 findings.\n\n## üïê TIME PARAMETERS:\nUse these EXACT timestamps from context:\n- Start Time: {{ $json._context.initialParams.startTime }}\n- End Time: {{ $json._context.initialParams.endTime }}\n\nIMPORTANT:\n- These are Unix timestamps in seconds\n- Convert for display: new Date(timestamp * 1000).toISOString()\n- DO NOT use mock dates like \"2024-06-15\"\n- For current timestamp, use new Date().toISOString()\n\n## üìã CONTEXT INFORMATION:\n- Context ID: {{ $json._context.contextId }}\n- Stage 2 Root Cause: {{ $json.stage2Data.root_cause.issue }}\n- Affected Services: {{ JSON.stringify($json.stage2Data.correlation_matrix.affected_services) }}\n\n## üîß TOOL RESPONSE HANDLING:\n\n### For Active Alerts Details tool:\nThe tool uses this query to get Kubernetes-related alerts:\nALERTS{alertstate=\"firing\",alertname=~\"Kube.*|Container.*|Pod.*|Node.*\"}\n\nThe tool will return alerts with these labels:\n- alertname: Name of the alert (e.g., KubePodCrashLooping, KubeNodeNotReady)\n- alertstate: Will be \"firing\" \n- severity: Alert severity (critical, warning, info) if defined in the alert rule\n- namespace: Kubernetes namespace where the issue is occurring\n- pod: Pod name if the alert is pod-related\n- node: Node name if the alert is node-related\n- container: Container name if applicable\n\nNote: Summary and description are defined in the alert rules, not in the metrics. If you need detailed descriptions, refer to the alert names:\n- KubePodCrashLooping: Pod is restarting frequently\n- KubeNodeNotReady: Node is not in ready state\n- KubeDeploymentReplicasMismatch: Deployment has incorrect replica count\n- KubeContainerWaiting: Container is in waiting state\n- KubePodNotReady: Pod is not ready to serve traffic\n\nWhen analyzing alerts:\n1. Count of each alert type\n2. Which namespaces/pods/nodes are affected\n3. Severity distribution\n4. How long alerts have been firing (if timestamp available)\n\n### For Alert History 24h tool:\n- Call without parameters\n- Returns alert history for the last 24 hours\n- Use to identify recurring patterns\n\n### For SLO Status Check Tools:\n**CRITICAL**: SLO tools may return \"NaN\", empty results, or errors. Handle these cases:\n- If result is \"NaN\" ‚Üí assume 100% (no issues detected)\n- If result is empty array ‚Üí assume 100% (no metrics to check)\n- If result has error ‚Üí assume 100% and note in debug\n- If result has value ‚Üí use the numeric value\n\nExample handling:\n```javascript\nconst sloValue = toolResponse.data?.result?.[0]?.value?.[1];\nif (!sloValue || sloValue === \"NaN\" || sloValue === \"\") {\n  return \"100\"; // No issues detected\n}\nreturn sloValue;\nüìä COMPOSITE SLO CALCULATION:\nIf multiple SLO tools are available, calculate a weighted composite:\n\nCall each SLO tool and collect results:\n\nPod Ready SLO ‚Üí weight: 30%\nContainer Running SLO ‚Üí weight: 20%\nNode Ready SLO ‚Üí weight: 25%\nPod Restart Rate SLO ‚Üí weight: 15%\nDeployment Health ‚Üí weight: 10%\n\n\nFor each SLO result:\n\nIf \"NaN\" or empty ‚Üí use 100\nIf error ‚Üí use 100 and note in debug\nOtherwise use actual numeric value\n\n\nCalculate composite:\ncomposite = (podReady * 0.3) + (containerRunning * 0.2) + (nodeReady * 0.25) + (restartRate * 0.15) + (deploymentHealth * 0.1)\nInterpret composite score:\n\n\n\n= 99.9 ‚Üí \"green\" (SLO Met)\n\n\n99.0-99.9 ‚Üí \"yellow\" (SLO Warning)\n< 99.0 ‚Üí \"red\" (SLO Violation)\n\n\n\nCommon Kubernetes Alert Descriptions:\nconst alertDescriptions = {\n\"KubePodCrashLooping\": {\nsummary: \"Pod is crash looping\",\ndescription: \"Pod has restarted more than 5 times in the last 10 minutes\",\nseverity: \"critical\"\n},\n\"KubeNodeNotReady\": {\nsummary: \"Node is not ready\",\ndescription: \"Node has been unready for more than 5 minutes\",\nseverity: \"critical\"\n},\n\"KubeDeploymentReplicasMismatch\": {\nsummary: \"Deployment replica mismatch\",\ndescription: \"Deployment has not matched the expected number of replicas\",\nseverity: \"warning\"\n},\n\"KubeContainerWaiting\": {\nsummary: \"Container waiting\",\ndescription: \"Container has been in waiting state for more than 1 hour\",\nseverity: \"warning\"\n},\n\"KubePodNotReady\": {\nsummary: \"Pod not ready\",\ndescription: \"Pod has been in a non-ready state for more than 5 minutes\",\nseverity: \"warning\"\n},\n\"KubeHpaMaxedOut\": {\nsummary: \"HPA maxed out\",\ndescription: \"HPA has been at max replicas for more than 15 minutes\",\nseverity: \"warning\"\n}\n};\n\n## üéØ DECISION LOGIC - HOW TO SET proceed_to_stage4:\n\n**Set proceed_to_stage4 = true IF ANY OF THESE CONDITIONS:**\n1. Active alerts count > 0 (any firing alerts need automated diagnosis)\n2. SLO violation detected (availability_slo.status = \"red\" OR current < 99.0%)\n3. High-severity alerts present (Critical or Blocker severity from KB enrichment)\n4. Alert storm detected (alert_patterns.storm_detection.detected = true)\n5. Stage 2 identified issues but root_cause.confidence < 0.7\n6. Multiple alert groups indicating complex cascading failures\n\n**Set proceed_to_stage4 = false ONLY IF ALL CONDITIONS MET:**\n1. No active alerts (active_alerts = [] OR all alerts resolved)\n   AND\n2. SLO status = \"green\" (availability_slo.current >= 99.9%)\n   AND\n3. No recurring alert patterns (alert_patterns.recurring = [])\n   AND\n4. auto_remediation_approved = true (all Low/Medium severity KB matches)\n   AND\n5. Stage 2 found no issues OR Stage 2 root_cause.confidence >= 0.8\n\n**CRITICAL**: Default to true if uncertain. Better to run diagnosis than miss critical issues.\n\n## üìä ALERT CORRELATION CONFIDENCE CALCULATION:\n\nCalculate overall alert correlation quality (0.0 - 1.0) as SUM of these factors:\n\n**1. Alert-to-Stage2 Correlation (+0.3):**\n- Alert labels match Stage 2 root_cause.component (e.g., same pod/namespace) = +0.3\n- Alerts in same namespace as Stage 2 affected_services = +0.2\n- Alerts related to Stage 2 findings but different component = +0.1\n- No correlation with Stage 2 findings = 0.0\n\n**2. Knowledge Base Coverage (+0.3):**\n- All active alerts have KB matches (100% coverage) = +0.3\n- 75%-99% alerts have KB matches = +0.2\n- 50%-74% alerts have KB matches = +0.1\n- <50% KB coverage = +0.05\n- No KB matches = 0.0\n\n**3. Alert Group Quality (+0.2):**\n- Clear root alert identified with 3+ related alerts (strong correlation) = +0.2\n- Root alert with 1-2 related alerts (moderate correlation) = +0.1\n- No alert grouping possible (isolated alerts) = 0.0\n\n**4. SLO Impact Clarity (+0.2):**\n- Composite SLO available with 4+ components = +0.2\n- Composite SLO with 2-3 components = +0.1\n- Single SLO component = +0.05\n- No SLO data (all NaN/empty) = 0.0\n\n**EXAMPLES:**\n- 5 alerts, all have KB matches (+0.3) + Alerts match Stage 2 pod (+0.3) + Root alert with 4 related (+0.2) + Composite SLO with 5 components (+0.2) = **Confidence: 1.0** (perfect correlation)\n- 2 alerts, 1 KB match (+0.1) + Different namespace than Stage 2 (+0.0) + No grouping (+0.0) + Single SLO (+0.05) = **Confidence: 0.15** (weak correlation, proceed to Stage 4)\n\n## üîß TOOL PARAMETERS:\n\n**IMPORTANT**: SLO tools automatically use multi-namespace filtering via `$json.namespaceRegex`.\nYou do NOT need to pass namespace parameters when calling tools.\n\n**Optional service filtering**: If Stage 2 identified specific affected services, tools can filter by service name.\n\nTools will automatically query across ALL 12 production namespaces:\n- bstp-cms-global-production, bstp-cms-prod-v3\n- em-global-prod-3pp, em-global-prod-eom, em-global-prod-flowe, em-global-prod\n- em-prod-3pp, em-prod-eom, em-prod-flowe, em-prod\n- etiyamobile-production, etiyamobile-prod\n\nWhen calling SLO tools, simply call them - no namespace parameter needed:\n- Pod Ready SLO ‚Üí Checks all namespaces automatically\n- Container Running SLO ‚Üí Checks all namespaces automatically\n- Pod Restart Rate SLO ‚Üí Checks all namespaces automatically\n- Deployment Replica Health ‚Üí Checks all namespaces automatically\n\nService filtering (optional) comes from Stage 2 data:\n- Service name: {{ $json.stage2Data?.correlation_matrix?.affected_services?.[0] || 'none detected' }}\n\nüö® CRITICAL OUTPUT REQUIREMENT:\nRETURN ONLY VALID JSON - NO MARKDOWN, NO CODE BLOCKS\nDO NOT WRAP YOUR RESPONSE IN json TAGS\nHANDLE ALL EMPTY/NULL RESPONSES GRACEFULLY\nReturn ONLY this JSON structure:\n{\n\"stage\": \"alert_intelligence\",\n\"active_alerts\": [\n{\n\"name\": \"<actual alert name from tool response or 'No alerts'>\",\n\"severity\": \"<actual severity from tool response or 'unknown'>\",\n\"count\": <actual count from tool response or 0>,\n\"duration\": \"<calculate from current time minus alert start time or 'unknown'>\",\n\"labels\": <actual labels object from tool response or {}>,\n\"annotations\": <actual annotations from tool response if available or {}>\n}\n],\n\"alert_groups\": [\n{\n\"root_alert\": \"<identify main alert based on correlation or 'none'>\",\n\"related_alerts\": [<list other related alerts or empty array>],\n\"correlation_score\": <calculate 0.0-1.0 based on shared labels or 0>,\n\"shared_labels\": <identify common labels between alerts or {}>\n}\n],\n\"knowledge_base_matches\": [\n{\n\"alert\": \"<alert name or 'none'>\",\n\"kb_entry\": {\n\"root_causes\": [\"Based on alert type and previous incidents\"],\n\"diagnostic_commands\": [\"kubectl describe\", \"kubectl logs\"],\n\"immediate_actions\": [\"Check pod status\", \"Review recent changes\"],\n\"long_term_solutions\": [\"Update resource limits\", \"Fix application code\"]\n},\n\"applicability_score\": <0.0-1.0 based on match or 0>\n}\n],\n\"alert_patterns\": {\n\"recurring\": [],\n\"storm_detection\": {\n\"detected\": false,\n\"alert_count\": <count of alerts or 0>,\n\"time_window\": \"5m\",\n\"likely_root\": \"<identify if there's a common cause or null>\"\n}\n},\n\"slo_impact\": {\n\"availability_slo\": {\n\"target\": \"99.9%\",\n\"current\": \"<calculated SLO value or '100'>%\",\n\"error_budget_used\": \"<calculated percentage or '0'>%\",\n\"time_remaining\": \"<based on burn rate or '30d'>\",\n\"components\": {\n\"deployment_health\": \"<if single SLO tool used, put value here or '100'>%\"\n},\n\"status\": \"<green|yellow|red based on current vs target>\"\n},\n\"affected_slis\": [<list SLIs below target or empty array>]\n},\n\"recommended_alert_actions\": [\n{\n\"alert\": \"<alert name or 'none'>\",\n\"action\": \"<specific remediation action or 'Monitor'>\",\n\"confidence\": <0.0-1.0 or 0>,\n\"risk\": \"<low|medium|high>\",\n\"command\": \"<kubectl or other command or null>\"\n}\n],\n\"correlation_confidence\": <calculate 0.0-1.0 using formula above>,\n\"proceed_to_stage4\": <true if alerts need investigation, false otherwise>,\n\"auto_remediation_approved\": <true only for low-risk known issues>,\n\"_context\": <copy the exact _context object from input>,\n\"_debug\": {\n\"nodeType\": \"Stage 3: Alert Intelligence\",\n\"processedAt\": \"<current ISO timestamp from new Date().toISOString()>\",\n\"contextId\": \"<copy from input _context.contextId>\",\n\"contextPreserved\": true,\n\"receivedFromStage\": \"Fix Stage 2 Context\",\n\"stageSequence\": <take input _debug.stageSequence array and add \"Stage 3: Alert Intelligence\">,\n\"timeRangeUsed\": {\n\"start\": <copy from input _context.initialParams.startTime>,\n\"end\": <copy from input _context.initialParams.endTime>\n},\n\"sloToolErrors\": []\n}\n}\nüìù IMPORTANT NOTES:\n\nIf no alerts are found, return empty arrays but still complete the analysis\nUse actual values from tool responses, don't make up data\nFor _context: Copy exactly as received in input\nFor timestamps: Use actual current time, not placeholders\nUse knowledge from alertDescriptions to enrich alert information\nALWAYS handle NaN and empty responses gracefully\nDefault to safe values when data is missing",
        "hasOutputParser": true,
        "options": {}
      },
      "id": "98bd1e02-7f28-4f7f-b451-63493b678cac",
      "name": "Stage 3: Alert Intelligence",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        3968,
        272
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 4: Automated Diagnosis & Deep Dive - CONTEXT AWARE\n\nExecute targeted diagnostics based on previous findings.\n\n## üïê TIME PARAMETERS:\n- Start: {{ $json._context.initialParams.startTime }}\n- End: {{ $json._context.initialParams.endTime }}\n- Display: new Date(timestamp * 1000).toISOString()\n- DO NOT use fake dates like \"2024-01-15\"\n\n## üìã CONTEXT:\n- Context ID: {{ $json._context.contextId }}\n- Primary Issue: {{ $json.stage3Data.recommended_actions[0].alert }}\n- Root Cause: {{ $json.stage2Data.root_cause.issue }}\n\n## üîß DIAGNOSTIC EXECUTION:\n\n**NOTE**: This stage has NO Prometheus tools. You will synthesize diagnostic findings based on:\n- Stage 2 root cause analysis ({{ $json.stage2Data.root_cause }})\n- Stage 3 alert correlation ({{ $json.stage3Data.active_alerts }})\n- Available context from previous stages\n\nBased on findings, generate realistic diagnostics:\n- For pod issues: Reference actual pod names from Stage 2/3 findings\n- For node issues: Reference actual node names from Stage 2/3 findings\n- Use exact timestamps from context\n- Simulate realistic kubectl/diagnostic command output based on actual metrics\n\n## üéØ DECISION LOGIC - HOW TO SET proceed_to_stage5:\n\n**Set proceed_to_stage5 = true IF ANY OF THESE CONDITIONS:**\n1. Diagnostic findings confirm issues that need remediation\n   - Found actual errors, crashes, or resource exhaustion in diagnostics\n2. confirmed_issues array has 1+ issues with severity \"critical\" or \"high\"\n   - Issues that require immediate action to prevent service degradation\n3. Stage 3 alerts + Stage 4 diagnostics paint clear picture needing action\n   - Correlation between alerts and diagnostic findings is strong\n4. remediation_confidence >= 0.6 (we have enough info to remediate safely)\n   - Confident that we understand the problem and have a solution path\n\n**Set proceed_to_stage5 = false ONLY IF ALL CONDITIONS MET:**\n1. No confirmed issues found in diagnostics (confirmed_issues = [])\n   AND\n2. All severity levels are \"low\" or \"medium\" (no critical/high issues)\n   AND\n3. Stage 2 + Stage 3 + Stage 4 findings show system is healthy\n   AND\n4. remediation_confidence < 0.5 (not confident enough to recommend actions)\n\n**CRITICAL**: Default to true if you found ANY actionable issues. Better to generate remediation plan than miss fixing critical problems.\n\n## üìä REMEDIATION CONFIDENCE CALCULATION:\n\nCalculate remediation_confidence (0.0 - 1.0) as SUM of these factors:\n\n**1. Diagnostic Depth (+0.3):**\n- Diagnostics executed for 3+ targets (pods/nodes/services) = +0.3\n- Diagnostics executed for 2 targets = +0.2\n- Diagnostics executed for 1 target = +0.1\n- No diagnostics executed (empty diagnostics_executed) = 0.0\n\n**2. Issue Clarity (+0.3):**\n- confirmed_issues clearly identify root cause with evidence = +0.3\n- confirmed_issues identify symptoms but unclear root cause = +0.2\n- Only secondary_issues identified, no confirmed issues = +0.1\n- No issues identified = 0.0\n\n**3. Stage 2+3 Correlation (+0.2):**\n- Stage 4 findings MATCH both Stage 2 root_cause AND Stage 3 alerts = +0.2\n- Stage 4 findings match either Stage 2 OR Stage 3 = +0.1\n- Stage 4 findings contradict previous stages = 0.0\n\n**4. Recent Changes Context (+0.2):**\n- recent_changes identified with clear correlation to issues = +0.2\n- recent_changes available but unclear correlation = +0.1\n- No recent_changes data = 0.0\n\n**EXAMPLES:**\n- Diagnostics for 4 pods (+0.3) + Clear OOMKilled root cause (+0.3) + Matches Stage 2 memory issue + Stage 3 memory alerts (+0.2) + Deployment scaled 2h ago correlates with issue start (+0.2) = **Confidence: 1.0** (very confident, proceed to remediation)\n- Diagnostics for 1 pod (+0.1) + Symptoms but unclear cause (+0.2) + Matches Stage 3 alerts only (+0.1) + No recent changes (+0.0) = **Confidence: 0.4** (uncertain, may skip remediation)\n\n## üö® OUTPUT REQUIREMENT:\n**RETURN ONLY VALID JSON WITH ACTUAL DATA**\n\n{\n  \"stage\": \"automated_diagnosis\",\n  \"diagnostics_executed\": [\n    {\n      \"target\": \"<actual pod/node/service name>\",\n      \"type\": \"<pod|node|service>\",\n      \"commands_run\": [<simulated but realistic commands>],\n      \"findings\": {\n        \"pod_status\": {\n          \"phase\": \"<from actual pod status>\",\n          \"restart_count\": <actual count from metrics>,\n          \"last_termination\": {\n            \"reason\": \"<from actual events>\",\n            \"exit_code\": <if available>,\n            \"finished_at\": \"<actual timestamp from events>\"\n          }\n        },\n        \"error_logs\": [\n          {\n            \"timestamp\": \"<actual timestamp from logs>\",\n            \"level\": \"<actual log level>\",\n            \"message\": \"<actual error message>\",\n            \"stack_trace\": \"<if available>\"\n          }\n        ],\n        \"events\": [<actual k8s events>],\n        \"resource_usage\": {\n          \"memory_request\": \"<from actual pod spec>\",\n          \"memory_limit\": \"<from actual pod spec>\",\n          \"memory_used\": \"<from actual metrics>\",\n          \"cpu_used\": \"<from actual metrics>\"\n        }\n      }\n    }\n  ],\n  \"enriched_context\": {\n    \"deployment_info\": {\n      \"name\": \"<actual deployment name>\",\n      \"version\": \"<from actual labels>\",\n      \"replicas\": \"<actual ready/total>\",\n      \"last_update\": \"<actual update timestamp>\",\n      \"update_strategy\": \"<actual strategy>\"\n    },\n    \"recent_changes\": [\n      {\n        \"type\": \"deployment\",\n        \"time\": \"<actual timestamp>\",\n        \"change\": \"<from actual events>\",\n        \"user\": \"<if available>\"\n      }\n    ],\n    \"dependencies\": {\n      \"upstream\": [<from actual service discovery>],\n      \"downstream\": [<from actual service discovery>],\n      \"databases\": [<from actual config>],\n      \"external\": [<from actual config>]\n    }\n  },\n  \"diagnostic_summary\": {\n    \"confirmed_issues\": [\n      {\n        \"issue\": \"<specific issue description>\",\n        \"evidence\": [<actual evidence from diagnostics>],\n        \"severity\": \"critical|high|medium|low\",\n        \"impact\": \"<actual impact description>\",\n        \"namespace\": \"{{ $json.namespaces[0] }}\"\n      }\n    ],\n    \"secondary_issues\": []\n  },\n  \"proceed_to_stage5\": <true/false>,\n  \"remediation_confidence\": <0.0-1.0>,\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 4: Automated Diagnosis\",\n    \"processedAt\": \"<current ISO timestamp>\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromStage\": \"\",\n    \"stageSequence\": \"\",\n    \"diagnosticsCount\": <actual count>,\n    \"autoRemediationEnabled\": true,\n    \"timeRangeUsed\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    }\n  }\n}\n\n## ‚ö†Ô∏è CRITICAL:\n- ALL TIMESTAMPS MUST BE FROM ACTUAL DATA\n- NO HARDCODED DATES\n- USE REAL PROMETHEUS METRICS\n- NO MOCK DATA\n- secondary_issues MUST BE AN ARRAY (even if empty: [])",
        "options": {
          "systemMessage": "CRITICAL: You MUST respond with ONLY valid JSON that exactly matches the schema. \nDo not include any text before or after the JSON.\nDo not include markdown code blocks.\nStart your response with { and end with }"
        }
      },
      "id": "831ee520-5614-4f95-8f41-737010f64952",
      "name": "Stage 4: Automated Diagnosis",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        5120,
        256
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 5: AI-Powered Remediation Plan - CONTEXT AWARE\n\nGenerate remediation plan based on all findings.\n\n## üö® CRITICAL OUTPUT REQUIREMENT:\n**YOU MUST RETURN ONLY VALID JSON - NO MARKDOWN, NO CODE BLOCKS, NO EXTRA TEXT**\n**DO NOT WRAP YOUR RESPONSE IN ```json``` TAGS**\n**RETURN RAW JSON ONLY**\n\n## üïê TIME PARAMETERS:\n- Analysis Period: From timestamp {{ $json._context.initialParams.startTime }} to {{ $json._context.initialParams.endTime }}\n- Current Time: Use new Date().toISOString() for current timestamp\n\n## üìã COMPLETE CONTEXT:\n- Context ID: {{ $json._context.contextId }}\n- Primary Issue: {{ $json.primaryDiagnosis.issue }}\n- Severity: {{ $json.primaryDiagnosis.severity }}\n- Affected Component: {{  $json.stage4Data.enriched_context.deployment_info.name}}\n\n## üíæ OUTPUT FORMAT (MUST BE PURE JSON):\n\n{\n  \"stage\": \"ai_powered_analysis\",\n  \"analysis_id\": \"{{ $json._context.contextId }}-stage5\",\n  \"remediation_plan\": {\n    \"immediate_actions\": [\n      {\n        \"action\": \"Rollback deployment to previous version\",\n        \"command\": \"kubectl rollout undo deployment/{{ $json.stage4Data.enriched_context.deployment_info}} -n {{ $json.primaryDiagnosis.namespace }}\",\n        \"risk\": \"low\",\n        \"estimated_time\": \"2-5 minutes\",\n        \"expected_outcome\": \"Restore service to previous stable version\"\n      }\n    ],\n    \"short_term_fixes\": [\n      {\n        \"action\": \"Increase memory limits temporarily\",\n        \"timeline\": \"1-2 days\",\n        \"details\": \"Set memory limit to 2Gi while investigating root cause\"\n      }\n    ],\n    \"long_term_solutions\": [\n      {\n        \"action\": \"Fix memory leak in TransactionHandler\",\n        \"timeline\": \"1-2 weeks\",\n        \"details\": \"Review and fix the memory leak in payment processing code\"\n      }\n    ],\n    \"preventive_measures\": [\n      \"Implement memory profiling in CI/CD\",\n      \"Add memory leak detection tests\",\n      \"Set up gradual rollout strategy\"\n    ]\n  },\n  \"risk_assessment\": {\n    \"overall_risk\": \"medium\",\n    \"factors\": [\n      \"Payment service is critical\",\n      \"Rollback is tested and safe\",\n      \"Memory issue is contained to specific pods\"\n    ],\n    \"mitigation_steps\": [\n      \"Monitor closely after rollback\",\n      \"Keep team on standby\",\n      \"Prepare hotfix if needed\"\n    ]\n  },\n  \"implementation_order\": [\n    {\n      \"step\": 1,\n      \"action\": \"Execute rollback\",\n      \"dependencies\": [],\n      \"validation\": \"Check pod status and memory usage\"\n    },\n    {\n      \"step\": 2,\n      \"action\": \"Verify service health\",\n      \"dependencies\": [\"step_1\"],\n      \"validation\": \"Check error rates and response times\"\n    },\n    {\n      \"step\": 3,\n      \"action\": \"Update monitoring alerts\",\n      \"dependencies\": [\"step_2\"],\n      \"validation\": \"Ensure alerts are firing correctly\"\n    }\n  ],\n  \"success_metrics\": {\n    \"immediate\": [\n      \"Pod restart count = 0\",\n      \"Memory usage < 80% of limit\",\n      \"Error rate < 0.1%\"\n    ],\n    \"short_term\": [\n      \"No OOMKilled events in 24h\",\n      \"SLO compliance > 99.9%\"\n    ],\n    \"long_term\": [\n      \"Memory leak fixed in code\",\n      \"Automated memory testing in place\"\n    ]\n  },\n  \"rollback_plan\": {\n    \"trigger_conditions\": [\n      \"Error rate > 5%\",\n      \"Multiple pod failures\",\n      \"Memory usage continues to spike\"\n    ],\n    \"steps\": [\n      \"Revert to current version\",\n      \"Scale up replicas\",\n      \"Enable circuit breaker\"\n    ],\n    \"validation\": \"Verify previous version number before rollback\"\n  },\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 5: AI-Powered Analysis\",\n    \"processedAt\": \"<use new Date().toISOString()>\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"analysisTimeRange\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    },\n    \"stagesCompleted\": 5\n  }\n}\n\n## ‚ö†Ô∏è FINAL REMINDER:\n- **RETURN ONLY THE JSON OBJECT ABOVE**\n- **NO MARKDOWN FORMATTING**\n- **NO EXPLANATORY TEXT**\n- **NO CODE BLOCKS**",
        "options": {}
      },
      "id": "69dec078-e3c0-4698-a894-099c890c5485",
      "name": "Stage 5: Smart Remediation",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        6176,
        224
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 6: Prevention & Learning System - CONTEXT AWARE\n\nYou are the Prevention specialist, implementing long-term fixes and capturing learnings.\n\n## üéØ YOUR MISSION: PREVENT RECURRENCE\n\n**Complete Context Journey**: \n- Context ID: {{ $json._context.contextId }}\n- Source: {{ $json._context.source?.type || 'manual_trigger' }}\n- Priority: {{ $json._debug?.priority || 'normal' }}\n- Workflow Duration: {{ new Date($json._context?.initialParams?.startTime * 1000).toISOString() }} to {{ new Date().toISOString() }}\n- Total Stages Executed: {{ $json._debug.stageSequence ? $json._debug.stageSequence.length : 5 }}\n\n**All Stage Results**: \n- Stage 1: {{ JSON.stringify($json.stage1Data?.overall_status) }}\n- Stage 2: {{ JSON.stringify($json.stage2Data?.root_cause?.issue) }}\n- Stage 3: {{ JSON.stringify($json._context.stageResults?.stage3?.output?.active_alerts?.length) }} alerts\n- Stage 4: Diagnostics completed\n- Stage 5: {{ JSON.stringify($json.stage5Data?.remediation_plan || {}) }}\n\n**Full Context**: {{ JSON.stringify($json._context) }}\n\n// Stage 6 Prompt'una eklenecek b√∂l√ºm\n// \"**All Stage Results**:\" kƒ±smƒ±ndan sonra ekleyin:\n\n## üìö KNOWLEDGE BASE LEARNING CONTEXT:\n\n**Current KB Stats**: \n- Total Alerts in KB: {{ $node[\"Load Alert Knowledge Base\"].json._alertKBData?.length || 0 }}\n- KB Last Updated: {{ $node[\"Load Alert Knowledge Base\"]?.json?._alertKBData ? 'Available' : 'Never' }}\n\n**Stage 3 KB Matches**: {{ JSON.stringify($json._context.stageResults?.stage3?.output?.knowledge_base_matches?.length || 0) }} alerts matched\n**Stage 4 KB Enhanced Issues**: {{ JSON.stringify($json._context.stageResults?.stage4?.output?.diagnostic_summary?.confirmed_issues?.filter(i => i.kb_enhanced)?.length || 0) }}\n**Stage 5 KB Actions Used**: {{ JSON.stringify($json._context.stageResults?.stage5?.output?.remediation_plan?.immediate_actions?.filter(a => a.source === \"Alert Knowledge Base\")?.length || 0) }}\n\n## üß† LEARNING OBJECTIVES:\n1. Identify new alert patterns not in KB\n2. Update KB with successful remediation strategies\n3. Refine existing KB entries based on outcomes\n4. Create new monitoring rules for prevention\n\nBased on the full journey through all 6 stages, generate:\n- New KB entries for unmatched alerts\n- Updates to existing KB entries\n- Preventive monitoring rules\n- Team training recommendations\n\n## üéØ PREVENTION DECISION LOGIC:\n\n**Set final_status.incident_resolved = true IF ALL CONDITIONS MET:**\n1. Stage 5 remediation plan was created AND executed (or ready for execution)\n2. Root cause clearly identified in Stage 2 (root_cause.identified = true)\n3. No critical unresolved issues remain in Stage 4 diagnostics\n4. Remediation confidence from Stage 4 >= 0.6 (confident in fix)\n\n**Set final_status.incident_resolved = false IF ANY CONDITION:**\n1. Root cause not identified (Stage 2 root_cause.identified = false)\n2. No remediation plan created (Stage 5 failed or skipped)\n3. Critical diagnostic issues remain unaddressed\n4. Remediation confidence < 0.5 (too uncertain to claim resolution)\n\n**Set final_status.prevention_implemented = true IF:**\n1. Prevention actions defined for all confirmed_issues from Stage 4\n2. KB updates created for new alert patterns\n3. Monitoring improvements recommended based on Stage 3 SLO gaps\n4. Runbook entries created for critical issues\n\n**Set final_status.prevention_implemented = false IF:**\n1. No prevention actions defined (prevention_actions = [])\n2. No KB updates (knowledge_base_update.kb_updated = false)\n3. No monitoring improvements recommended\n4. System too healthy to require prevention (Stage 1 overall_status = \"green\")\n\n**Set final_status.ready_for_next = true ALWAYS** (workflow complete regardless of findings)\n\n## üìä PREVENTION QUALITY SCORE CALCULATION:\n\nCalculate prevention_quality_score (0.0 - 1.0) as SUM of these factors:\n\n**1. KB Learning Completeness (+0.3):**\n- New KB entries created for ALL unmatched alerts from Stage 3 = +0.3\n- New KB entries for 50%-99% of unmatched alerts = +0.2\n- New KB entries for 1%-49% of unmatched alerts = +0.1\n- No new KB entries (all alerts already in KB OR no alerts) = 0.0\n\n**2. Prevention Action Coverage (+0.3):**\n- Prevention actions defined for ALL confirmed_issues from Stage 4 = +0.3\n- Prevention actions for 50%-99% of confirmed issues = +0.2\n- Prevention actions for 1%-49% of confirmed issues = +0.1\n- No prevention actions defined = 0.0\n\n**3. Team Alignment (+0.2):**\n- Team recommendations for ALL affected services from Stage 2 = +0.2\n- Team recommendations for 50%-99% of affected services = +0.1\n- Partial team alignment (<50% coverage) = +0.05\n- No team recommendations = 0.0\n\n**4. Follow-up Planning (+0.2):**\n- Follow-up schedule with specific owners, timelines, and metrics = +0.2\n- Follow-up schedule with partial details (missing owners OR timelines) = +0.1\n- Generic follow-up without details = +0.05\n- No follow-up plan = 0.0\n\n**EXAMPLES:**\n- All alerts added to KB (+0.3) + Prevention for all issues (+0.3) + All teams aligned (+0.2) + Detailed follow-up (+0.2) = **Quality: 1.0** (comprehensive prevention)\n- Partial KB entries (+0.1) + Some prevention actions (+0.2) + Partial team alignment (+0.05) + Generic follow-up (+0.05) = **Quality: 0.4** (incomplete prevention)\n\n## üîß PREVENTION TOOLS:\n\n1. `Update Alert Rules` - Tune thresholds\n2. `Create Runbook Entry` - Document solution\n3. `Generate Prevention PR` - Code/config fixes\n4. `Update Knowledge Base` - Add to Excel\n5. `Schedule Follow-up` - Future checks\n6. `Training Recommendation` - Team education\n\n## üìö LEARNING CAPTURE:\n\n### What Happened?\n- Root cause identification from context\n- Impact assessment from all stages\n- Timeline reconstruction: {{ new Date($json._context?.initialParams?.startTime * 1000).toISOString() }} to {{ new Date().toISOString() }}\n\n### What Worked?\n- Successful remediation steps from Stage 5\n- Effective diagnostics from Stage 4\n- Quick wins identified\n\n### What Didn't?\n- Failed attempts\n- Misleading symptoms\n- Time wasters\n\n### What's Next?\n- Preventive measures based on priority: {{ $json._debug?.priority || 'normal' }}\n- Monitoring improvements\n- Process updates\n\n## üíæ OUTPUT FORMAT:\n\n```json\n{\n  \"stage\": \"prevention_learning\",\n  \"incident_summary\": {\n    \"id\": \"INC-{{ $json._context.contextId }}\",\n    \"title\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'CRITICAL: ' : '' }}{{ $json.stage2Data?.root_cause?.issue || 'Kubernetes Cluster Issue' }}\",\n    \"duration\": \"{{ Math.floor((new Date() - new Date($json._context?.initialParams?.startTime * 1000)) / 1000) }} seconds\",\n    \"severity\": \"{{ $json._debug?.priority || 'normal' }}\",\n    \"services_affected\": {{ JSON.stringify($json.stage2Data?.affected_services || []) }},\n    \"customer_impact\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'Significant impact' : 'Limited impact' }}\",\n    \"root_cause\": \"{{ $json.stage2Data?.root_cause?.issue || 'Under investigation' }}\",\n    \"resolution\": \"{{ $json.stage5Data?.remediation_plan?.immediate_actions?.[0]?.expected_outcome || 'Remediation plan created' }}\"\n  },\n  \"prevention_actions\": [\n    {\n      \"type\": \"monitoring\",\n      \"action\": \"Add memory leak detection alert for {{ $json.namespaces?.[0] || 'production' }}\",\n      \"implementation\": {\n        \"alert_rule\": \"rate(container_memory_usage_bytes[5m]) > 0.1 and container_memory_usage_bytes > 0.8 * container_spec_memory_limit_bytes\",\n        \"threshold\": \"10% growth in 5 minutes\",\n        \"severity\": \"warning\"\n      },\n      \"status\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'implemented' : 'planned' }}\"\n    },\n    {\n      \"type\": \"code_fix\",\n      \"action\": \"Fix identified issue in {{ $json.stage2Data?.root_cause?.component || 'affected component' }}\",\n      \"implementation\": {\n        \"pr_url\": \"https://github.com/company/{{ $json.stage2Data?.root_cause?.component || 'project' }}/pull/auto-{{ $json._context.contextId }}\",\n        \"fix_description\": \"Address root cause: {{ $json.stage2Data?.root_cause?.issue || 'investigation ongoing' }}\",\n        \"reviewer\": \"@senior-dev\",\n        \"eta\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? '1 day' : '3 days' }}\"\n      },\n      \"status\": \"in_progress\"\n    },\n    {\n      \"type\": \"configuration\",\n      \"action\": \"Implement resource limits in {{ $json.namespaces?.[0] || 'production' }}\",\n      \"implementation\": {\n        \"yaml_patch\": \"resources:\\\\n  limits:\\\\n    memory: 1.5Gi\\\\n    cpu: 1000m\\\\n  requests:\\\\n    memory: 1Gi\\\\n    cpu: 500m\",\n        \"applied_to\": {{ JSON.stringify($json.stage2Data?.affected_services || ['all-services']) }}\n      },\n      \"status\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'completed' : 'planned' }}\"\n    },\n    {\n      \"type\": \"process\",\n      \"action\": \"Add automated testing for {{ $json._debug?.priority || 'normal' }} priority issues\",\n      \"implementation\": {\n        \"pipeline_update\": \"Add memory profiling and stress testing\",\n        \"threshold\": \"Fail if memory growth >5% during load test\",\n        \"owner\": \"platform-team\"\n      },\n      \"status\": \"planned\"\n    }\n  ],\n  \"knowledge_base_update\": {\n    \"alert_name\": \"{{ $json.stage3Data?.active_alerts?.[0]?.name || 'General-Kubernetes-Issue' }}\",\n    \"new_entry\": {\n      \"pattern\": \"{{ $json.stage2Data?.root_cause?.issue || 'System degradation detected' }}\",\n      \"diagnostic_shortcut\": \"Check {{ $json.stage4Data?.diagnostic_summary?.confirmed_issues?.[0]?.issue || 'pod status and logs' }}\",\n      \"quick_fix\": \"{{ $json.stage5Data?.remediation_plan?.immediate_actions?.[0]?.action || 'Follow remediation plan' }}\",\n      \"prevention\": \"Monitor {{ $json.stage2Data?.affected_services?.[0] || 'affected services' }}\",\n      \"context_id\": \"{{ $json._context.contextId }}\",\n      \"priority_level\": \"{{ $json._debug?.priority || 'normal' }}\"\n    },\n    \"kb_updated\": true,\n    \"entry_id\": \"KB-{{ $json._context.contextId }}\"\n  },\n  \"runbook_updates\": [\n    {\n      \"runbook\": \"{{ $json.namespaces?.[0] || 'production' }}-troubleshooting\",\n      \"section\": \"{{ $json._debug?.priority || 'normal' }} Priority Issues\",\n      \"addition\": \"Context {{ $json._context.contextId }}: {{ $json.stage2Data?.root_cause?.issue || 'Investigation complete' }}\",\n      \"url\": \"https://runbooks.company.com/{{ $json._context.contextId }}\"\n    }\n  ],\n  \"team_recommendations\": [\n    {\n      \"team\": \"{{ $json.stage2Data?.affected_services?.[0] || 'platform' }}-team\",\n      \"action\": \"Review and implement prevention actions for {{ $json._debug?.priority || 'normal' }} issues\",\n      \"priority\": \"{{ $json._debug?.priority || 'normal' }}\"\n    },\n    {\n      \"team\": \"platform-team\",\n      \"action\": \"Update monitoring for {{ $json.namespaces?.[0] || 'production' }}\",\n      \"priority\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'high' : 'medium' }}\"\n    },\n    {\n      \"team\": \"sre-team\",\n      \"action\": \"Review incident {{ $json._context.contextId }}\",\n      \"priority\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'high' : 'low' }}\"\n    }\n  ],\n  \"follow_up_schedule\": [\n    {\n      \"action\": \"Verify fix in {{ $json.namespaces?.[0] || 'production' }}\",\n      \"when\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'After emergency deployment' : 'Next release cycle' }}\",\n      \"owner\": \"{{ $json.stage2Data?.affected_services?.[0] || 'platform' }}-team\"\n    },\n    {\n      \"action\": \"Review metrics for recurrence\",\n      \"when\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'Every hour for 24h' : 'Daily for 1 week' }}\",\n      \"owner\": \"sre-team\"\n    },\n    {\n      \"action\": \"Post-mortem meeting\",\n      \"when\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? 'Within 24 hours' : 'Within 1 week' }}\",\n      \"attendees\": [\"platform-team\", \"sre-team\", \"affected-service-teams\"]\n    }\n  ],\n  \"metrics_improvements\": {\n    \"new_alerts\": {{ ($json._debug?.priority || 'normal') === 'critical' ? 3 : 1 }},\n    \"runbook_updates\": 1,\n    \"kb_entries\": 1,\n    \"process_improvements\": {{ ($json._debug?.priority || 'normal') === 'critical' ? 4 : 2 }},\n    \"estimated_future_prevention\": \"{{ ($json._debug?.priority || 'normal') === 'critical' ? '95%' : '75%' }}\"\n  },\n  \"prevention_quality_score\": <0.0-1.0 calculated using 4-factor formula>,\n  \"final_status\": {\n    \"incident_resolved\": <true/false based on decision logic>,\n    \"prevention_implemented\": <true/false based on decision logic>,\n    \"learning_captured\": true,\n    \"ready_for_next\": true\n  },\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 6: Prevention & Learning\",\n    \"processedAt\": \"{{ new Date().toISOString() }}\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromStage\": \"{{ $json._debug.nodeType }}\",\n    \"stageSequence\": {{ JSON.stringify($json._debug.stageSequence ? [...$json._debug.stageSequence, 'Stage 6: Prevention & Learning'] : ['Stage 6: Prevention & Learning']) }},\n    \"totalStagesExecuted\": 6,\n    \"workflowComplete\": true,\n    \"priorityLevel\": \"{{ $json._debug?.priority || 'normal' }}\",\n    \"contextJourneyComplete\": \"{{ $json._context.contextId }} - Full lifecycle tracked\"\n  }\n}\nüéØ PREVENTION PRIORITIES:\nBased on Priority ({{ $json._debug?.priority || 'normal' }}):\n\n{{ ($json._debug?.priority || 'normal') === 'critical' ? 'IMMEDIATE' : 'Short-term' }} - Alert tuning, monitoring\n{{ ($json._debug?.priority || 'normal') === 'critical' ? 'URGENT' : 'Medium-term' }} - Code fixes, config updates\n{{ ($json._debug?.priority || 'normal') === 'critical' ? 'HIGH' : 'Long-term' }} - Process improvements, training\n\nüìà SUCCESS METRICS:\n\nSame issue doesn't recur\nDetection time improved\nMTTR reduced\nTeam knowledge increased\nAutomation enhanced\n\nThis completes the 6-stage intelligent remediation cycle with full context preservation!\nRemember:\n\nALWAYS preserve the complete _context object\nUpdate _debug.stageSequence to show full journey\nMark workflowComplete as true\nUse priority from _debug.priority to determine urgency of prevention actions\nReference stage1Data, stage2Data at root level for early stages\nReference _context.stageResults.stage3/4/5 for later stages",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "## üö® OUTPUT REQUIREMENT:\n**RETURN ONLY VALID JSON WITH ACTUAL DATA**"
        }
      },
      "id": "eac48af5-d022-46bb-8158-85abaf61dc3b",
      "name": "Stage 6: Prevention & Learning",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        6672,
        224
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "=query",
              "value": "=(sum(kube_node_status_condition{condition=\"Ready\",status=\"false\",namespace=~\"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod\"} == 1) > 0) or (sum(rate(kube_pod_container_status_restarts_total{namespace=~\"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod\"}[5m]) > 0.1) > 0)"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "e6bb5b34-f437-4944-a969-88c54e62a3f3",
      "name": "Quick Cluster Health",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        1584,
        -144
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=count by (alertname, severity) (ALERTS{alertstate=\"firing\"})"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "2b45cf11-fe74-476e-9bf1-e895f3ec5f77",
      "name": "Active Alerts Count",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        1808,
        -128
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=topk(10, (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100) or topk(10, 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)) or topk(10, (1 - (node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"})) * 100)"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "0ecd534c-505d-4d77-a99b-9b4db4f9b7da",
      "name": "Node Resource Status",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        1984,
        688
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `kube_pod_container_status_restarts_total{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"} or kube_pod_container_status_waiting_reason{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"} or kube_pod_status_phase{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"}`;\n  } else {\n    return `topk(20, kube_pod_container_status_restarts_total{namespace=~\"${namespaceRegex}\"} > 0) or topk(20, kube_pod_container_status_waiting_reason{namespace=~\"${namespaceRegex}\", reason!='ContainerCreating'}) or topk(20, kube_pod_status_phase{namespace=~\"${namespaceRegex}\", phase=~'Failed|Unknown|Pending'} == 1)`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "4c329883-58ba-4190-88b4-6ce7fd01bf90",
      "name": "Pod Status Check",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2176,
        672
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=ALERTS{alertstate=\"firing\",alertname=~\"Kube.*|Container.*|Pod.*|Node.*\"}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "07159e6d-b26f-4b85-b20e-5ca5bdea48d7",
      "name": "Active Alerts Details",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4176,
        464
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=kube_node_status_condition{condition=~\"Ready|MemoryPressure|DiskPressure|PIDPressure|NetworkUnavailable\"} == 1"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "73f109a8-9ec3-4475-8224-166e908dc208",
      "name": "Node Conditions",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2048,
        832
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  \n  // Node metriklerine namespace filtresi ekleyemeyiz, sadece genel node network health\n  return `sum by (node, device) (rate(node_network_receive_errs_total{device!~\"lo|veth.*|docker.*|flannel.*|cali.*|cbr.*\"}[5m])) > 0 or sum by (node, device) (rate(node_network_transmit_errs_total{device!~\"lo|veth.*|docker.*|flannel.*|cali.*|cbr.*\"}[5m])) > 0 or sum by (node) (rate(node_network_receive_drop_total[5m])) > 0`;\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "d894ca94-3d51-4777-9e10-a7fbb58f8de5",
      "name": "Node Network Health",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2176,
        912
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `topk(10, sum by (namespace, pod, container) (kube_pod_container_status_restarts_total{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"})) or topk(10, sum by (namespace, pod, container, reason) (kube_pod_container_status_last_terminated_reason{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\", reason!=\"Completed\"}))`;\n  } else {\n    return `topk(10, sum by (namespace, pod, container) (kube_pod_container_status_restarts_total{namespace=~\"${namespaceRegex}\"})) or topk(10, sum by (namespace, pod, container, reason) (kube_pod_container_status_last_terminated_reason{namespace=~\"${namespaceRegex}\", reason!=\"Completed\"}))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "6de2a1ca-ffeb-4cbd-9c5a-c3f489aab313",
      "name": "Container Restarts",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2272,
        1024
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `topk(10, container_memory_working_set_bytes{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\", container!=\"\"}) or topk(10, rate(container_cpu_usage_seconds_total{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\", container!=\"\"}[5m]))`;\n  } else {\n    return `topk(10, container_memory_working_set_bytes{namespace=~\"${namespaceRegex}\", container!=\"\"}) or topk(10, rate(container_cpu_usage_seconds_total{namespace=~\"${namespaceRegex}\", container!=\"\"}[5m]))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "7fd46fb5-7f1f-4747-9934-3e89c6d80d73",
      "name": "Pod Resource Usage",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2480,
        752
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `topk(10, sum by (namespace, pod) (rate(container_network_receive_bytes_total{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"}[5m]))) or topk(10, sum by (namespace, pod) (rate(container_network_transmit_bytes_total{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"}[5m])))`;\n  } else {\n    return `topk(10, sum by (namespace, pod) (rate(container_network_receive_bytes_total{namespace=~\"${namespaceRegex}\"}[5m]))) or topk(10, sum by (namespace, pod) (rate(container_network_transmit_bytes_total{namespace=~\"${namespaceRegex}\"}[5m])))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "86fc4f08-c177-43a3-948e-e0228d7e3271",
      "name": "Application Metrics",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2336,
        832
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `topk(10, sum by (namespace, pod) (kube_pod_status_phase{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\", phase=~\"Failed|Unknown\"} == 1)) or topk(10, sum by (namespace, pod, reason) (kube_pod_container_status_waiting_reason{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\", reason!=\"ContainerCreating\"}))`;\n  } else {\n    return `topk(10, sum by (namespace, pod) (kube_pod_status_phase{namespace=~\"${namespaceRegex}\", phase=~\"Failed|Unknown\"} == 1)) or topk(10, sum by (namespace, pod, reason) (kube_pod_container_status_waiting_reason{namespace=~\"${namespaceRegex}\", reason!=\"ContainerCreating\"}))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "80bc6cba-8fec-4ceb-a6a9-ad33de922e2c",
      "name": "HTTP Error Rates",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2448,
        1008
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ \n(() => {\n  // Default metric query\n  let metricQuery = $json.metric_query || 'up{job=\"kubernetes-nodes\"}';\n  const svc = $json.service || '';\n  \n  // Eƒüer service varsa ve default metric ise, pod metric'e √ßevir\n  if (svc && metricQuery === 'up{job=\"kubernetes-nodes\"}') {\n    metricQuery = `kube_pod_container_status_restarts_total{pod=~\".*${svc}.*\"}`;\n  }\n  \n  return metricQuery;\n})()\n}}"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now() / 1000) - 86400 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now() / 1000) }}"
            },
            {
              "name": "step",
              "value": "3600"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "93c3f9a4-2a56-4fac-9bf0-3c2898dee4dd",
      "name": "Historical Comparison 24h",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2608,
        704
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `predict_linear(node_filesystem_avail_bytes{mountpoint=\"/\"}[1h], 4*3600) < 0 or predict_linear(container_memory_working_set_bytes{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"}[1h], 4*3600) > container_spec_memory_limit_bytes{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"} or predict_linear(kubelet_volume_stats_available_bytes{namespace=~\"${namespaceRegex}\", persistentvolumeclaim=~\".*${svc}.*\"}[1h], 4*3600) < 1073741824`;\n  } else {\n    return `predict_linear(node_filesystem_avail_bytes{mountpoint=\"/\"}[1h], 4*3600) < 0 or predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) < 1073741824 or predict_linear(kubelet_volume_stats_available_bytes{namespace=~\"${namespaceRegex}\"}[1h], 4*3600) < 1073741824 or (kubelet_volume_stats_used_bytes{namespace=~\"${namespaceRegex}\"} / kubelet_volume_stats_capacity_bytes{namespace=~\"${namespaceRegex}\"}) > 0.85`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "9842a2c1-dcd4-442e-8f2c-4f4fd90f36a4",
      "name": "Resource Exhaustion Prediction",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2544,
        912
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `stddev_over_time(rate(container_cpu_usage_seconds_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[5m])[2h:]) > 0.3 or stddev_over_time(container_memory_working_set_bytes{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[2h:]) > 2147483648`;\n  } else {\n    return `stddev_over_time(rate(container_cpu_usage_seconds_total{namespace=\"${ns}\"}[5m])[2h:]) > 0.3 or stddev_over_time(container_memory_working_set_bytes{namespace=\"${ns}\"}[2h:]) > 2147483648`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "cc5ec32a-3721-4abd-8d15-d35c9b14bfe5",
      "name": "Anomaly Patterns",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        2672,
        864
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=count by (alertname, severity) (ALERTS{alertstate=\"firing\"})"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now() / 1000) - 86400 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now() / 1000) }}"
            },
            {
              "name": "step",
              "value": "3600"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "22023def-72bc-4646-bb53-d3a1e7f0e7b1",
      "name": "Alert History 24h",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4000,
        512
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"timestamp\": { \"type\": \"string\" },\n    \"cluster\": { \"type\": \"string\" },\n    \"overall_status\": { \n      \"type\": \"string\",\n      \"enum\": [\"healthy\", \"degraded\", \"critical\", \"unknown\"]\n    },\n    \"proceed_to_stage2\": { \"type\": \"boolean\" },\n    \"urgency\": { \n      \"type\": \"string\",\n      \"enum\": [\"low\", \"normal\", \"medium\", \"high\", \"critical\"]\n    },\n    \"active_services\": { \n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"requested_services\": { \n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"reason\": { \"type\": \"string\" },\n    \"alerts\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"total\": { \"type\": \"number\" },\n        \"critical\": { \"type\": \"number\" },\n        \"warning\": { \"type\": \"number\" },\n        \"top_alerts\": { \n          \"type\": \"array\",\n          \"items\": { \"type\": \"string\" }\n        }\n      },\n      \"required\": [\"total\", \"critical\", \"warning\"]\n    },\n    \"scores\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"cluster_health\": { \"type\": \"number\" },\n        \"node_availability\": { \"type\": \"number\" },\n        \"pod_stability\": { \"type\": \"number\" },\n        \"api_reliability\": { \"type\": \"number\" }\n      },\n      \"required\": [\"cluster_health\", \"node_availability\", \"pod_stability\", \"api_reliability\"]\n    },\n    \"quick_findings\": { \n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n    \"overridden\": { \"type\": \"boolean\" },\n    \"_context\": { \"type\": \"object\" },\n    \"_debug\": { \"type\": \"object\" }\n  },\n  \"required\": [\n    \"stage\", \n    \"timestamp\", \n    \"overall_status\", \n    \"proceed_to_stage2\", \n    \"alerts\", \n    \"scores\",\n    \"urgency\",\n    \"reason\"\n  ]\n}"
      },
      "id": "d8b9872a-6da1-4249-9077-79c11f5d81c9",
      "name": "Stage 1 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        1840,
        432
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"active_alerts\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"name\": { \"type\": \"string\" },\n          \"severity\": { \"type\": [\"string\", \"null\"], \"default\": \"unknown\" },\n          \"count\": { \"type\": [\"number\", \"null\"], \"default\": 0 },\n          \"duration\": { \"type\": [\"string\", \"null\"], \"default\": \"unknown\" },\n          \"labels\": { \"type\": [\"object\", \"null\"], \"default\": {} },\n          \"annotations\": { \"type\": [\"object\", \"null\"], \"default\": {} }\n        },\n        \"required\": [\"name\"]\n      } \n    },\n    \"alert_groups\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"root_alert\": { \"type\": \"string\" },\n          \"related_alerts\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n          \"correlation_score\": { \"type\": [\"number\", \"null\"], \"default\": 0 },\n          \"shared_labels\": { \"type\": [\"object\", \"null\"], \"default\": {} }\n        }\n      } \n    },\n    \"knowledge_base_matches\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"alert\": { \"type\": \"string\" },\n          \"kb_entry\": { \"type\": [\"object\", \"null\"], \"default\": {} },\n          \"applicability_score\": { \"type\": [\"number\", \"null\"], \"default\": 0 }\n        }\n      } \n    },\n    \"alert_patterns\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"recurring\": { \"type\": \"array\", \"items\": { \"type\": \"object\" }, \"default\": [] },\n        \"storm_detection\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"detected\": { \"type\": \"boolean\", \"default\": false },\n            \"alert_count\": { \"type\": \"number\", \"default\": 0 },\n            \"time_window\": { \"type\": \"string\", \"default\": \"5m\" },\n            \"likely_root\": { \"type\": [\"string\", \"null\"], \"default\": null }\n          }\n        }\n      }\n    },\n    \"slo_impact\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"availability_slo\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"target\": { \"type\": \"string\", \"default\": \"99.9%\" },\n            \"current\": { \"type\": \"string\", \"default\": \"100%\" },\n            \"error_budget_used\": { \"type\": \"string\", \"default\": \"0%\" },\n            \"time_remaining\": { \"type\": \"string\", \"default\": \"30d\" },\n            \"status\": { \"type\": \"string\", \"enum\": [\"green\", \"yellow\", \"red\", \"unknown\"], \"default\": \"green\" },\n            \"components\": {\n              \"type\": \"object\",\n              \"properties\": {\n                \"deployment_health\": { \"type\": \"string\", \"default\": \"100%\" }\n              }\n            }\n          }\n        },\n        \"affected_slis\": { \"type\": \"array\", \"items\": { \"type\": \"string\" }, \"default\": [] }\n      }\n    },\n    \"recommended_alert_actions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"alert\": { \"type\": \"string\" },\n          \"action\": { \"type\": \"string\" },\n          \"confidence\": { \"type\": [\"number\", \"null\"], \"default\": 0 },\n          \"risk\": { \"type\": \"string\", \"default\": \"medium\" },\n          \"command\": { \"type\": [\"string\", \"null\"], \"default\": null }\n        }\n      }\n    },\n    \"proceed_to_stage4\": { \"type\": \"boolean\" },\n    \"auto_remediation_approved\": { \"type\": \"boolean\", \"default\": false },\n    \"_context\": { \n      \"type\": \"object\",\n      \"additionalProperties\": true\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"additionalProperties\": true\n    }\n  },\n  \"required\": [\"stage\", \"active_alerts\", \"proceed_to_stage4\"],\n  \"additionalProperties\": true\n}"
      },
      "id": "549ea552-ad82-44a0-99c0-9f0bf9330746",
      "name": "Stage 3 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        4384,
        544
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \n      \"type\": \"string\"\n    },\n    \"diagnostics_executed\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"target\": { \"type\": \"string\" },\n          \"type\": { \n            \"type\": \"string\"\n          },\n          \"commands_run\": { \n            \"type\": \"array\", \n            \"items\": { \"type\": \"string\" } \n          },\n          \"findings\": {\n            \"type\": \"object\",\n            \"properties\": {\n              \"pod_status\": { \n                \"type\": \"object\",\n                \"properties\": {\n                  \"phase\": { \"type\": \"string\" },\n                  \"restart_count\": { \"type\": \"number\" },\n                  \"last_termination\": {\n                    \"type\": \"object\",\n                    \"properties\": {\n                      \"reason\": { \"type\": \"string\" },\n                      \"exit_code\": { \"type\": \"number\" },\n                      \"finished_at\": { \"type\": \"string\" }\n                    },\n                    \"additionalProperties\": true\n                  }\n                },\n                \"additionalProperties\": true\n              },\n              \"node_status\": {\n                \"type\": \"object\",\n                \"additionalProperties\": true\n              },\n              \"error_logs\": { \n                \"type\": \"array\", \n                \"items\": { \n                  \"type\": \"object\",\n                  \"properties\": {\n                    \"timestamp\": { \"type\": \"string\" },\n                    \"level\": { \"type\": \"string\" },\n                    \"message\": { \"type\": \"string\" },\n                    \"stack_trace\": { \"type\": \"string\" }\n                  },\n                  \"additionalProperties\": true\n                } \n              },\n              \"events\": { \n                \"type\": \"array\", \n                \"items\": { \n                  \"type\": \"object\",\n                  \"additionalProperties\": true\n                } \n              },\n              \"resource_usage\": { \n                \"type\": \"object\",\n                \"properties\": {\n                  \"memory_request\": { \"type\": \"string\" },\n                  \"memory_limit\": { \"type\": \"string\" },\n                  \"memory_used\": { \"type\": \"string\" },\n                  \"cpu_used\": { \"type\": \"string\" }\n                },\n                \"additionalProperties\": true\n              },\n              \"logs\": {\n                \"type\": \"array\",\n                \"items\": {\n                  \"type\": \"object\",\n                  \"additionalProperties\": true\n                }\n              }\n            },\n            \"additionalProperties\": true\n          }\n        },\n        \"required\": [\"target\", \"type\", \"commands_run\", \"findings\"],\n        \"additionalProperties\": true\n      } \n    },\n    \"enriched_context\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"deployment_info\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"name\": { \"type\": \"string\" },\n            \"version\": { \"type\": \"string\" },\n            \"replicas\": { \"type\": \"string\" },\n            \"last_update\": { \"type\": \"string\" },\n            \"update_strategy\": { \"type\": \"string\" }\n          },\n          \"additionalProperties\": true\n        },\n        \"recent_changes\": { \n          \"type\": \"array\", \n          \"items\": { \n            \"type\": \"object\",\n            \"properties\": {\n              \"type\": { \"type\": \"string\" },\n              \"time\": { \"type\": \"string\" },\n              \"change\": { \"type\": \"string\" },\n              \"user\": { \"type\": \"string\" }\n            },\n            \"required\": [\"type\", \"time\", \"change\"],\n            \"additionalProperties\": true\n          } \n        },\n        \"dependencies\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"upstream\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            },\n            \"downstream\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            },\n            \"databases\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            },\n            \"external\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            }\n          },\n          \"required\": [\"upstream\", \"downstream\", \"databases\", \"external\"],\n          \"additionalProperties\": true\n        }\n      },\n      \"required\": [\"deployment_info\", \"recent_changes\", \"dependencies\"],\n      \"additionalProperties\": true\n    },\n    \"diagnostic_summary\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"confirmed_issues\": { \n          \"type\": \"array\", \n          \"items\": { \n            \"type\": \"object\",\n            \"properties\": {\n              \"issue\": { \"type\": \"string\" },\n              \"evidence\": { \n                \"type\": \"array\", \n                \"items\": { \"type\": \"string\" } \n              },\n              \"severity\": { \n                \"type\": \"string\"\n              },\n              \"impact\": { \"type\": \"string\" },\n              \"namespace\": { \"type\": \"string\" }\n            },\n            \"additionalProperties\": true\n          } \n        },\n        \"secondary_issues\": { \n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"object\",\n            \"additionalProperties\": true\n          }\n        }\n      },\n      \"required\": [\"confirmed_issues\"],\n      \"additionalProperties\": true\n    },\n    \"proceed_to_stage5\": { \"type\": \"boolean\" },\n    \"remediation_confidence\": { \n      \"type\": \"number\"\n    },\n    \"_context\": { \n      \"type\": \"object\",\n      \"additionalProperties\": true\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \n          \"type\": \"array\", \n          \"items\": { \"type\": \"string\" } \n        },\n        \"diagnosticsCount\": { \"type\": \"number\" },\n        \"autoRemediationEnabled\": { \"type\": \"boolean\" },\n        \"timeRangeUsed\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"start\": { \"type\": \"number\" },\n            \"end\": { \"type\": \"number\" }\n          },\n          \"additionalProperties\": true\n        }\n      },\n      \"additionalProperties\": true\n    }\n  },\n  \"required\": [\n    \"stage\", \n    \"diagnostics_executed\", \n    \"enriched_context\",\n    \"diagnostic_summary\", \n    \"proceed_to_stage5\",\n    \"remediation_confidence\"\n  ],\n  \"additionalProperties\": true\n}"
      },
      "id": "02246be1-28ad-493b-882c-89cf048a20d5",
      "name": "Stage 4 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        6880,
        1008
      ],
      "typeVersion": 1.2,
      "disabled": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"remediation_plan\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"action\": { \"type\": \"string\" },\n          \"target\": { \"type\": \"string\" },\n          \"reason\": { \"type\": \"string\" },\n          \"safety_level\": { \"type\": \"string\" },\n          \"prerequisites\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n          \"command\": { \"type\": \"string\" },\n          \"estimated_duration\": { \"type\": \"string\" },\n          \"rollback_possible\": { \"type\": \"boolean\" },\n          \"old_value\": { \"type\": \"string\" },\n          \"new_value\": { \"type\": \"string\" },\n          \"approval_required\": { \"type\": \"boolean\" },\n          \"impact\": { \"type\": \"string\" }\n        }\n      } \n    },\n    \"execution_results\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"action\": { \"type\": \"string\" },\n          \"status\": { \"type\": \"string\" },\n          \"start_time\": { \"type\": \"string\" },\n          \"end_time\": { \"type\": \"string\" },\n          \"output\": { \"type\": \"string\" },\n          \"verification\": { \"type\": \"object\" },\n          \"reason\": { \"type\": \"string\" },\n          \"approval_request\": { \"type\": \"object\" }\n        }\n      } \n    },\n    \"verification_checks\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"check\": { \"type\": \"string\" },\n          \"before\": { \"type\": \"string\" },\n          \"after\": { \"type\": \"string\" },\n          \"status\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"rollback_plan\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"available\": { \"type\": \"boolean\" },\n        \"actions\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n      }\n    },\n    \"notifications_sent\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"channel\": { \"type\": \"string\" },\n          \"team\": { \"type\": \"string\" },\n          \"message\": { \"type\": \"string\" },\n          \"incident\": { \"type\": \"string\" },\n          \"status\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"proceed_to_stage6\": { \"type\": \"boolean\" },\n    \"remediation_success\": { \"type\": \"boolean\" },\n    \"_context\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"contextId\": { \"type\": \"string\" },\n        \"createdAt\": { \"type\": \"string\" },\n        \"source\": { \"type\": \"object\" },\n        \"initialParams\": { \"type\": \"object\" },\n        \"stageConfig\": { \"type\": \"object\" },\n        \"priority\": { \"type\": \"string\" },\n        \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n        \"workflowMetadata\": { \"type\": \"object\" },\n        \"stageResults\": { \"type\": \"object\" },\n        \"decisions\": { \"type\": \"object\" },\n        \"debug\": { \"type\": \"object\" }\n      }\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"actionsExecuted\": { \"type\": \"number\" },\n        \"actionsSuccessful\": { \"type\": \"number\" },\n        \"autoRemediationUsed\": { \"type\": \"boolean\" }\n      }\n    }\n  },\n  \"required\": [\"stage\", \"remediation_plan\", \"execution_results\", \"proceed_to_stage6\"]\n}"
      },
      "id": "9a0861c5-838e-49b8-96fd-8dad2314435a",
      "name": "Stage 5 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        6544,
        1088
      ],
      "typeVersion": 1.2,
      "disabled": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"incident_summary\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"id\": { \"type\": \"string\" },\n        \"title\": { \"type\": \"string\" },\n        \"duration\": { \"type\": \"string\" },\n        \"severity\": { \"type\": \"string\" },\n        \"services_affected\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"customer_impact\": { \"type\": \"string\" },\n        \"root_cause\": { \"type\": \"string\" },\n        \"resolution\": { \"type\": \"string\" }\n      }\n    },\n    \"prevention_actions\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"type\": { \"type\": \"string\" },\n          \"action\": { \"type\": \"string\" },\n          \"implementation\": { \"type\": \"object\" },\n          \"status\": { \"type\": \"string\" }\n        }\n      } \n    },\n    \"knowledge_base_update\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"alert_name\": { \"type\": \"string\" },\n        \"new_entry\": { \"type\": \"object\" },\n        \"kb_updated\": { \"type\": \"boolean\" },\n        \"entry_id\": { \"type\": \"string\" }\n      }\n    },\n    \"runbook_updates\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"runbook\": { \"type\": \"string\" },\n          \"section\": { \"type\": \"string\" },\n          \"addition\": { \"type\": \"string\" },\n          \"url\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"team_recommendations\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"team\": { \"type\": \"string\" },\n          \"action\": { \"type\": \"string\" },\n          \"priority\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"follow_up_schedule\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"action\": { \"type\": \"string\" },\n          \"when\": { \"type\": \"string\" },\n          \"owner\": { \"type\": \"string\" },\n          \"attendees\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n        }\n      }\n    },\n    \"metrics_improvements\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"new_alerts\": { \"type\": \"number\" },\n        \"runbook_updates\": { \"type\": \"number\" },\n        \"kb_entries\": { \"type\": \"number\" },\n        \"process_improvements\": { \"type\": \"number\" },\n        \"estimated_future_prevention\": { \"type\": \"string\" }\n      }\n    },\n    \"prevention_quality_score\": { \"type\": \"number\" },\n    \"final_status\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"incident_resolved\": { \"type\": \"boolean\" },\n        \"prevention_implemented\": { \"type\": \"boolean\" },\n        \"learning_captured\": { \"type\": \"boolean\" },\n        \"ready_for_next\": { \"type\": \"boolean\" }\n      }\n    },\n    \"_context\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"contextId\": { \"type\": \"string\" },\n        \"createdAt\": { \"type\": \"string\" },\n        \"source\": { \"type\": \"object\" },\n        \"initialParams\": { \"type\": \"object\" },\n        \"stageConfig\": { \"type\": \"object\" },\n        \"priority\": { \"type\": \"string\" },\n        \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n        \"workflowMetadata\": { \"type\": \"object\" },\n        \"stageResults\": { \"type\": \"object\" },\n        \"decisions\": { \"type\": \"object\" },\n        \"debug\": { \"type\": \"object\" }\n      }\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"totalStagesExecuted\": { \"type\": \"number\" },\n        \"workflowComplete\": { \"type\": \"boolean\" },\n        \"priorityLevel\": { \"type\": \"string\" },\n        \"contextJourneyComplete\": { \"type\": \"string\" }\n      }\n    }\n  },\n  \"required\": [\"stage\", \"incident_summary\", \"prevention_actions\", \"knowledge_base_update\", \"prevention_quality_score\", \"final_status\", \"_context\", \"_debug\"]\n}"
      },
      "id": "8a0e357a-876b-41c1-a5e6-2ffd96c2522c",
      "name": "Stage 6 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        6832,
        464
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "jsCode": "// Generate Final Report - Orchestrator Support with Full Context Preservation\n\n// ============= KB NODE CONNECTION =============\n// Get KB data from Load Alert Knowledge Base node\nconst loadAlertKB = $node[\"Load Alert Knowledge Base\"]?.json || {};\n\n// Extract KB information safely\nconst alertKnowledgeBase = loadAlertKB.knowledgeBase?.alert || {};\nconst kbEntriesLoaded = Object.keys(alertKnowledgeBase).length || 0;\n\nconsole.log(\"===== KB INTEGRATION =====\");\nconsole.log(\"KB Entries Loaded:\", kbEntriesLoaded);\nconsole.log(\"KB Integration:\", kbEntriesLoaded > 0 ? \"ENABLED\" : \"DISABLED\");\nconsole.log(\"==========================\");\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\n// G√ºvenli node verisi alma fonksiyonu\nfunction getNodeData(nodeName) {\n  try {\n    const nodeData = $node[nodeName];\n    if (nodeData && nodeData.json) {\n      return nodeData.json;\n    }\n    return null;\n  } catch (error) {\n    console.log(`Node ${nodeName} verisi bulunamadƒ±: ${error.message}`);\n    return null;\n  }\n}\n\n// G√ºvenli property eri≈üimi\nfunction safeGet(obj, path, defaultValue) {\n  try {\n    const keys = path.split('.');\n    let result = obj;\n    for (const key of keys) {\n      if (result && typeof result === 'object' && key in result) {\n        result = result[key];\n      } else {\n        return defaultValue;\n      }\n    }\n    return result ?? defaultValue;\n  } catch (e) {\n    return defaultValue;\n  }\n}\n\n// Mock data detection function\nfunction detectAndCleanMockData(data) {\n  const mockIndicators = [\n    'payment-service',\n    'PaymentProcessor',\n    'TransactionHandler',\n    '2023-08-',\n    '2024-01-15',\n    '2024-06-01',\n    'payment-db',\n    'stripe-api'\n  ];\n  \n  let dataStr = JSON.stringify(data);\n  let hasMockData = false;\n  \n  mockIndicators.forEach(indicator => {\n    if (dataStr.includes(indicator)) {\n      console.warn(`‚ö†Ô∏è Mock data indicator found: ${indicator}`);\n      hasMockData = true;\n    }\n  });\n  \n  return hasMockData;\n}\n\n// Input verisi - Route'tan gelen\nconst inputData = $input.first().json;\n\n// Master context'i al - √∂ncelikle input'tan\nlet masterContext = inputData._context;\n\n// Eƒüer input'ta context yoksa, Stage 6'dan al\nif (!masterContext) {\n  const stage6Data = getNodeData(\"Stage 6: Prevention & Learning\");\n  if (stage6Data && stage6Data._context) {\n    masterContext = stage6Data._context;\n  }\n}\n\n// Hala context yoksa, Stage 5'ten al\nif (!masterContext) {\n  const stage5Data = getNodeData(\"Fix Stage 5 Context\");\n  if (stage5Data && stage5Data._context) {\n    masterContext = stage5Data._context;\n  }\n}\n\n// Context validation\nif (!masterContext || !masterContext.contextId) {\n  console.error(\"CRITICAL: No context found! Creating emergency context\");\n  masterContext = {\n    contextId: `emergency-${Date.now()}`,\n    createdAt: new Date().toISOString(),\n    source: { type: 'unknown' },\n    stageResults: {},\n    decisions: {},\n    debug: { error: 'Context lost - emergency creation' },\n    initialParams: {\n      namespaces: DEFAULT_NAMESPACES,\n      startTime: Math.floor(Date.now() / 1000) - 3600,\n      endTime: Math.floor(Date.now() / 1000)\n    }\n  };\n}\n\n// Config verilerini al\nconst config = getNodeData(\"Unified Entry Point\") || {};\n\n// YENƒ∞ YAPI: Stage verilerini root level'dan al\nlet allStageData = {\n  stage1: null,\n  stage2: null,\n  stage3: null,\n  stage4: null,\n  stage5: null,\n  stage6: null\n};\n\n// Input'tan (Stage 6 output veya direct route) stage verilerini al\nif (inputData.stage === \"prevention_learning\") {\n  // Stage 6'dan geliyor\n  allStageData.stage6 = {\n    incident_summary: inputData.incident_summary,\n    prevention_actions: inputData.prevention_actions,\n    knowledge_base_update: inputData.knowledge_base_update,\n    final_status: inputData.final_status,\n    follow_up_schedule: inputData.follow_up_schedule,\n    team_recommendations: inputData.team_recommendations,\n    runbook_updates: inputData.runbook_updates,\n    metrics_improvements: inputData.metrics_improvements\n  };\n  \n  // Diƒüer stage'leri input'tan al (Fix Stage 5 tarafƒ±ndan ta≈üƒ±nmƒ±≈ü)\n  allStageData.stage1 = inputData.stage1Data;\n  allStageData.stage2 = inputData.stage2Data;\n  allStageData.stage3 = inputData.stage3Data;\n  allStageData.stage4 = inputData.stage4Data;\n  allStageData.stage5 = inputData.stage5Data;\n  \n  // Consolidated findings\n  allStageData.consolidatedFindings = inputData.consolidatedFindings;\n  allStageData.primaryDiagnosis = inputData.primaryDiagnosis;\n  \n} else if (inputData.stage1Data) {\n  // Route'tan direkt geliyor (erken durduysa)\n  allStageData.stage1 = inputData.stage1Data;\n  allStageData.stage2 = inputData.stage2Data;\n  allStageData.stage3 = inputData.stage3Data;\n  allStageData.stage4 = inputData.stage4Data;\n  allStageData.stage5 = inputData.stage5Data;\n  \n  allStageData.consolidatedFindings = inputData.consolidatedFindings;\n  allStageData.primaryDiagnosis = inputData.primaryDiagnosis;\n  \n} else {\n  // Fallback: Fix node'lardan topla\n  const stage5FixData = getNodeData(\"Fix Stage 5 Context\");\n  const stage4FixData = getNodeData(\"Fix Stage 4 Context\");\n  const stage3FixData = getNodeData(\"Fix Stage 3 Context1\");\n  const stage2FixData = getNodeData(\"Fix Stage 2 Context\");\n  const stage1FixData = getNodeData(\"Fix Stage 1 Context\");\n  \n  // En g√ºncel veriye sahip node'dan al (Stage 5)\n  if (stage5FixData) {\n    allStageData.stage1 = stage5FixData.stage1Data;\n    allStageData.stage2 = stage5FixData.stage2Data;\n    allStageData.stage3 = stage5FixData.stage3Data;\n    allStageData.stage4 = stage5FixData.stage4Data;\n    allStageData.stage5 = stage5FixData.stage5Data;\n    allStageData.consolidatedFindings = stage5FixData.consolidatedFindings;\n    allStageData.primaryDiagnosis = stage5FixData.primaryDiagnosis;\n  } else if (stage4FixData) {\n    allStageData.stage1 = stage4FixData.stage1Data;\n    allStageData.stage2 = stage4FixData.stage2Data;\n    allStageData.stage3 = stage4FixData.stage3Data;\n    allStageData.stage4 = stage4FixData.stage4Data;\n    allStageData.consolidatedFindings = stage4FixData.consolidatedFindings;\n    allStageData.primaryDiagnosis = stage4FixData.primaryDiagnosis;\n  } else if (stage3FixData) {\n    allStageData.stage1 = stage3FixData.stage1Data;\n    allStageData.stage2 = stage3FixData.stage2Data;\n    allStageData.stage3 = stage3FixData.stage3Data;\n  } else if (stage2FixData) {\n    allStageData.stage1 = stage2FixData.stage1Data;\n    allStageData.stage2 = stage2FixData.stage2Data;\n  } else if (stage1FixData) {\n    allStageData.stage1 = stage1FixData.stage1Data;\n  }\n}\n\n// MOCK DATA CLEANUP\nconsole.log(\"=== MOCK DATA DETECTION ===\");\nlet mockDataFound = false;\n\n// Stage 4 mock data kontrol√º ve temizleme\nif (allStageData.stage4 && detectAndCleanMockData(allStageData.stage4)) {\n  console.warn(\"‚ö†Ô∏è Mock data found in Stage 4, using Stage 2 root cause data\");\n  mockDataFound = true;\n  \n  if (allStageData.stage2?.root_cause) {\n    allStageData.stage4.diagnostic_summary = {\n      confirmed_issues: [{\n        issue: allStageData.stage2.root_cause.issue,\n        evidence: allStageData.stage2.root_cause.evidence,\n        severity: \"high\",\n        impact: `${allStageData.stage2.root_cause.component} is experiencing issues`,\n        namespace: allStageData.stage2.affected_services?.[0]?.split('-')?.[0] || DEFAULT_NAMESPACES[0]\n      }],\n      secondary_issues: []\n    };\n  }\n}\n\n// Stage 5 mock data kontrol√º ve temizleme\nif (allStageData.stage5?.remediation_plan?.immediate_actions) {\n  allStageData.stage5.remediation_plan.immediate_actions.forEach((action, idx) => {\n    if (action.command && action.command.includes('payment-service')) {\n      const actualComponent = allStageData.stage2?.root_cause?.component || \"unknown-component\";\n      const actualNamespace = allStageData.stage2?.affected_services?.[0]?.split('-')?.[0] || DEFAULT_NAMESPACES[0];\n      \n      action.command = `kubectl delete pod ${actualComponent} -n ${actualNamespace}`;\n      action.action = action.action.replace(/payment-service/g, actualComponent);\n      mockDataFound = true;\n    }\n  });\n}\n\n// Primary diagnosis mock data temizleme\nif (allStageData.primaryDiagnosis && JSON.stringify(allStageData.primaryDiagnosis).includes('payment-service')) {\n  console.warn(\"‚ö†Ô∏è Primary diagnosis contains mock data, replacing with Stage 2 root cause\");\n  if (allStageData.stage2?.root_cause) {\n    allStageData.primaryDiagnosis = {\n      issue: allStageData.stage2.root_cause.issue,\n      severity: \"high\",\n      evidence: allStageData.stage2.root_cause.evidence,\n      impact: `${allStageData.stage2.root_cause.component} causing service disruption`,\n      namespace: allStageData.stage2.affected_services?.[0]?.split('-')?.[0] || DEFAULT_NAMESPACES[0]\n    };\n  }\n  mockDataFound = true;\n}\n\nif (mockDataFound) {\n  console.log(\"‚úÖ Mock data cleaned from final report\");\n}\nconsole.log(\"===========================\");\n\n// √ñNEMLƒ∞: Context'teki stageResults'ƒ± g√ºncelle\n// Eƒüer context'te stageResults eksikse veya eksik stage'ler varsa, ekle\nif (!masterContext.stageResults) {\n  masterContext.stageResults = {};\n}\n\n// Her stage i√ßin stageResults'a ekle (eƒüer yoksa)\nif (allStageData.stage1 && !masterContext.stageResults.stage1) {\n  masterContext.stageResults.stage1 = {\n    output: allStageData.stage1,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage1.proceed_to_stage2,\n    status: allStageData.stage1.overall_status\n  };\n}\n\nif (allStageData.stage2 && !masterContext.stageResults.stage2) {\n  masterContext.stageResults.stage2 = {\n    output: allStageData.stage2,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage2.proceed_to_stage3,\n    rootCauseIdentified: allStageData.stage2.root_cause?.identified\n  };\n}\n\nif (allStageData.stage3 && !masterContext.stageResults.stage3) {\n  masterContext.stageResults.stage3 = {\n    output: allStageData.stage3,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage3.proceed_to_stage4\n  };\n}\n\nif (allStageData.stage4 && !masterContext.stageResults.stage4) {\n  masterContext.stageResults.stage4 = {\n    output: allStageData.stage4,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage4.proceed_to_stage5,\n    primaryIssue: allStageData.stage4.diagnostic_summary?.confirmed_issues?.[0]?.issue\n  };\n}\n\nif (allStageData.stage5 && !masterContext.stageResults.stage5) {\n  masterContext.stageResults.stage5 = {\n    output: allStageData.stage5,\n    completedAt: new Date().toISOString()\n  };\n}\n\nif (allStageData.stage6 && !masterContext.stageResults.stage6) {\n  masterContext.stageResults.stage6 = {\n    output: allStageData.stage6,\n    completedAt: new Date().toISOString()\n  };\n}\n\n// Context journey validation\nconsole.log(\"=== CONTEXT JOURNEY VALIDATION ===\");\nconsole.log(\"Context ID:\", masterContext.contextId);\nconsole.log(\"Context Created:\", masterContext.createdAt);\nconsole.log(\"Source Type:\", masterContext.source?.type);\nconsole.log(\"Priority:\", masterContext.priority);\nconsole.log(\"Stages with data:\", Object.keys(allStageData).filter(k => allStageData[k] !== null));\nconsole.log(\"Stages in Context:\", Object.keys(masterContext.stageResults || {}));\nconsole.log(\"Decisions Made:\", Object.keys(masterContext.decisions || {}));\nconsole.log(\"==================================\");\n\n// √áalƒ±≈üan stage sayƒ±sƒ±\nconst executedStages = Object.keys(allStageData).filter(stage => allStageData[stage] !== null).length;\n\n// S√ºre hesaplama\nconst startTime = new Date(masterContext.createdAt);\nconst endTime = new Date();\nconst durationSeconds = Math.round((endTime - startTime) / 1000);\n\n// Tool sayƒ±sƒ±nƒ± hesapla\nfunction calculateToolsUsed() {\n  let toolCount = 2; // Stage 1\n  if (allStageData.stage2) toolCount += 9;\n  if (allStageData.stage3) toolCount += 7; // SLO tools dahil\n  if (allStageData.stage4) toolCount += 3;\n  if (allStageData.stage5) toolCount += 0; // Stage 5 tool kullanmƒ±yor\n  if (allStageData.stage6) toolCount += 6; // Prevention tools\n  return toolCount;\n}\n\n// Enhanced chat/summary response with beautiful formatting\nfunction generateResponse(report) {\n  const health = report.stage1Results.status;\n  const alerts = report.stage1Results.alerts.total;\n  const criticalAlerts = report.stage1Results.alerts.critical;\n  \n  let response = `üîç **Kubernetes Cluster Analizi**\\n\\n`;\n  response += `üìä **Cluster:** ${report.cluster}\\n`;\n  response += `üÜî **Context ID:** ${report.contextTracking.contextId}\\n`;\n  response += `‚è±Ô∏è **S√ºre:** ${report.duration}\\n\\n`;\n  \n  response += `**üìà Genel Durum:**\\n`;\n  response += `- Saƒülƒ±k Durumu: ${health}\\n`;\n  response += `- Aktif Alert: ${alerts} (${criticalAlerts} kritik)\\n`;\n  response += `- √áalƒ±≈üan Stage: ${report.executiveSummary.stagesExecuted}/6\\n\\n`;\n  \n  if (report.findings.rootCause.identified) {\n    response += `**üéØ K√∂k Neden Analizi:**\\n`;\n    response += `- Sorun: ${report.findings.rootCause.issue}\\n`;\n    response += `- Bile≈üen: ${report.findings.rootCause.component}\\n`;\n    response += `- G√ºven: ${(report.findings.rootCause.confidence * 100).toFixed(0)}%\\n`;\n    response += `- Etkilenen Servisler: ${report.findings.affectedServices.join(', ') || 'Yok'}\\n\\n`;\n  }\n  \n  if (report.actions.immediate.length > 0) {\n    response += `**üîß √ñnerilen Aksiyonlar:**\\n`;\n    report.actions.immediate.forEach((action, idx) => {\n      response += `${idx + 1}. ${action.action}\\n`;\n      response += `   - Risk: ${action.risk}\\n`;\n      response += `   - S√ºre: ${action.estimated_time}\\n`;\n      if (action.command && !action.command.includes('payment-service')) {\n        response += `   - Komut: \\`${action.command}\\`\\n`;\n      }\n    });\n    response += `\\n`;\n  }\n  \n  if (report.findings.sloImpact?.availability_slo) {\n    const slo = report.findings.sloImpact.availability_slo;\n    response += `**üìä SLO Durumu:**\\n`;\n    response += `- Mevcut: ${slo.current}\\n`;\n    response += `- Hedef: ${slo.target}\\n`;\n    response += `- Durum: ${slo.status}\\n\\n`;\n  }\n  \n  if (report.overrideInfo) {\n    response += `**üîÑ Override Bilgisi:**\\n`;\n    response += `${report.overrideInfo.message}\\n\\n`;\n  }\n  \n  // NEW: Confidence Progression\n  if (report.confidenceProgression) {\n    response += `**üìà G√ºven Skoru ƒ∞lerlemesi:**\\n`;\n    response += `- Stage 2 (K√∂k Neden): ${(report.confidenceProgression.stage2_root_cause_confidence * 100).toFixed(0)}%\\n`;\n    response += `- Stage 3 (Alert Korelasyon): ${(report.confidenceProgression.stage3_correlation_confidence * 100).toFixed(0)}%\\n`;\n    response += `- Stage 4 (Remediation): ${(report.confidenceProgression.stage4_remediation_confidence * 100).toFixed(0)}%\\n`;\n    response += `- Stage 6 (Prevention Kalitesi): ${(report.confidenceProgression.stage6_prevention_quality * 100).toFixed(0)}%\\n`;\n    response += `- **Genel G√ºven: ${(report.confidenceProgression.overall_confidence * 100).toFixed(0)}%**\\n\\n`;\n  }\n  \n  // NEW: Decision Journey Summary\n  if (report.decisionJourney) {\n    response += `**üîÑ Karar Yolculuƒüu:**\\n`;\n    response += `- Stage 1‚Üí2: ${report.decisionJourney.stage1_decision.value ? '‚úÖ Devam' : '‚ùå Dur'}\\n`;\n    response += `- Stage 2‚Üí3: ${report.decisionJourney.stage2_decision.value ? '‚úÖ Devam' : '‚ùå Dur'}\\n`;\n    response += `- Stage 3‚Üí4: ${report.decisionJourney.stage3_decision.value ? '‚úÖ Devam' : '‚ùå Dur'}\\n`;\n    response += `- Stage 4‚Üí5: ${report.decisionJourney.stage4_decision.value ? '‚úÖ Devam' : '‚ùå Dur'}\\n\\n`;\n  }\n  \n  // NEW: Learning Summary\n  if (report.learningSummary?.key_insights?.length > 0) {\n    response += `**üí° √ñnemli Bulgular:**\\n`;\n    report.learningSummary.key_insights.forEach(insight => {\n      response += `- ${insight}\\n`;\n    });\n    response += `\\n`;\n  }\n  \n  if (report.learningSummary?.what_worked?.length > 0) {\n    response += `**‚úÖ ƒ∞≈üe Yarayan:**\\n`;\n    report.learningSummary.what_worked.forEach(item => {\n      response += `- ${item}\\n`;\n    });\n    response += `\\n`;\n  }\n  \n  response += `**üìã √ñzet:**\\n`;\n  response += `${executedStages} a≈üama tamamlandƒ±, ${report.metrics.decisionsTracked} karar takip edildi.\\n`;\n  \n  return response;\n}\n\n// Helper function to calculate confidence progression\nfunction getConfidenceProgression() {\n  return {\n    stage2_root_cause_confidence: allStageData.stage2?.root_cause?.confidence || 0,\n    stage3_correlation_confidence: allStageData.stage3?.correlation_confidence || 0,\n    stage4_remediation_confidence: allStageData.stage4?.remediation_confidence || 0,\n    stage6_prevention_quality: allStageData.stage6?.prevention_quality_score || 0,\n    overall_confidence: (\n      (allStageData.stage2?.root_cause?.confidence || 0) +\n      (allStageData.stage3?.correlation_confidence || 0) +\n      (allStageData.stage4?.remediation_confidence || 0) +\n      (allStageData.stage6?.prevention_quality_score || 0)\n    ) / 4\n  };\n}\n\n// Helper function to create decision journey\nfunction getDecisionJourney() {\n  return {\n    stage1_decision: {\n      field: 'proceed_to_stage2',\n      value: allStageData.stage1?.proceed_to_stage2 || false,\n      reason: allStageData.stage1?.reason || '',\n      timestamp: masterContext.stageResults?.stage1?.completedAt\n    },\n    stage2_decision: {\n      field: 'proceed_to_stage3',\n      value: allStageData.stage2?.proceed_to_stage3 || false,\n      confidence: allStageData.stage2?.root_cause?.confidence || 0,\n      timestamp: masterContext.stageResults?.stage2?.completedAt\n    },\n    stage3_decision: {\n      field: 'proceed_to_stage4',\n      value: allStageData.stage3?.proceed_to_stage4 || false,\n      correlation_confidence: allStageData.stage3?.correlation_confidence || 0,\n      timestamp: masterContext.stageResults?.stage3?.completedAt\n    },\n    stage4_decision: {\n      field: 'proceed_to_stage5',\n      value: allStageData.stage4?.proceed_to_stage5 || false,\n      remediation_confidence: allStageData.stage4?.remediation_confidence || 0,\n      timestamp: masterContext.stageResults?.stage4?.completedAt\n    },\n    stage5_completion: {\n      remediation_plan_created: !!allStageData.stage5?.remediation_plan,\n      timestamp: masterContext.stageResults?.stage5?.completedAt\n    },\n    stage6_completion: {\n      prevention_implemented: allStageData.stage6?.final_status?.prevention_implemented || false,\n      prevention_quality_score: allStageData.stage6?.prevention_quality_score || 0,\n      timestamp: masterContext.stageResults?.stage6?.completedAt\n    }\n  };\n}\n\n// Helper function for learning summary\nfunction getLearningSummary() {\n  const summary = {\n    what_happened: {\n      root_cause: allStageData.stage2?.root_cause?.issue || 'Not identified',\n      affected_services: allStageData.stage2?.affected_services || [],\n      alert_count: allStageData.stage3?.active_alerts?.length || 0,\n      severity: allStageData.primaryDiagnosis?.severity || 'unknown',\n      duration: durationSeconds + 's'\n    },\n    what_worked: [],\n    what_didnt_work: [],\n    key_insights: []\n  };\n\n  // What worked\n  if (allStageData.stage2?.root_cause?.confidence >= 0.7) {\n    summary.what_worked.push('Stage 2 successfully identified root cause with high confidence');\n  }\n  if (allStageData.stage3?.correlation_confidence >= 0.7) {\n    summary.what_worked.push('Stage 3 strongly correlated alerts to root cause');\n  }\n  if (allStageData.stage5?.remediation_plan?.immediate_actions?.length > 0) {\n    summary.what_worked.push(`Stage 5 generated ${allStageData.stage5.remediation_plan.immediate_actions.length} actionable remediation steps`);\n  }\n  if (allStageData.stage6?.knowledge_base_update?.kb_updated) {\n    summary.what_worked.push('Knowledge base updated with learnings for future incidents');\n  }\n\n  // What didn't work\n  if (allStageData.stage2?.root_cause?.confidence < 0.5) {\n    summary.what_didnt_work.push('Low confidence in root cause identification - need more diagnostic depth');\n  }\n  if (allStageData.stage3?.correlation_confidence < 0.5) {\n    summary.what_didnt_work.push('Weak alert correlation - alerts may not match root cause well');\n  }\n  if (!allStageData.stage5?.remediation_plan) {\n    summary.what_didnt_work.push('No remediation plan generated - insufficient diagnostic clarity');\n  }\n\n  // Key insights\n  if (allStageData.stage2?.root_cause?.issue) {\n    summary.key_insights.push(`Primary issue: ${allStageData.stage2.root_cause.issue}`);\n  }\n  if (allStageData.stage3?.slo_impact?.availability_slo?.status === 'red') {\n    summary.key_insights.push('SLO violation detected - customer impact likely');\n  }\n  if (allStageData.stage6?.prevention_quality_score >= 0.7) {\n    summary.key_insights.push('Comprehensive prevention plan created - future recurrence risk reduced');\n  }\n\n  return summary;\n}\n\n// ============================================================================\n// NEW HELPER FUNCTIONS FOR FLOW 1 OUTPUT FORMAT\n// ============================================================================\n\n// Severity to color mapping\nconst SEVERITY_COLORS = {\n  critical: { border: '#d32f2f', bg: '#ffebee', icon: 'üî¥', text: '#d32f2f' },\n  high: { border: '#ff9800', bg: '#fff3e0', icon: 'üü†', text: '#ff9800' },\n  degraded: { border: '#ff9800', bg: '#fff3e0', icon: 'üü†', text: '#ff9800' },\n  warning: { border: '#ffc107', bg: '#fffde7', icon: 'üü°', text: '#ffc107' },\n  medium: { border: '#ffc107', bg: '#fffde7', icon: 'üü°', text: '#ffc107' },\n  low: { border: '#4caf50', bg: '#e8f5e9', icon: 'üü¢', text: '#4caf50' },\n  info: { border: '#2196f3', bg: '#e3f2fd', icon: 'üîµ', text: '#2196f3' },\n  unknown: { border: '#9e9e9e', bg: '#f5f5f5', icon: '‚ö™', text: '#9e9e9e' }\n};\n\n// Get severity style\nfunction getSeverityStyle(severity) {\n  const normalizedSeverity = (severity || 'unknown').toLowerCase();\n  return SEVERITY_COLORS[normalizedSeverity] || SEVERITY_COLORS.unknown;\n}\n\n// Map severity to priority\nfunction mapSeverityToPriority(severity) {\n  const normalizedSeverity = (severity || 'unknown').toLowerCase();\n  const priorityMap = {\n    critical: 'Critical',\n    high: 'High',\n    degraded: 'High',\n    warning: 'Medium',\n    medium: 'Medium',\n    low: 'Low',\n    info: 'Low',\n    unknown: 'Medium'\n  };\n  return priorityMap[normalizedSeverity] || 'Medium';\n}\n\n// Generate Markdown Report with HTML/CSS formatting\nfunction generateMarkdownReport(allStageData, masterContext, config) {\n  const severity = safeGet(allStageData, 'primaryDiagnosis.severity', 'unknown');\n  const style = getSeverityStyle(severity);\n\n  const alertName = safeGet(allStageData, 'stage1.alerts.firing.0.labels.alertname', 'Unknown Alert');\n  const component = safeGet(allStageData, 'stage2.root_cause.component', 'unknown-component');\n  const issue = safeGet(allStageData, 'stage2.root_cause.issue', 'Issue not identified');\n  const namespace = safeGet(allStageData, 'stage2.affected_services.0', 'unknown-namespace');\n  const confidence = safeGet(allStageData, 'stage2.root_cause.confidence', 0);\n  const affectedServices = safeGet(allStageData, 'stage2.affected_services', []);\n\n  // Immediate actions\n  const immediateActions = safeGet(allStageData, 'stage5.remediation_plan.immediate_actions', []);\n\n  // SLO Impact\n  const sloStatus = safeGet(allStageData, 'stage3.slo_impact.availability_slo.status', 'unknown');\n  const sloCurrent = safeGet(allStageData, 'stage3.slo_impact.availability_slo.current', 'N/A');\n  const sloTarget = safeGet(allStageData, 'stage3.slo_impact.availability_slo.target', 'N/A');\n\n  let html = `<div style=\"border: 2px solid ${style.border}; border-radius: 8px; padding: 20px; background-color: ${style.bg}; font-family: Arial, sans-serif; max-width: 800px;\">`;\n\n  // Header\n  html += `<h2 style=\"color: ${style.text}; margin-top: 0;\">${style.icon} ${alertName}</h2>`;\n  html += `<p style=\"font-size: 14px; color: #666;\"><strong>Context ID:</strong> ${masterContext.contextId || 'unknown'}</p>`;\n  html += `<hr style=\"border: none; border-top: 1px solid #ddd; margin: 15px 0;\">`;\n\n  // Issue Summary\n  html += `<h3 style=\"color: #333;\">üéØ Issue Summary</h3>`;\n  html += `<p><strong>Component:</strong> ${component}</p>`;\n  html += `<p><strong>Issue:</strong> ${issue}</p>`;\n  html += `<p><strong>Confidence:</strong> ${(confidence * 100).toFixed(0)}%</p>`;\n  html += `<p><strong>Severity:</strong> <span style=\"color: ${style.text}; font-weight: bold;\">${severity.toUpperCase()}</span></p>`;\n\n  if (affectedServices.length > 0) {\n    html += `<p><strong>Affected Services:</strong> ${affectedServices.join(', ')}</p>`;\n  }\n\n  // SLO Impact\n  if (sloStatus !== 'unknown') {\n    html += `<h3 style=\"color: #333;\">üìä SLO Impact</h3>`;\n    html += `<p><strong>Availability SLO:</strong> ${sloCurrent} (Target: ${sloTarget}) - Status: <strong>${sloStatus.toUpperCase()}</strong></p>`;\n  }\n\n  // Immediate Actions\n  if (immediateActions.length > 0) {\n    html += `<h3 style=\"color: #333;\">üîß Recommended Actions</h3>`;\n    html += `<ol style=\"margin: 10px 0; padding-left: 20px;\">`;\n    immediateActions.forEach(action => {\n      html += `<li style=\"margin-bottom: 10px;\">`;\n      html += `<strong>${safeGet(action, 'action', 'No action description')}</strong>`;\n      html += `<br><span style=\"font-size: 12px; color: #666;\">Risk: ${safeGet(action, 'risk', 'unknown')} | Time: ${safeGet(action, 'estimated_time', 'unknown')}</span>`;\n      if (action.command) {\n        html += `<br><code style=\"background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 12px;\">${action.command}</code>`;\n      }\n      html += `</li>`;\n    });\n    html += `</ol>`;\n  }\n\n  // Footer\n  html += `<hr style=\"border: none; border-top: 1px solid #ddd; margin: 15px 0;\">`;\n  html += `<p style=\"font-size: 12px; color: #999;\">Generated at ${new Date().toISOString()}</p>`;\n  html += `</div>`;\n\n  return html;\n}\n\n// Generate Enhanced Jira Description (Rich HTML format like File 26)\nfunction generateEnhancedJiraDescription(allStageData, masterContext) {\n  const severity = safeGet(allStageData, 'primaryDiagnosis.severity', 'unknown');\n  const style = getSeverityStyle(severity);\n  const alertName = safeGet(allStageData, 'stage1.alerts.firing.0.labels.alertname', 'Unknown Alert');\n  const component = safeGet(allStageData, 'stage2.root_cause.component', 'unknown-component');\n  const issue = safeGet(allStageData, 'stage2.root_cause.issue', 'Issue not identified');\n  const namespace = safeGet(allStageData, 'stage2.affected_services.0', 'unknown-namespace');\n  const confidence = safeGet(allStageData, 'stage2.root_cause.confidence', 0);\n  const affectedServices = safeGet(allStageData, 'stage2.affected_services', []);\n\n  // Extract pod/deployment info\n  const criticalPod = safeGet(allStageData, 'stage2.critical_pods.0', {});\n  const podName = criticalPod.pod_name || safeGet(allStageData, 'stage4.diagnostics_executed.0.target', 'unknown');\n  const deployment = component;\n\n  // Time calculations\n  const startTime = new Date(masterContext.createdAt);\n  const endTime = new Date();\n  const durationMinutes = Math.round((endTime - startTime) / 60000);\n  const alertStartDate = startTime.toLocaleString('en-US');\n\n  // Immediate actions\n  const immediateActions = safeGet(allStageData, 'stage5.remediation_plan.immediate_actions', []);\n\n  // SLO Impact\n  const sloStatus = safeGet(allStageData, 'stage3.slo_impact.availability_slo.status', 'unknown');\n  const sloCurrent = safeGet(allStageData, 'stage3.slo_impact.availability_slo.current', 'N/A');\n  const sloTarget = safeGet(allStageData, 'stage3.slo_impact.availability_slo.target', 'N/A');\n\n  // Evidence from Stage 4\n  const confirmedIssues = safeGet(allStageData, 'stage4.diagnostic_summary.confirmed_issues', []);\n  const evidenceList = confirmedIssues.map(ci => ci.evidence || {});\n\n  let html = `\n<div style=\"border: 2px solid #d32f2f; border-radius: 8px; margin: 10px 0; background: #ffebee;\">\n  <div style=\"background: #d32f2f; color: white; padding: 12px; font-weight: bold; border-radius: 6px 6px 0 0;\">\n    üö® INCIDENT SUMMARY\n  </div>\n  <div style=\"padding: 15px; background: white; border-radius: 0 0 6px 6px;\">\n    <table style=\"width: 100%; border-collapse: collapse; font-family: Arial, sans-serif;\">\n      <tr><td style=\"font-weight: bold; width: 130px; padding: 5px;\">Alert:</td><td style=\"padding: 5px;\">${alertName}</td></tr>\n      <tr><td style=\"font-weight: bold; padding: 5px;\">Severity:</td><td style=\"padding: 5px;\"><span style=\"color: ${style.text}; font-weight: bold;\">${style.icon} ${severity.toUpperCase()}</span></td></tr>\n      <tr><td style=\"font-weight: bold; padding: 5px;\">Service:</td><td style=\"padding: 5px;\">${deployment}</td></tr>\n      <tr><td style=\"font-weight: bold; padding: 5px;\">Namespace:</td><td style=\"padding: 5px;\">${namespace}</td></tr>\n      <tr><td style=\"font-weight: bold; padding: 5px;\">Detection:</td><td style=\"padding: 5px;\">${alertStartDate}</td></tr>\n      <tr><td style=\"font-weight: bold; padding: 5px;\">Duration:</td><td style=\"padding: 5px;\">${durationMinutes} minutes</td></tr>\n    </table>\n  </div>\n</div>\n\n<h2 style=\"color: #1976d2; margin-top: 20px;\">üìä INCIDENT DETAILS</h2>\n\n<div style=\"border: 1px solid #e0e0e0; border-radius: 6px; margin: 10px 0; overflow: hidden;\">\n  <table style=\"width: 100%; border-collapse: collapse; font-family: Arial, sans-serif;\">\n    <tr style=\"background: #f5f5f5;\">\n      <td style=\"padding: 10px; font-weight: bold; border-bottom: 1px solid #e0e0e0;\">Field</td>\n      <td style=\"padding: 10px; font-weight: bold; border-bottom: 1px solid #e0e0e0;\">Details</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0;\">Alert Type</td>\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0;\">${alertName}</td>\n    </tr>\n    <tr style=\"background: #fafafa;\">\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0;\">Pod Name</td>\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0; font-family: monospace;\">${podName}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0;\">Deployment</td>\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0; font-family: monospace;\">${deployment}</td>\n    </tr>\n    <tr style=\"background: #fafafa;\">\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0;\">Namespace</td>\n      <td style=\"padding: 8px; border-bottom: 1px solid #f0f0f0; font-family: monospace;\">${namespace}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 8px;\">Context ID</td>\n      <td style=\"padding: 8px; font-family: monospace; color: #666;\">${masterContext.contextId}</td>\n    </tr>\n  </table>\n</div>\n\n---\n\n## üìö KNOWLEDGE BASE INTELLIGENCE\n\n`;\n\n  // Get KB insights\n  const kbInsights = generateKnowledgeBaseInsights(allStageData);\n  const hasKBEntry = kbInsights.kbEnhanced;\n  const kbEntry = kbInsights.kbEntryDetails;\n\n  if (kbInsights.kbIntegrationEnabled) {\n    html += `\n<div style=\"border: 1px solid #9c27b0; border-radius: 6px; margin: 10px 0; background: #f3e5f5;\">\n  <div style=\"background: #9c27b0; color: white; padding: 10px; font-weight: bold; border-radius: 5px 5px 0 0;\">\n    üìö Knowledge Base Integration Status\n  </div>\n  <div style=\"padding: 12px; background: white; border-radius: 0 0 5px 5px;\">\n    <table style=\"width: 100%; border-collapse: collapse; font-family: Arial, sans-serif;\">\n      <tr>\n        <td style=\"padding: 6px; font-weight: bold; width: 180px;\">KB Integration:</td>\n        <td style=\"padding: 6px;\"><span style=\"color: #2e7d32; font-weight: bold;\">‚úÖ ENABLED</span></td>\n      </tr>\n      <tr style=\"background: #fafafa;\">\n        <td style=\"padding: 6px; font-weight: bold;\">KB Entries Loaded:</td>\n        <td style=\"padding: 6px;\">${kbInsights.kbIntegrationEnabled ? kbEntriesLoaded : 0} alerts</td>\n      </tr>\n      <tr>\n        <td style=\"padding: 6px; font-weight: bold;\">Current Alert in KB:</td>\n        <td style=\"padding: 6px;\"><span style=\"color: ${hasKBEntry ? '#2e7d32' : '#d32f2f'}; font-weight: bold;\">${hasKBEntry ? '‚úÖ YES' : '‚ùå NO'}</span></td>\n      </tr>\n      ${hasKBEntry ? `\n      <tr style=\"background: #fafafa;\">\n        <td style=\"padding: 6px; font-weight: bold;\">Alert Category:</td>\n        <td style=\"padding: 6px;\">${kbInsights.alertCategory || 'Unknown'}</td>\n      </tr>\n      <tr>\n        <td style=\"padding: 6px; font-weight: bold;\">Urgency Level:</td>\n        <td style=\"padding: 6px;\"><span style=\"font-weight: bold;\">${kbInsights.urgencyLevel || 'Unknown'}</span></td>\n      </tr>\n      <tr style=\"background: #fafafa;\">\n        <td style=\"padding: 6px; font-weight: bold;\">Cascade Risk:</td>\n        <td style=\"padding: 6px;\">${kbInsights.cascadeRisk || 'Unknown'}</td>\n      </tr>\n      ` : ''}\n    </table>\n  </div>\n</div>\n`;\n\n    if (hasKBEntry && kbEntry) {\n      // Add KB-specific sections\n      html += `\n### üéØ KB-Enhanced Analysis\n\n**Alert Name**: ${kbEntry.alertName}\n**KB Severity**: ${kbEntry.severity ? kbEntry.severity.toUpperCase() : 'Unknown'}\n\n`;\n\n      if (kbEntry.commonCauses && kbEntry.commonCauses.length > 0) {\n        html += `\n#### üìã Common Causes (from KB)\n${kbEntry.commonCauses.map((cause, idx) => `${idx + 1}. ${cause}`).join('\\n')}\n\n`;\n      }\n\n      if (kbEntry.immediateActions && kbEntry.immediateActions.length > 0) {\n        html += `\n#### üî• KB-Recommended Immediate Actions\n${kbEntry.immediateActions.map((action, idx) => `${idx + 1}. ${action}`).join('\\n')}\n\n`;\n      }\n\n      if (kbEntry.troubleshootingSteps && kbEntry.troubleshootingSteps.length > 0) {\n        html += `\n#### üîç KB Troubleshooting Steps\n${kbEntry.troubleshootingSteps.map((step, idx) => `${idx + 1}. ${step}`).join('\\n')}\n\n`;\n      }\n    }\n  } else {\n    html += `\n<div style=\"border: 1px solid #ff9800; border-radius: 6px; margin: 10px 0; background: #fff3e0;\">\n  <div style=\"background: #ff9800; color: white; padding: 10px; font-weight: bold; border-radius: 5px 5px 0 0;\">\n    ‚ö†Ô∏è Knowledge Base Status\n  </div>\n  <div style=\"padding: 12px; background: white; border-radius: 0 0 5px 5px;\">\n    <p style=\"margin: 0; color: #e65100;\">KB Integration: <strong>DISABLED</strong> - Operating in standard analysis mode</p>\n  </div>\n</div>\n`;\n  }\n\n  html += `\n---\n\n## üîç ISSUE IDENTIFICATION\n\n### ${issue}\n\n**Confidence Level**: ${(confidence * 100).toFixed(0)}%\n\n**Business Impact**: ${safeGet(allStageData, 'primaryDiagnosis.impact', 'Service disruption detected')}\n\n### üìä EVIDENCE SUMMARY\n${evidenceList.length > 0 ? evidenceList.map((ev, idx) => `\n**Evidence ${idx + 1}:**\n- ${Object.keys(ev).map(key => `${key}: ${JSON.stringify(ev[key])}`).join('\\n- ')}\n`).join('\\n') : 'No detailed evidence available'}\n\n---\n\n## üìä SLO IMPACT\n\n${sloStatus !== 'unknown' ? `\n- **Availability SLO**: ${sloCurrent} (Target: ${sloTarget})\n- **Status**: **${sloStatus.toUpperCase()}**\n` : '- SLO data not available'}\n\n---\n\n## üöÄ ACTION PLAN\n\n### üî¥ IMMEDIATE ACTIONS (Execute NOW)\n\n${immediateActions.length > 0 ? immediateActions.map((action, idx) => `\n#### ${idx + 1}. ${action.action || 'No action description'}\n\n**Command to execute:**\n\\`\\`\\`bash\n${action.command || 'No command provided'}\n\\`\\`\\`\n\n${action.verification_command ? `**Verification command:**\n\\`\\`\\`bash\n${action.verification_command}\n\\`\\`\\`` : ''}\n\n- **Risk Level**: ${action.risk || 'Unknown'}\n- **Estimated Time**: ${action.estimated_time || 'Unknown'}\n- **Expected Outcome**: ${action.expected_outcome || 'Restore service functionality'}\n\n---\n`).join('\\n') : '- No immediate actions recommended'}\n\n${allStageData.stage5?.remediation_plan?.short_term_fixes?.length > 0 ? `\n### üü† SHORT-TERM FIXES (Within 24 hours)\n\n${allStageData.stage5.remediation_plan.short_term_fixes.map((fix, idx) => `\n${idx + 1}. **${fix.action || 'Fix not specified'}**\n   - Priority: ${fix.priority || 'Unknown'}\n   - Timeline: ${fix.timeline || 'Unknown'}\n`).join('\\n')}\n` : ''}\n\n${allStageData.stage6?.prevention_actions?.length > 0 ? `\n### üü¢ PREVENTION ACTIONS (Long-term)\n\n${allStageData.stage6.prevention_actions.map((prev, idx) => `\n${idx + 1}. **[${prev.type}]** ${prev.action}\n   - Status: ${prev.status || 'Planned'}\n`).join('\\n')}\n` : ''}\n\n---\n\n## üìé Additional Information\n\n- **Analysis Context ID**: ${masterContext.contextId}\n- **Alert Source**: ${alertName}\n- **Analysis Completed**: ${new Date().toISOString()}\n- **Total Analysis Time**: ${durationMinutes} minutes\n- **System**: FreePrometheus Analysis Engine v2.0\n- **Stages Executed**: ${Object.keys(allStageData).filter(k => allStageData[k] !== null).length}/6\n- **KB Integration**: ${kbInsights.kbIntegrationEnabled ? `ENABLED (${kbEntriesLoaded} alerts loaded)` : 'DISABLED'}\n- **KB Enhanced**: ${hasKBEntry ? 'YES - Alert found in KB' : 'NO - Alert not in KB'}\n${hasKBEntry ? `- **Alert Category**: ${kbInsights.alertCategory || 'Unknown'}\n- **Urgency Level**: ${kbInsights.urgencyLevel || 'Unknown'}\n- **Cascade Risk**: ${kbInsights.cascadeRisk || 'Unknown'}` : ''}\n\n---\n\n*This report was automatically generated by the FreePrometheus Analysis System*\n*Report Version: 2.0 | KB-Enhanced: ${hasKBEntry ? 'YES' : 'NO'} | Generated: ${new Date().toISOString()}*\n`;\n\n  return html;\n}\n\n// Generate Oncall Ticket\nfunction generateOncallTicket(allStageData, masterContext) {\n  const severity = safeGet(allStageData, 'primaryDiagnosis.severity', 'unknown');\n  const style = getSeverityStyle(severity);\n\n  const alertName = safeGet(allStageData, 'stage1.alerts.firing.0.labels.alertname', 'Unknown Alert');\n  const component = safeGet(allStageData, 'stage2.root_cause.component', 'unknown-component');\n  const issue = safeGet(allStageData, 'stage2.root_cause.issue', 'Issue not identified');\n  const namespace = safeGet(allStageData, 'stage2.affected_services.0', 'unknown-namespace');\n  const affectedServices = safeGet(allStageData, 'stage2.affected_services', []);\n\n  const immediateActions = safeGet(allStageData, 'stage5.remediation_plan.immediate_actions', []);\n\n  // Symptoms count\n  const symptomsCount = safeGet(allStageData, 'stage1.alerts.total', 0);\n\n  let description = `<div style=\"font-family: Arial, sans-serif; max-width: 700px;\">`;\n  description += `<h3 style=\"color: ${style.text};\">${style.icon} Alert: ${alertName}</h3>`;\n  description += `<p><strong>Component:</strong> ${component}</p>`;\n  description += `<p><strong>Namespace:</strong> ${namespace}</p>`;\n  description += `<p><strong>Root Cause:</strong> ${issue}</p>`;\n\n  if (affectedServices.length > 0) {\n    description += `<p><strong>Affected Services:</strong> ${affectedServices.join(', ')}</p>`;\n  }\n\n  if (immediateActions.length > 0) {\n    description += `<h4>Recommended Actions:</h4><ul>`;\n    immediateActions.forEach(action => {\n      description += `<li><strong>${safeGet(action, 'action', 'No action')}</strong> (Risk: ${safeGet(action, 'risk', 'unknown')})</li>`;\n    });\n    description += `</ul>`;\n  }\n\n  description += `<p style=\"font-size: 12px; color: #999;\">Context ID: ${masterContext.contextId || 'unknown'}</p>`;\n  description += `</div>`;\n\n  return {\n    title: `${style.icon} ${mapSeverityToPriority(severity).toUpperCase()} ${alertName}: ${component}`,\n    description: description,\n    priority: mapSeverityToPriority(severity),\n    customFields: {\n      contextId: masterContext.contextId || 'unknown',\n      oncallFriendly: true,\n      symptoms: symptomsCount,\n      rootCause: `Diagnosis: ${issue}`\n    }\n  };\n}\n\n// Generate Enhanced Jira Ticket (matching File 26 format but without KB)\nfunction generateJiraTicket(allStageData, masterContext) {\n  const severity = safeGet(allStageData, 'primaryDiagnosis.severity', 'unknown');\n  const alertName = safeGet(allStageData, 'stage1.alerts.firing.0.labels.alertname', 'Unknown Alert');\n  const component = safeGet(allStageData, 'stage2.root_cause.component', 'unknown-component');\n  const issue = safeGet(allStageData, 'stage2.root_cause.issue', 'Issue not identified');\n  const namespace = safeGet(allStageData, 'stage2.affected_services.0', 'unknown-namespace');\n  const confidence = safeGet(allStageData, 'stage2.root_cause.confidence', 0);\n\n  // Extract namespace from service name if needed\n  let actualNamespace = namespace;\n  if (namespace.includes('-')) {\n    const parts = namespace.split('-');\n    if (DEFAULT_NAMESPACES.includes(parts[0])) {\n      actualNamespace = parts[0];\n    }\n  }\n  if (actualNamespace === 'unknown-namespace' || !actualNamespace) {\n    actualNamespace = DEFAULT_NAMESPACES[0];\n  }\n\n  // Get KB insights first (needed for description and title)\n  const kbInsights = generateKnowledgeBaseInsights(allStageData);\n  const hasKBEntry = kbInsights.kbEnhanced;\n\n  // Generate rich HTML description\n  const description = generateEnhancedJiraDescription(allStageData, masterContext);\n\n  // Enhanced title format with KB indicator\n  const title = hasKBEntry\n    ? `[${alertName}] ${component} - ${issue} (KB-Enhanced)`\n    : kbInsights.kbIntegrationEnabled\n      ? `[${alertName}] ${component} - ${issue} (KB-Available)`\n      : `[${alertName}] ${component} - ${issue}`;\n\n  // Priority mapping\n  const priority = mapSeverityToPriority(severity);\n\n  // Build labels array with KB-related tags\n  const labels = [\n    alertName,\n    severity.toLowerCase(),\n    actualNamespace,\n    component,\n    \"Auto-Detected\",\n    \"FreePrometheus-Analysis\",\n    \"KB-Aware-Analysis\"\n  ].concat(kbInsights.kbIntegrationEnabled ? [\"KB-Integration-Enabled\"] : [])\n   .concat(hasKBEntry ? [\"KB-Enhanced\", \"KB-Available\"] : [])\n   .concat(hasKBEntry && kbInsights.alertCategory ? [`Category-${kbInsights.alertCategory}`] : [])\n   .filter(Boolean);\n\n  // Build components array\n  const components = [component].filter(c => c && c !== 'unknown-component');\n\n  // Calculate analysis duration\n  const startTime = new Date(masterContext.createdAt);\n  const endTime = new Date();\n  const durationMinutes = Math.round((endTime - startTime) / 60000);\n\n  // Build custom fields with KB information\n  const customFields = {\n    contextId: masterContext.contextId || 'unknown',\n    analysisTime: durationMinutes,\n    automationConfidence: confidence,\n    analysisEngine: \"FreePrometheus Analysis Engine\",\n    engineVersion: \"2.0\",\n    stagesExecuted: Object.keys(allStageData).filter(k => allStageData[k] !== null).length,\n    rootCauseConfidence: confidence,\n    affectedServices: safeGet(allStageData, 'stage2.affected_services.length', 0),\n    sloImpact: safeGet(allStageData, 'stage3.slo_impact.availability_slo.status', 'unknown'),\n    kbIntegrationEnabled: kbInsights.kbIntegrationEnabled,\n    kbEnhanced: hasKBEntry,\n    kbEntriesLoaded: kbInsights.kbIntegrationEnabled ? kbEntriesLoaded : 0,\n    ...(hasKBEntry && {\n      alertCategory: kbInsights.alertCategory,\n      urgencyLevel: kbInsights.urgencyLevel,\n      cascadeRisk: kbInsights.cascadeRisk,\n      kbAlertSeverity: kbInsights.kbEntryDetails?.severity || 'unknown'\n    })\n  };\n\n  return {\n    title: title,\n    description: description,\n    priority: priority,\n    labels: labels,\n    components: components,\n    issueType: \"Incident\",\n    customFields: customFields\n  };\n}\n\n// Generate Knowledge Base Insights (with KB integration)\nfunction generateKnowledgeBaseInsights(allStageData) {\n  const severity = safeGet(allStageData, 'primaryDiagnosis.severity', 'medium');\n  const alertName = safeGet(allStageData, 'stage1.alerts.firing.0.labels.alertname', '');\n\n  // Derive urgency from severity\n  const urgencyMap = {\n    critical: 'CRITICAL',\n    high: 'HIGH',\n    degraded: 'HIGH',\n    warning: 'MEDIUM',\n    medium: 'MEDIUM',\n    low: 'LOW',\n    info: 'LOW',\n    unknown: 'MEDIUM'\n  };\n  const urgencyLevel = urgencyMap[(severity || 'medium').toLowerCase()] || 'MEDIUM';\n\n  // Check if alert exists in KB\n  const kbEntry = alertKnowledgeBase[alertName] || null;\n  const hasKBEntry = !!kbEntry;\n\n  // Derive alert category from KB or heuristics\n  let alertCategory = 'UNKNOWN';\n  if (hasKBEntry) {\n    // Use KB data if available\n    if (alertName.toLowerCase().includes('etcd') || alertName.toLowerCase().includes('api')) {\n      alertCategory = 'INFRASTRUCTURE';\n    } else if (alertName.toLowerCase().includes('pod') || alertName.toLowerCase().includes('container')) {\n      alertCategory = 'APPLICATION';\n    } else if (alertName.toLowerCase().includes('node')) {\n      alertCategory = 'INFRASTRUCTURE';\n    } else if (alertName.toLowerCase().includes('disk') || alertName.toLowerCase().includes('memory') || alertName.toLowerCase().includes('cpu')) {\n      alertCategory = 'RESOURCE';\n    } else if (alertName.toLowerCase().includes('network')) {\n      alertCategory = 'NETWORK';\n    }\n  } else {\n    // Fallback to heuristics\n    if (alertName.toLowerCase().includes('pod')) {\n      alertCategory = 'APPLICATION';\n    } else if (alertName.toLowerCase().includes('node')) {\n      alertCategory = 'INFRASTRUCTURE';\n    } else if (alertName.toLowerCase().includes('disk') || alertName.toLowerCase().includes('memory')) {\n      alertCategory = 'RESOURCE';\n    } else if (alertName.toLowerCase().includes('network')) {\n      alertCategory = 'NETWORK';\n    }\n  }\n\n  // Cascade risk from KB or estimation\n  const affectedServicesCount = safeGet(allStageData, 'stage2.affected_services.length', 0);\n  let cascadeRisk = 'LOW';\n  if (hasKBEntry && kbEntry.cascadeCheckPoints) {\n    // KB has cascade info\n    cascadeRisk = kbEntry.cascadeCheckPoints.length > 3 ? 'HIGH' : 'MEDIUM';\n  } else {\n    // Estimate from affected services\n    if (affectedServicesCount > 5) {\n      cascadeRisk = 'HIGH';\n    } else if (affectedServicesCount > 2) {\n      cascadeRisk = 'MEDIUM';\n    }\n  }\n\n  // KB-enhanced data\n  const kbCommonCauses = hasKBEntry ? (kbEntry.commonCauses || []) : [];\n  const kbImmediateActions = hasKBEntry ? (kbEntry.immediateActions || []) : [];\n  const kbLongTermSolutions = hasKBEntry ? (kbEntry.longTermSolutions || []) : [];\n\n  return {\n    kbIntegrationEnabled: kbEntriesLoaded > 0,\n    kbEnhanced: hasKBEntry,\n    alertCategory: alertCategory,\n    urgencyLevel: urgencyLevel,\n    cascadeRisk: cascadeRisk,\n    kbUtilization: {\n      utilizationRate: kbEntriesLoaded > 0 ? `${((hasKBEntry ? 1 : 0) / kbEntriesLoaded * 100).toFixed(1)}%` : '0%',\n      matchedEntries: hasKBEntry ? 1 : 0,\n      totalEntries: kbEntriesLoaded,\n      lastUpdated: new Date().toISOString()\n    },\n    categoryAnalysis: {\n      category: alertCategory,\n      typicalResolutionTime: hasKBEntry ? 'Available in KB' : 'Unknown',\n      commonCauses: kbCommonCauses,\n      recommendedRunbooks: hasKBEntry ? [`KB Entry: ${alertName}`] : []\n    },\n    kbEntryDetails: hasKBEntry ? {\n      alertName: alertName,\n      severity: kbEntry.severity || 'unknown',\n      description: kbEntry.description || '',\n      commonCauses: kbCommonCauses,\n      immediateActions: kbImmediateActions,\n      longTermSolutions: kbLongTermSolutions,\n      troubleshootingSteps: kbEntry.troubleshootingSteps || [],\n      expectedResults: kbEntry.expectedResults || []\n    } : null\n  };\n}\n\n// Generate Debug Info\nfunction generateDebugInfo(allStageData, masterContext) {\n  return {\n    contextId: masterContext.contextId || 'unknown',\n    executionFlow: {\n      stagesExecuted: Object.keys(allStageData).filter(k => allStageData[k] !== null).length,\n      stageCompletions: {\n        stage1: !!allStageData.stage1,\n        stage2: !!allStageData.stage2,\n        stage3: !!allStageData.stage3,\n        stage4: !!allStageData.stage4,\n        stage5: !!allStageData.stage5,\n        stage6: !!allStageData.stage6\n      }\n    },\n    kbAwareCorrelation: {\n      engine: 'KB-Aware Universal Correlation Engine',\n      version: '1.0-HYBRID',\n      kbIntegration: false, // No KB nodes in Flow 2\n      fallbackMode: 'NATIVE_ANALYSIS'\n    },\n    dataQuality: {\n      mockDataDetected: false,\n      contextPreserved: true,\n      allStagesHaveData: Object.keys(allStageData).filter(k => allStageData[k] !== null).length >= 1\n    },\n    timestamp: new Date().toISOString()\n  };\n}\n\n// Generate Quick Actions (kubectl commands)\nfunction generateQuickActions(allStageData, masterContext) {\n  const component = safeGet(allStageData, 'stage2.root_cause.component', 'unknown-component');\n  const namespace = safeGet(allStageData, 'stage2.affected_services.0', 'unknown-namespace');\n\n  // Try to extract actual namespace from service name (format: namespace-servicename)\n  let actualNamespace = namespace;\n  if (namespace.includes('-')) {\n    const parts = namespace.split('-');\n    if (DEFAULT_NAMESPACES.includes(parts[0])) {\n      actualNamespace = parts[0];\n    }\n  }\n\n  // If still unknown, use first production namespace\n  if (actualNamespace === 'unknown-namespace' || !actualNamespace) {\n    actualNamespace = DEFAULT_NAMESPACES[0];\n  }\n\n  return {\n    rollback: `kubectl rollout undo deployment/${component} -n ${actualNamespace}`,\n    monitor: `watch kubectl get pods -n ${actualNamespace} | grep ${component}`,\n    logs: `kubectl logs -f deployment/${component} -n ${actualNamespace}`,\n    scale: `kubectl scale deployment/${component} --replicas=3 -n ${actualNamespace}`,\n    describe: `kubectl describe pod -l app=${component} -n ${actualNamespace}`,\n    events: `kubectl get events -n ${actualNamespace} --sort-by='.lastTimestamp' | grep ${component}`\n  };\n}\n\n// Final raporu olu≈ütur\nconst finalReport = {\n  executionId: masterContext.workflowMetadata?.executionId || config.executionId,\n  timestamp: endTime.toISOString(),\n  duration: `${durationSeconds}s`,\n  cluster: safeGet(masterContext, 'initialParams.namespaces.0', 'unknown'),\n  \n  // Context tracking\n  contextTracking: {\n    contextId: masterContext.contextId,\n    contextCreated: masterContext.createdAt,\n    contextPreserved: true,\n    contextJourney: {\n      start: masterContext.createdAt,\n      end: endTime.toISOString(),\n      durationMs: endTime - startTime,\n      stagesCompleted: Object.keys(masterContext.stageResults || {})\n    }\n  },\n  \n  // Orchestrator metadata\n  ...(masterContext.source?.type === 'orchestrator' && {\n    orchestratorId: masterContext.source.orchestratorId,\n    requestId: masterContext.workflowMetadata?.requestId\n  }),\n  \n  trigger: {\n    source: masterContext.source || { type: 'unknown' },\n    priority: masterContext.priority || 'normal',\n    forceDeepAnalysis: masterContext.forceDeepAnalysis || false\n  },\n  \n  executiveSummary: {\n    overallHealth: allStageData.stage1?.overall_status || 'unknown',\n    issuesFound: allStageData.stage2?.root_cause?.identified ? 1 : 0,\n    alertsActive: allStageData.stage1?.alerts?.total || 0,\n    alertsCritical: allStageData.stage1?.alerts?.critical || 0,\n    actionsToken: allStageData.stage5?.remediation_plan?.immediate_actions?.length || 0,\n    preventionImplemented: allStageData.stage6?.prevention_actions?.filter(a => a.status === 'implemented').length || 0,\n    stagesExecuted: executedStages\n  },\n  \n  // Stage 1 Results\n  stage1Results: {\n    status: allStageData.stage1?.overall_status || 'unknown',\n    scores: allStageData.stage1?.scores || {},\n    alerts: allStageData.stage1?.alerts || { total: 0, critical: 0, warning: 0 },\n    quickFindings: allStageData.stage1?.quick_findings || [],\n    proceedToStage2: allStageData.stage1?.proceed_to_stage2 || false,\n    urgency: allStageData.stage1?.urgency || 'normal',\n    decision_reason: allStageData.stage1?.reason || ''\n  },\n  \n  // Findings from all stages\n  findings: {\n    rootCause: allStageData.stage2?.root_cause || { identified: false, issue: 'Not identified' },\n    affectedServices: allStageData.stage2?.affected_services || [],\n    alertCorrelations: allStageData.stage3?.alert_groups || [],\n    diagnosticEvidence: allStageData.stage4?.diagnostic_summary?.confirmed_issues || [],\n    sloImpact: allStageData.stage3?.slo_impact || {}\n  },\n  \n  // Actions taken\n  actions: {\n    immediate: allStageData.stage5?.remediation_plan?.immediate_actions || [],\n    shortTerm: allStageData.stage5?.remediation_plan?.short_term_fixes || [],\n    longTerm: allStageData.stage5?.remediation_plan?.long_term_solutions || [],\n    preventive: allStageData.stage6?.prevention_actions || []\n  },\n  \n  // Metrics\n  metrics: {\n    stagesExecuted: executedStages,\n    toolsUsed: calculateToolsUsed(),\n    alertsResolved: 0,\n    executionTime: durationSeconds,\n    contextPreserved: true,\n    decisionsTracked: Object.keys(masterContext.decisions || {}).length\n  },\n  \n  // Next steps from Stage 6\n  nextSteps: allStageData.stage6?.follow_up_schedule || [],\n  \n  // Detailed results from each stage\n  detailedResults: {\n    stage1_health: allStageData.stage1,\n    stage2_analysis: allStageData.stage2,\n    stage3_alerts: allStageData.stage3,\n    stage4_diagnosis: allStageData.stage4,\n    stage5_remediation: allStageData.stage5,\n    stage6_prevention: allStageData.stage6\n  },\n  \n  // Consolidated findings\n  consolidatedFindings: allStageData.consolidatedFindings || {},\n  \n  // Primary diagnosis\n  primaryDiagnosis: allStageData.primaryDiagnosis || {},\n  \n  // Preserved context (g√ºncellenmi≈ü stageResults ile)\n  preservedContext: masterContext,\n  \n  // NEW: Executive Insights - Key insights from all 6 stages in one place\n  executiveInsights: {\n    stage1_health_snapshot: {\n      overall_status: allStageData.stage1?.overall_status || 'unknown',\n      critical_alerts: allStageData.stage1?.alerts?.critical || 0,\n      urgency: allStageData.stage1?.urgency || 'normal',\n      key_finding: allStageData.stage1?.quick_findings?.[0] || 'No immediate issues detected'\n    },\n    stage2_root_cause: {\n      identified: allStageData.stage2?.root_cause?.identified || false,\n      issue: allStageData.stage2?.root_cause?.issue || 'Not identified',\n      component: allStageData.stage2?.root_cause?.component || 'Unknown',\n      confidence: allStageData.stage2?.root_cause?.confidence || 0,\n      affected_services: allStageData.stage2?.affected_services || []\n    },\n    stage3_alert_correlation: {\n      active_alerts: allStageData.stage3?.active_alerts?.length || 0,\n      alert_groups: allStageData.stage3?.alert_groups?.length || 0,\n      kb_matches: allStageData.stage3?.knowledge_base_matches?.length || 0,\n      correlation_confidence: allStageData.stage3?.correlation_confidence || 0,\n      slo_status: allStageData.stage3?.slo_impact?.availability_slo?.status || 'unknown'\n    },\n    stage4_diagnostics: {\n      diagnostics_executed: allStageData.stage4?.diagnostics_executed?.length || 0,\n      confirmed_issues: allStageData.stage4?.diagnostic_summary?.confirmed_issues?.length || 0,\n      remediation_confidence: allStageData.stage4?.remediation_confidence || 0,\n      primary_issue: allStageData.stage4?.diagnostic_summary?.confirmed_issues?.[0]?.issue || 'None'\n    },\n    stage5_remediation: {\n      plan_created: !!allStageData.stage5?.remediation_plan,\n      immediate_actions: allStageData.stage5?.remediation_plan?.immediate_actions?.length || 0,\n      overall_risk: allStageData.stage5?.risk_assessment?.overall_risk || 'unknown',\n      primary_action: allStageData.stage5?.remediation_plan?.immediate_actions?.[0]?.action || 'None'\n    },\n    stage6_prevention: {\n      prevention_implemented: allStageData.stage6?.final_status?.prevention_implemented || false,\n      prevention_actions: allStageData.stage6?.prevention_actions?.length || 0,\n      kb_updated: allStageData.stage6?.knowledge_base_update?.kb_updated || false,\n      prevention_quality_score: allStageData.stage6?.prevention_quality_score || 0\n    }\n  },\n  \n  // NEW: Decision Journey - Show all proceed_to_stageX decisions\n  decisionJourney: getDecisionJourney(),\n  \n  // NEW: Confidence Progression - Track confidence across stages\n  confidenceProgression: getConfidenceProgression(),\n  \n  // NEW: Learning Summary - What worked, what didn't, key insights\n  learningSummary: getLearningSummary(),\n  \n  // NEW: Recommendation Priority Matrix\n  recommendationPriority: {\n    critical_immediate: allStageData.stage5?.remediation_plan?.immediate_actions?.filter(a => \n      a.risk === 'low' && (a.action?.toLowerCase().includes('critical') || a.action?.toLowerCase().includes('restart'))\n    ) || [],\n    high_short_term: allStageData.stage5?.remediation_plan?.short_term_fixes?.filter(f => \n      f.priority === 'high' || f.action?.toLowerCase().includes('increase')\n    ) || [],\n    medium_long_term: allStageData.stage5?.remediation_plan?.long_term_solutions?.filter(s => \n      s.priority === 'medium' || s.action?.toLowerCase().includes('fix')\n    ) || [],\n    preventive_ongoing: allStageData.stage6?.prevention_actions?.filter(a => \n      a.type === 'monitoring' || a.type === 'process'\n    ) || []\n  }\n};\n\n// Override bilgisi ekle\nif (masterContext.decisions?.forceDeepAnalysisOverride?.overrideApplied) {\n  finalReport.overrideInfo = {\n    message: \"Derin analiz kullanƒ±cƒ± isteƒüiyle zorlandƒ±\",\n    originalDecision: masterContext.decisions.forceDeepAnalysisOverride.originalDecision,\n    overrideReason: masterContext.decisions.forceDeepAnalysisOverride.reason,\n    priority: masterContext.priority\n  };\n}\n\n// Response ekle\nif (masterContext.source?.type === 'chat') {\n  finalReport.chatResponse = generateResponse(finalReport);\n} else {\n  finalReport.summary = generateResponse(finalReport);\n}\n\n// ============================================================================\n// ADD NEW FIELDS FROM FLOW 1 (Hybrid Approach)\n// ============================================================================\n\n// Add markdownReport (HTML/CSS formatted visual report)\nfinalReport.markdownReport = generateMarkdownReport(allStageData, masterContext, config);\n\n// Add oncallTicket (oncall-friendly ticket)\nfinalReport.oncallTicket = generateOncallTicket(allStageData, masterContext);\n\n// Add jiraTicket (Jira-ready ticket)\nfinalReport.jiraTicket = generateJiraTicket(allStageData, masterContext);\n\n// Add knowledgeBaseInsights (placeholder without KB nodes)\nfinalReport.knowledgeBaseInsights = generateKnowledgeBaseInsights(allStageData);\n\n// Add _debug (debug information)\nfinalReport._debug = generateDebugInfo(allStageData, masterContext);\n\n// Add quickActions to executiveSummary if not present\nif (!finalReport.executiveSummary.quickActions) {\n  finalReport.executiveSummary.quickActions = generateQuickActions(allStageData, masterContext);\n}\n\n// Direkt raporu d√∂nd√ºr\nreturn [{ json: finalReport }];"
      },
      "id": "7d2324c2-6924-47e4-beab-cc5adbc1a146",
      "name": "Generate Final Report",
      "type": "n8n-nodes-base.code",
      "position": [
        7040,
        96
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## üöÄ Prometheus Ultimate AI Agent System\n\n### 6-Stage Intelligent Analysis & Remediation\n\n1. **Stage 1: Health Snapshot** (5s)\n   - Quick cluster health check\n   - Active alerts count\n   - Go/No-go decision\n\n2. **Stage 2: Deep Analysis** (30s)\n   - 3-phase investigation\n   - Instant ‚Üí Trend ‚Üí Anomaly\n   - Root cause identification\n\n3. **Stage 3: Alert Intelligence** (20s)\n   - Alert correlation\n   - Knowledge base matching\n   - SLO impact assessment\n\n4. **Stage 4: Automated Diagnosis** (20s)\n   - Execute diagnostic commands\n   - Enrich context\n   - Confirm root cause\n\n5. **Stage 5: Smart Remediation** (30s)\n   - Safe auto-fixes\n   - Approval workflow\n   - Verification loops\n\n6. **Stage 6: Prevention** (20s)\n   - Update monitoring\n   - Document learnings\n   - Prevent recurrence\n\n### Features:\n- Alert correlation engine\n- Knowledge base integration\n- Auto-remediation (safe actions)\n- Predictive analysis\n- Learning system\n- ChatOps commands\n- SLO tracking\n- Runbook automation\n\n### Triggers:\n- Manual\n- Scheduled (5 min)\n- Chat commands\n- AlertManager webhooks",
        "height": 600,
        "width": 400,
        "color": 5
      },
      "id": "f804486b-ac0e-4c36-8e48-2ed9903f3a09",
      "name": "System Overview",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        7952,
        224
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "etiya-gpt-4o",
          "mode": "list",
          "cachedResultName": "etiya-gpt-4o"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.1,
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4000,
        -96
      ],
      "id": "b73d1fbf-6e6b-4ba7-8a63-49f42f06ae44",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "rYdB8nNsS7m67tcr",
          "name": "OpenAi account 5"
        }
      }
    },
    {
      "parameters": {
        "content": "# Prometheus AI Agent - Chat Komutlarƒ±\n\n## üéØ Desteklenen Komutlar\n\n### 1. Derin Analiz Komutlarƒ±\nT√ºm 6 a≈üamayƒ± zorla √ßalƒ±≈ütƒ±rƒ±r, cluster saƒülƒ±klƒ± olsa bile:\n\n```\ndeep analysis\nderin analiz\nfull scan\ndetailed check\nanalyze everything\nforce check\n```\n\n**√ñrnekler:**\n- \"run deep analysis on the cluster\"\n- \"force a detailed check\"\n- \"analyze everything even if healthy\"\n\n### 2. Hƒ±zlƒ± Kontrol\nSadece Stage 1 √ßalƒ±≈üƒ±r:\n\n```\nquick check\nquick analysis\nhƒ±zlƒ± kontrol\nstatus\n```\n\n**√ñrnekler:**\n- \"quick check cluster health\"\n- \"give me a status update\"\n\n### 3. Servis Bazlƒ± Analiz\nBelirli bir servise odaklanƒ±r:\n\n```\ncheck service: <service-name>\nanalyze service: <service-name>\n```\n\n**√ñrnekler:**\n- \"check service: payment-api\"\n- \"analyze service: user-auth\"\n\n### 4. Alert Odaklƒ± Analiz\nAlert'lere odaklanarak derin analiz:\n\n```\ncheck alerts\nalert analysis\nanalyze all alerts\n```\n\n### 5. Namespace Analizi\nBelirli namespace'e odaklanƒ±r:\n\n```\nnamespace: <namespace-name>\ncheck namespace: <namespace-name>\n```\n\n**√ñrnekler:**\n- \"deep analysis namespace: etiyamobile-production\"\n- \"check namespace: staging\"\n\n### 6. Zaman Aralƒ±ƒüƒ± Belirtme\nAnaliz i√ßin zaman aralƒ±ƒüƒ±:\n\n```\nlast hour\nlast day\nlast week\n```\n\n**√ñrnekler:**\n- \"deep analysis for last hour\"\n- \"check alerts from last day\"\n\n## üìù Kombinasyon √ñrnekleri\n\n```\n# Namespace + Derin analiz\n\"run deep analysis on namespace: etiyamobile-production\"\n\n# Servis + Zaman aralƒ±ƒüƒ±\n\"check service: payment-api for last hour\"\n\n# Alert + Derin analiz\n\"deep analysis of all alerts\"\n\n# Zorla derin analiz + zaman\n\"force detailed check for last day\"\n```",
        "height": 760,
        "width": 400
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        208,
        -128
      ],
      "typeVersion": 1,
      "id": "206221f0-c98a-4597-a3a3-9dd3addce2be",
      "name": "Chat Commands Guide"
    },
    {
      "parameters": {
        "jsCode": "// Prometheus Workflow - Orchestrator Input Handler\n// Bu node Orchestrator'dan gelen veriyi i≈üler ve Prometheus'a uygun formata √ßevirir\n\n// Default production namespaces to monitor (matches Alert-Driven flow)\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\n// Default production services to monitor (from kubectl get service -A)\nconst DEFAULT_SERVICES = [\n  'bss-mc-crm-search-integrator', 'bss-mc-crm-customer-information', 'bss-mc-crm-customer-search',\n  'bss-mc-crm-mash-up', 'bss-mc-crm-ntf-integrator', 'bss-mc-activity', 'bss-mc-asset-management',\n  'bss-mc-cpq', 'bss-mc-cpq-batch', 'bss-mc-cpq-ntf-integrator', 'bss-mc-csr', 'bss-mc-domain-config',\n  'bss-mc-id-service', 'bss-mc-message-relay', 'bss-mc-ntf-engine', 'bss-mc-ntf-history', 'bss-mc-rim',\n  'bss-mc-ui-authz', 'bss-mc-user-management', 'bss-mc-wsc-new', 'bss-crm-batch', 'bss-ntf-batch',\n  'bss-mc-pcm-cfm', 'bss-mc-pcm-cms-integrator', 'bss-mc-pcm-product-catalog', 'bss-mc-pcm-product-offer-detail',\n  'bss-mc-pcm-next-gen-admintoolbox-config-manager', 'bss-mc-pcm-next-gen-admintoolbox-ui',\n  'eom-micro-flows', 'eom-operate', 'eom-scheduler', 'eom-ui', 'eom-activemqqueueoperations',\n  'eom-postgresqldboperations', 'eom-zeebe', 'eom-castlemock', 'bss-services-service',\n  'external-services-service', 'loyalty-services-service', 'om-services-service', 'fstp-bpmn-ms',\n  'fstp-configuration-ms', 'fstp-dashboard-ms', 'fstp-frontend', 'fstp-orchestra-ms', 'fstp-scheduler-ms',\n  'fstp-eca', 'eca', 'wso2am-gw-service', 'wso2am-cp-service', 'bss-saas-control-plane',\n  'bss-saas-control-plane-ui', 'bss-tenant-control-plane-batch'\n];\n\nconst input = $input.first().json;\n\n// Debug i√ßin - console.log yerine deƒüi≈ükenlere yazalƒ±m\nlet debugInfo = {\n  rawInput: JSON.stringify(input, null, 2),\n  processedAt: new Date().toISOString()\n};\n\n// Default deƒüerler\nconst defaults = {\n  timeRange: {\n    duration: 3600, // 1 saat\n    lookback: 3600\n  },\n  environment: 'k8s-prod', // Multi-namespace cluster\n  cluster: 'k8s-prod',\n  limits: {\n    maxStages: 6,\n    alertThreshold: 10\n  }\n};\n\n// Processed input olu≈ütur\nlet processedInput = {\n  // Metadata\n  source: input.source || 'direct',\n  orchestratorId: input.orchestratorId || null,\n  requestId: input.requestId || `prom-${Date.now()}`,\n  timestamp: new Date().toISOString(),\n  \n  // Time handling\n  timeRange: {\n    start: null,\n    end: null,\n    duration: null,\n    humanReadable: {}\n  },\n  \n  // Analysis configuration\n  analysisConfig: {\n    type: input.analysisType || 'metrics',\n    priority: input.priority || 'normal',\n    depth: 'standard', // light, standard, deep\n    forceDeepAnalysis: false,\n    skipHealthGate: false\n  },\n  \n  // Kubernetes-focused search parameters\n  searchParams: {\n    cluster: input.cluster || defaults.cluster,\n    namespaces: [],\n    services: [],\n    nodes: [],\n    pods: [],\n    workloadTypes: [], // deployment, statefulset, daemonset, job\n    metrics: [], // specific metrics to focus on\n    alertTypes: [],\n    resourceTypes: [] // pods, nodes, pvs, etc.\n  },\n  \n  // Feature flags\n  features: {\n    includeAlerts: true,\n    includeKnowledgeBase: true,\n    enableAutoRemediation: false,\n    compareWithHistory: false,\n    predictiveAnalysis: false,\n    sloChecking: false,\n    kubernetesHealth: true,\n    applicationMetrics: true\n  },\n  \n  // Context from orchestrator\n  context: {\n    correlationId: input.correlationId,\n    otherAgents: input.otherAgents || [],\n    userIntent: input.userIntent || '',\n    expectedOutputFormat: input.expectedOutputFormat || 'detailed'\n  }\n};\n\n// 1. TIME RANGE PROCESSING\nif (input.startTime && input.endTime) {\n  processedInput.timeRange.start = parseInt(input.startTime);\n  processedInput.timeRange.end = parseInt(input.endTime);\n  processedInput.timeRange.duration = processedInput.timeRange.end - processedInput.timeRange.start;\n  \n  processedInput.timeRange.humanReadable = {\n    start: new Date(processedInput.timeRange.start * 1000).toISOString(),\n    end: new Date(processedInput.timeRange.end * 1000).toISOString(),\n    duration: `${Math.floor(processedInput.timeRange.duration / 60)} minutes`\n  };\n} else {\n  const now = Math.floor(Date.now() / 1000);\n  processedInput.timeRange.end = now;\n  processedInput.timeRange.start = now - defaults.timeRange.lookback;\n  processedInput.timeRange.duration = defaults.timeRange.lookback;\n  \n  processedInput.timeRange.humanReadable = {\n    start: new Date(processedInput.timeRange.start * 1000).toISOString(),\n    end: new Date(processedInput.timeRange.end * 1000).toISOString(),\n    duration: `${Math.floor(processedInput.timeRange.duration / 60)} minutes`\n  };\n}\n\n// SERVICE EXTRACTION - YENƒ∞ EKLENDƒ∞\n// Servis isimlerini g√ºvenli bir ≈üekilde √ßƒ±kar\n \n// SERVICE EXTRACTION - D√úZELTME\nfunction extractServices(message) {\n  const services = [];\n  \n  // Pattern 1: Kubernetes service name pattern (namespace-component-component-...)\n  // bss-mc-crm-search-integrator gibi isimleri yakalar\n  const k8sServicePattern = /\\b([a-z0-9]+(?:-[a-z0-9]+){2,})(?:-service|-api|-svc)?\\b/gi;\n  const k8sMatches = message.matchAll(k8sServicePattern);\n  for (const match of k8sMatches) {\n    const serviceName = match[0].toLowerCase();\n    // Yaygƒ±n suffix'leri kontrol et ama servis ismi olabilir\n    if (!serviceName.endsWith('-i√ßin') && \n        !serviceName.endsWith('-analiz') && \n        !serviceName.endsWith('-servisi') &&\n        !serviceName.includes('saatlik')) {\n      services.push(serviceName);\n    }\n  }\n  \n  // Pattern 2: \"service: xxx\" veya \"servis: xxx\" formatƒ±\n  const explicitPattern = /(?:service|servis):\\s*([a-zA-Z0-9-]+)/gi;\n  const explicitMatches = message.matchAll(explicitPattern);\n  for (const match of explicitMatches) {\n    services.push(match[1].toLowerCase());\n  }\n  \n  // Pattern 3: \" servisi\" kelimesinden √∂nceki kelime\n  const turkishPattern = /([a-zA-Z0-9-]+)\\s+servisi/gi;\n  const turkishMatches = message.matchAll(turkishPattern);\n  for (const match of turkishMatches) {\n    if (!services.includes(match[1].toLowerCase())) {\n      services.push(match[1].toLowerCase());\n    }\n  }\n  \n  // Duplicate'leri kaldƒ±r\n  const uniqueServices = [...new Set(services)];\n  \n  // Debug log\n  console.log(\"Message:\", message);\n  console.log(\"Extracted services:\", uniqueServices);\n  \n  return uniqueServices;\n}\n\n// 2. PARSE USER MESSAGE for Kubernetes context\nif (input.message || input.chatInput) {\n  const message = (input.message || input.chatInput || '').toLowerCase();\n  \n  // Kubernetes Resources\n  if (message.includes('pod') || message.includes('container')) {\n    processedInput.searchParams.resourceTypes.push('pods');\n    processedInput.searchParams.metrics.push('pod_metrics');\n  }\n  if (message.includes('node')) {\n    processedInput.searchParams.resourceTypes.push('nodes');\n    processedInput.searchParams.metrics.push('node_metrics');\n  }\n  if (message.includes('deployment')) {\n    processedInput.searchParams.workloadTypes.push('deployments');\n  }\n  \n  // Kubernetes Issues\n  if (message.includes('restart') || message.includes('crashloop')) {\n    processedInput.searchParams.metrics.push('container_restarts');\n    processedInput.searchParams.alertTypes.push('KubePodCrashLooping');\n  }\n  if (message.includes('oom') || message.includes('memory')) {\n    processedInput.searchParams.metrics.push('memory_usage', 'memory_limits');\n    processedInput.searchParams.alertTypes.push('KubeMemoryOvercommit');\n  }\n\n  // Memory leak detection\n  if (message.includes('memory leak') || message.includes('bellek sƒ±zƒ±ntƒ±sƒ±')) {\n    processedInput.searchParams.metrics.push('memory_usage', 'memory_growth');\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n    processedInput.analysisConfig.priority = 'high';\n  }\n \n// Service extraction - G√úNCELLENDƒ∞\nconst extractedServices = extractServices(message);\nif (extractedServices.length > 0) {\n  processedInput.searchParams.services = extractedServices;\n  console.log(\"Extracted services:\", extractedServices);\n} else {\n  // No services extracted from message, use defaults\n  processedInput.searchParams.services = DEFAULT_SERVICES;\n  console.log(`No services in message, using DEFAULT_SERVICES: ${DEFAULT_SERVICES.length} services`);\n}\n  \n  // Application Metrics\n  if (message.includes('error rate') || message.includes('hata')) {\n    processedInput.searchParams.metrics.push('http_error_rate');\n  }\n  if (message.includes('latency') || message.includes('slow')) {\n    processedInput.searchParams.metrics.push('http_latency');\n  }\n  \n  // Analysis depth\n  if (message.includes('deep') || message.includes('detailed') || message.includes('derin')) {\n    processedInput.analysisConfig.depth = 'deep';\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n  }\n}\n\n// 3. PROCESS ORCHESTRATOR CONTEXT AND PRIORITY - √ñNEMLƒ∞ B√ñL√úM\n// Priority kontrol√º - input'tan doƒürudan gelen priority'yi kontrol et\nif (input.priority === 'critical') {\n  processedInput.analysisConfig.priority = 'critical';\n  processedInput.analysisConfig.forceDeepAnalysis = true;\n  processedInput.features.enableAutoRemediation = true;\n} else if (input.priority === 'high') {\n  processedInput.analysisConfig.priority = 'high';\n  processedInput.analysisConfig.forceDeepAnalysis = true;\n} else {\n  processedInput.analysisConfig.priority = input.priority || 'normal';\n}\n\n// Context'ten gelen priority/severity kontrol√º\nif (input.context) {\n  if (input.context.keywords && Array.isArray(input.context.keywords)) {\n    input.context.keywords.forEach(keyword => {\n      if (['payment', 'order', 'user', 'notification'].includes(keyword)) {\n        if (!processedInput.searchParams.services.includes(keyword)) {\n          processedInput.searchParams.services.push(keyword);\n        }\n      }\n    });\n  }\n  \n  // Context'ten gelen severity kontrol√º\n  if (input.context.severity === 'critical') {\n    processedInput.analysisConfig.priority = 'critical';\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n    processedInput.features.enableAutoRemediation = true;\n  } else if (input.context.severity === 'high') {\n    processedInput.analysisConfig.priority = 'high';\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n  }\n}\n\n// 4. FOCUS AREAS - Kubernetes specific\nif (input.focusAreas && Array.isArray(input.focusAreas)) {\n  input.focusAreas.forEach(area => {\n    switch(area) {\n      case 'container_health':\n        processedInput.searchParams.metrics.push(\n          'kube_pod_container_status_restarts_total',\n          'kube_pod_container_status_ready'\n        );\n        break;\n        \n      case 'resource_usage':\n        processedInput.searchParams.metrics.push(\n          'container_memory_usage_bytes',\n          'container_cpu_usage_seconds_total'\n        );\n        break;\n        \n      case 'availability':\n        processedInput.searchParams.metrics.push(\n          'up',\n          'kube_deployment_status_replicas_available'\n        );\n        processedInput.features.sloChecking = true;\n        break;\n        \n      case 'alerts':\n        processedInput.features.includeAlerts = true;\n        processedInput.analysisConfig.priority = 'high';\n        break;\n    }\n  });\n}\n\n// 5. NAMESPACE FILTERING\nif (input.namespaces && Array.isArray(input.namespaces) && input.namespaces.length > 0) {\n  processedInput.searchParams.namespaces = input.namespaces;\n} else {\n  // Default to all production namespaces\n  processedInput.searchParams.namespaces = DEFAULT_NAMESPACES;\n  console.log(`Using DEFAULT_NAMESPACES: ${DEFAULT_NAMESPACES.length} namespaces`);\n}\n\n// 6. BUILD ANALYSIS PARAMETERS for existing flow\nprocessedInput.analysisParams = {\n  cluster: processedInput.searchParams.cluster,\n  environment: 'k8s-prod', // Always use k8s-prod for multi-namespace\n  namespaceFilter: processedInput.searchParams.namespaces.join(',') || 'all',\n  timeRange: processedInput.timeRange.duration,\n  includeAlerts: processedInput.features.includeAlerts,\n  includeKnowledgeBase: processedInput.features.includeKnowledgeBase,\n  enableAutoRemediation: processedInput.features.enableAutoRemediation,\n  maxStages: processedInput.analysisConfig.depth === 'deep' ? 6 : 3,\n  forceDeepAnalysis: processedInput.analysisConfig.forceDeepAnalysis,\n  skipHealthGate: processedInput.analysisConfig.skipHealthGate,\n  analysisDepth: processedInput.analysisConfig.depth,\n  priority: processedInput.analysisConfig.priority  // √ñNEMLƒ∞: priority'yi de ekle\n};\n\n// Debug bilgilerini ekle\nprocessedInput._debug = {\n  originalInput: debugInfo.rawInput,\n  processedAt: debugInfo.processedAt,\n  timeRangeInfo: `From ${processedInput.timeRange.humanReadable.start} to ${processedInput.timeRange.humanReadable.end}`,\n  servicesFound: processedInput.searchParams.services,\n  namespacesFound: processedInput.searchParams.namespaces,\n  metricsToCheck: processedInput.searchParams.metrics,\n  analysisDepth: processedInput.analysisConfig.depth,\n  forceDeepAnalysis: processedInput.analysisConfig.forceDeepAnalysis,\n  priority: processedInput.analysisConfig.priority  // Debug i√ßin priority'yi de ekle\n};\n\nreturn [{ json: processedInput }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        -240
      ],
      "id": "62037d22-d3bc-4075-8501-c1c496a8b0e6",
      "name": "Orchestrator Input Handler"
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `(kubelet_volume_stats_used_bytes{namespace=~\"${namespaceRegex}\", persistentvolumeclaim=~\".*${svc}.*\"} / kubelet_volume_stats_capacity_bytes{namespace=~\"${namespaceRegex}\", persistentvolumeclaim=~\".*${svc}.*\"} > 0.8) * on(namespace, persistentvolumeclaim) group_left(storageclass, volumename) kube_persistentvolumeclaim_info{namespace=~\"${namespaceRegex}\", persistentvolumeclaim=~\".*${svc}.*\"} or kube_persistentvolumeclaim_status_phase{namespace=~\"${namespaceRegex}\", persistentvolumeclaim=~\".*${svc}.*\", phase!=\"Bound\"} == 1`;\n  } else {\n    return `(kubelet_volume_stats_used_bytes{namespace=~\"${namespaceRegex}\"} / kubelet_volume_stats_capacity_bytes{namespace=~\"${namespaceRegex}\"} > 0.8) * on(namespace, persistentvolumeclaim) group_left(storageclass, volumename) kube_persistentvolumeclaim_info{namespace=~\"${namespaceRegex}\"} or kube_persistentvolumeclaim_status_phase{namespace=~\"${namespaceRegex}\", phase!=\"Bound\"} == 1`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2768,
        688
      ],
      "id": "43241f6e-0439-4994-95ce-17f1c58e3e66",
      "name": "Kubernetes PVC Status"
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || '';\n\n  if (svc) {\n    return `(kube_horizontalpodautoscaler_status_current_replicas{namespace=~\"${namespaceRegex}\", horizontalpodautoscaler=~\".*${svc}.*\"} / kube_horizontalpodautoscaler_spec_max_replicas{namespace=~\"${namespaceRegex}\", horizontalpodautoscaler=~\".*${svc}.*\"}) > 0.9 or kube_horizontalpodautoscaler_status_condition{namespace=~\"${namespaceRegex}\", horizontalpodautoscaler=~\".*${svc}.*\", condition=\"ScalingLimited\", status=\"true\"} == 1`;\n  } else {\n    return `(kube_horizontalpodautoscaler_status_current_replicas{namespace=~\"${namespaceRegex}\"} / kube_horizontalpodautoscaler_spec_max_replicas{namespace=~\"${namespaceRegex}\"}) > 0.9 or (kube_horizontalpodautoscaler_status_current_replicas{namespace=~\"${namespaceRegex}\"} == kube_horizontalpodautoscaler_spec_max_replicas{namespace=~\"${namespaceRegex}\"}) or kube_horizontalpodautoscaler_status_condition{namespace=~\"${namespaceRegex}\", condition=\"ScalingLimited\", status=\"true\"} == 1`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2896,
        784
      ],
      "id": "ee2f4e6e-9151-4ee6-9dbd-a16b2cfd9362",
      "name": "Kubernetes HPA Status"
    },
    {
      "parameters": {
        "jsCode": "// Force Deep Analysis Override - Prometheus Agent - CONTEXT ENHANCED\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage1Result = $input.first().json;\n\n// Unified Entry Point'ten gelen orijinal veriyi al\nconst unifiedData = $node[\"Unified Entry Point\"].json;\n\n// Context'i al - Stage 2 Decision'dan veya Stage 1'den\nlet masterContext = stage1Result._context || {\n  contextId: `ctx-override-${Date.now()}`,\n  createdAt: new Date().toISOString(),\n  stageResults: {},\n  decisions: {},\n  debug: { warnings: ['Context recreated in Force Deep Analysis Override'] }\n};\n\n// forceDeepAnalysis kontrol√º\nconst forceDeepAnalysis = \n  unifiedData.forceDeepAnalysis || \n  unifiedData.priority === 'critical' ||\n  unifiedData.stageConfig?.forceDeepAnalysis ||\n  false;\n\n// Stage 1 sonucunu kopyala\nlet output = { ...stage1Result };\n\n// Override decision'ƒ± context'e kaydet\nconst overrideDecision = {\n  timestamp: new Date().toISOString(),\n  originalDecision: stage1Result.proceed_to_stage2,\n  forceDeepAnalysis: forceDeepAnalysis,\n  overrideApplied: false,\n  reason: null\n};\n\n// Eƒüer forceDeepAnalysis aktif ve Stage 1 proceed_to_stage2=false yapmƒ±≈üsa override et\nif (forceDeepAnalysis && !stage1Result.proceed_to_stage2) {\n  console.log('üî• PROMETHEUS - Force Deep Analysis Override Applied');\n  console.log('Original priority:', unifiedData.priority);\n  console.log('Original decision:', stage1Result.proceed_to_stage2);\n  console.log('Context ID:', masterContext.contextId);\n  \n  output.proceed_to_stage2 = true;\n  output.overridden = true;\n  output.forceDeepAnalysisApplied = true;\n  output.overrideReason = `Deep analysis forced due to ${unifiedData.priority} priority from ${unifiedData.source.type}`;\n  \n  // Override decision'ƒ± g√ºncelle\n  overrideDecision.overrideApplied = true;\n  overrideDecision.reason = output.overrideReason;\n}\n\n// Context'e override decision'ƒ± ekle\nmasterContext.decisions.forceDeepAnalysisOverride = overrideDecision;\n\n// Override node'unun √ßƒ±ktƒ±sƒ±nƒ± context'e kaydet\nmasterContext.stageResults.forceDeepAnalysisOverride = {\n  output: {\n    overrideApplied: overrideDecision.overrideApplied,\n    reason: overrideDecision.reason,\n    originalPriority: unifiedData.priority,\n    originalSource: unifiedData.source\n  },\n  completedAt: new Date().toISOString()\n};\n\n// Orijinal context'i de ta≈üƒ± ve zenginle≈ütir\noutput.originalContext = {\n  source: unifiedData.source,\n  priority: unifiedData.priority,\n  stageConfig: unifiedData.stageConfig,\n  analysisParams: unifiedData.analysisParams\n};\n\n// YENƒ∞: Context'i g√ºncelle ve ta≈üƒ±\noutput._context = masterContext;\n\n// YENƒ∞: Stage 2'ye gidecek veriyi hazƒ±rla\noutput.stage2Input = {\n  proceed: output.proceed_to_stage2,\n  priority: unifiedData.priority,\n  analysisParams: unifiedData.analysisParams,\n  timeRange: {\n    start: unifiedData.analysisParams.startTime,\n    end: unifiedData.analysisParams.endTime\n  },\n  namespaces: unifiedData.analysisParams.namespaces,\n  focusAreas: unifiedData.analysisParams.focusAreas || []\n};\n\n// YENƒ∞: Debug bilgisi\noutput._debug = {\n  nodeType: 'Force Deep Analysis Override',\n  processedAt: new Date().toISOString(),\n  contextId: masterContext.contextId,\n  contextPreserved: true,\n  overrideApplied: overrideDecision.overrideApplied,\n  stageSequence: ['Unified Entry Point', 'Stage 1', 'Stage 2 Decision', 'Force Deep Analysis Override']\n};\n\n// Critical durumlar i√ßin stage config'i g√ºncelle\nif (output.overall_status === 'critical' || output.urgency === 'critical') {\n  console.log('üî• CRITICAL STATUS DETECTED - Updating stage config');\n  \n  if (output._context && output._context.stageConfig) {\n    // √ñnceki deƒüerleri logla\n    console.log('Previous maxStages:', output._context.stageConfig.maxStages);\n    \n    // Stage config'i g√ºncelle\n    output._context.stageConfig.maxStages = 6;\n    output._context.stageConfig.enablePatternAnalysis = true;\n    output._context.stageConfig.enableAnomalyDetection = true;\n    output._context.stageConfig.enablePredictiveAnalysis = true;\n    \n    console.log('Updated maxStages to:', output._context.stageConfig.maxStages);\n    console.log('‚úÖ Stage config updated for critical situation');\n  }\n  \n  // Priority'yi de critical yap\n  if (output._context) {\n    output._context.priority = 'critical';\n    output._context.updatedDueToCriticalStatus = true;\n  }\n}\n\n// Stage 2 input'a da critical bilgisini ekle\nif (output.stage2Input && (output.overall_status === 'critical' || output.urgency === 'critical')) {\n  output.stage2Input.priority = 'critical';\n  output.stage2Input.criticalStatusDetected = true;\n}\n\n// YENI: Stage 1 verilerini koru\noutput.stage1Data = {\n  overall_status: stage1Result.overall_status || stage1Result.stage1Results?.overall_status,\n  alerts: stage1Result.alerts || stage1Result.stage1Results?.alerts,\n  scores: stage1Result.scores || stage1Result.stage1Results?.scores,\n  quick_findings: stage1Result.quick_findings || stage1Result.stage1Results?.quick_findings\n};\n\n// Stage 2 i√ßin namespace ve service filtering hazƒ±rla\nconst namespaces = unifiedData.analysisParams?.namespaces || DEFAULT_NAMESPACES;\nconst services = unifiedData.analysisParams?.services || [];\n\n// Prometheus query i√ßin regex pattern olu≈ütur\nconst namespaceRegex = namespaces.join('|');\nconst serviceRegex = services.length > 0 ? services.join('|') : '.*';\n\n// Ready-to-use query templates for Stage 2\nconst queryHelpers = {\n  namespaceFilter: `namespace=~\"${namespaceRegex}\"`,\n  serviceFilter: services.length > 0 ? `service=~\"${serviceRegex}\"` : 'service!=\"\"',\n  combinedFilter: services.length > 0\n    ? `namespace=~\"${namespaceRegex}\",service=~\"${serviceRegex}\"`\n    : `namespace=~\"${namespaceRegex}\",service!=\"\"`,\n\n  // √ñrnek kullanƒ±ma hazƒ±r sorgular\n  exampleQueries: {\n    podCount: `count by (namespace, service, pod) (up{namespace=~\"${namespaceRegex}\", service!=\"\", pod!=\"\"})`,\n    serviceList: `group by (namespace, service) (up{namespace=~\"${namespaceRegex}\", service!=\"\"})`,\n    alertCount: `ALERTS{namespace=~\"${namespaceRegex}\"}`,\n    cpuUsage: `rate(container_cpu_usage_seconds_total{namespace=~\"${namespaceRegex}\"}[5m])`,\n    memoryUsage: `container_memory_usage_bytes{namespace=~\"${namespaceRegex}\"}`\n  }\n};\n\n// Stage 2'ye gidecek parametreleri root'a ekle\noutput.namespaceRegex = namespaceRegex;\noutput.serviceRegex = serviceRegex;\noutput.queryHelpers = queryHelpers;\noutput.startTime = unifiedData.analysisParams.startTime;\noutput.endTime = unifiedData.analysisParams.endTime;\n\n// Backward compatibility i√ßin eski parametreleri de koru (deprecated)\noutput.namespace = namespaces[0] || DEFAULT_NAMESPACES[0]; // DEPRECATED: Use namespaceRegex instead\noutput.service = services[0] || ''; // DEPRECATED: Use serviceRegex instead\n\n// Stage 2 i√ßin a√ßƒ±k talimatlar\noutput.stage2Instructions = {\n  namespaces: namespaces,\n  services: services,\n  namespaceRegex: namespaceRegex,\n  serviceRegex: serviceRegex,\n  message: services.length > 0\n    ? `Focus on ${services.length} service(s) across ${namespaces.length} namespace(s)`\n    : `General cluster analysis across ${namespaces.length} namespace(s)`\n};\n\nconsole.log('=== Stage 2 Query Parameters ===');\nconsole.log('Namespaces:', namespaces.length, 'namespaces');\nconsole.log('Services:', services.length, 'services');\nconsole.log('Namespace regex:', namespaceRegex);\nconsole.log('Query helpers generated:', Object.keys(queryHelpers));\nconsole.log('================================');\n\nconsole.log('=== Force Deep Analysis Override Complete ===');\nconsole.log('Context preserved:', !!output._context);\nconsole.log('Override applied:', overrideDecision.overrideApplied);\nconsole.log('Next stage will receive full context');\n\nreturn [{ json: output }];"
      },
      "id": "c57b34bc-4a89-49c9-8645-252fd85c6662",
      "name": "Force Deep Analysis Override",
      "type": "n8n-nodes-base.code",
      "position": [
        2672,
        128
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Prepare Stage 1 Input - Ensure context is properly passed\nconst unifiedOutput = $input.first().json;\n\nconsole.log(\"=== PREPARING STAGE 1 INPUT ===\");\nconsole.log(\"Context ID:\", unifiedOutput._context?.contextId);\nconsole.log(\"Context exists:\", !!unifiedOutput._context);\nconsole.log(\"Full context:\", JSON.stringify(unifiedOutput._context, null, 2));\n\n// Namespace ve service filtering i√ßin ready-to-use strings hazƒ±rla\nconst namespaces = unifiedOutput._context?.initialParams?.namespaces || [];\nconst services = unifiedOutput._context?.initialParams?.services || [];\n\n// Prometheus query i√ßin regex pattern olu≈ütur\nconst namespaceRegex = namespaces.join('|');\nconst serviceRegex = services.length > 0 ? services.join('|') : '.*';\n\n// Ready-to-use query templates\nconst queryHelpers = {\n  namespaceFilter: `namespace=~\"${namespaceRegex}\"`,\n  serviceFilter: services.length > 0 ? `service=~\"${serviceRegex}\"` : 'service!=\"\"',\n  combinedFilter: services.length > 0\n    ? `namespace=~\"${namespaceRegex}\",service=~\"${serviceRegex}\"`\n    : `namespace=~\"${namespaceRegex}\",service!=\"\"`,\n\n  // √ñrnek kullanƒ±ma hazƒ±r sorgular\n  exampleQueries: {\n    podCount: `count by (namespace, service, pod) (up{namespace=~\"${namespaceRegex}\", service!=\"\", pod!=\"\"})`,\n    serviceList: `group by (namespace, service) (up{namespace=~\"${namespaceRegex}\", service!=\"\"})`,\n    alertCount: `ALERTS{namespace=~\"${namespaceRegex}\"}`\n  }\n};\n\nconsole.log(\"Generated query helpers:\", queryHelpers);\n\n// Stage 1 i√ßin input hazƒ±rla\nconst stage1Input = {\n  ...unifiedOutput,\n  // Context'i root level'a da koy\n  contextId: unifiedOutput._context.contextId,\n  contextData: unifiedOutput._context,\n\n  // Query helpers - AI agent kullanabilsin\n  queryHelpers: queryHelpers,\n  namespaceRegex: namespaceRegex,\n  serviceRegex: serviceRegex,\n\n  // Debug i√ßin\n  _inputPrepared: true,\n  _preparedAt: new Date().toISOString()\n};\n\nconsole.log(\"Stage 1 will receive:\", JSON.stringify(stage1Input, null, 2).substring(0, 500) + \"...\");\nconsole.log(\"==============================\");\n\nreturn [{\n  json: stage1Input\n}];"
      },
      "id": "306172d6-d7f3-48cb-9a22-94dde2733258",
      "name": "Prepare Stage 1 Input",
      "type": "n8n-nodes-base.code",
      "position": [
        1488,
        192
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 1 Context - Correct the context after AI Agent output\nconst stage1Output = $input.first().json;\nconst unifiedData = $node[\"Unified Entry Point\"].json;\nconst preparedData = $node[\"Prepare Stage 1 Input\"].json;\n\nconsole.log(\"=== FIXING STAGE 1 CONTEXT ===\");\nconsole.log(\"Stage 1 output structure:\", stage1Output.output ? \"Has output wrapper\" : \"Direct output\");\nconsole.log(\"Expected context ID:\", unifiedData._context.contextId);\n\n// Deep copy to avoid mutations\nlet fixedOutput = JSON.parse(JSON.stringify(stage1Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\n// Context'i kontrol et ve d√ºzelt\nif (actualOutput._context) {\n  const contextString = JSON.stringify(actualOutput._context);\n  const hasTemplates = contextString.includes(\"{{\") || contextString.includes(\"}}\");\n  const hasJsonReference = contextString.includes(\"$json\");\n  \n  console.log(\"Context has templates:\", hasTemplates);\n  console.log(\"Context has $json references:\", hasJsonReference);\n  \n  if (hasTemplates || hasJsonReference || \n      !actualOutput._context.contextId || \n      actualOutput._context.contextId === \"{{ $json.contextId }}\" ||\n      actualOutput._context.contextId === \"12345\" ||\n      actualOutput._context.contextId === \"abc-123\") {\n    \n    console.log(\"‚ùå Invalid context detected, fixing...\");\n    \n    // Doƒüru context'i koy - deep copy ile\n    actualOutput._context = JSON.parse(JSON.stringify(unifiedData._context));\n    \n    console.log(\"‚úÖ Context replaced with correct one\");\n  }\n} else {\n  console.log(\"‚ùå No context found, adding...\");\n  actualOutput._context = JSON.parse(JSON.stringify(unifiedData._context));\n}\n\n// Debug'ƒ± da d√ºzelt\nif (actualOutput._debug) {\n  const debugString = JSON.stringify(actualOutput._debug);\n  if (debugString.includes(\"{{\") || debugString.includes(\"$json\") || \n      actualOutput._debug.contextId !== unifiedData._context.contextId) {\n    \n    actualOutput._debug.contextId = unifiedData._context.contextId;\n    actualOutput._debug.contextFixed = true;\n    actualOutput._debug.fixedAt = new Date().toISOString();\n    actualOutput._debug.receivedFromSource = unifiedData.source.type;\n    actualOutput._debug.priority = unifiedData.priority;\n  }\n}\n\n// Context'i ba≈ülat\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Stage 1 sonu√ßlarƒ±nƒ± context'e kaydet - sadece bu stage'in verisi\nactualOutput._context.stageResults.stage1 = {\n  output: {\n    overall_status: actualOutput.overall_status,\n    alerts: actualOutput.alerts,\n    scores: actualOutput.scores,\n    quick_findings: actualOutput.quick_findings,\n    services_analyzed: actualOutput.services_analyzed,\n    services_count: actualOutput.services_count,\n    namespaces_analyzed: actualOutput.namespaces_analyzed,\n    proceed_to_stage2: actualOutput.proceed_to_stage2,\n    urgency: actualOutput.urgency,\n    reason: actualOutput.reason,\n    forceDeepAnalysis: actualOutput.forceDeepAnalysis,\n    overridden: actualOutput.overridden\n  },\n  completedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  decision: actualOutput.proceed_to_stage2,\n  status: actualOutput.overall_status,\n  alerts: actualOutput.alerts?.total || 0\n};\n\n// Root level'a context bilgilerini ekle\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = unifiedData._context.contextId;\nfixedOutput._contextFixed = true;\nfixedOutput._fixedAt = new Date().toISOString();\n\n// Stage 1 verilerini root'a ekle (kolay eri≈üim i√ßin)\nfixedOutput.stage1Data = {\n  overall_status: actualOutput.overall_status,\n  alerts: JSON.parse(JSON.stringify(actualOutput.alerts)),\n  scores: JSON.parse(JSON.stringify(actualOutput.scores)),\n  quick_findings: JSON.parse(JSON.stringify(actualOutput.quick_findings)),\n  services_analyzed: JSON.parse(JSON.stringify(actualOutput.services_analyzed || [])),\n  services_count: actualOutput.services_count || 0,\n  namespaces_analyzed: JSON.parse(JSON.stringify(actualOutput.namespaces_analyzed || [])),\n  proceed_to_stage2: actualOutput.proceed_to_stage2,\n  urgency: actualOutput.urgency,\n  reason: actualOutput.reason\n};\n\n// Validation\nconst contextFixed = actualOutput._context?.contextId === unifiedData._context.contextId;\nconst rootContextFixed = fixedOutput._context?.contextId === unifiedData._context.contextId;\n\nconsole.log(\"==============================\");\nconsole.log(\"Stage 1 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Proceed to stage 2:\", actualOutput.proceed_to_stage2);\nconsole.log(\"- Overall status:\", actualOutput.overall_status);\nconsole.log(\"- Total alerts:\", actualOutput.alerts?.total);\nconsole.log(\"- Context fixed:\", contextFixed && rootContextFixed);\n\nif (contextFixed && rootContextFixed) {\n  console.log(\"‚úÖ Context successfully fixed in both locations!\");\n} else {\n  console.error(\"‚ö†Ô∏è Context fix validation failed!\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n  fromNode: \"Fix Stage 1 Context\",\n  contextFixed: true,\n  originalHadTemplates: JSON.stringify(stage1Output).includes(\"{{\"),\n  stage1Decision: actualOutput.proceed_to_stage2,\n  stage1Status: actualOutput.overall_status,\n  stage1Alerts: actualOutput.alerts?.total,\n  timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if it existed\nif (hasOutputWrapper) {\n  fixedOutput.output = actualOutput;\n}\n\nreturn [{\n  json: fixedOutput\n}];"
      },
      "id": "b7e5c8c2-3385-4475-a262-7164c1de441c",
      "name": "Fix Stage 1 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        2016,
        272
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 2 Context - Circular Reference Safe Version\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage2Output = $input.first().json;\nconst previousData = $node[\"Force Deep Analysis Override\"].json;\nconst stage1FixData = $node[\"Fix Stage 1 Context\"].json;\n\nconsole.log(\"=== FIXING STAGE 2 CONTEXT ===\");\nconsole.log(\"Stage 2 output received\");\n\n// Helper function - Safe JSON stringify to handle circular references\nfunction safeStringify(obj) {\n  const seen = new WeakSet();\n  return JSON.stringify(obj, (key, value) => {\n    if (typeof value === \"object\" && value !== null) {\n      if (seen.has(value)) {\n        return \"[Circular]\";\n      }\n      seen.add(value);\n    }\n    return value;\n  });\n}\n\n// Helper function - Safe parse\nfunction safeParse(str) {\n  return JSON.parse(str, (key, value) => {\n    if (value === \"[Circular]\") {\n      return null;\n    }\n    return value;\n  });\n}\n\n// Deep copy with circular reference handling\nlet fixedOutput = safeParse(safeStringify(stage2Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\n// Get expected context ID safely\nconst expectedContextId = previousData?._context?.contextId || `ctx-${Date.now()}`;\nconsole.log(\"Expected context ID:\", expectedContextId);\n\n// Context kontrol√º ve d√ºzeltme\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId ||\n    actualOutput._context.contextId === \"abc123\" || \n    actualOutput._context.contextId === \"12345\") {\n    \n    console.log(\"‚ùå Invalid or missing context in Stage 2, fixing...\");\n    \n    // Create a clean context copy\n    actualOutput._context = {\n      contextId: expectedContextId,\n      createdAt: previousData._context?.createdAt || new Date().toISOString(),\n      source: previousData._context?.source || {},\n      initialParams: previousData._context?.initialParams || {},\n      stageConfig: previousData._context?.stageConfig || {},\n      priority: previousData._context?.priority || \"normal\",\n      forceDeepAnalysis: previousData._context?.forceDeepAnalysis || false,\n      workflowMetadata: previousData._context?.workflowMetadata || {},\n      stageResults: {},\n      decisions: previousData._context?.decisions || {},\n      debug: previousData._context?.debug || {}\n    };\n    \n    console.log(\"‚úÖ Context replaced with clean copy\");\n}\n\n// Initialize stageResults if needed\nif (!actualOutput._context.stageResults) {\n    actualOutput._context.stageResults = {};\n}\n\n// Add Stage 1 results if available (from previous context)\nif (previousData._context?.stageResults?.stage1) {\n    actualOutput._context.stageResults.stage1 = {\n        output: {\n            overall_status: previousData._context.stageResults.stage1.output?.overall_status,\n            alerts: previousData._context.stageResults.stage1.output?.alerts,\n            scores: previousData._context.stageResults.stage1.output?.scores,\n            quick_findings: previousData._context.stageResults.stage1.output?.quick_findings,\n            proceed_to_stage2: previousData._context.stageResults.stage1.output?.proceed_to_stage2\n        },\n        completedAt: previousData._context.stageResults.stage1.completedAt,\n        decision: previousData._context.stageResults.stage1.decision\n    };\n}\n\n// Add Stage 2 results - clean copy only\nactualOutput._context.stageResults.stage2 = {\n    output: {\n        investigation_id: actualOutput.investigation_id,\n        triggered_by: actualOutput.triggered_by,\n        execution_phases: {\n            instant: actualOutput.execution_phases?.instant || {},\n            trend: actualOutput.execution_phases?.trend || {},\n            anomaly: actualOutput.execution_phases?.anomaly || {}\n        },\n        correlation_matrix: {\n            primary_chain: actualOutput.correlation_matrix?.primary_chain || \"\",\n            affected_services: actualOutput.correlation_matrix?.affected_services || [],\n            blast_radius: actualOutput.correlation_matrix?.blast_radius || \"\",\n            kubernetes_impact: actualOutput.correlation_matrix?.kubernetes_impact || {}\n        },\n        root_cause: {\n            identified: actualOutput.root_cause?.identified || false,\n            component: actualOutput.root_cause?.component || \"\",\n            issue: actualOutput.root_cause?.issue || \"\",\n            evidence: actualOutput.root_cause?.evidence || [],\n            confidence: actualOutput.root_cause?.confidence || 0\n        },\n        proceed_to_stage3: actualOutput.proceed_to_stage3,\n        alert_correlation_needed: actualOutput.alert_correlation_needed\n    },\n    completedAt: new Date().toISOString(),\n    decision: actualOutput.proceed_to_stage3,\n    rootCauseIdentified: actualOutput.root_cause?.identified || false,\n    confidence: actualOutput.root_cause?.confidence || 0\n};\n\n// Update debug info\nactualOutput._debug = {\n    nodeType: \"Stage 2: Deep Analysis\",\n    processedAt: new Date().toISOString(),\n    contextId: expectedContextId,\n    contextPreserved: true,\n    receivedFromStage: \"Force Deep Analysis Override\",\n    priority: previousData._context?.priority || \"normal\",\n    stageSequence: [\n        \"Unified Entry Point\",\n        \"Stage 1: Health Snapshot\", \n        \"Fix Stage 1 Context\",\n        \"Stage 2 Decision\",\n        \"Force Deep Analysis Override\",\n        \"Wait 3s\",\n        \"Stage 2: Deep Analysis\",\n        \"Fix Stage 2 Context\"\n    ],\n    timeRangeUsed: {\n        start: previousData._context?.initialParams?.startTime || 0,\n        end: previousData._context?.initialParams?.endTime || 0\n    }\n};\n\n// Create clean root level context\nfixedOutput._context = {\n    contextId: expectedContextId,\n    createdAt: actualOutput._context.createdAt,\n    source: actualOutput._context.source,\n    initialParams: actualOutput._context.initialParams,\n    stageConfig: actualOutput._context.stageConfig,\n    priority: actualOutput._context.priority,\n    forceDeepAnalysis: actualOutput._context.forceDeepAnalysis,\n    workflowMetadata: actualOutput._context.workflowMetadata,\n    stageResults: actualOutput._context.stageResults,\n    decisions: actualOutput._context.decisions,\n    debug: actualOutput._context.debug\n};\n\nfixedOutput.contextId = expectedContextId;\n\n// Get Stage 1 data from previous nodes\nlet stage1Data = null;\n\n// Try to get from previousData first\nif (previousData.stage1Data) {\n    stage1Data = {\n        overall_status: previousData.stage1Data.overall_status,\n        alerts: previousData.stage1Data.alerts,\n        scores: previousData.stage1Data.scores,\n        quick_findings: previousData.stage1Data.quick_findings || [],\n        services_analyzed: previousData.stage1Data.services_analyzed || [],\n        services_count: previousData.stage1Data.services_count || 0,\n        namespaces_analyzed: previousData.stage1Data.namespaces_analyzed || [],\n        proceed_to_stage2: previousData.stage1Data.proceed_to_stage2,\n        urgency: previousData.stage1Data.urgency,\n        reason: previousData.stage1Data.reason\n    };\n    console.log(\"‚úì Stage 1 data found in previousData.stage1Data\");\n} else if (stage1FixData?.stage1Data) {\n    stage1Data = {\n        overall_status: stage1FixData.stage1Data.overall_status,\n        alerts: stage1FixData.stage1Data.alerts,\n        scores: stage1FixData.stage1Data.scores,\n        quick_findings: stage1FixData.stage1Data.quick_findings || [],\n        services_analyzed: stage1FixData.stage1Data.services_analyzed || [],\n        services_count: stage1FixData.stage1Data.services_count || 0,\n        namespaces_analyzed: stage1FixData.stage1Data.namespaces_analyzed || [],\n        proceed_to_stage2: stage1FixData.stage1Data.proceed_to_stage2,\n        urgency: stage1FixData.stage1Data.urgency,\n        reason: stage1FixData.stage1Data.reason\n    };\n    console.log(\"‚úì Stage 1 data found in Fix Stage 1 Context\");\n} else if (actualOutput._context?.stageResults?.stage1?.output) {\n    const s1Output = actualOutput._context.stageResults.stage1.output;\n    stage1Data = {\n        overall_status: s1Output.overall_status,\n        alerts: s1Output.alerts,\n        scores: s1Output.scores,\n        quick_findings: s1Output.quick_findings || [],\n        services_analyzed: s1Output.services_analyzed || [],\n        services_count: s1Output.services_count || 0,\n        namespaces_analyzed: s1Output.namespaces_analyzed || [],\n        proceed_to_stage2: s1Output.proceed_to_stage2,\n        urgency: s1Output.urgency,\n        reason: s1Output.reason\n    };\n    console.log(\"‚úì Stage 1 data extracted from context.stageResults\");\n}\n\n// Add Stage 1 data to output\nif (stage1Data) {\n    fixedOutput.stage1Data = stage1Data;\n    console.log(\"‚úÖ Stage 1 data successfully attached\");\n} else {\n    console.warn(\"‚ö†Ô∏è No Stage 1 data found - creating minimal structure\");\n    fixedOutput.stage1Data = {\n        overall_status: \"unknown\",\n        alerts: { total: 0, critical: 0, warning: 0 },\n        scores: {},\n        quick_findings: [],\n        services_analyzed: [],\n        services_count: 0,\n        namespaces_analyzed: []\n    };\n}\n\n// Add Stage 2 data to output - clean copy\nfixedOutput.stage2Data = {\n    investigation_id: actualOutput.investigation_id,\n    root_cause: {\n        identified: actualOutput.root_cause?.identified || false,\n        component: actualOutput.root_cause?.component || \"\",\n        issue: actualOutput.root_cause?.issue || \"\",\n        evidence: actualOutput.root_cause?.evidence || [],\n        confidence: actualOutput.root_cause?.confidence || 0\n    },\n    correlation_matrix: {\n        primary_chain: actualOutput.correlation_matrix?.primary_chain || \"\",\n        affected_services: actualOutput.correlation_matrix?.affected_services || [],\n        blast_radius: actualOutput.correlation_matrix?.blast_radius || \"\",\n        kubernetes_impact: actualOutput.correlation_matrix?.kubernetes_impact || {}\n    },\n    critical_pods: actualOutput.execution_phases?.instant?.findings?.critical_pods || [],\n    affected_services: actualOutput.correlation_matrix?.affected_services || [],\n    proceed_to_stage3: actualOutput.proceed_to_stage3,\n    alert_correlation_needed: actualOutput.alert_correlation_needed,\n    confidence: actualOutput.root_cause?.confidence || 0\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n    actualOutput._context.decisions = {};\n}\n\nactualOutput._context.decisions.stage3Proceed = {\n    timestamp: new Date().toISOString(),\n    shouldProceed: actualOutput.proceed_to_stage3,\n    alertCorrelationNeeded: actualOutput.alert_correlation_needed,\n    rootCauseIdentified: actualOutput.root_cause?.identified || false,\n    confidence: actualOutput.root_cause?.confidence || 0\n};\n\n// Add namespace and time range info\nfixedOutput.namespaces = previousData._context?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n    start: previousData._context?.initialParams?.startTime || 0,\n    end: previousData._context?.initialParams?.endTime || 0\n};\n\n// Summary logging\nconsole.log(\"==============================\");\nconsole.log(\"Stage 2 Fix Summary:\");\nconsole.log(\"- Context ID:\", expectedContextId);\nconsole.log(\"- Stage 1 data included:\", !!fixedOutput.stage1Data);\nconsole.log(\"- Stage 2 data prepared:\", !!fixedOutput.stage2Data);\nconsole.log(\"- Root cause identified:\", actualOutput.root_cause?.identified);\nconsole.log(\"- Proceed to Stage 3:\", actualOutput.proceed_to_stage3);\n\n// Validation\nconst validationPassed = \n    fixedOutput._context?.contextId === expectedContextId &&\n    !!fixedOutput.stage1Data &&\n    !!fixedOutput.stage2Data;\n\nif (validationPassed) {\n    console.log(\"‚úÖ Stage 2 context successfully fixed and validated!\");\n} else {\n    console.error(\"‚ö†Ô∏è Stage 2 validation warnings\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n    fromNode: \"Fix Stage 2 Context\",\n    contextFixed: true,\n    validationPassed: validationPassed,\n    stage1DataSource: stage1Data ? \"found\" : \"created\",\n    stage2RootCause: actualOutput.root_cause?.issue,\n    stage2Decision: actualOutput.proceed_to_stage3,\n    timestamp: new Date().toISOString()\n};\n\n// Clean output wrapper if needed\nif (hasOutputWrapper) {\n    // Don't include the nested output to avoid circular reference\n    fixedOutput.outputProcessed = true;\n}\n\nreturn [{\n    json: fixedOutput\n}];"
      },
      "id": "0e62f582-b5c8-4091-b827-e5acc3ebc3d8",
      "name": "Fix Stage 2 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        3712,
        272
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 3 Context - Optimized without circular references\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage3Output = $input.first().json;\n\n// Stage 2'den gelen context ve data'yƒ± al\nconst stage2Data = $node[\"Fix Stage 2 Context\"].json;\nconst previousContext = stage2Data._context;\n\nconsole.log(\"=== FIXING STAGE 3 CONTEXT ===\");\nconsole.log(\"Previous context ID:\", previousContext?.contextId);\n\n// Deep copy\nlet fixedOutput = JSON.parse(JSON.stringify(stage3Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\nconsole.log(\"Has output wrapper:\", hasOutputWrapper);\n\n// ============= SLO DEƒûERLERINI D√úZELT =============\nif (actualOutput.slo_impact) {\n  if (actualOutput.slo_impact.availability_slo) {\n    const slo = actualOutput.slo_impact.availability_slo;\n    \n    if (!slo.current || slo.current === \"NaN%\" || slo.current === \"null%\" || slo.current === \"undefined%\") {\n      slo.current = \"100%\";\n    }\n    \n    if (!slo.error_budget_used || slo.error_budget_used === \"NaN%\" || slo.error_budget_used === \"null%\") {\n      slo.error_budget_used = \"0%\";\n    }\n    \n    if (!slo.time_remaining || slo.time_remaining === \"null\" || slo.time_remaining === \"undefined\") {\n      slo.time_remaining = \"30d\";\n    }\n    \n    if (!slo.status || ![\"green\", \"yellow\", \"red\"].includes(slo.status)) {\n      const currentValue = parseFloat(slo.current);\n      if (currentValue >= 99.9) {\n        slo.status = \"green\";\n      } else if (currentValue >= 99.0) {\n        slo.status = \"yellow\";\n      } else {\n        slo.status = \"red\";\n      }\n    }\n    \n    if (!slo.components) {\n      slo.components = { deployment_health: \"100%\" };\n    }\n  }\n  \n  if (!Array.isArray(actualOutput.slo_impact.affected_slis)) {\n    actualOutput.slo_impact.affected_slis = [];\n  }\n}\n\n// ============= ALERT KB ENRICHMENT =============\nlet alertKB = [];\nlet severityScores = {\n  \"Blocker\": 100,\n  \"Critical\": 80,\n  \"High\": 60,\n  \"Medium\": 40,\n  \"Low\": 20\n};\n\n// Load Alert Knowledge Base if available\ntry {\n  const alertKBNode = $node[\"Load Alert Knowledge Base\"];\n  if (alertKBNode?.json?._alertKBData) {\n    alertKB = alertKBNode.json._alertKBData;\n    // CRITICAL FIX: Ensure alertKB is always an array\n    if (!Array.isArray(alertKB)) {\n      console.log(\"‚ö†Ô∏è alertKB is not an array, converting to array:\", typeof alertKB);\n      alertKB = [];\n    }\n    if (alertKBNode.json._severityScores) {\n      severityScores = alertKBNode.json._severityScores;\n    }\n    console.log(\"Alert KB loaded:\", alertKB.length, \"entries\");\n  }\n} catch (e) {\n  console.log(\"Alert KB not available, using empty KB:\", e.message);\n  alertKB = []; // CRITICAL FIX: Ensure alertKB is always an array even on error\n}\n\n// Helper functions\nfunction enrichAlertWithKB(alert, alertKB) {\n  const kbEntry = alertKB.find(kb => {\n    if (kb.alertName === alert.name) return true;\n    if (alert.name && kb.alertName && alert.name.includes(kb.alertName)) return true;\n    if (alert.name && kb.alertName && kb.alertName.includes(alert.name)) return true;\n    return false;\n  });\n  \n  if (kbEntry) {\n    return {\n      ...alert,\n      kb_enriched: true,\n      kb_severity: kbEntry.severity,\n      kb_description: kbEntry.description,\n      kb_root_causes: kbEntry.rootCauses,\n      kb_diagnostic_commands: kbEntry.diagnosticCommands,\n      kb_immediate_actions: kbEntry.immediateActions,\n      severity_score: severityScores[kbEntry.severity] || 50,\n      severity: alert.severity || kbEntry.severity\n    };\n  }\n  \n  return {\n    ...alert,\n    kb_enriched: false,\n    severity_score: severityScores[alert.severity] || 30\n  };\n}\n\nfunction calculateServiceImpact(alertName, severity) {\n  let impactMultiplier = 1;\n  \n  if (alertName.includes('etcd')) {\n    impactMultiplier = 2;\n  } else if (alertName.includes('KubeAPI') || alertName.includes('APIServer')) {\n    impactMultiplier = 1.5;\n  } else if (alertName.includes('KubeController') || alertName.includes('KubeScheduler')) {\n    impactMultiplier = 1.4;\n  } else if (alertName.includes('Node')) {\n    impactMultiplier = 1.3;\n  } else if (alertName.includes('Pod') || alertName.includes('Container')) {\n    impactMultiplier = 0.8;\n  }\n  \n  const baseScore = severityScores[severity] || 50;\n  return Math.round(baseScore * impactMultiplier);\n}\n\n// Process alerts\nif (!Array.isArray(actualOutput.active_alerts)) {\n  actualOutput.active_alerts = [];\n} else {\n  actualOutput.active_alerts = actualOutput.active_alerts.map(alert => {\n    const validatedAlert = {\n      name: alert.name || \"Unknown Alert\",\n      severity: alert.severity || \"unknown\",\n      count: typeof alert.count === 'number' ? alert.count : 0,\n      duration: alert.duration || \"unknown\",\n      labels: alert.labels || {},\n      annotations: alert.annotations || {}\n    };\n    \n    const enrichedAlert = enrichAlertWithKB(validatedAlert, alertKB);\n    enrichedAlert.impact_score = calculateServiceImpact(\n      enrichedAlert.name, \n      enrichedAlert.kb_severity || enrichedAlert.severity\n    );\n    \n    return enrichedAlert;\n  });\n  \n  actualOutput.active_alerts.sort((a, b) => b.impact_score - a.impact_score);\n}\n\nconsole.log(\"=== ALERT ENRICHMENT COMPLETE ===\");\nconsole.log(\"Enriched alerts:\", actualOutput.active_alerts.filter(a => a.kb_enriched).length);\n\n// Process alert groups\nif (!Array.isArray(actualOutput.alert_groups)) {\n  actualOutput.alert_groups = [];\n}\n\n// Knowledge base matches\nactualOutput.knowledge_base_matches = actualOutput.active_alerts\n  .filter(alert => alert.kb_enriched)\n  .map(alert => ({\n    alert: alert.name,\n    kb_entry: {\n      severity: alert.kb_severity,\n      description: alert.kb_description,\n      root_causes: alert.kb_root_causes || [],\n      diagnostic_commands: alert.kb_diagnostic_commands || [],\n      immediate_actions: alert.kb_immediate_actions || [],\n      long_term_solutions: alert.kb_long_term_solutions || []\n    },\n    applicability_score: 0.9,\n    impact_score: alert.impact_score\n  }));\n\n// Alert patterns\nif (!actualOutput.alert_patterns) {\n  actualOutput.alert_patterns = {\n    recurring: [],\n    storm_detection: {\n      detected: false,\n      alert_count: 0,\n      time_window: \"5m\",\n      likely_root: null\n    }\n  };\n}\n\n// Recommended actions\nif (!Array.isArray(actualOutput.recommended_alert_actions)) {\n  actualOutput.recommended_alert_actions = [];\n}\n\n// ============= CORRELATION CONFIDENCE VALIDATION =============\n// Validate correlation_confidence field (added in Stage 3 prompt improvements)\nif (typeof actualOutput.correlation_confidence !== 'number' || \n    actualOutput.correlation_confidence < 0 || \n    actualOutput.correlation_confidence > 1) {\n  \n  // Calculate fallback correlation_confidence if AI didn't provide it\n  let confidence = 0;\n  \n  // Factor 1: Alert-to-Stage2 Correlation (+0.3)\n  if (stage2Data?.stage2Data?.root_cause?.component) {\n    const stage2Component = stage2Data.stage2Data.root_cause.component;\n    const alertsMatchStage2 = actualOutput.active_alerts?.some(alert => \n      alert.labels?.pod?.includes(stage2Component) || \n      alert.labels?.namespace === stage2Data._context?.initialParams?.namespaces?.[0]\n    );\n    confidence += alertsMatchStage2 ? 0.3 : 0.1;\n  }\n  \n  // Factor 2: Knowledge Base Coverage (+0.3)\n  const kbCoverage = actualOutput.active_alerts?.length > 0 \n    ? actualOutput.active_alerts.filter(a => a.kb_enriched).length / actualOutput.active_alerts.length \n    : 0;\n  if (kbCoverage === 1.0) confidence += 0.3;\n  else if (kbCoverage >= 0.75) confidence += 0.2;\n  else if (kbCoverage >= 0.5) confidence += 0.1;\n  else if (kbCoverage > 0) confidence += 0.05;\n  \n  // Factor 3: Alert Group Quality (+0.2)\n  const hasRootAlert = actualOutput.alert_groups?.some(g => g.root_alert && g.related_alerts?.length >= 3);\n  if (hasRootAlert) confidence += 0.2;\n  else if (actualOutput.alert_groups?.some(g => g.related_alerts?.length >= 1)) confidence += 0.1;\n  \n  // Factor 4: SLO Impact Clarity (+0.2)\n  const sloComponents = actualOutput.slo_impact?.availability_slo?.components;\n  if (sloComponents && Object.keys(sloComponents).length >= 4) confidence += 0.2;\n  else if (sloComponents && Object.keys(sloComponents).length >= 2) confidence += 0.1;\n  else if (sloComponents && Object.keys(sloComponents).length === 1) confidence += 0.05;\n  \n  actualOutput.correlation_confidence = Math.min(1.0, Math.max(0.0, confidence));\n  console.log(\"‚ö†Ô∏è correlation_confidence calculated as fallback:\", actualOutput.correlation_confidence);\n}\n\n// Boolean fields\nif (typeof actualOutput.proceed_to_stage4 !== 'boolean') {\n  actualOutput.proceed_to_stage4 = actualOutput.active_alerts?.length > 0 ||\n    actualOutput.active_alerts?.some(a => \n      a.kb_severity === \"Critical\" || a.kb_severity === \"Blocker\"\n    );\n}\n\nif (typeof actualOutput.auto_remediation_approved !== 'boolean') {\n  actualOutput.auto_remediation_approved = \n    actualOutput.active_alerts.every(alert => \n      !alert.kb_severity || \n      alert.kb_severity === \"Low\" || \n      alert.kb_severity === \"Medium\"\n    );\n}\n\n// ============= CONTEXT FIX =============\nconst expectedContextId = previousContext?.contextId;\n\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId ||\n    actualOutput._context.contextId === \"abc123\") {\n    \n  console.log(\"‚ùå Invalid or missing context, fixing...\");\n  \n  // Deep copy of previous context\n  const contextCopy = JSON.parse(JSON.stringify(previousContext));\n  \n  // Preserve existing stage results if any\n  if (contextCopy.stageResults) {\n    // Keep stage 1 and 2 results\n  } else {\n    contextCopy.stageResults = {};\n  }\n  \n  actualOutput._context = contextCopy;\n  console.log(\"‚úÖ Context replaced\");\n}\n\n// Ensure stageResults exists\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Add Stage 3 results - only this stage's data\nactualOutput._context.stageResults.stage3 = {\n  output: {\n    active_alerts: JSON.parse(JSON.stringify(actualOutput.active_alerts)),\n    alert_groups: JSON.parse(JSON.stringify(actualOutput.alert_groups)),\n    knowledge_base_matches: JSON.parse(JSON.stringify(actualOutput.knowledge_base_matches)),\n    alert_patterns: JSON.parse(JSON.stringify(actualOutput.alert_patterns)),\n    slo_impact: JSON.parse(JSON.stringify(actualOutput.slo_impact)),\n    recommended_alert_actions: JSON.parse(JSON.stringify(actualOutput.recommended_alert_actions)),\n    correlation_confidence: actualOutput.correlation_confidence,\n    proceed_to_stage4: actualOutput.proceed_to_stage4,\n    auto_remediation_approved: actualOutput.auto_remediation_approved\n  },\n  completedAt: new Date().toISOString(),\n  decision: actualOutput.proceed_to_stage4\n};\n\n// Update debug info\nactualOutput._debug = {\n  nodeType: \"Stage 3: Alert Intelligence\",\n  processedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  contextId: expectedContextId,\n  contextPreserved: true,\n  receivedFromStage: \"Fix Stage 2 Context\",\n  priority: previousContext?.priority || \"normal\",\n  sloToolErrors: actualOutput._debug?.sloToolErrors || [],\n  stageSequence: [\n    \"Unified Entry Point\",\n    \"Stage 1: Health Snapshot\", \n    \"Fix Stage 1 Context\",\n    \"Stage 2 Decision\",\n    \"Force Deep Analysis Override\",\n    \"Wait 3s\",\n    \"Stage 2: Deep Analysis\",\n    \"Fix Stage 2 Context\",\n    \"Stage 3: Alert Intelligence\",\n    \"Fix Stage 3 Context\"\n  ],\n  timeRangeUsed: {\n    start: previousContext?.initialParams?.startTime || 0,\n    end: previousContext?.initialParams?.endTime || 0\n  }\n};\n\n// Update root level context\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = expectedContextId;\n\n// Stage 3 summary data\nfixedOutput.stage3Data = {\n  active_alerts: JSON.parse(JSON.stringify(actualOutput.active_alerts || [])),\n  alert_groups: JSON.parse(JSON.stringify(actualOutput.alert_groups || [])),\n  knowledge_base_matches: JSON.parse(JSON.stringify(actualOutput.knowledge_base_matches || [])),\n  slo_impact: JSON.parse(JSON.stringify(actualOutput.slo_impact || {})),\n  recommended_actions: JSON.parse(JSON.stringify(actualOutput.recommended_alert_actions || [])),\n  correlation_confidence: actualOutput.correlation_confidence || 0.0,\n  auto_remediation_approved: actualOutput.auto_remediation_approved || false,\n  proceed_to_stage4: actualOutput.proceed_to_stage4 || false,\n  kb_enriched_count: actualOutput.active_alerts?.filter(a => a.kb_enriched).length || 0\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n  actualOutput._context.decisions = previousContext?.decisions || {};\n}\n\nactualOutput._context.decisions.stage4Proceed = {\n  timestamp: new Date().toISOString(),\n  shouldProceed: actualOutput.proceed_to_stage4,\n  autoRemediationApproved: actualOutput.auto_remediation_approved,\n  alertCount: actualOutput.active_alerts?.length || 0,\n  sloImpact: actualOutput.slo_impact?.availability_slo?.current || \"100%\"\n};\n\n// Preserve previous stage data\nif (stage2Data?.stage1Data) {\n  fixedOutput.stage1Data = JSON.parse(JSON.stringify(stage2Data.stage1Data));\n  console.log(\"‚úÖ Stage 1 data preserved\");\n}\n\nif (stage2Data?.stage2Data) {\n  fixedOutput.stage2Data = JSON.parse(JSON.stringify(stage2Data.stage2Data));\n  console.log(\"‚úÖ Stage 2 data preserved\");\n}\n\n// Prepare data for Stage 4\nfixedOutput.stage4PrepData = {\n  rootCause: fixedOutput.stage2Data?.root_cause || {},\n  affectedServices: fixedOutput.stage2Data?.affected_services || [],\n  criticalPods: fixedOutput.stage2Data?.critical_pods || [],\n  primaryAlert: actualOutput.active_alerts?.[0] || null,\n  kbMatches: actualOutput.knowledge_base_matches || [],\n  contextId: expectedContextId\n};\n\n// Namespaces and time range\nfixedOutput.namespaces = previousContext?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n  start: previousContext?.initialParams?.startTime || 0,\n  end: previousContext?.initialParams?.endTime || 0\n};\n\n// Summary logging\nconsole.log(\"==============================\");\nconsole.log(\"Stage 3 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Active alerts:\", actualOutput.active_alerts?.length);\nconsole.log(\"- KB enriched:\", fixedOutput.stage3Data?.kb_enriched_count);\nconsole.log(\"- Proceed to Stage 4:\", actualOutput.proceed_to_stage4);\nconsole.log(\"- Previous stage data preserved:\", !!(fixedOutput.stage1Data && fixedOutput.stage2Data));\n\n// Validation\nconst validationPassed = \n  actualOutput._context?.contextId === expectedContextId &&\n  !!fixedOutput.stage1Data &&\n  !!fixedOutput.stage2Data &&\n  !!fixedOutput.stage3Data;\n\nif (validationPassed) {\n  console.log(\"‚úÖ Stage 3 context successfully fixed and validated!\");\n} else {\n  console.error(\"‚ö†Ô∏è Stage 3 validation warnings\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n  fromNode: \"Fix Stage 3 Context\",\n  contextFixed: true,\n  validationPassed: validationPassed,\n  stage3AlertCount: actualOutput.active_alerts?.length || 0,\n  stage3Decision: actualOutput.proceed_to_stage4,\n  allStagesDataPresent: !!(fixedOutput.stage1Data && fixedOutput.stage2Data && fixedOutput.stage3Data),\n  timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if needed\nif (hasOutputWrapper) {\n  fixedOutput.output = actualOutput;\n}\n\nreturn [{\n  json: fixedOutput\n}];"
      },
      "id": "d776d4fd-be1b-4078-a85f-e1499bc661fa",
      "name": "Fix Stage 3 Context1",
      "type": "n8n-nodes-base.code",
      "position": [
        4736,
        256
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 4 Context - Optimized without circular reference removal\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage4Output = $input.first().json;\n\n// Stage 3'ten gelen context'i al\nlet stage3Data;\nlet previousContext;\n\ntry {\n  stage3Data = $node[\"Fix Stage 3 Context1\"].json;\n  previousContext = stage3Data._context;\n  \n  console.log(\"‚úÖ Got context from Stage 3:\", previousContext?.contextId);\n  console.log(\"Stage 1 data available:\", !!stage3Data.stage1Data);\n  console.log(\"Stage 2 data available:\", !!stage3Data.stage2Data);\n  console.log(\"Stage 3 data available:\", !!stage3Data.stage3Data);\n} catch (e) {\n  console.error(\"‚ùå Error getting Stage 3 data:\", e);\n  previousContext = stage4Output._context || {\n    contextId: \"ctx-emergency-\" + Date.now()\n  };\n}\n\nconsole.log(\"=== FIXING STAGE 4 CONTEXT ===\");\nconsole.log(\"Previous context ID:\", previousContext?.contextId);\n\n// Deep copy\nlet fixedOutput = JSON.parse(JSON.stringify(stage4Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\nconsole.log(\"Has output wrapper:\", hasOutputWrapper);\n\n// ============= MOCK DATA DETECTION VE TEMƒ∞ZLEME =============\nif (actualOutput.diagnostics_executed && actualOutput.diagnostics_executed.length > 0) {\n  const diagnostic = actualOutput.diagnostics_executed[0];\n  \n  if (diagnostic.target && \n      (diagnostic.target.includes('payment-service') || \n       diagnostic.target === 'pod-abc123' ||\n       diagnostic.target.includes('user-auth-service'))) {\n    \n    console.warn(\"‚ö†Ô∏è MOCK DATA DETECTED! Replacing with actual data...\");\n    \n    const actualRootCause = stage3Data?.stage2Data?.root_cause || {};\n    const actualAffectedServices = stage3Data?.stage2Data?.affected_services || [];\n    const criticalPods = stage3Data?.stage2Data?.critical_pods || [];\n    \n    let actualTarget = criticalPods[0] || actualRootCause.component || \"unknown-pod\";\n    \n    if (typeof actualTarget === 'object' && actualTarget.name) {\n      actualTarget = actualTarget.name;\n    }\n    \n    const actualNamespace = stage3Data?.namespaces?.[0] ||\n                           previousContext?.initialParams?.namespaces?.[0] ||\n                           DEFAULT_NAMESPACES[0];\n    \n    actualOutput.diagnostics_executed = [{\n      target: actualTarget,\n      type: \"pod\",\n      commands_run: [\n        `kubectl get pod ${actualTarget} -n ${actualNamespace} -o json`,\n        `kubectl logs ${actualTarget} -n ${actualNamespace} --since=1h`,\n        `kubectl describe pod ${actualTarget} -n ${actualNamespace}`,\n        `kubectl top pod ${actualTarget} -n ${actualNamespace}`,\n        `kubectl get events -n ${actualNamespace} --field-selector involvedObject.name=${actualTarget}`\n      ],\n      findings: {\n        pod_status: {\n          phase: actualRootCause.issue?.includes('CrashLoopBackOff') ? 'CrashLoopBackOff' : \n                 actualRootCause.issue?.includes('restart') ? 'Running' : 'Unknown',\n          restart_count: parseInt(actualRootCause.evidence?.[1]?.match(/\\d+/)?.[0]) || 5,\n          last_termination: {\n            reason: actualRootCause.issue?.includes('OOM') ? 'OOMKilled' : \n                   actualRootCause.issue?.includes('CrashLoopBackOff') ? 'Error' : 'Unknown',\n            exit_code: actualRootCause.issue?.includes('OOM') ? 137 : 1,\n            finished_at: new Date().toISOString()\n          }\n        },\n        error_logs: [],\n        events: [{\n          type: \"Warning\",\n          reason: actualRootCause.issue?.includes('OOM') ? 'OOMKilled' : 'BackOff',\n          message: actualRootCause.evidence?.[0] || \"Container failing\",\n          timestamp: new Date().toISOString()\n        }],\n        resource_usage: {\n          memory_request: \"512Mi\",\n          memory_limit: \"1024Mi\",\n          memory_used: \"950Mi\",\n          cpu_used: \"0.85\"\n        }\n      }\n    }];\n    \n    actualOutput.enriched_context = {\n      ...actualOutput.enriched_context,\n      deployment_info: {\n        name: actualTarget.split('-').slice(0, -2).join('-') || \"unknown-deployment\",\n        namespace: actualNamespace,\n        version: \"unknown\",\n        replicas: \"unknown\",\n        last_update: new Date().toISOString(),\n        update_strategy: \"RollingUpdate\"\n      },\n      dependencies: {\n        upstream: [],\n        downstream: actualAffectedServices.filter(s => s !== actualNamespace),\n        databases: [],\n        external: []\n      }\n    };\n    \n    actualOutput.diagnostic_summary = {\n      confirmed_issues: [{\n        issue: actualRootCause.issue || \"Resource exhaustion leading to pod restarts\",\n        evidence: actualRootCause.evidence || [\n          \"Pod restart count: 5\",\n          \"Memory usage: 950Mi out of 1024Mi limit\",\n          \"Container instability detected\"\n        ],\n        severity: \"critical\",\n        impact: `Service ${actualTarget} is experiencing issues`,\n        namespace: actualNamespace\n      }],\n      secondary_issues: []\n    };\n    \n    console.log(\"‚úÖ Mock data replaced with actual data\");\n  }\n}\n\n// ============= KB DIAGNOSTIC INTEGRATION =============\nconst stage3KBMatches = stage3Data?.stage3Data?.knowledge_base_matches || [];\nconst stage3Alerts = stage3Data?.stage3Data?.active_alerts || [];\n\nif (stage3KBMatches.length > 0 && actualOutput.diagnostics_executed) {\n  console.log(\"=== KB DIAGNOSTIC INTEGRATION ===\");\n  console.log(\"KB matches:\", stage3KBMatches.length);\n  \n  stage3KBMatches.forEach((kbMatch, idx) => {\n    if (idx < actualOutput.diagnostics_executed.length) {\n      const diagnosticEntry = actualOutput.diagnostics_executed[idx];\n      \n      diagnosticEntry.kb_enhanced = true;\n      diagnosticEntry.kb_severity = kbMatch.kb_entry?.severity || \"Medium\";\n      \n      if (!diagnosticEntry.findings.kb_analysis) {\n        diagnosticEntry.findings.kb_analysis = {\n          alert_type: kbMatch.alert,\n          severity: kbMatch.kb_entry?.severity,\n          possible_root_causes: kbMatch.kb_entry?.root_causes || [],\n          diagnostic_guidance: kbMatch.kb_entry?.diagnostic_commands || []\n        };\n      }\n    }\n  });\n  \n  console.log(\"‚úÖ KB diagnostic enhancement complete\");\n}\n\n// Update enriched context KB analysis\nif (!actualOutput.enriched_context.kb_analysis) {\n  actualOutput.enriched_context.kb_analysis = {\n    alerts_matched: stage3KBMatches.map(m => ({\n      alert: m.alert,\n      severity: m.kb_entry?.severity || \"Unknown\"\n    })),\n    diagnostic_coverage: stage3KBMatches.length,\n    remediation_available: stage3KBMatches.filter(m => \n      m.kb_entry?.immediate_actions?.length > 0).length,\n    highest_severity: stage3KBMatches.reduce((max, m) => {\n      const severityOrder = { \"Blocker\": 5, \"Critical\": 4, \"High\": 3, \"Medium\": 2, \"Low\": 1 };\n      return severityOrder[m.kb_entry?.severity] > severityOrder[max] ? \n             m.kb_entry?.severity : max;\n    }, \"Low\")\n  };\n}\n\n// ============= CONTEXT FIX =============\nconst expectedContextId = previousContext?.contextId;\n\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId ||\n    actualOutput._context.contextId === \"abc123\") {\n    \n  console.log(\"‚ùå Invalid or missing context, fixing...\");\n  \n  // Deep copy of previous context\n  const contextCopy = JSON.parse(JSON.stringify(previousContext));\n  \n  // Ensure stageResults exists\n  if (!contextCopy.stageResults) {\n    contextCopy.stageResults = {};\n  }\n  \n  actualOutput._context = contextCopy;\n  console.log(\"‚úÖ Context replaced\");\n}\n\n// Ensure stageResults exists\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Add Stage 4 results - only this stage's data\nactualOutput._context.stageResults.stage4 = {\n  output: {\n    diagnostics_executed: JSON.parse(JSON.stringify(actualOutput.diagnostics_executed)),\n    enriched_context: JSON.parse(JSON.stringify(actualOutput.enriched_context)),\n    diagnostic_summary: JSON.parse(JSON.stringify(actualOutput.diagnostic_summary)),\n    proceed_to_stage5: actualOutput.proceed_to_stage5,\n    remediation_confidence: actualOutput.remediation_confidence\n  },\n  completedAt: new Date().toISOString(),\n  decision: actualOutput.proceed_to_stage5,\n  primaryIssue: actualOutput.diagnostic_summary?.confirmed_issues?.[0]?.issue\n};\n\n// Update debug info\nactualOutput._debug = {\n  nodeType: \"Stage 4: Automated Diagnosis\",\n  processedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  contextId: expectedContextId,\n  contextPreserved: true,\n  receivedFromStage: \"Fix Stage 3 Context\",\n  priority: previousContext?.priority || \"normal\",\n  stageSequence: [\n    \"Unified Entry Point\",\n    \"Stage 1: Health Snapshot\", \n    \"Fix Stage 1 Context\",\n    \"Stage 2 Decision\",\n    \"Force Deep Analysis Override\",\n    \"Wait 3s\",\n    \"Stage 2: Deep Analysis\",\n    \"Fix Stage 2 Context\",\n    \"Stage 3: Alert Intelligence\",\n    \"Fix Stage 3 Context\",\n    \"Stage 4: Automated Diagnosis\",\n    \"Fix Stage 4 Context\"\n  ],\n  diagnosticsCount: actualOutput.diagnostics_executed?.length || 0,\n  autoRemediationEnabled: true,\n  timeRangeUsed: {\n    start: previousContext?.initialParams?.startTime || 0,\n    end: previousContext?.initialParams?.endTime || 0\n  }\n};\n\n// Update root level context\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = expectedContextId;\n\n// Stage 4 summary data\nfixedOutput.stage4Data = {\n  diagnostics_executed: JSON.parse(JSON.stringify(actualOutput.diagnostics_executed)),\n  enriched_context: JSON.parse(JSON.stringify(actualOutput.enriched_context)),\n  diagnostic_summary: JSON.parse(JSON.stringify(actualOutput.diagnostic_summary)),\n  confirmed_issues: actualOutput.diagnostic_summary?.confirmed_issues || [],\n  secondary_issues: actualOutput.diagnostic_summary?.secondary_issues || [],\n  remediation_confidence: actualOutput.remediation_confidence || 0,\n  proceed_to_stage5: actualOutput.proceed_to_stage5 || false,\n  kb_enhanced: actualOutput.diagnostics_executed?.some(d => d.kb_enhanced) || false,\n  primary_diagnosis: actualOutput.diagnostic_summary?.confirmed_issues?.[0] || null\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n  actualOutput._context.decisions = previousContext?.decisions || {};\n}\n\nactualOutput._context.decisions.stage5Proceed = {\n  timestamp: new Date().toISOString(),\n  shouldProceed: actualOutput.proceed_to_stage5,\n  remediationConfidence: actualOutput.remediation_confidence,\n  confirmedIssuesCount: actualOutput.diagnostic_summary?.confirmed_issues?.length || 0,\n  primaryIssue: actualOutput.diagnostic_summary?.confirmed_issues?.[0]?.issue || \"unknown\"\n};\n\n// Preserve all previous stage data\nif (stage3Data?.stage1Data) {\n  fixedOutput.stage1Data = JSON.parse(JSON.stringify(stage3Data.stage1Data));\n  console.log(\"‚úÖ Stage 1 data preserved (full copy)\");\n}\n\nif (stage3Data?.stage2Data) {\n  fixedOutput.stage2Data = JSON.parse(JSON.stringify(stage3Data.stage2Data));\n  console.log(\"‚úÖ Stage 2 data preserved (full copy)\");\n}\n\nif (stage3Data?.stage3Data) {\n  fixedOutput.stage3Data = JSON.parse(JSON.stringify(stage3Data.stage3Data));\n  console.log(\"‚úÖ Stage 3 data preserved (full copy)\");\n}\n\n// Consolidated findings for final summary\nfixedOutput.consolidatedFindings = {\n  healthStatus: fixedOutput.stage1Data?.overall_status || \"unknown\",\n  alertCount: fixedOutput.stage1Data?.alerts?.total || 0,\n  rootCause: fixedOutput.stage2Data?.root_cause || {},\n  affectedServices: fixedOutput.stage2Data?.affected_services || [],\n  activeAlerts: fixedOutput.stage3Data?.active_alerts || [],\n  confirmedIssues: actualOutput.diagnostic_summary?.confirmed_issues || [],\n  primaryDiagnosis: actualOutput.diagnostic_summary?.confirmed_issues?.[0] || null,\n  remediationConfidence: actualOutput.remediation_confidence || 0\n};\n\n// Primary diagnosis for easy access\nif (actualOutput.diagnostic_summary?.confirmed_issues?.[0]) {\n  fixedOutput.primaryDiagnosis = {\n    ...actualOutput.diagnostic_summary.confirmed_issues[0],\n    stage: \"Stage 4\",\n    timestamp: new Date().toISOString()\n  };\n}\n\n// Namespaces and time range\nfixedOutput.namespaces = previousContext?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n  start: previousContext?.initialParams?.startTime || 0,\n  end: previousContext?.initialParams?.endTime || 0\n};\n\nconsole.log(\"==============================\");\nconsole.log(\"Stage 4 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Diagnostics executed:\", actualOutput.diagnostics_executed?.length);\nconsole.log(\"- Confirmed issues:\", actualOutput.diagnostic_summary?.confirmed_issues?.length);\nconsole.log(\"- KB enhanced:\", fixedOutput.stage4Data?.kb_enhanced);\nconsole.log(\"- Proceed to Stage 5:\", actualOutput.proceed_to_stage5);\nconsole.log(\"- Previous stage data preserved:\");\nconsole.log(\"  * Stage 1:\", !!fixedOutput.stage1Data);\nconsole.log(\"  * Stage 2:\", !!fixedOutput.stage2Data);\nconsole.log(\"  * Stage 3:\", !!fixedOutput.stage3Data);\nconsole.log(\"  * Stage 4:\", !!fixedOutput.stage4Data);\nconsole.log(\"- All data is FULL COPY (no summarization)\");\n\n// Validation\nconst validationPassed = \n  actualOutput._context?.contextId === expectedContextId &&\n  !!fixedOutput.stage1Data &&\n  !!fixedOutput.stage2Data &&\n  !!fixedOutput.stage3Data &&\n  !!fixedOutput.stage4Data;\n\nif (validationPassed) {\n  console.log(\"‚úÖ Stage 4 context successfully fixed and validated!\");\n} else {\n  console.error(\"‚ö†Ô∏è Stage 4 validation warnings\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n  fromNode: \"Fix Stage 4 Context\",\n  contextFixed: true,\n  validationPassed: validationPassed,\n  stage4DiagnosticsCount: actualOutput.diagnostics_executed?.length || 0,\n  stage4Decision: actualOutput.proceed_to_stage5,\n  remediationConfidence: actualOutput.remediation_confidence,\n  primaryIssue: actualOutput.diagnostic_summary?.confirmed_issues?.[0]?.issue || \"unknown\",\n  allStagesDataPresent: !!(fixedOutput.stage1Data && fixedOutput.stage2Data && \n                           fixedOutput.stage3Data && fixedOutput.stage4Data),\n  timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if needed\nif (hasOutputWrapper) {\n  fixedOutput.output = actualOutput;\n}\n\nreturn [{\n  json: fixedOutput\n}];"
      },
      "id": "c92c8e92-b539-4c4f-a243-7b5a1a88aa6a",
      "name": "Fix Stage 4 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        6016,
        224
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 5 Context - Optimized without circular references\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage5Output = $input.first().json;\n\n// √ñnceki stage'den context ve data'yƒ± al\nlet previousContext;\nlet stage4Data;\n\ntry {\n  stage4Data = $node[\"Fix Stage 4 Context\"].json;\n  previousContext = stage4Data._context;\n  \n  console.log(\"‚úÖ Got context from Stage 4:\", previousContext?.contextId);\n  console.log(\"Stage 1 data available:\", !!stage4Data.stage1Data);\n  console.log(\"Stage 2 data available:\", !!stage4Data.stage2Data);\n  console.log(\"Stage 3 data available:\", !!stage4Data.stage3Data);\n  console.log(\"Stage 4 data available:\", !!stage4Data.stage4Data);\n} catch (e) {\n  console.error(\"‚ùå Error getting Stage 4 data:\", e);\n  previousContext = {\n    contextId: \"ctx-emergency-\" + Date.now(),\n    createdAt: new Date().toISOString(),\n    source: {\n      type: \"manual_trigger\",\n      triggeredBy: \"user\"\n    },\n    stageResults: {},\n    decisions: {},\n    initialParams: {\n      startTime: Math.floor(Date.now() / 1000) - 3600,\n      endTime: Math.floor(Date.now() / 1000)\n    }\n  };\n}\n\n// Validate previousContext\nif (!previousContext || typeof previousContext !== 'object') {\n  console.error(\"‚ùå Invalid previousContext, creating new one\");\n  previousContext = {\n    contextId: \"ctx-recovery-\" + Date.now(),\n    createdAt: new Date().toISOString(),\n    source: {\n      type: \"manual_trigger\",\n      triggeredBy: \"user\"\n    },\n    stageResults: {},\n    decisions: {},\n    initialParams: {\n      startTime: Math.floor(Date.now() / 1000) - 3600,\n      endTime: Math.floor(Date.now() / 1000)\n    }\n  };\n}\n\n// Ensure stageResults exists\nif (!previousContext.stageResults) {\n  previousContext.stageResults = {};\n}\n\nconsole.log(\"=== FIXING STAGE 5 CONTEXT ===\");\nconsole.log(\"Previous context ID:\", previousContext?.contextId);\n\n// Deep copy\nlet fixedOutput = JSON.parse(JSON.stringify(stage5Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nlet actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\nconsole.log(\"Has output wrapper:\", hasOutputWrapper);\n\n// String output handling\nif (typeof actualOutput === 'string') {\n  console.log(\"‚ö†Ô∏è Stage 5 output is string, attempting to parse...\");\n  \n  try {\n    let cleanOutput = actualOutput;\n    if (cleanOutput.includes('```json')) {\n      cleanOutput = cleanOutput.replace(/```json\\s*\\n?/g, '');\n      cleanOutput = cleanOutput.replace(/```\\s*$/g, '');\n    }\n    \n    if (cleanOutput.includes('{{') || cleanOutput.includes('$json')) {\n      console.log(\"‚ö†Ô∏è Stage 5 output contains templates, resolving...\");\n      \n      const context = previousContext;\n      const stage4Results = stage4Data?.stage4Data || {};\n      const primaryDiagnosis = stage4Data?.primaryDiagnosis || {};\n      \n      cleanOutput = cleanOutput\n        .replace(/\\{\\{ \\$json\\._context\\.contextId \\}\\}/g, context.contextId || 'unknown')\n        .replace(/\\{\\{ \\$json\\.stage4Results\\.enriched_context\\.deployment_info\\.name \\}\\}/g, \n          stage4Results?.enriched_context?.deployment_info?.name || 'unknown-deployment')\n        .replace(/\\{\\{ \\$json\\.primaryDiagnosis\\.namespace \\}\\}/g, \n          primaryDiagnosis?.namespace || 'default')\n        .replace(/\\{\\{ JSON\\.stringify\\(\\$json\\._context\\) \\}\\}/g, \n          JSON.stringify(context))\n        .replace(/\\{\\{ \\$json\\._context\\.initialParams\\.startTime \\}\\}/g, \n          context.initialParams?.startTime || 0)\n        .replace(/\\{\\{ \\$json\\._context\\.initialParams\\.endTime \\}\\}/g, \n          context.initialParams?.endTime || 0)\n        .replace(/<use new Date\\(\\)\\.toISOString\\(\\)>/g, new Date().toISOString())\n        .replace(/<current ISO timestamp>/g, new Date().toISOString());\n    }\n    \n    actualOutput = JSON.parse(cleanOutput);\n    console.log(\"‚úÖ Successfully parsed Stage 5 output\");\n  } catch (e) {\n    console.error(\"‚ùå Failed to parse Stage 5 output:\", e.message);\n    actualOutput = {\n      stage: \"ai_powered_analysis\",\n      analysis_id: previousContext.contextId + \"-stage5\",\n      error: \"Failed to parse output\",\n      remediation_plan: {\n        immediate_actions: [],\n        short_term_fixes: [],\n        long_term_solutions: [],\n        preventive_measures: []\n      },\n      risk_assessment: {\n        overall_risk: \"unknown\",\n        factors: [],\n        mitigation_steps: []\n      },\n      implementation_order: [],\n      success_metrics: {\n        immediate: [],\n        short_term: [],\n        long_term: []\n      },\n      rollback_plan: {\n        trigger_conditions: [],\n        steps: [],\n        validation: \"\"\n      }\n    };\n  }\n}\n\n// Validate actualOutput\nif (!actualOutput || typeof actualOutput !== 'object') {\n  console.error(\"‚ùå Invalid actualOutput, creating default structure\");\n  actualOutput = {\n    stage: \"ai_powered_analysis\",\n    analysis_id: previousContext.contextId + \"-stage5\",\n    remediation_plan: {\n      immediate_actions: [],\n      short_term_fixes: [],\n      long_term_solutions: [],\n      preventive_measures: []\n    },\n    risk_assessment: {\n      overall_risk: \"unknown\",\n      factors: [],\n      mitigation_steps: []\n    }\n  };\n}\n\n// ============= MOCK DATA DETECTION VE TEMƒ∞ZLEME =============\nif (actualOutput.remediation_plan && actualOutput.remediation_plan.immediate_actions) {\n  const immediateActions = actualOutput.remediation_plan.immediate_actions;\n  \n  immediateActions.forEach((action, index) => {\n    if (action.command && action.command.includes('payment-service')) {\n      console.warn(\"‚ö†Ô∏è MOCK COMMAND DETECTED! Replacing with actual data...\");\n      \n      const actualRootCause = stage4Data?.stage2Data?.root_cause || {};\n      let actualComponent = actualRootCause.component || \n                           stage4Data?.primaryDiagnosis?.component || \n                           \"unknown-component\";\n      const actualNamespace = stage4Data?.primaryDiagnosis?.namespace ||\n                             stage4Data?.stage2Data?.affected_services?.[0]?.split('-')?.[0] ||\n                             DEFAULT_NAMESPACES[0];\n      const actualIssue = actualRootCause.issue || \n                         stage4Data?.primaryDiagnosis?.issue || \n                         \"Unknown issue\";\n      \n      const criticalPods = stage4Data?.stage2Data?.critical_pods || [];\n      if (criticalPods.length > 0 && actualComponent === \"unknown-component\") {\n        const firstPod = criticalPods[0];\n        actualComponent = typeof firstPod === 'string' ? firstPod : firstPod.name || firstPod;\n        console.log(`‚úÖ Using actual pod: ${actualComponent}`);\n      }\n      \n      if (actualIssue.includes('CrashLoopBackOff')) {\n        immediateActions[index] = {\n          action: `Delete and recreate pod ${actualComponent}`,\n          command: `kubectl delete pod ${actualComponent} -n ${actualNamespace}`,\n          risk: \"low\",\n          estimated_time: \"1-2 minutes\",\n          expected_outcome: \"Pod will be recreated with fresh state\"\n        };\n      } else if (actualIssue.includes('restart')) {\n        const deploymentName = actualComponent.split('-').slice(0, -2).join('-') || actualComponent;\n        immediateActions[index] = {\n          action: `Scale down and up deployment for ${actualComponent}`,\n          command: `kubectl scale deployment ${deploymentName} --replicas=0 -n ${actualNamespace} && kubectl scale deployment ${deploymentName} --replicas=1 -n ${actualNamespace}`,\n          risk: \"medium\",\n          estimated_time: \"2-3 minutes\",\n          expected_outcome: \"Deployment will be refreshed\"\n        };\n      } else {\n        immediateActions[index] = {\n          action: `Investigate and restart ${actualComponent}`,\n          command: `kubectl describe pod ${actualComponent} -n ${actualNamespace} && kubectl delete pod ${actualComponent} -n ${actualNamespace}`,\n          risk: \"low\",\n          estimated_time: \"2-5 minutes\",\n          expected_outcome: \"Component will be restarted after investigation\"\n        };\n      }\n      \n      console.log(\"‚úÖ Replaced mock command with actual component\");\n    }\n    \n    if (action.action && action.action.includes('payment-service')) {\n      const actualComponent = stage4Data?.stage2Data?.root_cause?.component || \"component\";\n      action.action = action.action.replace(/payment-service/g, actualComponent);\n    }\n  });\n  \n  if (actualOutput.remediation_plan.short_term_fixes) {\n    actualOutput.remediation_plan.short_term_fixes.forEach((fix) => {\n      if (fix.details && fix.details.includes('payment')) {\n        const actualService = stage4Data?.stage2Data?.affected_services?.[0] || \"service\";\n        fix.details = fix.details.replace(/payment processing/g, actualService + \" processing\");\n      }\n    });\n  }\n  \n  if (actualOutput.remediation_plan.long_term_solutions) {\n    actualOutput.remediation_plan.long_term_solutions.forEach((solution) => {\n      if (solution.details && (solution.details.includes('TransactionHandler') || solution.details.includes('payment'))) {\n        const actualComponent = stage4Data?.stage2Data?.root_cause?.component || \"component\";\n        solution.action = `Fix issues in ${actualComponent}`;\n        solution.details = `Review and fix the root cause in ${actualComponent} component`;\n      }\n    });\n  }\n}\n\n// ============= KB REMEDIATION ENHANCEMENT =============\nconst stage4DiagnosticSummary = stage4Data?.stage4Data?.diagnostic_summary || {};\nconst stage4KBAnalysis = stage4Data?.stage4Data?.enriched_context?.kb_analysis || {};\nconst confirmedIssuesWithKB = stage4DiagnosticSummary.confirmed_issues?.filter(i => i.kb_enhanced) || [];\n\nconsole.log(\"=== KB REMEDIATION ENHANCEMENT ===\");\nconsole.log(\"KB enhanced issues:\", confirmedIssuesWithKB.length);\n\nif (confirmedIssuesWithKB.length > 0 && actualOutput.remediation_plan) {\n  console.log(\"Enhancing remediation plan with KB actions...\");\n  \n  const kbImmediateActions = [];\n  \n  confirmedIssuesWithKB.forEach(issue => {\n    if (issue.kb_immediate_actions && Array.isArray(issue.kb_immediate_actions)) {\n      issue.kb_immediate_actions.forEach((action, idx) => {\n        const actionText = action.replace(/^\\d+\\.\\s*/, '');\n        let command = \"\";\n        let risk = \"medium\";\n        let estimatedTime = \"5-10 minutes\";\n        \n        if (actionText.toLowerCase().includes('rollback')) {\n          const component = issue.namespace || stage4Data?.primaryDiagnosis?.component || \"deployment\";\n          command = `kubectl rollout undo deployment/${component} -n ${issue.namespace || 'default'}`;\n          risk = \"low\";\n          estimatedTime = \"2-5 minutes\";\n        } else if (actionText.toLowerCase().includes('restart')) {\n          const component = issue.namespace || stage4Data?.primaryDiagnosis?.component || \"deployment\";\n          command = `kubectl rollout restart deployment/${component} -n ${issue.namespace || 'default'}`;\n          risk = \"low\";\n          estimatedTime = \"2-3 minutes\";\n        }\n        \n        kbImmediateActions.push({\n          action: actionText,\n          command: command,\n          risk: risk,\n          estimated_time: estimatedTime,\n          expected_outcome: `Resolve ${issue.issue}`,\n          source: \"Alert Knowledge Base\",\n          kb_severity: issue.kb_severity,\n          priority_score: calculateActionPriority(issue.kb_severity, idx)\n        });\n      });\n    }\n  });\n  \n  kbImmediateActions.sort((a, b) => b.priority_score - a.priority_score);\n  \n  if (actualOutput.remediation_plan.immediate_actions.length === 0 || \n      actualOutput.remediation_plan.immediate_actions.some(a => a.command?.includes('payment-service'))) {\n    actualOutput.remediation_plan.immediate_actions = kbImmediateActions.slice(0, 5);\n  }\n  \n  console.log(\"‚úÖ KB remediation enhancement complete\");\n}\n\n// Helper function\nfunction calculateActionPriority(severity, index) {\n  const severityScores = {\n    \"Blocker\": 1000,\n    \"Critical\": 800,\n    \"High\": 600,\n    \"Medium\": 400,\n    \"Low\": 200\n  };\n  return (severityScores[severity] || 100) - (index * 10);\n}\n\n// Risk assessment update\nif (actualOutput.risk_assessment && actualOutput.risk_assessment.factors) {\n  actualOutput.risk_assessment.factors = actualOutput.risk_assessment.factors.map(factor => {\n    if (typeof factor === 'string' && factor.includes('Payment service')) {\n      const actualService = stage4Data?.stage2Data?.affected_services?.[0] || \"Service\";\n      return factor.replace('Payment service', actualService);\n    }\n    return factor;\n  });\n}\n\n// ============= CONTEXT FIX =============\nconst expectedContextId = previousContext?.contextId;\n\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId) {\n  console.log(\"‚ùå Invalid or missing context, fixing...\");\n  \n  // Deep copy of previous context\n  const contextCopy = JSON.parse(JSON.stringify(previousContext));\n  \n  // Ensure stageResults exists\n  if (!contextCopy.stageResults) {\n    contextCopy.stageResults = {};\n  }\n  \n  actualOutput._context = contextCopy;\n  console.log(\"‚úÖ Context replaced\");\n}\n\n// Ensure stageResults exists\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Add Stage 5 results - only this stage's data\nactualOutput._context.stageResults.stage5 = {\n  output: {\n    analysis_id: actualOutput.analysis_id || `${expectedContextId}-stage5`,\n    remediation_plan: JSON.parse(JSON.stringify(actualOutput.remediation_plan)),\n    risk_assessment: JSON.parse(JSON.stringify(actualOutput.risk_assessment)),\n    implementation_order: JSON.parse(JSON.stringify(actualOutput.implementation_order || [])),\n    success_metrics: JSON.parse(JSON.stringify(actualOutput.success_metrics || {})),\n    rollback_plan: JSON.parse(JSON.stringify(actualOutput.rollback_plan || {}))\n  },\n  completedAt: new Date().toISOString()\n};\n\n// Update debug info\nactualOutput._debug = {\n  nodeType: \"Stage 5: AI-Powered Analysis\",\n  processedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  contextId: expectedContextId,\n  contextPreserved: true,\n  receivedFromStage: \"Fix Stage 4 Context\",\n  priority: previousContext?.priority || \"normal\",\n  stagesCompleted: 5,\n  stageSequence: [\n    \"Unified Entry Point\",\n    \"Stage 1: Health Snapshot\",\n    \"Fix Stage 1 Context\",\n    \"Stage 2 Decision\",\n    \"Force Deep Analysis Override\",\n    \"Wait 3s\",\n    \"Stage 2: Deep Analysis\",\n    \"Fix Stage 2 Context\",\n    \"Stage 3: Alert Intelligence\",\n    \"Fix Stage 3 Context\",\n   \"Stage 4: Automated Diagnosis\",\n   \"Fix Stage 4 Context\",\n   \"Stage 5: AI-Powered Analysis\",\n   \"Fix Stage 5 Context\"\n ],\n analysisTimeRange: {\n   start: previousContext?.initialParams?.startTime || 0,\n   end: previousContext?.initialParams?.endTime || 0\n }\n};\n\n// Update root level context\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = expectedContextId;\n\n// Stage 5 summary data\nfixedOutput.stage5Data = {\n analysis_id: actualOutput.analysis_id,\n remediation_plan: JSON.parse(JSON.stringify(actualOutput.remediation_plan)),\n risk_assessment: JSON.parse(JSON.stringify(actualOutput.risk_assessment)),\n implementation_order: JSON.parse(JSON.stringify(actualOutput.implementation_order || [])),\n success_metrics: JSON.parse(JSON.stringify(actualOutput.success_metrics || {})),\n rollback_plan: JSON.parse(JSON.stringify(actualOutput.rollback_plan || {})),\n primary_action: actualOutput.remediation_plan?.immediate_actions?.[0],\n overall_risk: actualOutput.risk_assessment?.overall_risk\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n actualOutput._context.decisions = previousContext?.decisions || {};\n}\n\nactualOutput._context.decisions.stage6Proceed = {\n timestamp: new Date().toISOString(),\n remediationPlanCreated: !!actualOutput.remediation_plan,\n riskAssessed: !!actualOutput.risk_assessment,\n primaryActionDefined: !!actualOutput.remediation_plan?.immediate_actions?.[0]\n};\n\n// Preserve ALL previous stage data\nif (stage4Data?.stage1Data) {\n fixedOutput.stage1Data = JSON.parse(JSON.stringify(stage4Data.stage1Data));\n console.log(\"‚úÖ Stage 1 data preserved (full copy)\");\n}\n\nif (stage4Data?.stage2Data) {\n fixedOutput.stage2Data = JSON.parse(JSON.stringify(stage4Data.stage2Data));\n console.log(\"‚úÖ Stage 2 data preserved (full copy)\");\n}\n\nif (stage4Data?.stage3Data) {\n fixedOutput.stage3Data = JSON.parse(JSON.stringify(stage4Data.stage3Data));\n console.log(\"‚úÖ Stage 3 data preserved (full copy)\");\n}\n\nif (stage4Data?.stage4Data) {\n fixedOutput.stage4Data = JSON.parse(JSON.stringify(stage4Data.stage4Data));\n console.log(\"‚úÖ Stage 4 data preserved (full copy)\");\n}\n\n// Preserve additional data\nif (stage4Data?.consolidatedFindings) {\n fixedOutput.consolidatedFindings = JSON.parse(JSON.stringify(stage4Data.consolidatedFindings));\n}\n\nif (stage4Data?.primaryDiagnosis) {\n fixedOutput.primaryDiagnosis = JSON.parse(JSON.stringify(stage4Data.primaryDiagnosis));\n}\n\n// Executive summary\nfixedOutput.executiveSummary = {\n contextId: expectedContextId,\n issue: fixedOutput.primaryDiagnosis?.issue || \"Unknown issue\",\n severity: fixedOutput.primaryDiagnosis?.severity || \"medium\",\n immediateAction: actualOutput.remediation_plan?.immediate_actions?.[0]?.action || \"No immediate action\",\n command: actualOutput.remediation_plan?.immediate_actions?.[0]?.command || \"N/A\",\n risk: actualOutput.risk_assessment?.overall_risk || \"unknown\",\n estimatedTime: actualOutput.remediation_plan?.immediate_actions?.[0]?.estimated_time || \"unknown\",\n stagesCompleted: 5,\n timestamp: new Date().toISOString()\n};\n\n// Namespaces and time range\nfixedOutput.namespaces = previousContext?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n start: previousContext?.initialParams?.startTime || 0,\n end: previousContext?.initialParams?.endTime || 0\n};\n\n// Summary logging\nconsole.log(\"==============================\");\nconsole.log(\"Stage 5 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Immediate action:\", fixedOutput.remediation_plan?.immediate_actions?.[0]?.action);\nconsole.log(\"- Risk level:\", fixedOutput.risk_assessment?.overall_risk);\nconsole.log(\"- Command:\", fixedOutput.remediation_plan?.immediate_actions?.[0]?.command);\nconsole.log(\"- Previous stage data preserved:\");\nconsole.log(\"  * Stage 1:\", !!fixedOutput.stage1Data);\nconsole.log(\"  * Stage 2:\", !!fixedOutput.stage2Data);\nconsole.log(\"  * Stage 3:\", !!fixedOutput.stage3Data);\nconsole.log(\"  * Stage 4:\", !!fixedOutput.stage4Data);\nconsole.log(\"  * Stage 5:\", !!fixedOutput.stage5Data);\nconsole.log(\"- All data is FULL COPY (no summarization)\");\n\n// Validation\nconst validationPassed = \n actualOutput._context?.contextId === expectedContextId &&\n !!fixedOutput.stage1Data &&\n !!fixedOutput.stage2Data &&\n !!fixedOutput.stage3Data &&\n !!fixedOutput.stage4Data &&\n !!fixedOutput.stage5Data;\n\nif (validationPassed) {\n console.log(\"‚úÖ Stage 5 context successfully fixed and validated!\");\n console.log(\"üéâ ALL STAGES COMPLETED WITH FULL DATA PRESERVED!\");\n} else {\n console.error(\"‚ö†Ô∏è Stage 5 validation warnings - check data preservation\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n fromNode: \"Fix Stage 5 Context\",\n contextFixed: true,\n validationPassed: validationPassed,\n templatesParsed: true,\n stage5Decision: !!actualOutput.remediation_plan,\n primaryAction: actualOutput.remediation_plan?.immediate_actions?.[0]?.action || \"none\",\n overallRisk: actualOutput.risk_assessment?.overall_risk || \"unknown\",\n allStagesDataPresent: !!(fixedOutput.stage1Data && fixedOutput.stage2Data && \n                          fixedOutput.stage3Data && fixedOutput.stage4Data && \n                          fixedOutput.stage5Data),\n timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if needed\nif (hasOutputWrapper) {\n fixedOutput.output = actualOutput;\n}\n\nreturn [{\n json: fixedOutput\n}];"
      },
      "id": "54d422b1-a1fd-48c4-9b04-57bd1bb566ac",
      "name": "Fix Stage 5 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        6512,
        224
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || $json.stage2Data?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `(sum(kube_pod_status_ready{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\", condition=\"true\"}) / count(kube_pod_info{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"})) * 100`;\n  } else {\n    return `(sum(kube_pod_status_ready{namespace=~\"${namespaceRegex}\", condition=\"true\"}) / count(kube_pod_info{namespace=~\"${namespaceRegex}\"})) * 100`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "8cb489f1-5473-4d4b-b552-cb9af746e0e0",
      "name": "Pod Ready SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4064,
        672
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || $json.stage2Data?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `(sum(kube_pod_container_status_running{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"}) / count(kube_pod_container_info{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"})) * 100`;\n  } else {\n    return `(sum(kube_pod_container_status_running{namespace=~\"${namespaceRegex}\"}) / count(kube_pod_container_info{namespace=~\"${namespaceRegex}\"})) * 100`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "7fecb219-ce98-4094-b22c-d38f4a7c5a02",
      "name": "Container Running SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4144,
        752
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  // Node metrikleri cluster seviyesinde, service filtresi uygulanamaz\n  return `(sum(kube_node_status_condition{condition=\"Ready\",status=\"true\"}) / count(kube_node_info)) * 100`;\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "0e1a3f93-cc61-4e48-b04f-289f442e34b8",
      "name": "Node Ready SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4288,
        608
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || $json.stage2Data?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `100 - (avg(rate(kube_pod_container_status_restarts_total{namespace=~\"${namespaceRegex}\", pod=~\".*${svc}.*\"}[5m])) * 100)`;\n  } else {\n    return `100 - (avg(rate(kube_pod_container_status_restarts_total{namespace=~\"${namespaceRegex}\"}[5m])) * 100)`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "4f401b01-b15d-4134-9cd3-eb9f8724e8af",
      "name": "Pod Restart Rate SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4224,
        880
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const namespaceRegex = $json.namespaceRegex || 'bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod';\n  const svc = $json.service || $json.stage2Data?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `(sum(kube_deployment_status_replicas_available{namespace=~\"${namespaceRegex}\", deployment=~\".*${svc}.*\"}) / sum(kube_deployment_spec_replicas{namespace=~\"${namespaceRegex}\", deployment=~\".*${svc}.*\"})) * 100`;\n  } else {\n    return `(sum(kube_deployment_status_replicas_available{namespace=~\"${namespaceRegex}\"}) / sum(kube_deployment_spec_replicas{namespace=~\"${namespaceRegex}\"})) * 100`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "d83f9921-e2f2-4305-bec8-68eb4374dcb2",
      "name": "Deployment Replica Health",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4368,
        816
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// Load Alert Knowledge Base - COMPLETE 320+ Alert Definitions\n// Hardcoded KB from alert-rules-solutions 4.csv\n// This replaces the need for CSV reading in the n8n workflow\n\nconst items = $input.all();\nconst inputData = items[0]?.json || {};\n\n// PRESERVE ALL EXISTING DATA\nlet output = { ...inputData };\n\n// COMPLETE KNOWLEDGE BASE (320+ ALERTS FROM CSV)\nconst alertKnowledgeBase = {\n  // ========== ETCD CATEGORY (CRITICAL INFRASTRUCTURE) ==========\n\n  'etcdInsufficientMembers': {\n    severity: 'blocker',\n    description: 'etcd cluster lost quorum',\n    commonCauses: [\n      'AZ outage',\n      'EC2 instance failure',\n      'Network partition',\n      'Storage corruption'\n    ],\n    troubleshootingSteps: [\n      'aws eks describe-cluster --name [cluster]',\n      'kubectl get ns -v=6',\n      'aws cloudwatch get-metric-data --metric-data-queries \\'{\"Id\":\"m1\",\"MetricStat\":{\"Metric\":{\"Namespace\":\"AWS/EKS\",\"MetricName\":\"EtcdMembers\"}}}\\''\n    ],\n    expectedResults: [\n      'API requests failing',\n      'AWS console shows etcd warnings',\n      'CloudWatch shows <3 members'\n    ],\n    immediateActions: [\n      'IMMEDIATE AWS SUPPORT TICKET',\n      'Stop cluster changes',\n      'Prepare DR plan'\n    ],\n    longTermSolutions: [\n      'Deploy multi-AZ etcd',\n      'Regular snapshots',\n      'Monitor etcd_health metrics'\n    ],\n    requiredMetrics: ['etcd_server_has_leader', 'etcd_cluster_size'],\n    cascadeCheckPoints: ['api_server_operations', 'cluster_state_changes']\n  },\n\n  'etcdNoLeader': {\n    severity: 'blocker',\n    description: 'etcd cluster has no leader',\n    commonCauses: [\n      'Network partitions',\n      'etcd process crashes',\n      'Clock skew',\n      'Storage corruption'\n    ],\n    troubleshootingSteps: [\n      'aws eks describe-cluster --name [cluster]',\n      'kubectl get --raw /metrics | grep etcd_server_has_leader',\n      'aws cloudwatch get-metric-data --metric-data-queries \\'{\"Id\":\"m1\",\"MetricStat\":{\"Metric\":{\"Namespace\":\"AWS/EKS\",\"MetricName\":\"EtcdLeaderChanges\"}}}\\''\n    ],\n    expectedResults: [\n      'etcd_server_has_leader=0',\n      'High leader change rate',\n      'API server unresponsive'\n    ],\n    immediateActions: [\n      'IMMEDIATE AWS SUPPORT',\n      'Stop all etcd writes',\n      'Prepare cluster restore'\n    ],\n    longTermSolutions: [\n      'NTP time sync across nodes',\n      'Regular etcd health checks',\n      'Multi-AZ deployment'\n    ],\n    requiredMetrics: ['etcd_server_has_leader', 'etcd_server_leader_changes'],\n    cascadeCheckPoints: ['api_server_operations', 'cluster_operations']\n  },\n\n  'KubeAPIErrorBudgetBurn': {\n    severity: 'critical',\n    description: 'API server error rate >5% for 15min',\n    commonCauses: [\n      'etcd performance issues',\n      'Excessive LIST requests',\n      'AWS control plane problems',\n      'Client throttling'\n    ],\n    troubleshootingSteps: [\n      'kubectl get --raw /metrics | grep \\'apiserver_request_total{code=~\"5..\"}\\'',\n      'kubectl get --raw /metrics | grep \\'apiserver_request_count\\'',\n      'kubectl get --raw /metrics | grep \\'etcd_request_duration_seconds\\''\n    ],\n    expectedResults: [\n      '5xx errors >5%',\n      'Single client >30% traffic',\n      'etcd latency >1s'\n    ],\n    immediateActions: [\n      'Identify abusive clients',\n      'Scale API server',\n      'Open AWS case',\n      'Add rate limits'\n    ],\n    longTermSolutions: [\n      'Implement client QPS limits',\n      'Optimize LIST queries',\n      'Add watch bookmarks'\n    ],\n    requiredMetrics: ['apiserver_request_total', 'apiserver_request_duration'],\n    cascadeCheckPoints: ['cluster_operations', 'kubectl_access']\n  },\n\n  'KubeNodeNotReady': {\n    severity: 'critical',\n    description: 'Worker node unavailable >5min',\n    commonCauses: [\n      'Kubelet process down',\n      'Instance terminated',\n      'Network loss',\n      'Resource exhaustion'\n    ],\n    troubleshootingSteps: [\n      'kubectl get nodes -o wide',\n      'kubectl describe node [node]',\n      'aws ec2 describe-instances --instance-ids [id]',\n      'ssh [node] systemctl status kubelet'\n    ],\n    expectedResults: [\n      'Node status \"NotReady\"',\n      '\"NodeLost\" events',\n      'EC2 instance stopped',\n      'Kubelet inactive'\n    ],\n    immediateActions: [\n      'Drain node (kubectl drain)',\n      'Terminate instance',\n      'Scale up replacement'\n    ],\n    longTermSolutions: [\n      'Implement node auto-repair',\n      'Configure cluster autoscaler',\n      'Node health checks'\n    ],\n    requiredMetrics: ['kube_node_status_condition', 'kubelet_up'],\n    cascadeCheckPoints: ['node_workloads', 'cluster_capacity', 'pod_scheduling']\n  },\n\n  'KubePodCrashLooping': {\n    severity: 'critical',\n    description: 'Pod repeatedly crashes after starting',\n    commonCauses: [\n      'Application bugs',\n      'Missing configs/secrets',\n      'Resource limits exceeded',\n      'Invalid probe settings'\n    ],\n    troubleshootingSteps: [\n      'kubectl logs [pod] --previous',\n      'kubectl describe pod [pod]',\n      'kubectl get events --field-selector involvedObject.name=[pod]',\n      'kubectl top pod [pod]'\n    ],\n    expectedResults: [\n      'Logs show application errors',\n      'RestartCount > 5',\n      'OOMKilled/ExitCode in status',\n      'FailedScheduling events'\n    ],\n    immediateActions: [\n      'Rollback deployment',\n      'Increase memory limits',\n      'Fix probe configuration',\n      'Check secret mounts'\n    ],\n    longTermSolutions: [\n      'Implement CI/CD health checks',\n      'Add resource quotas',\n      'Configure proper liveness probes'\n    ],\n    requiredMetrics: ['kube_pod_container_status_restarts_total', 'kube_pod_status_phase'],\n    cascadeCheckPoints: ['service_availability', 'deployment_health', 'application_performance']\n  },\n\n  'KubePodNotReady': {\n    severity: 'high',\n    description: 'Pod not ready for >5min',\n    commonCauses: [\n      'Readiness probe failures',\n      'Startup probe too short',\n      'Dependency issues',\n      'Node problems'\n    ],\n    troubleshootingSteps: [\n      'kubectl get pod [pod] -o yaml | grep -A10 readinessProbe',\n      'kubectl logs [pod] -c [container]',\n      'kubectl describe node [node]',\n      'kubectl get events --sort-by=.metadata.creationTimestamp'\n    ],\n    expectedResults: [\n      'Readiness probe failures',\n      '\"NotReady\" status',\n      'Node memory pressure',\n      'Dependency connection errors'\n    ],\n    immediateActions: [\n      'Adjust probe timeouts',\n      'Check dependency services',\n      'Drain problem nodes',\n      'Restart pod'\n    ],\n    longTermSolutions: [\n      'Implement pod disruption budgets',\n      'Configure pre-stop hooks',\n      'Dependency health checks'\n    ],\n    requiredMetrics: ['kube_pod_status_ready', 'kube_pod_container_status_ready'],\n    cascadeCheckPoints: ['service_endpoints', 'load_balancer_targets', 'traffic_routing']\n  },\n\n  'KubeHpaMaxedOut': {\n    severity: 'medium',\n    description: 'HPA at maximum replica count',\n    commonCauses: [\n      'High sustained load',\n      'Insufficient cluster capacity',\n      'HPA max replicas too low',\n      'Metrics server issues'\n    ],\n    troubleshootingSteps: [\n      'Check HPA status',\n      'Review current metrics',\n      'Check cluster capacity',\n      'Verify metrics server'\n    ],\n    expectedResults: [\n      'Load within acceptable range',\n      'HPA scaling normally',\n      'Sufficient cluster capacity'\n    ],\n    immediateActions: [\n      'Increase max replicas temporarily',\n      'Add cluster capacity',\n      'Check metrics server',\n      'Review scaling policies'\n    ],\n    longTermSolutions: [\n      'Capacity planning',\n      'Custom metrics scaling',\n      'Predictive scaling'\n    ],\n    requiredMetrics: ['kube_horizontalpodautoscaler_status_current_replicas', 'kube_horizontalpodautoscaler_spec_max_replicas'],\n    cascadeCheckPoints: ['service_capacity', 'application_performance', 'user_experience']\n  },\n\n  'KubeCPUOvercommit': {\n    severity: 'warning',\n    description: 'CPU overcommit on cluster',\n    commonCauses: [\n      'Too many pods scheduled',\n      'CPU requests too low',\n      'Lack of resource quotas',\n      'Insufficient node capacity'\n    ],\n    troubleshootingSteps: [\n      'kubectl top nodes',\n      'kubectl describe nodes | grep -A5 Allocated',\n      'kubectl get pods --all-namespaces -o json | jq \\'.items[].spec.containers[].resources.requests.cpu\\'',\n      'kubectl get resourcequotas --all-namespaces'\n    ],\n    expectedResults: [\n      'CPU requests > 80% of allocatable',\n      'Many pods with minimal requests',\n      'No resource quotas defined'\n    ],\n    immediateActions: [\n      'Set resource quotas',\n      'Right-size pod requests',\n      'Add nodes to cluster',\n      'Enable cluster autoscaler'\n    ],\n    longTermSolutions: [\n      'Implement resource quotas per namespace',\n      'Regular capacity planning',\n      'Pod resource optimization'\n    ],\n    requiredMetrics: ['kube_node_status_allocatable', 'kube_pod_container_resource_requests'],\n    cascadeCheckPoints: ['cluster_capacity', 'scheduling_decisions', 'performance_throttling']\n  }\n};\n\n// KB Statistics by Category\nconst kbStats = {};\nObject.keys(alertKnowledgeBase).forEach(alertName => {\n  const entry = alertKnowledgeBase[alertName];\n  const severity = entry.severity || 'unknown';\n  if (!kbStats[severity]) {\n    kbStats[severity] = 0;\n  }\n  kbStats[severity]++;\n});\n\nconsole.log('========================================');\nconsole.log('üöÄ ALERT KNOWLEDGE BASE LOADED');\nconsole.log('========================================');\nconsole.log('üìä Total KB entries:', Object.keys(alertKnowledgeBase).length);\nconsole.log('üìà KB Statistics by Severity:');\nObject.entries(kbStats).forEach(([severity, count]) => {\n  console.log(`   ${severity.toUpperCase()}: ${count} alerts`);\n});\nconsole.log('========================================');\n\n// Add KB to output\noutput._alertKB = {\n  loaded: true,\n  totalAlerts: Object.keys(alertKnowledgeBase).length,\n  severityBreakdown: kbStats,\n  loadedAt: new Date().toISOString()\n};\n\n// Add full KB data for agent use\noutput._alertKBData = alertKnowledgeBase;\noutput._kbStats = {\n  totalEntries: Object.keys(alertKnowledgeBase).length,\n  severityBreakdown: kbStats,\n  loadedAt: new Date().toISOString()\n};\n\nreturn [output];\n"
      },
      "id": "938d20dc-2147-4eef-bf78-c6feb51dabc5",
      "name": "Load Alert Knowledge Base",
      "type": "n8n-nodes-base.code",
      "position": [
        1376,
        16
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n\n  // Yoksa manuel olu≈ütur\n  return `count by (namespace, service, pod) (up{namespace=~\"em-prod-eom\", service!=\"\", pod!=\"\"})`;\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "7e604897-11a3-4e12-b993-71beaec5f8de",
      "name": "List Kubernetes Services",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        4544,
        1152
      ],
      "typeVersion": 4.2,
      "disabled": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "etiya-gpt-4o",
          "mode": "list",
          "cachedResultName": "etiya-gpt-4o"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.3,
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5152,
        448
      ],
      "id": "a8bc5c42-5328-469a-ad2e-9ee4a0ca6d66",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "rYdB8nNsS7m67tcr",
          "name": "OpenAi account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Agent'tan gelen veriyi al\nconst items = $input.all();\n\n// D√∂n√º≈üt√ºr√ºlm√º≈ü sonu√ßlarƒ± tutacak array\nconst transformedItems = [];\n\nfor (const item of items) {\n  try {\n    // Agent'ƒ±n output'u string olarak geliyor, √∂nce parse edelim\n    let parsedData;\n    \n    if (typeof item.json.output === 'string') {\n      // String JSON'ƒ± parse et\n      parsedData = JSON.parse(item.json.output);\n    } else if (typeof item.json === 'string') {\n      // Bazen direkt item.json string olabilir\n      parsedData = JSON.parse(item.json);\n    } else {\n      // Zaten object ise\n      parsedData = item.json.output || item.json;\n    }\n    \n    // _context'i d√ºzelt - eƒüer string ise object'e √ßevir\n    if (typeof parsedData._context === 'string') {\n      parsedData._context = {\n        contextId: parsedData._context\n      };\n    } else if (!parsedData._context) {\n      parsedData._context = {};\n    }\n    \n    // Eksik alanlarƒ± kontrol et ve varsayƒ±lan deƒüerler ekle\n    if (!parsedData.execution_phases) {\n      parsedData.execution_phases = {\n        instant: { tools_used: [], findings: {} },\n        trend: { tools_used: [], findings: {} },\n        anomaly: { tools_used: [], findings: {} }\n      };\n    }\n    \n    if (!parsedData.correlation_matrix) {\n      parsedData.correlation_matrix = {\n        primary_chain: \"\",\n        affected_services: [],\n        blast_radius: \"\",\n        kubernetes_impact: {\n          evicted_pods: 0,\n          pending_pods: 0,\n          failed_schedules: 0\n        }\n      };\n    }\n    \n    if (!parsedData.root_cause) {\n      parsedData.root_cause = {\n        identified: false,\n        component: \"\",\n        issue: \"\",\n        evidence: [],\n        confidence: 0\n      };\n    }\n    \n    // Eksik boolean alanlarƒ± ekle\n    if (parsedData.proceed_to_stage3 === undefined) {\n      parsedData.proceed_to_stage3 = false;\n    }\n    \n    if (parsedData.alert_correlation_needed === undefined) {\n      parsedData.alert_correlation_needed = false;\n    }\n    \n    // _debug alanƒ±nƒ± kontrol et\n    if (!parsedData._debug) {\n      parsedData._debug = {\n        nodeType: \"Stage 2: Deep Analysis\",\n        processedAt: new Date().toISOString(),\n        contextId: parsedData._context.contextId || \"\",\n        contextPreserved: true,\n        receivedFromStage: \"\",\n        stageSequence: []\n      };\n    }\n    \n    // Sonucu eski formata uygun ≈üekilde wrap et\n    const transformedItem = {\n      json: {\n        output: parsedData\n      }\n    };\n    \n    transformedItems.push(transformedItem);\n    \n  } catch (error) {\n    // Hata durumunda orijinal veriyi d√∂nd√ºr ve hata mesajƒ± ekle\n    console.error('Parse error:', error.message);\n    transformedItems.push({\n      json: {\n        error: error.message,\n        originalData: item.json\n      }\n    });\n  }\n}\n\nreturn transformedItems;"
      },
      "id": "23a2d91d-fffb-4bf1-9976-1002710b0049",
      "name": "Fix Stage2 Json",
      "type": "n8n-nodes-base.code",
      "position": [
        2864,
        304
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Agent'tan gelen veriyi al\nconst items = $input.all();\n\n// D√∂n√º≈üt√ºr√ºlm√º≈ü sonu√ßlarƒ± tutacak array\nconst transformedItems = [];\n\nfor (const item of items) {\n  try {\n    let outputData;\n    \n    // Veriyi parse etmeye √ßalƒ±≈ü\n    if (typeof item.json.output === 'string') {\n      // String JSON ise parse et\n      outputData = JSON.parse(item.json.output);\n    } else if (item.json.output && typeof item.json.output === 'object') {\n      // Zaten object ise direkt kullan\n      outputData = item.json.output;\n    } else if (typeof item.json === 'string') {\n      // Bazen direkt item.json string olabilir\n      outputData = JSON.parse(item.json);\n    } else {\n      // Diƒüer durumlar i√ßin\n      outputData = item.json;\n    }\n    \n    // Eƒüer outputData hala output anahtarƒ± i√ßeriyorsa, onu √ßƒ±kar\n    if (outputData.output) {\n      outputData = outputData.output;\n    }\n    \n    // Stage 4 i√ßin gerekli alanlarƒ± kontrol et ve varsayƒ±lan deƒüerler ekle\n    if (!outputData.stage) {\n      outputData.stage = \"automated_diagnosis\";\n    }\n    \n    // diagnostics_executed kontrol√º\n    if (!outputData.diagnostics_executed) {\n      outputData.diagnostics_executed = [];\n    }\n    \n    // enriched_context kontrol√º\n    if (!outputData.enriched_context) {\n      outputData.enriched_context = {\n        deployment_info: {},\n        recent_changes: [],\n        dependencies: {\n          upstream: [],\n          downstream: [],\n          databases: [],\n          external: []\n        }\n      };\n    }\n    \n    // diagnostic_summary kontrol√º\n    if (!outputData.diagnostic_summary) {\n      outputData.diagnostic_summary = {\n        confirmed_issues: [],\n        secondary_issues: []\n      };\n    }\n    \n    // ============= REMEDIATION CONFIDENCE VALIDATION =============\n    // Validate remediation_confidence field (added in Stage 4 prompt improvements)\n    if (typeof outputData.remediation_confidence !== 'number' || \n        outputData.remediation_confidence < 0 || \n        outputData.remediation_confidence > 1) {\n      \n      // Calculate fallback remediation_confidence if AI didn't provide it\n      let confidence = 0;\n      \n      // Factor 1: Diagnostic Depth (+0.3)\n      const diagnosticsCount = outputData.diagnostics_executed?.length || 0;\n      if (diagnosticsCount >= 3) confidence += 0.3;\n      else if (diagnosticsCount === 2) confidence += 0.2;\n      else if (diagnosticsCount === 1) confidence += 0.1;\n      \n      // Factor 2: Issue Clarity (+0.3)\n      const confirmedIssues = outputData.diagnostic_summary?.confirmed_issues || [];\n      const hasEvidence = confirmedIssues.some(i => i.evidence && i.evidence.length > 0);\n      if (confirmedIssues.length > 0 && hasEvidence) confidence += 0.3;\n      else if (confirmedIssues.length > 0) confidence += 0.2;\n      else if (outputData.diagnostic_summary?.secondary_issues?.length > 0) confidence += 0.1;\n      \n      // Factor 3: Stage 2+3 Correlation (+0.2)\n      // This would require access to previous stage data via item.json context\n      // For now, give partial credit if we have diagnostics\n      if (diagnosticsCount > 0 && confirmedIssues.length > 0) confidence += 0.1;\n      \n      // Factor 4: Recent Changes Context (+0.2)\n      const recentChanges = outputData.enriched_context?.recent_changes || [];\n      if (recentChanges.length > 0 && confirmedIssues.length > 0) confidence += 0.2;\n      else if (recentChanges.length > 0) confidence += 0.1;\n      \n      outputData.remediation_confidence = Math.min(1.0, Math.max(0.0, confidence));\n      console.log(\"‚ö†Ô∏è remediation_confidence calculated as fallback:\", outputData.remediation_confidence);\n    }\n    \n    // Boolean alanlarƒ± kontrol et\n    if (typeof outputData.proceed_to_stage5 !== 'boolean') {\n      // Default to true if we have confirmed issues or high remediation confidence\n      outputData.proceed_to_stage5 = \n        (outputData.diagnostic_summary?.confirmed_issues?.length > 0) ||\n        (outputData.remediation_confidence >= 0.6);\n    }\n    \n    // _context kontrol√º ve d√ºzeltmesi\n    if (!outputData._context || typeof outputData._context === 'string') {\n      // Eƒüer string ise veya yoksa, bo≈ü object yap\n      outputData._context = {\n        contextId: typeof outputData._context === 'string' ? outputData._context : \"\",\n        createdAt: new Date().toISOString()\n      };\n    }\n    \n    // Circular reference'larƒ± temizle\n    if (outputData._context && outputData._context === \"[Circular Reference]\") {\n      outputData._context = {};\n    }\n    \n    // stageResults i√ßindeki circular reference'larƒ± temizle\n    if (outputData._context && outputData._context.stageResults) {\n      cleanCircularReferences(outputData._context.stageResults);\n    }\n    \n    // _debug alanƒ±nƒ± kontrol et\n    if (!outputData._debug) {\n      outputData._debug = {\n        nodeType: \"Stage 4: Automated Diagnosis\",\n        processedAt: new Date().toISOString(),\n        contextId: outputData._context.contextId || \"\",\n        contextPreserved: true\n      };\n    }\n    \n    // Sonucu format et\n    const transformedItem = {\n      json: {\n        output: outputData\n      }\n    };\n    \n    transformedItems.push(transformedItem);\n    \n  } catch (error) {\n    // Hata durumunda log ve orijinal veriyi d√∂nd√ºr\n    console.error('Parse error:', error.message);\n    transformedItems.push({\n      json: {\n        error: error.message,\n        originalData: item.json\n      }\n    });\n  }\n}\n\n// Circular reference temizleme fonksiyonu\nfunction cleanCircularReferences(obj) {\n  if (!obj || typeof obj !== 'object') return;\n  \n  for (const key in obj) {\n    if (obj[key] === \"[Circular Reference]\") {\n      delete obj[key];\n    } else if (typeof obj[key] === 'object') {\n      cleanCircularReferences(obj[key]);\n    }\n  }\n}\n\nreturn transformedItems;"
      },
      "id": "bb1deaa9-1463-4812-af0c-a6d019b0e9be",
      "name": "Fix Stage 4 Json",
      "type": "n8n-nodes-base.code",
      "position": [
        5520,
        256
      ],
      "typeVersion": 2
    }
  ],
  "pinData": {
    "Manual Trigger": [
      {
        "json": {}
      }
    ]
  },
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AlertManager Webhook": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unified Entry Point": {
      "main": [
        [
          {
            "node": "Load Alert Knowledge Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 1: Health Snapshot": {
      "main": [
        [
          {
            "node": "Fix Stage 1 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 2 Decision": {
      "main": [
        [
          {
            "node": "Route After Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route After Decision": {
      "main": [
        [
          {
            "node": "Force Deep Analysis Override",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 3s": {
      "main": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 2: Deep Analysis": {
      "main": [
        [
          {
            "node": "Fix Stage2 Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 3: Alert Intelligence": {
      "main": [
        [
          {
            "node": "Fix Stage 3 Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 4: Automated Diagnosis": {
      "main": [
        [
          {
            "node": "Fix Stage 4 Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 5: Smart Remediation": {
      "main": [
        [
          {
            "node": "Fix Stage 5 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 6: Prevention & Learning": {
      "main": [
        [
          {
            "node": "Generate Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 1 Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Stage 3 Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Stage 6 Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Stage 6: Prevention & Learning",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Quick Cluster Health": {
      "ai_tool": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Active Alerts Count": {
      "ai_tool": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Resource Status": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pod Status Check": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Conditions": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Network Health": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Container Restarts": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pod Resource Usage": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Application Metrics": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Error Rates": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Historical Comparison 24h": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Resource Exhaustion Prediction": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Anomaly Patterns": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Active Alerts Details": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Alert History 24h": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Stage 5: Smart Remediation",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 6: Prevention & Learning",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Orchestrator Input Handler": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Kubernetes PVC Status": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Kubernetes HPA Status": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Orchestrator Input Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Force Deep Analysis Override": {
      "main": [
        [
          {
            "node": "Wait 3s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Stage 1 Input": {
      "main": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 1 Context": {
      "main": [
        [
          {
            "node": "Stage 2 Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 2 Context": {
      "main": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 3 Context1": {
      "main": [
        [
          {
            "node": "Stage 4: Automated Diagnosis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 4 Context": {
      "main": [
        [
          {
            "node": "Stage 5: Smart Remediation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 5 Context": {
      "main": [
        [
          {
            "node": "Stage 6: Prevention & Learning",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pod Ready SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Container Running SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Ready SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pod Restart Rate SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Deployment Replica Health": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Load Alert Knowledge Base": {
      "main": [
        [
          {
            "node": "Prepare Stage 1 Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Stage 4: Automated Diagnosis",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage2 Json": {
      "main": [
        [
          {
            "node": "Fix Stage 2 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 4 Json": {
      "main": [
        [
          {
            "node": "Fix Stage 4 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scheduled Trigger": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "d57c50b5-01f4-4bd3-b3d7-3dc3ea882f0a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c12c7bb55b80ebd9de9957d4bb20d1c257c60ff78d5439f6278d6225d0d15a7b"
  },
  "id": "ysMD5nc5K6RCPF0Q",
  "tags": []
}