# TempoFlow Tempo Query Examples

**Purpose**: Real query examples used in TempoFlow for Grafana Tempo

---

## ðŸ” Multi-Namespace Service Error Query

**Generated By**: Node 4 (Service-Aware Query Builder)
**Used In**: Recent Errors HTTP tool (Stage 1)
**Location**: `enhancedParams.serviceAnalysis.enhancedQueries.serviceErrors`

### Query Structure:

```traceql
{ resource.deployment.environment=~"NAMESPACE_PATTERN" && (SERVICE_FILTER) && status.code>=400 }
```

### Real Production Example:

```traceql
{ resource.deployment.environment=~"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod" && (service.name="APIGateway" || service.name="crm-mash-up" || service.name="crm-customer-information" || service.name="crm-asset" || service.name="domain-config-service" || service.name="ntf-engine-service" || service.name="ntf-history-service" || service.name="bss-services-service.etiyamobile-production-eom" || service.name="bss-mc-domain-config-t4" || service.name="bss-mc-ntf-engine-t4" || service.name="bstp-pcm-product-catalog" || service.name="eca-t4" || service.name="bss-mc-asset-management-t4" || service.name="bss-mc-crm-customer-information-t4" || service.name="bss-mc-pcm-product-catalog-t4" || service.name="cpq-ordercapture" || service.name="bstp-pcm-product-offer-detail" || service.name="activity" || service.name="bss-mc-cpq-t4" || service.name="customer-search-mc-backend" || service.name="ui-authz-mc-backend") && status.code>=400 }
```

### Query Breakdown:

**1. Namespace Filter (12 namespaces)**:
```traceql
resource.deployment.environment=~"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod"
```

**2. Service Filter (20 critical services)**:
```traceql
(service.name="APIGateway" ||
 service.name="crm-mash-up" ||
 service.name="crm-customer-information" ||
 service.name="crm-asset" ||
 service.name="domain-config-service" ||
 service.name="ntf-engine-service" ||
 service.name="ntf-history-service" ||
 service.name="bss-services-service.etiyamobile-production-eom" ||
 service.name="bss-mc-domain-config-t4" ||
 service.name="bss-mc-ntf-engine-t4" ||
 service.name="bstp-pcm-product-catalog" ||
 service.name="eca-t4" ||
 service.name="bss-mc-asset-management-t4" ||
 service.name="bss-mc-crm-customer-information-t4" ||
 service.name="bss-mc-pcm-product-catalog-t4" ||
 service.name="cpq-ordercapture" ||
 service.name="bstp-pcm-product-offer-detail" ||
 service.name="activity" ||
 service.name="bss-mc-cpq-t4" ||
 service.name="customer-search-mc-backend" ||
 service.name="ui-authz-mc-backend")
```

**3. Error Filter**:
```traceql
status.code>=400
```

---

## âš¡ Multi-Namespace High Latency Query

**Generated By**: Node 4 (Service-Aware Query Builder)
**Used In**: Stage 2 Deep Dive (critical services only)
**Location**: `enhancedParams.serviceAnalysis.enhancedQueries.criticalLatency`

### Query Structure:

```traceql
{ resource.deployment.environment=~"NAMESPACE_PATTERN" && (CRITICAL_SERVICE_FILTER) && duration > 500ms }
```

### Real Production Example (Critical Services Only):

```traceql
{ resource.deployment.environment=~"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod" && (service.name="APIGateway" || service.name="ui-authz-mc-backend" || service.name="crm-customer-information" || service.name="cpq-ordercapture") && duration > 500ms }
```

### Query Breakdown:

**1. Namespace Filter**: Same as above (12 namespaces)

**2. Critical Service Filter** (only `criticality: "critical"` services):
```traceql
(service.name="APIGateway" ||
 service.name="ui-authz-mc-backend" ||
 service.name="crm-customer-information" ||
 service.name="cpq-ordercapture")
```

**3. Latency Threshold**:
```traceql
duration > 500ms
```

---

## ðŸŽ¯ Orchestrator Mode Query

**Generated By**: Node 1 (Unified Entry Point)
**Used In**: Orchestrator-triggered analysis
**Location**: `config.searchParams.customQuery`

### Query Structure (All Errors):

```traceql
{resource.deployment.environment=~"NAMESPACE_PATTERN" && status.code>=400}
```

### Real Production Example:

```traceql
{resource.deployment.environment=~"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod" && status.code>=400}
```

### With Service Filter:

```traceql
{resource.deployment.environment=~"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod" && (service.name=~".*payment.*" || service.name=~".*auth.*") && status.code>=400}
```

---

## ðŸ“ Chat Mode Query

**Generated By**: Node 1 (Unified Entry Point) â†’ Node 4 (Service Detection)
**Used In**: Chat-triggered analysis
**Location**: `config.searchParams.customQuery`

### Example: User asks "payment errors?"

**Service Detection**: `cpq-ordercapture`, `bstp-cpq-batch`, `bss-services-service.etiyamobile-production-eom`

**Generated Query**:
```traceql
{ resource.deployment.environment=~"bstp-cms-global-production|bstp-cms-prod-v3|em-global-prod-3pp|em-global-prod-eom|em-global-prod-flowe|em-global-prod|em-prod-3pp|em-prod-eom|em-prod-flowe|em-prod|etiyamobile-production|etiyamobile-prod" && (service.name="cpq-ordercapture" || service.name="bstp-cpq-batch" || service.name="bss-services-service.etiyamobile-production-eom") && status.code>=400 }
```

---

## âš ï¸ TraceQL Syntax Rules

### âœ… CORRECT Syntax:

1. **Span Attributes** (require `.` prefix for sub-fields):
   - `status.code>=400` âœ…
   - `resource.deployment.environment=~"pattern"` âœ…
   - `service.name="value"` âœ…

2. **Regex Matching**:
   - `=~"pattern"` for regex
   - `="exact"` for exact match

3. **Logical Operators**:
   - `&&` for AND
   - `||` for OR
   - Parentheses for grouping: `(A || B) && C`

### âŒ INCORRECT Syntax:

1. **Missing Sub-field**:
   - `status=error` âŒ â†’ `status.code>=400` âœ…
   - `status=~"error"` âŒ â†’ `status.code=~"4..|5.."` âœ…

2. **Invalid Attribute Paths**:
   - `.status.code` âŒ (leading dot) â†’ `status.code` âœ…
   - `.service.name` âŒ (leading dot) â†’ `service.name` âœ…

3. **Wrong Operators**:
   - `status.code="error"` âŒ â†’ `status.code>=400` âœ…

---

## ðŸ”§ Query Generation Code

### Node 4 (Service-Aware Query Builder):

```javascript
// Build enhanced Tempo queries - MULTI-NAMESPACE SUPPORT
const namespaces = input.searchParams?.namespaces || [
  "bstp-cms-global-production",
  "bstp-cms-prod-v3",
  "em-global-prod-3pp",
  "em-global-prod-eom",
  "em-global-prod-flowe",
  "em-global-prod",
  "em-prod-3pp",
  "em-prod-eom",
  "em-prod-flowe",
  "em-prod",
  "etiyamobile-production",
  "etiyamobile-prod"
];
const namespacePattern = namespaces.join('|');

// Query 1: Service-specific errors across ALL namespaces
if (enhancedParams.serviceAnalysis.detectedServices.length > 0) {
  const serviceFilter = enhancedParams.serviceAnalysis.detectedServices
    .map(s => `service.name="${s}"`)
    .join(' || ');

  enhancedParams.serviceAnalysis.enhancedQueries.serviceErrors =
    `{ resource.deployment.environment=~"${namespacePattern}" && (${serviceFilter}) && status.code>=400 }`;
}

// Query 2: High latency for critical services across ALL namespaces
const criticalServices = enhancedParams.serviceAnalysis.detectedServices
  .filter(s => enhancedParams.serviceAnalysis.serviceMetadata[s]?.criticality === 'critical');

if (criticalServices.length > 0) {
  const criticalFilter = criticalServices.map(s => `service.name="${s}"`).join(' || ');
  enhancedParams.serviceAnalysis.enhancedQueries.criticalLatency =
    `{ resource.deployment.environment=~"${namespacePattern}" && (${criticalFilter}) && duration > 500ms }`;
}
```

### Node 1 (Unified Entry Point):

```javascript
// Build Tempo query - MULTI-NAMESPACE SUPPORT
const namespacePattern = config.searchParams.namespaces.join('|');
let tempoQuery = `{resource.deployment.environment=~"${namespacePattern}"`;

// For critical priority, search for all errors
if (config.analysisConfig.priority === 'critical' &&
    config.searchParams.errorTypes.includes('all_errors')) {
  tempoQuery += ` && status.code>=400`;
} else if (config.searchParams.statusCodes.length > 0) {
  const codes = config.searchParams.statusCodes.join('|');
  tempoQuery += ` && status.code=~"${codes}"`;
}

// Add service filter if specified
if (config.searchParams.services.length > 0) {
  const serviceFilter = config.searchParams.services
    .map(s => `service.name=~".*${s}.*"`)
    .join(' || ');
  tempoQuery += ` && (${serviceFilter})`;
}

// Close the query
tempoQuery += '}';
```

---

## ðŸ“Š Query Performance Considerations

### Namespace Regex Pattern:
- **12 namespaces** in pattern: `=~"ns1|ns2|...|ns12"`
- **Impact**: Scans all 12 namespaces in parallel
- **Performance**: Acceptable for production (Tempo optimized for regex)

### Service Filter:
- **Up to 37 services** in OR condition
- **Impact**: Large service list increases query complexity
- **Mitigation**: Only include detected services (typically 5-20)

### Status Code Filter:
- **Single range**: `status.code>=400` (fastest)
- **Regex pattern**: `status.code=~"4..|5.."` (slower)
- **Exact codes**: `status.code=~"404|500|503"` (moderate)

---

## ðŸ§ª Testing Queries

### Test in Grafana Tempo UI:

1. Navigate to: **Explore** â†’ **Tempo** datasource
2. Select **TraceQL** query type
3. Paste query from examples above
4. Click **Run query**

### Expected Results:

- **Valid Query**: Returns traces or "No traces found"
- **Syntax Error**: Shows error at specific column
- **Invalid Attribute**: "unknown attribute" error

---

**Last Updated**: 2025-12-21
**Version**: 2.0 (Multi-Namespace Support)
