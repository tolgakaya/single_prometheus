{
  "name": "Scheduled Cluster Health Checker",
  "nodes": [
    {
      "parameters": {},
      "id": "71604844-626d-4c81-933c-86cf5176a0e0",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        -3728,
        16
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "5e34495d-7a68-4874-925d-dd35d2acdbe3",
      "name": "Scheduled Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        -3712,
        448
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -3728,
        192
      ],
      "id": "c58b9e3e-ea12-466d-a26e-2dbf0c8a28e4",
      "name": "When chat message received",
      "webhookId": "0e174fa6-89e0-4e54-b544-4f869ab04fed"
    },
    {
      "parameters": {
        "path": "53adcc16-6fcc-494f-9264-06eeb33cdc7d",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "0c8e86a0-12d3-4b2a-860a-8e966061575c",
      "name": "AlertManager Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -3712,
        720
      ],
      "typeVersion": 2,
      "webhookId": "53adcc16-6fcc-494f-9264-06eeb33cdc7d",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Unified Entry Point - Orchestrator Request Handler with Enhanced Context\n\n// Default production namespaces to monitor (matches Alert-Driven flow)\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\n// Default production services to monitor (from kubectl get service -A)\nconst DEFAULT_SERVICES = [\n  'bss-mc-crm-search-integrator', 'bss-mc-crm-customer-information', 'bss-mc-crm-customer-search',\n  'bss-mc-crm-mash-up', 'bss-mc-crm-ntf-integrator', 'bss-mc-activity', 'bss-mc-asset-management',\n  'bss-mc-cpq', 'bss-mc-cpq-batch', 'bss-mc-cpq-ntf-integrator', 'bss-mc-csr', 'bss-mc-domain-config',\n  'bss-mc-id-service', 'bss-mc-message-relay', 'bss-mc-ntf-engine', 'bss-mc-ntf-history', 'bss-mc-rim',\n  'bss-mc-ui-authz', 'bss-mc-user-management', 'bss-mc-wsc-new', 'bss-crm-batch', 'bss-ntf-batch',\n  'bss-mc-pcm-cfm', 'bss-mc-pcm-cms-integrator', 'bss-mc-pcm-product-catalog', 'bss-mc-pcm-product-offer-detail',\n  'bss-mc-pcm-next-gen-admintoolbox-config-manager', 'bss-mc-pcm-next-gen-admintoolbox-ui',\n  'eom-micro-flows', 'eom-operate', 'eom-scheduler', 'eom-ui', 'eom-activemqqueueoperations',\n  'eom-postgresqldboperations', 'eom-zeebe', 'eom-castlemock', 'bss-services-service',\n  'external-services-service', 'loyalty-services-service', 'om-services-service', 'fstp-bpmn-ms',\n  'fstp-configuration-ms', 'fstp-dashboard-ms', 'fstp-frontend', 'fstp-orchestra-ms', 'fstp-scheduler-ms',\n  'fstp-eca', 'eca', 'wso2am-gw-service', 'wso2am-cp-service', 'bss-saas-control-plane',\n  'bss-saas-control-plane-ui', 'bss-tenant-control-plane-batch'\n];\n\nconst input = $input.first().json;\n\n// Detect source and extract parameters\nlet source = {};\nlet analysisParams = {};\n\nif (input.orchestratorId && input.startTime && input.endTime) {\n  // From orchestrator - DEƒûƒ∞≈ûƒ∞KLƒ∞K YOK\n  source = {\n    type: 'orchestrator',\n    orchestratorId: input.orchestratorId,\n    requestId: input.requestId || `req-${Date.now()}`,\n    priority: input.priority || 'normal'\n  };\n  \n  analysisParams = {\n    startTime: input.startTime,\n    endTime: input.endTime,\n    namespaces: (input.namespaces && input.namespaces.length > 0) ? input.namespaces : DEFAULT_NAMESPACES,\n    focusAreas: input.focusAreas || [],\n    analysisType: input.analysisType || 'general',\n    context: input.context || {}\n  };\n  \n} else if (input.chatInput || input.sessionId) {\n  // From chat - SERVICE EXTRACTION EKLENDƒ∞\n  source = {\n    type: 'chat',\n    sessionId: input.sessionId,\n    priority: 'normal'\n  };\n  \n  const message = input.chatInput || '';\n  const timeRange = parseTimeFromMessage(message);\n  \n  analysisParams = {\n    startTime: Math.floor(new Date(timeRange.start).getTime() / 1000),\n    endTime: Math.floor(new Date(timeRange.end).getTime() / 1000),\n    namespaces: DEFAULT_NAMESPACES,\n    userMessage: message,\n    keywords: extractKeywords(message)\n  };\n  \n  // YENƒ∞: Service extraction for chat messages\n  const services = extractServicesFromMessage(message);\n  if (services.length > 0) {\n    analysisParams.services = services;\n  } else {\n    analysisParams.services = DEFAULT_SERVICES;\n  }\n  \n} else if (input.webhookUrl && input.body) {\n  // From webhook - DEƒûƒ∞≈ûƒ∞KLƒ∞K YOK\n  source = {\n    type: 'webhook',\n    url: input.webhookUrl,\n    priority: input.body.severity === 'critical' ? 'high' : 'normal'\n  };\n  \n  analysisParams = {\n    startTime: Math.floor(Date.now() / 1000) - 3600,\n    endTime: Math.floor(Date.now() / 1000),\n    alerts: input.body.alerts || [],\n    incidentId: input.body.incident_id\n  };\n  \n} else {\n  // Manual or unknown trigger - G√úNCELLEME: searchParams kontrol√º eklendi\n  source = {\n    type: 'manual',\n    priority: input.priority || 'normal'\n  };\n  \n  analysisParams = {\n    startTime: input.startTime || Math.floor(Date.now() / 1000) - 3600,\n    endTime: input.endTime || Math.floor(Date.now() / 1000),\n    namespaces: (input.namespaces && input.namespaces.length > 0) ? input.namespaces : DEFAULT_NAMESPACES,\n    services: (input.searchParams?.services && input.searchParams.services.length > 0)\n      ? input.searchParams.services\n      : DEFAULT_SERVICES,\n    focusAreas: input.focusAreas || [],\n    analysisType: input.analysisType || 'general',\n    context: input.context || {}\n  };\n\n  // G√úNCELLEME: Orchestrator'dan gelen servis bilgisini al\n  if (source.type === 'manual' && input.searchParams?.services) {\n    analysisParams.services = input.searchParams.services;\n    console.log(\"Services from orchestrator:\", analysisParams.services);\n  }\n}\n\n// G√úNCELLEME: forceDeepAnalysis mantƒ±ƒüƒ±nƒ± ekle\nconst forceDeepAnalysis = source.priority === 'critical' || \n                         input.forceDeepAnalysis || \n                         input.analysisConfig?.forceDeepAnalysis ||\n                         false;\n\n// Stage configuration based on priority - G√úNCELLENDƒ∞\nlet stageConfig = {\n  maxStages: 1,\n  enablePatternAnalysis: false,\n  enableAnomalyDetection: false,\n  enablePredictiveAnalysis: false,\n  forceDeepAnalysis: forceDeepAnalysis  // YENƒ∞\n};\n\nif (source.priority === 'critical' || forceDeepAnalysis) {\n  stageConfig = {\n    maxStages: 3,\n    enablePatternAnalysis: true,\n    enableAnomalyDetection: true,\n    enablePredictiveAnalysis: true,\n    forceDeepAnalysis: true  // YENƒ∞\n  };\n} else if (source.priority === 'high') {\n  stageConfig = {\n    maxStages: 2,\n    enablePatternAnalysis: true,\n    enableAnomalyDetection: true,\n    enablePredictiveAnalysis: false,\n    forceDeepAnalysis: false\n  };\n}\n\n// Helper functions - MEVCUT FONKSƒ∞YONLAR AYNEN KALIYOR\n// Helper functions\nfunction parseTimeFromMessage(message) {\n  const now = Date.now();\n  const msgLower = message.toLowerCase();\n  \n  if (msgLower.includes('last hour') || msgLower.includes('son 1 saat')) {\n    return {\n      start: new Date(now - 3600000).toISOString(),\n      end: new Date(now).toISOString()\n    };\n  } else if (msgLower.includes('last 2 hours') || msgLower.includes('son 2 saat')) {\n    return {\n      start: new Date(now - 7200000).toISOString(),\n      end: new Date(now).toISOString()\n    };\n  } else if (msgLower.includes('today') || msgLower.includes('bug√ºn')) {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    return {\n      start: today.toISOString(),\n      end: new Date(now).toISOString()\n    };\n  }\n  \n  return {\n    start: new Date(now - 3600000).toISOString(),\n    end: new Date(now).toISOString()\n  };\n}\n\nfunction extractKeywords(message) {\n  const keywords = [];\n  const msgLower = message.toLowerCase();\n  \n  if (msgLower.includes('cpu')) keywords.push('cpu_usage');\n  if (msgLower.includes('memory')) keywords.push('memory_usage');\n  if (msgLower.includes('disk')) keywords.push('disk_usage');\n  if (msgLower.includes('network')) keywords.push('network_traffic');\n  if (msgLower.includes('error')) keywords.push('error_rate');\n  if (msgLower.includes('latency')) keywords.push('response_time');\n  \n  const services = message.match(/(payment|order|user|auth|inventory)/gi);\n  if (services) keywords.push(...services.map(s => s.toLowerCase()));\n  \n  return [...new Set(keywords)];\n}\n\n// YENƒ∞ FONKSƒ∞YON: Service extraction helper\nfunction extractServicesFromMessage(message) {\n  const services = [];\n  \n  // Pattern 1: Kubernetes service name pattern\n  const k8sServicePattern = /\\b([a-z0-9]+(?:-[a-z0-9]+){2,})(?:-service|-api|-svc)?\\b/gi;\n  const k8sMatches = message.matchAll(k8sServicePattern);\n  for (const match of k8sMatches) {\n    const serviceName = match[0].toLowerCase();\n    if (!serviceName.endsWith('-i√ßin') && \n        !serviceName.endsWith('-analiz') && \n        !serviceName.endsWith('-servisi') &&\n        !serviceName.includes('saatlik')) {\n      services.push(serviceName);\n    }\n  }\n  \n  // Pattern 2: \"service: xxx\" veya \"servis: xxx\" formatƒ±\n  const explicitPattern = /(?:service|servis):\\s*([a-zA-Z0-9-]+)/gi;\n  const explicitMatches = message.matchAll(explicitPattern);\n  for (const match of explicitMatches) {\n    services.push(match[1].toLowerCase());\n  }\n  \n  // Pattern 3: \" servisi\" kelimesinden √∂nceki kelime\n  const turkishPattern = /([a-zA-Z0-9-]+)\\s+servisi/gi;\n  const turkishMatches = message.matchAll(turkishPattern);\n  for (const match of turkishMatches) {\n    if (!services.includes(match[1].toLowerCase())) {\n      services.push(match[1].toLowerCase());\n    }\n  }\n  \n  return [...new Set(services)];\n}\n\n// YENƒ∞: Enhanced context structure\nconst contextId = `ctx-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n// Output format - CONTEXT ENHANCED\nreturn [{\n  json: {\n    timestamp: new Date().toISOString(),\n    source: source,\n    analysisParams: analysisParams,\n    stageConfig: stageConfig,\n    priority: source.priority,\n    forceDeepAnalysis: forceDeepAnalysis,\n    metadata: {\n      workflowId: $workflow.id,\n      executionId: $execution.id,\n      orchestratorId: source.orchestratorId || null,\n      requestId: source.requestId || `req-${Date.now()}`\n    },\n    // YENƒ∞: Master context object\n    _context: {\n      contextId: contextId,\n      createdAt: new Date().toISOString(),\n      source: source,\n      initialParams: analysisParams,\n      stageConfig: stageConfig,\n      priority: source.priority,\n      forceDeepAnalysis: forceDeepAnalysis,\n      workflowMetadata: {\n        workflowId: $workflow.id,\n        executionId: $execution.id,\n        orchestratorId: source.orchestratorId || null,\n        requestId: source.requestId || `req-${Date.now()}`\n      },\n      stageResults: {}, // Will be populated by each stage\n      decisions: {},    // Will store decision points\n      debug: {\n        contextVersion: '1.0',\n        createdBy: 'Unified Entry Point'\n      }\n    }\n  }\n}];"
      },
      "id": "58273cc5-1d94-4422-9850-557588c4bdb2",
      "name": "Unified Entry Point",
      "type": "n8n-nodes-base.code",
      "position": [
        -3328,
        448
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 1: Ultra-Fast Kubernetes Health Assessment - CONTEXT AWARE\n\nYou are a specialized AI agent for rapid Kubernetes cluster health check using Prometheus metrics.\n\n## üéØ YOUR MISSION: INSTANT HEALTH SNAPSHOT\n\nExecute ONLY these tools in sequence:\n1. `Quick Cluster Health` - Overall cluster status\n2. `Active Alerts Count` - Current firing alerts\n\nComplete in <5 seconds and determine if deeper investigation needed.\n\n**NOTE**: You are analyzing {{ $json.analysisParams?.services?.length || 0 }} pre-configured services across {{ $json._context.initialParams.namespaces.length }} namespaces. These services are defined in the system configuration.\n\n## üïê TIME PARAMETERS:\nUse these EXACT timestamps from context:\n- Start Time: {{ $json._context.initialParams.startTime }}\n- End Time: {{ $json._context.initialParams.endTime }}\n\nIMPORTANT: \n- These are Unix timestamps in seconds\n- Convert them properly for display: new Date(timestamp * 1000).toISOString()\n- DO NOT use hardcoded dates like \"2024-01-15\"\n- Use actual data from Prometheus queries, not mock data\n\nWhen calling Prometheus tools, ALWAYS use:\n{\n  \"start\": {{ $json._context.initialParams.startTime }},\n  \"end\": {{ $json._context.initialParams.endTime }},\n  \"step\": 60\n}\n\n## üéØ NAMESPACE & SERVICE FILTERING:\n\n**CRITICAL: Use these READY-TO-USE query filters in ALL Prometheus queries:**\n\nNamespace regex pattern (use in all queries): {{ $json.namespaceRegex }}\nService regex pattern (use if filtering services): {{ $json.serviceRegex }}\n\n**COPY THESE EXACT FILTERS INTO YOUR PROMETHEUS QUERIES:**\n1. Namespace filter only: {{ $json.queryHelpers?.namespaceFilter }}\n2. Combined namespace + service: {{ $json.queryHelpers?.combinedFilter }}\n\n**READY-TO-USE EXAMPLE QUERIES (COPY EXACTLY):**\n- Pod count query: {{ $json.queryHelpers?.exampleQueries?.podCount }}\n- Service list query: {{ $json.queryHelpers?.exampleQueries?.serviceList }}\n- Alert count query: {{ $json.queryHelpers?.exampleQueries?.alertCount }}\n\n**CRITICAL RULES:**\n- NEVER use hardcoded namespaces like \"etiyamobile-production\"\n- COPY the ready-to-use queries shown above\n- DO NOT construct your own namespace regex - use {{ $json.namespaceRegex }}\n- The filters above are pre-validated and ready to paste\n\n**For reference, target namespaces:**\n{{ JSON.stringify($json._context.initialParams.namespaces) }}\n\n## üö® CRITICAL OUTPUT REQUIREMENT:\n**YOU MUST RETURN ONLY VALID JSON - NO MARKDOWN, NO CODE BLOCKS, NO EXTRA TEXT**\n**DO NOT WRAP YOUR RESPONSE IN ```json``` TAGS**\n**RETURN RAW JSON ONLY**\n\n## üìã CRITICAL CONTEXT INFORMATION:\nYOU MUST USE THIS EXACT CONTEXT - DO NOT CREATE YOUR OWN VALUES:\n- Context ID: {{ $json.contextId }}\n- Full Context Object: {{ JSON.stringify($json._context) }}\n- Context Data Backup: {{ JSON.stringify($json.contextData) }}\n\n## üíæ OUTPUT FORMAT (MUST BE PURE JSON):\n\n## üîß JSON FORMAT VALIDATION RULES:\n\n1. Start your response with { and end with }\n2. Do not include any text before or after the JSON\n3. Ensure all string values are in double quotes\n4. Ensure all numbers are unquoted (not \"5\" but 5)\n5. Ensure booleans are unquoted (not \"true\" but true)\n6. For _context field, use this exact value: {{ JSON.stringify($json._context) }}\n7. Arrays must use square brackets []\n8. Empty arrays are valid: []\n9. Validate JSON mentally before returning\n\n## ‚úÖ FINAL CHECK:\nBefore returning, ensure your response:\n- Starts with { (no backticks, no ```json)\n- Ends with } (no backticks, no ```)\n- Contains valid JSON that can be parsed by JSON.parse()\n- Has all required fields from the template above\n- Uses actual tool data, not placeholder values\n\nReturn ONLY this JSON structure with NO markdown formatting:\n\n{\n  \"stage\": \"health_snapshot\",\n  \"timestamp\": \"<use actual current ISO timestamp from new Date().toISOString()>\",\n  \"cluster\": \"etiyamobile-production\",\n  \"overall_status\": \"<one of: healthy|degraded|critical>\",\n  \"scores\": {\n    \"cluster_health\": <actual number from tool response>,\n    \"node_availability\": <actual number from tool response>,\n    \"pod_stability\": <actual number from tool response>,\n    \"api_reliability\": <actual number from tool response>\n  },\n  \"services_analyzed\": {{ JSON.stringify($json.analysisParams?.services || $json.initialParams?.services || []) }},\n  \"services_count\": {{ ($json.analysisParams?.services || $json.initialParams?.services || []).length }},\n  \"namespaces_analyzed\": {{ JSON.stringify($json._context.initialParams.namespaces) }},\n  \"alerts\": {\n    \"total\": <actual count from tool response>,\n    \"critical\": <actual count from tool response>,\n    \"warning\": <actual count from tool response>,\n    \"top_alerts\": [<actual alert names from tool response>]\n  },\n  \"quick_findings\": [<findings based on actual tool responses>],\n  \"proceed_to_stage2\": <true or false>,\n  \"urgency\": \"<one of: normal|high|critical>\",\n  \"reason\": \"<your analysis reason>\",\n  \"forceDeepAnalysis\": false,\n  \"overridden\": false,\n  \"_context\": <copy the exact _context object from input>,\n  \"_debug\": {\n    \"nodeType\": \"Stage 1: Health Snapshot\",\n    \"processedAt\": \"<current ISO timestamp from new Date().toISOString()>\",\n    \"contextId\": \"{{ $json.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromSource\": \"{{ $json.source.type }}\",\n    \"priority\": \"{{ $json.priority }}\",\n    \"timeRangeUsed\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    }\n  }\n}\n\n## ‚ö†Ô∏è FINAL REMINDER:\n- **RETURN ONLY JSON - NO MARKDOWN FORMATTING**\n- **USE ACTUAL TOOL RESPONSE DATA - NO MOCK DATA**\n- **USE PROVIDED TIMESTAMPS - NO HARDCODED DATES**\n- For _context field: copy {{ JSON.stringify($json._context) }} exactly",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a Kubernetes cluster health analyzer. Analyze the cluster state and provide a structured health assessment.\n\nYou MUST return a valid JSON object with this exact structure:\n\n{\n  \"stage\": \"health_snapshot\",\n  \"timestamp\": \"<current ISO timestamp>\",\n  \"overall_status\": \"<one of: healthy, degraded, critical, unknown>\",\n  \"proceed_to_stage2\": <boolean>,\n  \"urgency\": \"<one of: low, medium, high, critical>\",\n  \"reason\": \"<brief explanation>\",\n  \"alerts\": {\n    \"total\": <number>,\n    \"critical\": <number>,\n    \"warning\": <number>,\n    \"top_alerts\": [<array of alert names>]\n  },\n  \"scores\": {\n    \"cluster_health\": <1-5>,\n    \"node_availability\": <1-5>,\n    \"pod_stability\": <1-5>,\n    \"api_reliability\": <1-5>\n  },\n  \"quick_findings\": [<array of findings>],\n  \"forceDeepAnalysis\": false,\n  \"overridden\": false,\n  \"_context\": <context object>,\n  \"_debug\": {\n    \"nodeType\": \"Stage 1: Health Snapshot\",\n    \"processedAt\": \"<ISO timestamp>\",\n    \"contextId\": \"<context ID>\"\n  }\n}\n\nIMPORTANT: Return ONLY the JSON object, no markdown, no explanations, no code blocks."
        }
      },
      "id": "cb25f34f-0a6a-4b60-b2fd-84bae0f2f4d7",
      "name": "Stage 1: Health Snapshot",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -2880,
        464
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "jsCode": "// Stage 2 Decision - Code Node ile karar verme - CONTEXT ENHANCED & ERROR HANDLING ADDED\nconst stage1Output = $input.first().json;\nconst unifiedConfig = $node[\"Unified Entry Point\"].json;\n\n// Stage 1 output'u d√ºzg√ºn parse et\nlet stage1ProceedDecision = false;\nlet stage1ActualData = null;\n\n// Nested output kontrol√º - Stage 1'in yapƒ±sƒ± karma≈üƒ±k olabilir\nif (stage1Output.output && typeof stage1Output.output === 'object') {\n  // Output i√ßinde output var mƒ±?\n  if (stage1Output.output.output && typeof stage1Output.output.output === 'object') {\n    stage1ActualData = stage1Output.output.output;\n    stage1ProceedDecision = stage1ActualData.proceed_to_stage2;\n  } else {\n    stage1ActualData = stage1Output.output;\n    stage1ProceedDecision = stage1ActualData.proceed_to_stage2;\n  }\n} else if (stage1Output.proceed_to_stage2 !== undefined) {\n  stage1ActualData = stage1Output;\n  stage1ProceedDecision = stage1Output.proceed_to_stage2;\n} else {\n  console.error(\"Cannot find proceed_to_stage2 in Stage 1 output!\");\n  stage1ActualData = stage1Output;\n}\n\nconsole.log(\"=== STAGE 2 DECISION DEBUG ===\");\nconsole.log(\"Stage 1 output structure:\", JSON.stringify(stage1Output, null, 2).substring(0, 500) + \"...\");\nconsole.log(\"Stage 1 actual data extracted:\", stage1ActualData ? \"Yes\" : \"No\");\nconsole.log(\"Stage 1 proceed_to_stage2 value:\", stage1ProceedDecision);\nconsole.log(\"Stage 1 overall_status:\", stage1ActualData?.overall_status);\nconsole.log(\"Stage 1 alerts total:\", stage1ActualData?.alerts?.total);\n\n// Context'i al veya olu≈ütur - nested structure'ƒ± kontrol et\nlet masterContext = null;\n\n// √ñnce Stage 1'in actual data'sƒ±ndan context'i almayƒ± dene\nif (stage1ActualData && stage1ActualData._context) {\n  masterContext = stage1ActualData._context;\n  console.log(\"Context found in Stage 1 actual data\");\n} else if (stage1Output._context) {\n  masterContext = stage1Output._context;\n  console.log(\"Context found in Stage 1 output root\");\n} else if (unifiedConfig._context) {\n  masterContext = unifiedConfig._context;\n  console.log(\"Context found in Unified Config\");\n} else {\n  console.error(\"No context found! Creating fallback\");\n  masterContext = {\n    contextId: `ctx-fallback-${Date.now()}`,\n    createdAt: new Date().toISOString(),\n    stageResults: {},\n    decisions: {},\n    debug: { warnings: ['Context not found, created fallback'] }\n  };\n}\n\n// Context ID kontrol√º\nconsole.log(\"Master Context ID:\", masterContext.contextId);\nconsole.log(\"Expected Context ID:\", unifiedConfig._context?.contextId);\n\n// Context ID uyumsuzluƒüunu d√ºzelt\nif (masterContext.contextId !== unifiedConfig._context?.contextId && unifiedConfig._context) {\n  console.warn(\"Context ID mismatch! Using Unified Entry Point context\");\n  masterContext = unifiedConfig._context;\n}\n\n// Unified Entry Point'ten gelen config'i kontrol et\nconsole.log(\"Config source type:\", unifiedConfig.source?.type);\nconsole.log(\"Config priority:\", unifiedConfig.priority);\nconsole.log(\"Config forceDeepAnalysis:\", unifiedConfig.forceDeepAnalysis);\nconsole.log(\"Config stageConfig.forceDeepAnalysis:\", unifiedConfig.stageConfig?.forceDeepAnalysis);\n\n// Karar mantƒ±ƒüƒ± - √ñNEMLƒ∞: forceDeepAnalysis kontrol√º ekle\nconst shouldProceedStage1 = stage1ProceedDecision === true;\nconst forceDeepAnalysisFromConfig = \n  unifiedConfig.forceDeepAnalysis === true || \n  unifiedConfig.priority === 'critical' ||\n  unifiedConfig.stageConfig?.forceDeepAnalysis === true;\n\n// Override logic: Eƒüer config'den force geliyorsa, Stage 1'in kararƒ±nƒ± override et\nconst shouldProceed = shouldProceedStage1 || forceDeepAnalysisFromConfig;\n\nconsole.log(\"=== DECISION SUMMARY ===\");\nconsole.log(\"Stage 1 said proceed:\", shouldProceedStage1);\nconsole.log(\"Force deep analysis from config:\", forceDeepAnalysisFromConfig);\nconsole.log(\"Final decision - proceed to Stage 2?\", shouldProceed);\nconsole.log(\"=======================\");\n\n// Stage 1 sonu√ßlarƒ±nƒ± context'e kaydet - actual data'yƒ± kullan\nmasterContext.stageResults.stage1 = {\n  output: stage1ActualData || stage1Output,\n  completedAt: new Date().toISOString(),\n  decision: stage1ProceedDecision,\n  rawOutput: stage1Output // Debug i√ßin raw output'u da sakla\n};\n\n// Decision bilgisini context'e kaydet\nmasterContext.decisions.stage2Decision = {\n  timestamp: new Date().toISOString(),\n  shouldProceed: shouldProceed,\n  stage1Said: shouldProceedStage1,\n  forcedDeep: forceDeepAnalysisFromConfig,\n  forceSource: forceDeepAnalysisFromConfig ? \n    (unifiedConfig.priority === 'critical' ? 'critical priority' : 'explicit force flag') : \n    'none',\n  reason: shouldProceed && !shouldProceedStage1 ? \n    \"Forced deep analysis by user request\" : \n    (stage1ActualData?.reason || \"Based on Stage 1 analysis\")\n};\n\n// Output data hazƒ±rla - Stage 1'in actual data'sƒ±nƒ± kullan\nconst outputData = {\n  // Stage 1'in t√ºm verilerini koru\n  ...(stage1ActualData || stage1Output),\n  \n  // Stage 1 results'ƒ± ayrƒ±ca sakla\n  stage1Results: stage1ActualData || stage1Output,\n  \n  // Decision bilgisi\n  _decision: {\n    shouldProceed: shouldProceed,\n    stage1Said: shouldProceedStage1,\n    forcedDeep: forceDeepAnalysisFromConfig,\n    forceSource: forceDeepAnalysisFromConfig ? \n      (unifiedConfig.priority === 'critical' ? 'critical priority' : 'explicit force flag') : \n      'none',\n    reason: shouldProceed && !shouldProceedStage1 ? \n      \"Forced deep analysis by user request\" : \n      (stage1ActualData?.reason || \"Based on Stage 1 analysis\")\n  },\n  \n  // Context'i ta≈üƒ± ve g√ºncelle\n  _context: masterContext,\n  \n  // Debug bilgisi\n  _debug: {\n    nodeType: 'Stage 2 Decision',\n    processedAt: new Date().toISOString(),\n    contextPreserved: true,\n    contextId: masterContext.contextId,\n    stage1Structure: stage1Output.output ? 'nested' : 'flat',\n    stage1ProceedValue: stage1ProceedDecision,\n    stage1Status: stage1ActualData?.overall_status,\n    stage1Alerts: stage1ActualData?.alerts?.total\n  }\n};\n\n// Final validation\nif (shouldProceed && stage1ActualData?.overall_status === 'degraded' && stage1ActualData?.alerts?.total > 0) {\n  console.log(\"‚úÖ Decision validated: Degraded cluster with alerts, proceeding to Stage 2\");\n} else if (!shouldProceed && stage1ActualData?.overall_status === 'healthy') {\n  console.log(\"‚úÖ Decision validated: Healthy cluster, stopping here\");\n} else if (shouldProceed && forceDeepAnalysisFromConfig) {\n  console.log(\"‚úÖ Decision validated: Deep analysis forced by configuration\");\n} else {\n  console.warn(\"‚ö†Ô∏è Unexpected decision state - please verify\");\n}\n\nreturn [outputData];"
      },
      "id": "1ddc76df-d862-4646-9709-328e92cc0aa1",
      "name": "Stage 2 Decision",
      "type": "n8n-nodes-base.code",
      "position": [
        -2336,
        416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json._decision.shouldProceed }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "4a8f54c8-a3d2-4eb3-b133-085ad6a72a40"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e670717b-b006-483c-8f61-82e6bb3e32e3",
      "name": "Route After Decision",
      "type": "n8n-nodes-base.if",
      "position": [
        -2112,
        416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 2: Deep Kubernetes Analysis - CONTEXT AWARE\n\nExecute comprehensive analysis based on Stage 1 findings.\n\n## üïê TIME PARAMETERS:\nUse these EXACT timestamps from context:\n- Start Time: {{ $json._context.initialParams.startTime }}\n- End Time: {{ $json._context.initialParams.endTime }}\n\nIMPORTANT: \n- These are Unix timestamps in seconds\n- Convert for display: new Date(timestamp * 1000).toISOString()\n- DO NOT use mock dates like \"2024-06-01\"\n- ALL tool calls must use these timestamps\n\n## üéØ NAMESPACE & SERVICE FILTERING:\n\n**CRITICAL: Use these READY-TO-USE query filters in ALL Prometheus queries:**\n\nNamespace regex pattern: {{ $json.namespaceRegex }}\nService regex pattern: {{ $json.serviceRegex }}\n\n**COPY THESE EXACT FILTERS INTO YOUR PROMETHEUS QUERIES:**\n1. Namespace filter: {{ $json.queryHelpers?.namespaceFilter }}\n2. Combined filter: {{ $json.queryHelpers?.combinedFilter }}\n\n**READY-TO-USE EXAMPLE QUERIES (COPY EXACTLY):**\n- Pod count: {{ $json.queryHelpers?.exampleQueries?.podCount }}\n- Service list: {{ $json.queryHelpers?.exampleQueries?.serviceList }}\n- Alert count: {{ $json.queryHelpers?.exampleQueries?.alertCount }}\n- CPU usage: {{ $json.queryHelpers?.exampleQueries?.cpuUsage }}\n- Memory usage: {{ $json.queryHelpers?.exampleQueries?.memoryUsage }}\n\n**CRITICAL RULES:**\n- NEVER use hardcoded namespaces - use {{ $json.namespaceRegex }} pattern\n- COPY the ready-to-use queries shown above\n- The filters are pre-validated and ready to use\n\n**Analysis scope:** {{ $json.stage2Instructions?.message }}\n\n## üìã CONTEXT INFORMATION:\n- Context ID: {{ $json._context.contextId }}\n- Full Context: {{ JSON.stringify($json._context) }}\n- Stage 1 Findings: {{ JSON.stringify($json.stage1Results) }}\n\n## üîß TOOL EXECUTION:\n\nWhen calling ANY Prometheus tool, use these timestamps and filters:\n{\n  \"start\": {{ $json._context.initialParams.startTime }},\n  \"end\": {{ $json._context.initialParams.endTime }},\n  \"query\": \"<use ready-to-use queries from above with namespace/service filters>\"\n}\n\nExample tool call:\n{\n  \"start\": {{ $json.startTime }},\n  \"end\": {{ $json.endTime }},\n  \"query\": \"{{ $json.queryHelpers?.exampleQueries?.podCount }}\"\n}\n\n## üéØ ANALYSIS PHASES:\n\n### Phase 1: INSTANT (0-10s)\nExecute based on Stage 1 findings:\n- If pods failing: Use `Pod Status Check`, `Container Restarts`, `Pod Resource Usage`\n- If node issues: Use `Node Status Check`, `Node Resource Usage`\n- If network issues: Use `Service Endpoints Health`, `Ingress Status`\n\n### Phase 2: TREND (10-20s)\nHistorical analysis:\n- Use `Historical Comparison 24h` with actual timestamps\n- Look for patterns in the time range\n\n### Phase 3: ANOMALY (20-30s)\n- Use `Resource Exhaustion Prediction`\n- Use `Anomaly Patterns`\n\n## üîß JSON FORMAT VALIDATION RULES:\n\n1. Start your response with { and end with }\n2. Do not include any text before or after the JSON\n3. Do not use any code block formatting or markdown. No triple backticks before or after the JSON\n4. Ensure all string values are in double quotes\n5. Ensure all numbers are unquoted (5 not \"5\")\n6. Ensure booleans are unquoted (true not \"true\")\n7. For _context field, use this exact value: {{ JSON.stringify($json._context) }}\n8. Empty arrays are valid: []\n9. All arrays must use square brackets []\n10. All objects must use curly braces {}\n\n## ‚úÖ RESPONSE VALIDATION:\nYour complete response must:\n- Be valid JSON that starts with { and ends with }\n- Include all required fields from the template\n- Use actual tool response data, not placeholders\n- Have proper nesting for execution_phases, correlation_matrix, and root_cause objects\n- Contain real timestamps and data from Prometheus\n\n## üìù FINAL REMINDER:\nRETURN RAW JSON ONLY - NO EXPLANATIONS, NO MARKDOWN, NO CODE BLOCKS\n\n## üö® CRITICAL OUTPUT REQUIREMENT:\n**RETURN ONLY VALID JSON - NO MARKDOWN**\n\n{\n  \"stage\": \"deep_analysis\",\n  \"investigation_id\": \"{{ $json._context.contextId }}-stage2\",\n  \"triggered_by\": \"Stage 1: {{ $json.stage1Results.alerts.total }} alerts\",\n  \"execution_phases\": {\n    \"instant\": {\n      \"tools_used\": [\"<actual tools used>\"],\n      \"duration\": \"<actual duration>\",\n      \"findings\": {\n        \"critical_pods\": [\"<from actual tool responses>\"],\n        \"resource_pressure\": [\"<from actual tool responses>\"],\n        \"workload_issues\": [\"<from actual tool responses>\"],\n        \"scaling_issues\": [\"<from actual tool responses>\"]\n      }\n    },\n    \"trend\": {\n      \"tools_used\": [\"<actual tools used>\"],\n      \"findings\": {\n        \"memory_growth\": \"<from actual 24h comparison>\",\n        \"restart_pattern\": \"<from actual data>\",\n        \"peak_times\": [\"<actual timestamps if found>\"],\n        \"pvc_growth\": \"<from actual metrics>\"\n      }\n    },\n    \"anomaly\": {\n      \"tools_used\": [\"<actual tools used>\"],\n      \"findings\": {\n        \"predictions\": [\"<from actual analysis>\"],\n        \"anomalies\": [\"<from actual detection>\"]\n      }\n    }\n  },\n  \"correlation_matrix\": {\n    \"primary_chain\": \"<actual correlation found>\",\n    \"affected_services\": [\"<from actual findings>\"],\n    \"blast_radius\": \"<actual impact>\",\n    \"kubernetes_impact\": {\n      \"evicted_pods\": 0,\n      \"pending_pods\": 0,\n      \"failed_schedules\": 0\n    }\n  },\n  \"root_cause\": {\n    \"identified\": false,\n    \"component\": \"<actual component from findings>\",\n    \"issue\": \"<actual issue description>\",\n    \"evidence\": [\"<actual evidence from tools>\"],\n    \"confidence\": 0.0\n  },\n  \"proceed_to_stage3\": false,\n  \"alert_correlation_needed\": false,\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 2: Deep Analysis\",\n    \"processedAt\": \"<current ISO timestamp>\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromStage\": \"\",\n    \"stageSequence\": {{ JSON.stringify($json._debug.stageSequence) }},\n    \"timeRangeUsed\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    }\n  }\n}\n\n## ‚ö†Ô∏è CRITICAL FINAL INSTRUCTION:\nYour ENTIRE response must be ONLY the JSON object above. Do NOT add any text before the opening { or after the closing }. Do NOT use markdown code blocks or backticks. Start with { and end with }",
        "options": {
          "systemMessage": "You are a Kubernetes cluster analyzer. You MUST return ONLY raw JSON without any formatting, markdown, TEXT or code blocks. Do not use triple backticks or any other wrapper around your response. Your entire response must be valid JSON that starts with { and ends with }. Never include explanatory text before or after the JSON."
        }
      },
      "id": "7d1ba539-a407-405a-a5d7-0542903acf8b",
      "name": "Stage 2: Deep Analysis",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -2144,
        576
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {},
      "id": "9da44a43-a146-41c7-867d-431e24707f93",
      "name": "Wait 3s",
      "type": "n8n-nodes-base.wait",
      "position": [
        -1872,
        176
      ],
      "typeVersion": 1.1,
      "webhookId": "c1df24e6-b60a-4413-9229-aab90bb5d955"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 3: Alert Intelligence & Correlation - CONTEXT AWARE\n\nAnalyze alerts and correlate with Stage 2 findings.\n\n## üïê TIME PARAMETERS:\nUse these EXACT timestamps from context:\n- Start Time: {{ $json._context.initialParams.startTime }}\n- End Time: {{ $json._context.initialParams.endTime }}\n\nIMPORTANT:\n- These are Unix timestamps in seconds\n- Convert for display: new Date(timestamp * 1000).toISOString()\n- DO NOT use mock dates like \"2024-06-15\"\n- For current timestamp, use new Date().toISOString()\n\n## üìã CONTEXT INFORMATION:\n- Context ID: {{ $json._context.contextId }}\n- Stage 2 Root Cause: {{ $json.stage2Data.root_cause.issue }}\n- Affected Services: {{ JSON.stringify($json.stage2Data.correlation_matrix.affected_services) }}\n\n## üîß TOOL RESPONSE HANDLING:\n\n### For Active Alerts Details tool:\nThe tool uses this query to get Kubernetes-related alerts:\nALERTS{alertstate=\"firing\",alertname=~\"Kube.*|Container.*|Pod.*|Node.*\"}\n\nThe tool will return alerts with these labels:\n- alertname: Name of the alert (e.g., KubePodCrashLooping, KubeNodeNotReady)\n- alertstate: Will be \"firing\" \n- severity: Alert severity (critical, warning, info) if defined in the alert rule\n- namespace: Kubernetes namespace where the issue is occurring\n- pod: Pod name if the alert is pod-related\n- node: Node name if the alert is node-related\n- container: Container name if applicable\n\nNote: Summary and description are defined in the alert rules, not in the metrics. If you need detailed descriptions, refer to the alert names:\n- KubePodCrashLooping: Pod is restarting frequently\n- KubeNodeNotReady: Node is not in ready state\n- KubeDeploymentReplicasMismatch: Deployment has incorrect replica count\n- KubeContainerWaiting: Container is in waiting state\n- KubePodNotReady: Pod is not ready to serve traffic\n\nWhen analyzing alerts:\n1. Count of each alert type\n2. Which namespaces/pods/nodes are affected\n3. Severity distribution\n4. How long alerts have been firing (if timestamp available)\n\n### For Alert History 24h tool:\n- Call without parameters\n- Returns alert history for the last 24 hours\n- Use to identify recurring patterns\n\n### For SLO Status Check Tools:\n**CRITICAL**: SLO tools may return \"NaN\", empty results, or errors. Handle these cases:\n- If result is \"NaN\" ‚Üí assume 100% (no issues detected)\n- If result is empty array ‚Üí assume 100% (no metrics to check)\n- If result has error ‚Üí assume 100% and note in debug\n- If result has value ‚Üí use the numeric value\n\nExample handling:\n```javascript\nconst sloValue = toolResponse.data?.result?.[0]?.value?.[1];\nif (!sloValue || sloValue === \"NaN\" || sloValue === \"\") {\n  return \"100\"; // No issues detected\n}\nreturn sloValue;\nüìä COMPOSITE SLO CALCULATION:\nIf multiple SLO tools are available, calculate a weighted composite:\n\nCall each SLO tool and collect results:\n\nPod Ready SLO ‚Üí weight: 30%\nContainer Running SLO ‚Üí weight: 20%\nNode Ready SLO ‚Üí weight: 25%\nPod Restart Rate SLO ‚Üí weight: 15%\nDeployment Health ‚Üí weight: 10%\n\n\nFor each SLO result:\n\nIf \"NaN\" or empty ‚Üí use 100\nIf error ‚Üí use 100 and note in debug\nOtherwise use actual numeric value\n\n\nCalculate composite:\ncomposite = (podReady * 0.3) + (containerRunning * 0.2) + (nodeReady * 0.25) + (restartRate * 0.15) + (deploymentHealth * 0.1)\nInterpret composite score:\n\n\n\n= 99.9 ‚Üí \"green\" (SLO Met)\n\n\n99.0-99.9 ‚Üí \"yellow\" (SLO Warning)\n< 99.0 ‚Üí \"red\" (SLO Violation)\n\n\n\nCommon Kubernetes Alert Descriptions:\nconst alertDescriptions = {\n\"KubePodCrashLooping\": {\nsummary: \"Pod is crash looping\",\ndescription: \"Pod has restarted more than 5 times in the last 10 minutes\",\nseverity: \"critical\"\n},\n\"KubeNodeNotReady\": {\nsummary: \"Node is not ready\",\ndescription: \"Node has been unready for more than 5 minutes\",\nseverity: \"critical\"\n},\n\"KubeDeploymentReplicasMismatch\": {\nsummary: \"Deployment replica mismatch\",\ndescription: \"Deployment has not matched the expected number of replicas\",\nseverity: \"warning\"\n},\n\"KubeContainerWaiting\": {\nsummary: \"Container waiting\",\ndescription: \"Container has been in waiting state for more than 1 hour\",\nseverity: \"warning\"\n},\n\"KubePodNotReady\": {\nsummary: \"Pod not ready\",\ndescription: \"Pod has been in a non-ready state for more than 5 minutes\",\nseverity: \"warning\"\n},\n\"KubeHpaMaxedOut\": {\nsummary: \"HPA maxed out\",\ndescription: \"HPA has been at max replicas for more than 15 minutes\",\nseverity: \"warning\"\n}\n};\n\n## üîß TOOL PARAMETERS:\nWhen calling SLO tools, use these parameters:\n{\n  \"namespace\": \"{{ $json._context.initialParams.namespaces[0] || 'etiyamobile-production' }}\",\n  \"service\": \"{{ $json.output.correlation_matrix.affected_services && $json.output.correlation_matrix.affected_services[0] || '' }}\"\n}\n\nüö® CRITICAL OUTPUT REQUIREMENT:\nRETURN ONLY VALID JSON - NO MARKDOWN, NO CODE BLOCKS\nDO NOT WRAP YOUR RESPONSE IN json TAGS\nHANDLE ALL EMPTY/NULL RESPONSES GRACEFULLY\nReturn ONLY this JSON structure:\n{\n\"stage\": \"alert_intelligence\",\n\"active_alerts\": [\n{\n\"name\": \"<actual alert name from tool response or 'No alerts'>\",\n\"severity\": \"<actual severity from tool response or 'unknown'>\",\n\"count\": <actual count from tool response or 0>,\n\"duration\": \"<calculate from current time minus alert start time or 'unknown'>\",\n\"labels\": <actual labels object from tool response or {}>,\n\"annotations\": <actual annotations from tool response if available or {}>\n}\n],\n\"alert_groups\": [\n{\n\"root_alert\": \"<identify main alert based on correlation or 'none'>\",\n\"related_alerts\": [<list other related alerts or empty array>],\n\"correlation_score\": <calculate 0.0-1.0 based on shared labels or 0>,\n\"shared_labels\": <identify common labels between alerts or {}>\n}\n],\n\"knowledge_base_matches\": [\n{\n\"alert\": \"<alert name or 'none'>\",\n\"kb_entry\": {\n\"root_causes\": [\"Based on alert type and previous incidents\"],\n\"diagnostic_commands\": [\"kubectl describe\", \"kubectl logs\"],\n\"immediate_actions\": [\"Check pod status\", \"Review recent changes\"],\n\"long_term_solutions\": [\"Update resource limits\", \"Fix application code\"]\n},\n\"applicability_score\": <0.0-1.0 based on match or 0>\n}\n],\n\"alert_patterns\": {\n\"recurring\": [],\n\"storm_detection\": {\n\"detected\": false,\n\"alert_count\": <count of alerts or 0>,\n\"time_window\": \"5m\",\n\"likely_root\": \"<identify if there's a common cause or null>\"\n}\n},\n\"slo_impact\": {\n\"availability_slo\": {\n\"target\": \"99.9%\",\n\"current\": \"<calculated SLO value or '100'>%\",\n\"error_budget_used\": \"<calculated percentage or '0'>%\",\n\"time_remaining\": \"<based on burn rate or '30d'>\",\n\"components\": {\n\"deployment_health\": \"<if single SLO tool used, put value here or '100'>%\"\n},\n\"status\": \"<green|yellow|red based on current vs target>\"\n},\n\"affected_slis\": [<list SLIs below target or empty array>]\n},\n\"recommended_alert_actions\": [\n{\n\"alert\": \"<alert name or 'none'>\",\n\"action\": \"<specific remediation action or 'Monitor'>\",\n\"confidence\": <0.0-1.0 or 0>,\n\"risk\": \"<low|medium|high>\",\n\"command\": \"<kubectl or other command or null>\"\n}\n],\n\"proceed_to_stage4\": <true if alerts need investigation, false otherwise>,\n\"auto_remediation_approved\": <true only for low-risk known issues>,\n\"_context\": <copy the exact _context object from input>,\n\"_debug\": {\n\"nodeType\": \"Stage 3: Alert Intelligence\",\n\"processedAt\": \"<current ISO timestamp from new Date().toISOString()>\",\n\"contextId\": \"<copy from input _context.contextId>\",\n\"contextPreserved\": true,\n\"receivedFromStage\": \"Fix Stage 2 Context\",\n\"stageSequence\": <take input _debug.stageSequence array and add \"Stage 3: Alert Intelligence\">,\n\"timeRangeUsed\": {\n\"start\": <copy from input _context.initialParams.startTime>,\n\"end\": <copy from input _context.initialParams.endTime>\n},\n\"sloToolErrors\": []\n}\n}\nüìù IMPORTANT NOTES:\n\nIf no alerts are found, return empty arrays but still complete the analysis\nUse actual values from tool responses, don't make up data\nFor _context: Copy exactly as received in input\nFor timestamps: Use actual current time, not placeholders\nUse knowledge from alertDescriptions to enrich alert information\nALWAYS handle NaN and empty responses gracefully\nDefault to safe values when data is missing",
        "hasOutputParser": true,
        "options": {}
      },
      "id": "af247169-e272-4720-8f4b-69f88ef95d13",
      "name": "Stage 3: Alert Intelligence",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -1664,
        576
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 4: Automated Diagnosis & Deep Dive - CONTEXT AWARE\n\nExecute targeted diagnostics based on previous findings.\n\n## üïê TIME PARAMETERS:\n- Start: {{ $json._context.initialParams.startTime }}\n- End: {{ $json._context.initialParams.endTime }}\n- Display: new Date(timestamp * 1000).toISOString()\n- DO NOT use fake dates like \"2024-01-15\"\n\n## üìã CONTEXT:\n- Context ID: {{ $json._context.contextId }}\n- Primary Issue: {{ $json.stage3Data.recommended_actions[0].alert }}\n- Root Cause: {{ $json.stage2Data.root_cause.issue }}\n\n## üîß DIAGNOSTIC EXECUTION:\n\nBased on findings, execute appropriate diagnostics:\n- For pod issues: Use pod-specific tools with actual pod names\n- For node issues: Use node-specific tools with actual node names\n- Use exact timestamps from context\n\nTool parameters:\n{\n  \"namespace\": \"{{  $json.namespaces[0]}}\",\n  \"start\": {{ $json._context.initialParams.startTime }},\n  \"end\": {{ $json._context.initialParams.endTime }},\n  \"pod\": \"<actual pod name from previous stages>\",\n  \"node\": \"<actual node name from previous stages>\"\n}\n\n## üö® OUTPUT REQUIREMENT:\n**RETURN ONLY VALID JSON WITH ACTUAL DATA**\n\n{\n  \"stage\": \"automated_diagnosis\",\n  \"diagnostics_executed\": [\n    {\n      \"target\": \"<actual pod/node/service name>\",\n      \"type\": \"<pod|node|service>\",\n      \"commands_run\": [<simulated but realistic commands>],\n      \"findings\": {\n        \"pod_status\": {\n          \"phase\": \"<from actual pod status>\",\n          \"restart_count\": <actual count from metrics>,\n          \"last_termination\": {\n            \"reason\": \"<from actual events>\",\n            \"exit_code\": <if available>,\n            \"finished_at\": \"<actual timestamp from events>\"\n          }\n        },\n        \"error_logs\": [\n          {\n            \"timestamp\": \"<actual timestamp from logs>\",\n            \"level\": \"<actual log level>\",\n            \"message\": \"<actual error message>\",\n            \"stack_trace\": \"<if available>\"\n          }\n        ],\n        \"events\": [<actual k8s events>],\n        \"resource_usage\": {\n          \"memory_request\": \"<from actual pod spec>\",\n          \"memory_limit\": \"<from actual pod spec>\",\n          \"memory_used\": \"<from actual metrics>\",\n          \"cpu_used\": \"<from actual metrics>\"\n        }\n      }\n    }\n  ],\n  \"enriched_context\": {\n    \"deployment_info\": {\n      \"name\": \"<actual deployment name>\",\n      \"version\": \"<from actual labels>\",\n      \"replicas\": \"<actual ready/total>\",\n      \"last_update\": \"<actual update timestamp>\",\n      \"update_strategy\": \"<actual strategy>\"\n    },\n    \"recent_changes\": [\n      {\n        \"type\": \"deployment\",\n        \"time\": \"<actual timestamp>\",\n        \"change\": \"<from actual events>\",\n        \"user\": \"<if available>\"\n      }\n    ],\n    \"dependencies\": {\n      \"upstream\": [<from actual service discovery>],\n      \"downstream\": [<from actual service discovery>],\n      \"databases\": [<from actual config>],\n      \"external\": [<from actual config>]\n    }\n  },\n  \"diagnostic_summary\": {\n    \"confirmed_issues\": [\n      {\n        \"issue\": \"<specific issue description>\",\n        \"evidence\": [<actual evidence from diagnostics>],\n        \"severity\": \"critical|high|medium|low\",\n        \"impact\": \"<actual impact description>\",\n        \"namespace\": \"{{ $json.namespaces[0] }}\"\n      }\n    ],\n    \"secondary_issues\": []\n  },\n  \"proceed_to_stage5\": <true/false>,\n  \"remediation_confidence\": <0.0-1.0>,\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 4: Automated Diagnosis\",\n    \"processedAt\": \"<current ISO timestamp>\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromStage\": \"\",\n    \"stageSequence\": \"\",\n    \"diagnosticsCount\": <actual count>,\n    \"autoRemediationEnabled\": true,\n    \"timeRangeUsed\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    }\n  }\n}\n\n## ‚ö†Ô∏è CRITICAL:\n- ALL TIMESTAMPS MUST BE FROM ACTUAL DATA\n- NO HARDCODED DATES\n- USE REAL PROMETHEUS METRICS\n- NO MOCK DATA\n- secondary_issues MUST BE AN ARRAY (even if empty: [])",
        "options": {
          "systemMessage": "CRITICAL: You MUST respond with ONLY valid JSON that exactly matches the schema. \nDo not include any text before or after the JSON.\nDo not include markdown code blocks.\nStart your response with { and end with }"
        }
      },
      "id": "46e263d4-13b2-4808-bbea-c2ef75742600",
      "name": "Stage 4: Automated Diagnosis",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -1152,
        576
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 5: AI-Powered Remediation Plan - CONTEXT AWARE\n\nGenerate remediation plan based on all findings.\n\n## üö® CRITICAL OUTPUT REQUIREMENT:\n**YOU MUST RETURN ONLY VALID JSON - NO MARKDOWN, NO CODE BLOCKS, NO EXTRA TEXT**\n**DO NOT WRAP YOUR RESPONSE IN ```json``` TAGS**\n**RETURN RAW JSON ONLY**\n\n## üïê TIME PARAMETERS:\n- Analysis Period: From timestamp {{ $json._context.initialParams.startTime }} to {{ $json._context.initialParams.endTime }}\n- Current Time: Use new Date().toISOString() for current timestamp\n\n## üìã COMPLETE CONTEXT:\n- Context ID: {{ $json._context.contextId }}\n- Primary Issue: {{ $json.primaryDiagnosis.issue }}\n- Severity: {{ $json.primaryDiagnosis.severity }}\n- Affected Component: {{  $json.stage4Data.enriched_context.deployment_info.name}}\n\n## üíæ OUTPUT FORMAT (MUST BE PURE JSON):\n\n{\n  \"stage\": \"ai_powered_analysis\",\n  \"analysis_id\": \"{{ $json._context.contextId }}-stage5\",\n  \"remediation_plan\": {\n    \"immediate_actions\": [\n      {\n        \"action\": \"Rollback deployment to previous version\",\n        \"command\": \"kubectl rollout undo deployment/{{ $json.stage4Data.enriched_context.deployment_info}} -n {{ $json.primaryDiagnosis.namespace }}\",\n        \"risk\": \"low\",\n        \"estimated_time\": \"2-5 minutes\",\n        \"expected_outcome\": \"Restore service to previous stable version\"\n      }\n    ],\n    \"short_term_fixes\": [\n      {\n        \"action\": \"Increase memory limits temporarily\",\n        \"timeline\": \"1-2 days\",\n        \"details\": \"Set memory limit to 2Gi while investigating root cause\"\n      }\n    ],\n    \"long_term_solutions\": [\n      {\n        \"action\": \"Fix memory leak in TransactionHandler\",\n        \"timeline\": \"1-2 weeks\",\n        \"details\": \"Review and fix the memory leak in payment processing code\"\n      }\n    ],\n    \"preventive_measures\": [\n      \"Implement memory profiling in CI/CD\",\n      \"Add memory leak detection tests\",\n      \"Set up gradual rollout strategy\"\n    ]\n  },\n  \"risk_assessment\": {\n    \"overall_risk\": \"medium\",\n    \"factors\": [\n      \"Payment service is critical\",\n      \"Rollback is tested and safe\",\n      \"Memory issue is contained to specific pods\"\n    ],\n    \"mitigation_steps\": [\n      \"Monitor closely after rollback\",\n      \"Keep team on standby\",\n      \"Prepare hotfix if needed\"\n    ]\n  },\n  \"implementation_order\": [\n    {\n      \"step\": 1,\n      \"action\": \"Execute rollback\",\n      \"dependencies\": [],\n      \"validation\": \"Check pod status and memory usage\"\n    },\n    {\n      \"step\": 2,\n      \"action\": \"Verify service health\",\n      \"dependencies\": [\"step_1\"],\n      \"validation\": \"Check error rates and response times\"\n    },\n    {\n      \"step\": 3,\n      \"action\": \"Update monitoring alerts\",\n      \"dependencies\": [\"step_2\"],\n      \"validation\": \"Ensure alerts are firing correctly\"\n    }\n  ],\n  \"success_metrics\": {\n    \"immediate\": [\n      \"Pod restart count = 0\",\n      \"Memory usage < 80% of limit\",\n      \"Error rate < 0.1%\"\n    ],\n    \"short_term\": [\n      \"No OOMKilled events in 24h\",\n      \"SLO compliance > 99.9%\"\n    ],\n    \"long_term\": [\n      \"Memory leak fixed in code\",\n      \"Automated memory testing in place\"\n    ]\n  },\n  \"rollback_plan\": {\n    \"trigger_conditions\": [\n      \"Error rate > 5%\",\n      \"Multiple pod failures\",\n      \"Memory usage continues to spike\"\n    ],\n    \"steps\": [\n      \"Revert to current version\",\n      \"Scale up replicas\",\n      \"Enable circuit breaker\"\n    ],\n    \"validation\": \"Verify previous version number before rollback\"\n  },\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 5: AI-Powered Analysis\",\n    \"processedAt\": \"<use new Date().toISOString()>\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"analysisTimeRange\": {\n      \"start\": {{ $json._context.initialParams.startTime }},\n      \"end\": {{ $json._context.initialParams.endTime }}\n    },\n    \"stagesCompleted\": 5\n  }\n}\n\n## ‚ö†Ô∏è FINAL REMINDER:\n- **RETURN ONLY THE JSON OBJECT ABOVE**\n- **NO MARKDOWN FORMATTING**\n- **NO EXPLANATORY TEXT**\n- **NO CODE BLOCKS**",
        "options": {}
      },
      "id": "811e48e0-df1e-43e9-8e05-32d3203d8103",
      "name": "Stage 5: Smart Remediation",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -656,
        576
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# Stage 6: Prevention & Learning System - CONTEXT AWARE\n\nYou are the Prevention specialist, implementing long-term fixes and capturing learnings.\n\n## üéØ YOUR MISSION: PREVENT RECURRENCE\n\n**Complete Context Journey**: \n- Context ID: {{ $json._context.contextId }}\n- Source: {{ $json._context.source.type }}\n- Priority: {{ $json._context.priority }}\n- Workflow Duration: {{ $json._context.createdAt }} to now\n- Total Stages Executed: {{ $json._debug.stageSequence ? $json._debug.stageSequence.length : 5 }}\n\n**All Stage Results**: \n- Stage 1: {{ JSON.stringify($json._context.stageResults?.stage1?.output?.overall_status) }}\n- Stage 2: {{ JSON.stringify($json._context.stageResults?.stage2?.output?.root_cause?.issue) }}\n- Stage 3: {{ JSON.stringify($json._context.stageResults?.stage3?.output?.active_alerts?.length) }} alerts\n- Stage 4: Diagnostics completed\n- Stage 5: {{ JSON.stringify($json.stage5Results || $json) }}\n\n**Full Context**: {{ JSON.stringify($json._context) }}\n\n// Stage 6 Prompt'una eklenecek b√∂l√ºm\n// \"**All Stage Results**:\" kƒ±smƒ±ndan sonra ekleyin:\n\n## üìö KNOWLEDGE BASE LEARNING CONTEXT:\n\n**Current KB Stats**: \n- Total Alerts in KB: {{ $node[\"Load Alert Knowledge Base\"].json._alertKBData?.length || 0 }}\n- KB Last Updated: {{ $node[\"Load Alert Knowledge Base\"].json._alertKB?.loadedAt || 'Never' }}\n\n**Stage 3 KB Matches**: {{ JSON.stringify($json._context.stageResults?.stage3?.output?.knowledge_base_matches?.length || 0) }} alerts matched\n**Stage 4 KB Enhanced Issues**: {{ JSON.stringify($json._context.stageResults?.stage4?.output?.diagnostic_summary?.confirmed_issues?.filter(i => i.kb_enhanced)?.length || 0) }}\n**Stage 5 KB Actions Used**: {{ JSON.stringify($json._context.stageResults?.stage5?.output?.remediation_plan?.immediate_actions?.filter(a => a.source === \"Alert Knowledge Base\")?.length || 0) }}\n\n## üß† LEARNING OBJECTIVES:\n1. Identify new alert patterns not in KB\n2. Update KB with successful remediation strategies\n3. Refine existing KB entries based on outcomes\n4. Create new monitoring rules for prevention\n\nBased on the full journey through all 6 stages, generate:\n- New KB entries for unmatched alerts\n- Updates to existing KB entries\n- Preventive monitoring rules\n- Team training recommendations\n\n## üîß PREVENTION TOOLS:\n\n1. `Update Alert Rules` - Tune thresholds\n2. `Create Runbook Entry` - Document solution\n3. `Generate Prevention PR` - Code/config fixes\n4. `Update Knowledge Base` - Add to Excel\n5. `Schedule Follow-up` - Future checks\n6. `Training Recommendation` - Team education\n\n## üìö LEARNING CAPTURE:\n\n### What Happened?\n- Root cause identification from context\n- Impact assessment from all stages\n- Timeline reconstruction: {{ $json._context.createdAt }} to now\n\n### What Worked?\n- Successful remediation steps from Stage 5\n- Effective diagnostics from Stage 4\n- Quick wins identified\n\n### What Didn't?\n- Failed attempts\n- Misleading symptoms\n- Time wasters\n\n### What's Next?\n- Preventive measures based on priority: {{ $json._context.priority }}\n- Monitoring improvements\n- Process updates\n\n## üíæ OUTPUT FORMAT:\n\n```json\n{\n  \"stage\": \"prevention_learning\",\n  \"incident_summary\": {\n    \"id\": \"INC-{{ $json._context.contextId }}\",\n    \"title\": \"{{ $json._context.priority === 'critical' ? 'CRITICAL: ' : '' }}{{ $json._context.stageResults?.stage2?.output?.root_cause?.issue || 'Kubernetes Cluster Issue' }}\",\n    \"duration\": \"{{ new Date() - new Date($json._context.createdAt) }} ms\",\n    \"severity\": \"{{ $json._context.priority }}\",\n    \"services_affected\": {{ JSON.stringify($json._context.stageResults?.stage2?.output?.correlation_matrix?.affected_services || []) }},\n    \"customer_impact\": \"{{ $json._context.priority === 'critical' ? 'Significant impact' : 'Limited impact' }}\",\n    \"root_cause\": \"{{ $json._context.stageResults?.stage2?.output?.root_cause?.issue || 'Under investigation' }}\",\n    \"resolution\": \"{{ $json._context.stageResults?.stage5?.output?.execution_results?.[0]?.output || 'Remediation applied' }}\"\n  },\n  \"prevention_actions\": [\n    {\n      \"type\": \"monitoring\",\n      \"action\": \"Add memory leak detection alert for {{ $json._context.initialParams.namespaces[0] }}\",\n      \"implementation\": {\n        \"alert_rule\": \"rate(container_memory_usage_bytes[5m]) > 0.1 and container_memory_usage_bytes > 0.8 * container_spec_memory_limit_bytes\",\n        \"threshold\": \"10% growth in 5 minutes\",\n        \"severity\": \"warning\"\n      },\n      \"status\": \"{{ $json._context.priority === 'critical' ? 'implemented' : 'planned' }}\"\n    },\n    {\n      \"type\": \"code_fix\",\n      \"action\": \"Fix identified issue in {{ $json._context.stageResults?.stage2?.output?.root_cause?.component }}\",\n      \"implementation\": {\n        \"pr_url\": \"https://github.com/company/{{ $json._context.stageResults?.stage2?.output?.root_cause?.component }}/pull/auto-{{ $json._context.contextId }}\",\n        \"fix_description\": \"Address root cause: {{ $json._context.stageResults?.stage2?.output?.root_cause?.issue }}\",\n        \"reviewer\": \"@senior-dev\",\n        \"eta\": \"{{ $json._context.priority === 'critical' ? '1 day' : '3 days' }}\"\n      },\n      \"status\": \"in_progress\"\n    },\n    {\n      \"type\": \"configuration\",\n      \"action\": \"Implement resource limits in {{ $json._context.initialParams.namespaces[0] }}\",\n      \"implementation\": {\n        \"yaml_patch\": \"resources:\\\\n  limits:\\\\n    memory: 1.5Gi\\\\n    cpu: 1000m\\\\n  requests:\\\\n    memory: 1Gi\\\\n    cpu: 500m\",\n        \"applied_to\": {{ JSON.stringify($json._context.stageResults?.stage2?.output?.correlation_matrix?.affected_services || ['all-services']) }}\n      },\n      \"status\": \"{{ $json._context.priority === 'critical' ? 'completed' : 'planned' }}\"\n    },\n    {\n      \"type\": \"process\",\n      \"action\": \"Add automated testing for {{ $json._context.priority }} priority issues\",\n      \"implementation\": {\n        \"pipeline_update\": \"Add memory profiling and stress testing\",\n        \"threshold\": \"Fail if memory growth >5% during load test\",\n        \"owner\": \"platform-team\"\n      },\n      \"status\": \"planned\"\n    }\n  ],\n  \"knowledge_base_update\": {\n    \"alert_name\": \"{{ $json._context.stageResults?.stage3?.output?.active_alerts?.[0]?.name || 'General-Kubernetes-Issue' }}\",\n    \"new_entry\": {\n      \"pattern\": \"{{ $json._context.stageResults?.stage2?.output?.root_cause?.issue }}\",\n      \"diagnostic_shortcut\": \"Check {{ $json._context.stageResults?.stage4?.output?.diagnostic_summary?.confirmed_issues?.[0]?.issue }}\",\n      \"quick_fix\": \"{{ $json._context.stageResults?.stage5?.output?.remediation_plan?.immediate_actions[0]?.action }}\",\n      \"prevention\": \"Monitor for {{ $json._context.stageResults?.stage2?.output?.correlation_matrix?.primary_chain }}\",\n      \"context_id\": \"{{ $json._context.contextId }}\",\n      \"priority_level\": \"{{ $json._context.priority }}\"\n    },\n    \"kb_updated\": true,\n    \"entry_id\": \"KB-{{ $json._context.contextId }}\"\n  },\n  \"runbook_updates\": [\n    {\n      \"runbook\": \"{{ $json._context.initialParams.namespaces[0] }}-troubleshooting\",\n      \"section\": \"{{ $json._context.priority }} Priority Issues\",\n      \"addition\": \"Context {{ $json._context.contextId }}: {{ $json._context.stageResults?.stage2?.output?.root_cause?.issue }}\",\n      \"url\": \"https://runbooks.company.com/{{ $json._context.contextId }}\"\n    }\n  ],\n  \"team_recommendations\": [\n    {\n      \"team\": \"{{ $json._context.stageResults?.stage2?.output?.correlation_matrix?.affected_services?.[0] }}-team\",\n      \"action\": \"Review and implement prevention actions for {{ $json._context.priority }} issues\",\n      \"priority\": \"{{ $json._context.priority }}\"\n    },\n    {\n      \"team\": \"platform-team\",\n      \"action\": \"Update monitoring for {{ $json._context.initialParams.namespaces[0] }}\",\n      \"priority\": \"{{ $json._context.priority === 'critical' ? 'high' : 'medium' }}\"\n    },\n    {\n      \"team\": \"sre-team\",\n      \"action\": \"Review incident {{ $json._context.contextId }}\",\n      \"priority\": \"{{ $json._context.priority === 'critical' ? 'high' : 'low' }}\"\n    }\n  ],\n  \"follow_up_schedule\": [\n    {\n      \"action\": \"Verify fix in {{ $json._context.initialParams.namespaces[0] }}\",\n      \"when\": \"{{ $json._context.priority === 'critical' ? 'After emergency deployment' : 'Next release cycle' }}\",\n      \"owner\": \"{{ $json._context.stageResults?.stage2?.output?.correlation_matrix?.affected_services?.[0] }}-team\"\n    },\n    {\n      \"action\": \"Review metrics for recurrence\",\n      \"when\": \"{{ $json._context.priority === 'critical' ? 'Every hour for 24h' : 'Daily for 1 week' }}\",\n      \"owner\": \"sre-team\"\n    },\n    {\n      \"action\": \"Post-mortem meeting\",\n      \"when\": \"{{ $json._context.priority === 'critical' ? 'Within 24 hours' : 'Within 1 week' }}\",\n      \"attendees\": [\"platform-team\", \"sre-team\", \"affected-service-teams\"]\n    }\n  ],\n  \"metrics_improvements\": {\n    \"new_alerts\": {{ $json._context.priority === 'critical' ? 3 : 1 }},\n    \"runbook_updates\": 1,\n    \"kb_entries\": 1,\n    \"process_improvements\": {{ $json._context.priority === 'critical' ? 4 : 2 }},\n    \"estimated_future_prevention\": \"{{ $json._context.priority === 'critical' ? '95%' : '75%' }}\"\n  },\n  \"final_status\": {\n    \"incident_resolved\": true,\n    \"prevention_implemented\": {{ $json._context.priority === 'critical' }},\n    \"learning_captured\": true,\n    \"ready_for_next\": true\n  },\n  \"_context\": {{ JSON.stringify($json._context) }},\n  \"_debug\": {\n    \"nodeType\": \"Stage 6: Prevention & Learning\",\n    \"processedAt\": \"{{ new Date().toISOString() }}\",\n    \"contextId\": \"{{ $json._context.contextId }}\",\n    \"contextPreserved\": true,\n    \"receivedFromStage\": \"{{ $json._debug.nodeType }}\",\n    \"stageSequence\": {{ JSON.stringify($json._debug.stageSequence ? [...$json._debug.stageSequence, 'Stage 6: Prevention & Learning'] : ['Stage 6: Prevention & Learning']) }},\n    \"totalStagesExecuted\": 6,\n    \"workflowComplete\": true,\n    \"priorityLevel\": \"{{ $json._context.priority }}\",\n    \"contextJourneyComplete\": \"{{ $json._context.contextId }} - Full lifecycle tracked\"\n  }\n}\nüéØ PREVENTION PRIORITIES:\nBased on Priority ({{ $json._context.priority }}):\n\n{{ $json._context.priority === 'critical' ? 'IMMEDIATE' : 'Short-term' }} - Alert tuning, monitoring\n{{ $json._context.priority === 'critical' ? 'URGENT' : 'Medium-term' }} - Code fixes, config updates\n{{ $json._context.priority === 'critical' ? 'HIGH' : 'Long-term' }} - Process improvements, training\n\nüìà SUCCESS METRICS:\n\nSame issue doesn't recur\nDetection time improved\nMTTR reduced\nTeam knowledge increased\nAutomation enhanced\n\nThis completes the 6-stage intelligent remediation cycle with full context preservation!\nRemember:\n\nALWAYS preserve the complete _context object\nUpdate _debug.stageSequence to show full journey\nMark workflowComplete as true\nUse priority to determine urgency of prevention actions\nReference all previous stage results from context",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "## üö® OUTPUT REQUIREMENT:\n**RETURN ONLY VALID JSON WITH ACTUAL DATA**"
        }
      },
      "id": "36006389-5a16-438f-8622-141e8f145cdb",
      "name": "Stage 6: Prevention & Learning",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -160,
        576
      ],
      "typeVersion": 1.9
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "=query",
              "value": "=(sum(kube_node_status_condition{condition=\"Ready\",status=\"false\"} == 1) > 0) or (sum(rate(kube_pod_container_status_restarts_total[5m]) > 0.1) > 0)"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "70faf0f9-1adf-42b3-93f4-5f18e1f3fad7",
      "name": "Quick Cluster Health",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2944,
        128
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=count by (alertname, severity) (ALERTS{alertstate=\"firing\"})"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "d6e8a609-d102-4086-9b15-6df38b0fcc9e",
      "name": "Active Alerts Count",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2720,
        144
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=topk(10, (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100) or topk(10, 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)) or topk(10, (1 - (node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"})) * 100)"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "09b092aa-0e39-4a99-88f6-4ea60bcece91",
      "name": "Node Resource Status",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2544,
        960
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ \n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `kube_pod_container_status_restarts_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"} or kube_pod_container_status_waiting_reason{namespace=\"${ns}\", pod=~\".*${svc}.*\"} or kube_pod_status_phase{namespace=\"${ns}\", pod=~\".*${svc}.*\"}`;\n  } else {\n    // Rate filtresi yerine, restart count > 0 olan pod'larƒ± g√∂ster\n    return `topk(20, kube_pod_container_status_restarts_total{namespace=\"${ns}\"} > 0) or topk(20, kube_pod_container_status_waiting_reason{namespace=\"${ns}\", reason!='ContainerCreating'}) or topk(20, kube_pod_status_phase{namespace=\"${ns}\", phase=~'Failed|Unknown|Pending'} == 1)`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "08b2411a-be89-4b32-bcfe-e00b9612f930",
      "name": "Pod Status Check",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2352,
        944
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=ALERTS{alertstate=\"firing\",alertname=~\"Kube.*|Container.*|Pod.*|Node.*\"}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "31c3842b-2fb0-40a0-9073-822a9905c7de",
      "name": "Active Alerts Details",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1456,
        768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=kube_node_status_condition{condition=~\"Ready|MemoryPressure|DiskPressure|PIDPressure|NetworkUnavailable\"} == 1"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "cf52516d-011d-4c7c-bb88-0bbe0031adea",
      "name": "Node Conditions",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2480,
        1104
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  \n  // Node metriklerine namespace filtresi ekleyemeyiz, sadece genel node network health\n  return `sum by (node, device) (rate(node_network_receive_errs_total{device!~\"lo|veth.*|docker.*|flannel.*|cali.*|cbr.*\"}[5m])) > 0 or sum by (node, device) (rate(node_network_transmit_errs_total{device!~\"lo|veth.*|docker.*|flannel.*|cali.*|cbr.*\"}[5m])) > 0 or sum by (node) (rate(node_network_receive_drop_total[5m])) > 0`;\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "155f306a-261c-417b-b7c1-140354635fb0",
      "name": "Node Network Health",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2352,
        1184
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ \n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `topk(10, sum by (namespace, pod, container) (kube_pod_container_status_restarts_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"})) or topk(10, sum by (namespace, pod, container, reason) (kube_pod_container_status_last_terminated_reason{namespace=\"${ns}\", pod=~\".*${svc}.*\", reason!=\"Completed\"}))`;\n  } else {\n    return `topk(10, sum by (namespace, pod, container) (kube_pod_container_status_restarts_total)) or topk(10, sum by (namespace, pod, container, reason) (kube_pod_container_status_last_terminated_reason{reason!=\"Completed\"}))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "abe8409b-0673-4bf0-8ff9-b5649a2ec369",
      "name": "Container Restarts",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2256,
        1296
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ \n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    // Limit olmasa bile memory usage g√∂ster\n    return `topk(10, container_memory_working_set_bytes{namespace=\"${ns}\", pod=~\".*${svc}.*\", container!=\"\"}) or topk(10, rate(container_cpu_usage_seconds_total{namespace=\"${ns}\", pod=~\".*${svc}.*\", container!=\"\"}[5m]))`;\n  } else {\n    return `topk(10, container_memory_working_set_bytes{namespace=\"${ns}\", container!=\"\"}) or topk(10, rate(container_cpu_usage_seconds_total{namespace=\"${ns}\", container!=\"\"}[5m]))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "c869a981-8eab-4973-a7d7-666568c243b7",
      "name": "Pod Resource Usage",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2048,
        1024
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  // Farklƒ± metrik kombinasyonlarƒ± deneyelim\n  if (svc) {\n    // Service-specific metrics - container network metrikleri kullanarak\n    return `topk(10, sum by (namespace, pod) (rate(container_network_receive_bytes_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[5m]))) or topk(10, sum by (namespace, pod) (rate(container_network_transmit_bytes_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[5m])))`;\n  } else {\n    // Genel namespace metrikleri\n    return `topk(10, sum by (namespace, pod) (rate(container_network_receive_bytes_total{namespace=\"${ns}\"}[5m]))) or topk(10, sum by (namespace, pod) (rate(container_network_transmit_bytes_total{namespace=\"${ns}\"}[5m])))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "815a3c4c-379f-4e44-9c69-685af2c7d3d8",
      "name": "Application Metrics",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2192,
        1104
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    // Pod failure rate as proxy for errors\n    return `topk(10, sum by (namespace, pod) (kube_pod_status_phase{namespace=\"${ns}\", pod=~\".*${svc}.*\", phase=~\"Failed|Unknown\"} == 1)) or topk(10, sum by (namespace, pod, reason) (kube_pod_container_status_waiting_reason{namespace=\"${ns}\", pod=~\".*${svc}.*\", reason!=\"ContainerCreating\"}))`;\n  } else {\n    return `topk(10, sum by (namespace, pod) (kube_pod_status_phase{namespace=\"${ns}\", phase=~\"Failed|Unknown\"} == 1)) or topk(10, sum by (namespace, pod, reason) (kube_pod_container_status_waiting_reason{namespace=\"${ns}\", reason!=\"ContainerCreating\"}))`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "f792c393-e23e-4e8c-a39d-ae7577b5d4d9",
      "name": "HTTP Error Rates",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2080,
        1280
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ \n(() => {\n  // Default metric query\n  let metricQuery = $json.metric_query || 'up{job=\"kubernetes-nodes\"}';\n  const svc = $json.service || '';\n  \n  // Eƒüer service varsa ve default metric ise, pod metric'e √ßevir\n  if (svc && metricQuery === 'up{job=\"kubernetes-nodes\"}') {\n    metricQuery = `kube_pod_container_status_restarts_total{pod=~\".*${svc}.*\"}`;\n  }\n  \n  return metricQuery;\n})()\n}}"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now() / 1000) - 86400 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now() / 1000) }}"
            },
            {
              "name": "step",
              "value": "3600"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "5ddf4fcd-6e37-460c-b5aa-9df96c55532e",
      "name": "Historical Comparison 24h",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1920,
        976
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `predict_linear(node_filesystem_avail_bytes{mountpoint=\"/\"}[1h], 4*3600) < 0 or predict_linear(container_memory_working_set_bytes{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[1h], 4*3600) > container_spec_memory_limit_bytes{namespace=\"${ns}\", pod=~\".*${svc}.*\"} or predict_linear(kubelet_volume_stats_available_bytes{namespace=\"${ns}\", persistentvolumeclaim=~\".*${svc}.*\"}[1h], 4*3600) < 1073741824`;\n  } else {\n    return `predict_linear(node_filesystem_avail_bytes{mountpoint=\"/\"}[1h], 4*3600) < 0 or predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) < 1073741824 or predict_linear(kubelet_volume_stats_available_bytes[1h], 4*3600) < 1073741824 or (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) > 0.85`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "8132b533-d0aa-4268-ae7f-16f08ee9c3fb",
      "name": "Resource Exhaustion Prediction",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1984,
        1184
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `stddev_over_time(rate(container_cpu_usage_seconds_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[5m])[2h:]) > 0.3 or stddev_over_time(container_memory_working_set_bytes{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[2h:]) > 2147483648`;\n  } else {\n    return `stddev_over_time(rate(container_cpu_usage_seconds_total{namespace=\"${ns}\"}[5m])[2h:]) > 0.3 or stddev_over_time(container_memory_working_set_bytes{namespace=\"${ns}\"}[2h:]) > 2147483648`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "34e24193-4f0e-4710-bb5c-85d76c2acbc2",
      "name": "Anomaly Patterns",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1856,
        1136
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=count by (alertname, severity) (ALERTS{alertstate=\"firing\"})"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now() / 1000) - 86400 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now() / 1000) }}"
            },
            {
              "name": "step",
              "value": "3600"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "d8b32cda-a239-47a1-bba3-504a074007a6",
      "name": "Alert History 24h",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1632,
        816
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"timestamp\": { \"type\": \"string\" },\n    \"cluster\": { \"type\": \"string\" },\n    \"overall_status\": { \n      \"type\": \"string\",\n      \"enum\": [\"healthy\", \"degraded\", \"critical\", \"unknown\"]\n    },\n    \"proceed_to_stage2\": { \"type\": \"boolean\" },\n    \"urgency\": { \n      \"type\": \"string\",\n      \"enum\": [\"low\", \"normal\", \"medium\", \"high\", \"critical\"]\n    },\n    \"active_services\": { \n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"requested_services\": { \n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"reason\": { \"type\": \"string\" },\n    \"alerts\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"total\": { \"type\": \"number\" },\n        \"critical\": { \"type\": \"number\" },\n        \"warning\": { \"type\": \"number\" },\n        \"top_alerts\": { \n          \"type\": \"array\",\n          \"items\": { \"type\": \"string\" }\n        }\n      },\n      \"required\": [\"total\", \"critical\", \"warning\"]\n    },\n    \"scores\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"cluster_health\": { \"type\": \"number\" },\n        \"node_availability\": { \"type\": \"number\" },\n        \"pod_stability\": { \"type\": \"number\" },\n        \"api_reliability\": { \"type\": \"number\" }\n      },\n      \"required\": [\"cluster_health\", \"node_availability\", \"pod_stability\", \"api_reliability\"]\n    },\n    \"quick_findings\": { \n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n    \"overridden\": { \"type\": \"boolean\" },\n    \"_context\": { \"type\": \"object\" },\n    \"_debug\": { \"type\": \"object\" }\n  },\n  \"required\": [\n    \"stage\", \n    \"timestamp\", \n    \"overall_status\", \n    \"proceed_to_stage2\", \n    \"alerts\", \n    \"scores\",\n    \"urgency\",\n    \"reason\"\n  ]\n}"
      },
      "id": "1debf070-849d-43a3-91c1-6507a50b2dab",
      "name": "Stage 1 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        -2688,
        704
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"investigation_id\": { \"type\": \"string\" },\n    \"triggered_by\": { \"type\": \"string\" },\n    \"execution_phases\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"instant\": { \"type\": \"object\" },\n        \"trend\": { \"type\": \"object\" },\n        \"anomaly\": { \"type\": \"object\" }\n      }\n    },\n    \"correlation_matrix\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"primary_chain\": { \"type\": \"string\" },\n        \"affected_services\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"blast_radius\": { \"type\": \"string\" },\n        \"kubernetes_impact\": { \"type\": \"object\" }\n      }\n    },\n    \"root_cause\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"identified\": { \"type\": \"boolean\" },\n        \"component\": { \"type\": \"string\" },\n        \"issue\": { \"type\": \"string\" },\n        \"evidence\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"confidence\": { \"type\": \"number\" }\n      }\n    },\n    \"proceed_to_stage3\": { \"type\": \"boolean\" },\n    \"alert_correlation_needed\": { \"type\": \"boolean\" },\n    \"_context\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"contextId\": { \"type\": \"string\" },\n        \"createdAt\": { \"type\": \"string\" },\n        \"source\": { \"type\": \"object\" },\n        \"initialParams\": { \"type\": \"object\" },\n        \"stageConfig\": { \"type\": \"object\" },\n        \"priority\": { \"type\": \"string\" },\n        \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n        \"workflowMetadata\": { \"type\": \"object\" },\n        \"stageResults\": { \"type\": \"object\" },\n        \"decisions\": { \"type\": \"object\" },\n        \"debug\": { \"type\": \"object\" }\n      }\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n      }\n    }\n  },\n  \"required\": [\"stage\", \"root_cause\", \"correlation_matrix\", \"proceed_to_stage3\"]\n}"
      },
      "id": "7a7dc301-f784-48d8-8ba1-7a0739be32a7",
      "name": "Stage 2 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        -2208,
        704
      ],
      "typeVersion": 1.2,
      "disabled": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"active_alerts\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"name\": { \"type\": \"string\" },\n          \"severity\": { \"type\": [\"string\", \"null\"], \"default\": \"unknown\" },\n          \"count\": { \"type\": [\"number\", \"null\"], \"default\": 0 },\n          \"duration\": { \"type\": [\"string\", \"null\"], \"default\": \"unknown\" },\n          \"labels\": { \"type\": [\"object\", \"null\"], \"default\": {} },\n          \"annotations\": { \"type\": [\"object\", \"null\"], \"default\": {} }\n        },\n        \"required\": [\"name\"]\n      } \n    },\n    \"alert_groups\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"root_alert\": { \"type\": \"string\" },\n          \"related_alerts\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n          \"correlation_score\": { \"type\": [\"number\", \"null\"], \"default\": 0 },\n          \"shared_labels\": { \"type\": [\"object\", \"null\"], \"default\": {} }\n        }\n      } \n    },\n    \"knowledge_base_matches\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"alert\": { \"type\": \"string\" },\n          \"kb_entry\": { \"type\": [\"object\", \"null\"], \"default\": {} },\n          \"applicability_score\": { \"type\": [\"number\", \"null\"], \"default\": 0 }\n        }\n      } \n    },\n    \"alert_patterns\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"recurring\": { \"type\": \"array\", \"items\": { \"type\": \"object\" }, \"default\": [] },\n        \"storm_detection\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"detected\": { \"type\": \"boolean\", \"default\": false },\n            \"alert_count\": { \"type\": \"number\", \"default\": 0 },\n            \"time_window\": { \"type\": \"string\", \"default\": \"5m\" },\n            \"likely_root\": { \"type\": [\"string\", \"null\"], \"default\": null }\n          }\n        }\n      }\n    },\n    \"slo_impact\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"availability_slo\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"target\": { \"type\": \"string\", \"default\": \"99.9%\" },\n            \"current\": { \"type\": \"string\", \"default\": \"100%\" },\n            \"error_budget_used\": { \"type\": \"string\", \"default\": \"0%\" },\n            \"time_remaining\": { \"type\": \"string\", \"default\": \"30d\" },\n            \"status\": { \"type\": \"string\", \"enum\": [\"green\", \"yellow\", \"red\", \"unknown\"], \"default\": \"green\" },\n            \"components\": {\n              \"type\": \"object\",\n              \"properties\": {\n                \"deployment_health\": { \"type\": \"string\", \"default\": \"100%\" }\n              }\n            }\n          }\n        },\n        \"affected_slis\": { \"type\": \"array\", \"items\": { \"type\": \"string\" }, \"default\": [] }\n      }\n    },\n    \"recommended_alert_actions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"alert\": { \"type\": \"string\" },\n          \"action\": { \"type\": \"string\" },\n          \"confidence\": { \"type\": [\"number\", \"null\"], \"default\": 0 },\n          \"risk\": { \"type\": \"string\", \"default\": \"medium\" },\n          \"command\": { \"type\": [\"string\", \"null\"], \"default\": null }\n        }\n      }\n    },\n    \"proceed_to_stage4\": { \"type\": \"boolean\" },\n    \"auto_remediation_approved\": { \"type\": \"boolean\", \"default\": false },\n    \"_context\": { \n      \"type\": \"object\",\n      \"additionalProperties\": true\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"additionalProperties\": true\n    }\n  },\n  \"required\": [\"stage\", \"active_alerts\", \"proceed_to_stage4\"],\n  \"additionalProperties\": true\n}"
      },
      "id": "fa641aca-94c7-4069-af65-270d8b4eee98",
      "name": "Stage 3 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        -1232,
        864
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \n      \"type\": \"string\"\n    },\n    \"diagnostics_executed\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"target\": { \"type\": \"string\" },\n          \"type\": { \n            \"type\": \"string\"\n          },\n          \"commands_run\": { \n            \"type\": \"array\", \n            \"items\": { \"type\": \"string\" } \n          },\n          \"findings\": {\n            \"type\": \"object\",\n            \"properties\": {\n              \"pod_status\": { \n                \"type\": \"object\",\n                \"properties\": {\n                  \"phase\": { \"type\": \"string\" },\n                  \"restart_count\": { \"type\": \"number\" },\n                  \"last_termination\": {\n                    \"type\": \"object\",\n                    \"properties\": {\n                      \"reason\": { \"type\": \"string\" },\n                      \"exit_code\": { \"type\": \"number\" },\n                      \"finished_at\": { \"type\": \"string\" }\n                    },\n                    \"additionalProperties\": true\n                  }\n                },\n                \"additionalProperties\": true\n              },\n              \"node_status\": {\n                \"type\": \"object\",\n                \"additionalProperties\": true\n              },\n              \"error_logs\": { \n                \"type\": \"array\", \n                \"items\": { \n                  \"type\": \"object\",\n                  \"properties\": {\n                    \"timestamp\": { \"type\": \"string\" },\n                    \"level\": { \"type\": \"string\" },\n                    \"message\": { \"type\": \"string\" },\n                    \"stack_trace\": { \"type\": \"string\" }\n                  },\n                  \"additionalProperties\": true\n                } \n              },\n              \"events\": { \n                \"type\": \"array\", \n                \"items\": { \n                  \"type\": \"object\",\n                  \"additionalProperties\": true\n                } \n              },\n              \"resource_usage\": { \n                \"type\": \"object\",\n                \"properties\": {\n                  \"memory_request\": { \"type\": \"string\" },\n                  \"memory_limit\": { \"type\": \"string\" },\n                  \"memory_used\": { \"type\": \"string\" },\n                  \"cpu_used\": { \"type\": \"string\" }\n                },\n                \"additionalProperties\": true\n              },\n              \"logs\": {\n                \"type\": \"array\",\n                \"items\": {\n                  \"type\": \"object\",\n                  \"additionalProperties\": true\n                }\n              }\n            },\n            \"additionalProperties\": true\n          }\n        },\n        \"required\": [\"target\", \"type\", \"commands_run\", \"findings\"],\n        \"additionalProperties\": true\n      } \n    },\n    \"enriched_context\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"deployment_info\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"name\": { \"type\": \"string\" },\n            \"version\": { \"type\": \"string\" },\n            \"replicas\": { \"type\": \"string\" },\n            \"last_update\": { \"type\": \"string\" },\n            \"update_strategy\": { \"type\": \"string\" }\n          },\n          \"additionalProperties\": true\n        },\n        \"recent_changes\": { \n          \"type\": \"array\", \n          \"items\": { \n            \"type\": \"object\",\n            \"properties\": {\n              \"type\": { \"type\": \"string\" },\n              \"time\": { \"type\": \"string\" },\n              \"change\": { \"type\": \"string\" },\n              \"user\": { \"type\": \"string\" }\n            },\n            \"required\": [\"type\", \"time\", \"change\"],\n            \"additionalProperties\": true\n          } \n        },\n        \"dependencies\": { \n          \"type\": \"object\",\n          \"properties\": {\n            \"upstream\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            },\n            \"downstream\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            },\n            \"databases\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            },\n            \"external\": { \n              \"type\": \"array\", \n              \"items\": { \"type\": \"string\" } \n            }\n          },\n          \"required\": [\"upstream\", \"downstream\", \"databases\", \"external\"],\n          \"additionalProperties\": true\n        }\n      },\n      \"required\": [\"deployment_info\", \"recent_changes\", \"dependencies\"],\n      \"additionalProperties\": true\n    },\n    \"diagnostic_summary\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"confirmed_issues\": { \n          \"type\": \"array\", \n          \"items\": { \n            \"type\": \"object\",\n            \"properties\": {\n              \"issue\": { \"type\": \"string\" },\n              \"evidence\": { \n                \"type\": \"array\", \n                \"items\": { \"type\": \"string\" } \n              },\n              \"severity\": { \n                \"type\": \"string\"\n              },\n              \"impact\": { \"type\": \"string\" },\n              \"namespace\": { \"type\": \"string\" }\n            },\n            \"additionalProperties\": true\n          } \n        },\n        \"secondary_issues\": { \n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"object\",\n            \"additionalProperties\": true\n          }\n        }\n      },\n      \"required\": [\"confirmed_issues\"],\n      \"additionalProperties\": true\n    },\n    \"proceed_to_stage5\": { \"type\": \"boolean\" },\n    \"remediation_confidence\": { \n      \"type\": \"number\"\n    },\n    \"_context\": { \n      \"type\": \"object\",\n      \"additionalProperties\": true\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \n          \"type\": \"array\", \n          \"items\": { \"type\": \"string\" } \n        },\n        \"diagnosticsCount\": { \"type\": \"number\" },\n        \"autoRemediationEnabled\": { \"type\": \"boolean\" },\n        \"timeRangeUsed\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"start\": { \"type\": \"number\" },\n            \"end\": { \"type\": \"number\" }\n          },\n          \"additionalProperties\": true\n        }\n      },\n      \"additionalProperties\": true\n    }\n  },\n  \"required\": [\n    \"stage\", \n    \"diagnostics_executed\", \n    \"enriched_context\",\n    \"diagnostic_summary\", \n    \"proceed_to_stage5\",\n    \"remediation_confidence\"\n  ],\n  \"additionalProperties\": true\n}"
      },
      "id": "b206f31a-5f11-469f-a5bf-95922b77b7e8",
      "name": "Stage 4 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        -960,
        816
      ],
      "typeVersion": 1.2,
      "disabled": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"remediation_plan\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"action\": { \"type\": \"string\" },\n          \"target\": { \"type\": \"string\" },\n          \"reason\": { \"type\": \"string\" },\n          \"safety_level\": { \"type\": \"string\" },\n          \"prerequisites\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n          \"command\": { \"type\": \"string\" },\n          \"estimated_duration\": { \"type\": \"string\" },\n          \"rollback_possible\": { \"type\": \"boolean\" },\n          \"old_value\": { \"type\": \"string\" },\n          \"new_value\": { \"type\": \"string\" },\n          \"approval_required\": { \"type\": \"boolean\" },\n          \"impact\": { \"type\": \"string\" }\n        }\n      } \n    },\n    \"execution_results\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"action\": { \"type\": \"string\" },\n          \"status\": { \"type\": \"string\" },\n          \"start_time\": { \"type\": \"string\" },\n          \"end_time\": { \"type\": \"string\" },\n          \"output\": { \"type\": \"string\" },\n          \"verification\": { \"type\": \"object\" },\n          \"reason\": { \"type\": \"string\" },\n          \"approval_request\": { \"type\": \"object\" }\n        }\n      } \n    },\n    \"verification_checks\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"check\": { \"type\": \"string\" },\n          \"before\": { \"type\": \"string\" },\n          \"after\": { \"type\": \"string\" },\n          \"status\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"rollback_plan\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"available\": { \"type\": \"boolean\" },\n        \"actions\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n      }\n    },\n    \"notifications_sent\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"channel\": { \"type\": \"string\" },\n          \"team\": { \"type\": \"string\" },\n          \"message\": { \"type\": \"string\" },\n          \"incident\": { \"type\": \"string\" },\n          \"status\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"proceed_to_stage6\": { \"type\": \"boolean\" },\n    \"remediation_success\": { \"type\": \"boolean\" },\n    \"_context\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"contextId\": { \"type\": \"string\" },\n        \"createdAt\": { \"type\": \"string\" },\n        \"source\": { \"type\": \"object\" },\n        \"initialParams\": { \"type\": \"object\" },\n        \"stageConfig\": { \"type\": \"object\" },\n        \"priority\": { \"type\": \"string\" },\n        \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n        \"workflowMetadata\": { \"type\": \"object\" },\n        \"stageResults\": { \"type\": \"object\" },\n        \"decisions\": { \"type\": \"object\" },\n        \"debug\": { \"type\": \"object\" }\n      }\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"actionsExecuted\": { \"type\": \"number\" },\n        \"actionsSuccessful\": { \"type\": \"number\" },\n        \"autoRemediationUsed\": { \"type\": \"boolean\" }\n      }\n    }\n  },\n  \"required\": [\"stage\", \"remediation_plan\", \"execution_results\", \"proceed_to_stage6\"]\n}"
      },
      "id": "a301491b-5583-49a8-96e5-f89b73957a20",
      "name": "Stage 5 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        -608,
        784
      ],
      "typeVersion": 1.2,
      "disabled": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"stage\": { \"type\": \"string\" },\n    \"incident_summary\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"id\": { \"type\": \"string\" },\n        \"title\": { \"type\": \"string\" },\n        \"duration\": { \"type\": \"string\" },\n        \"severity\": { \"type\": \"string\" },\n        \"services_affected\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"customer_impact\": { \"type\": \"string\" },\n        \"root_cause\": { \"type\": \"string\" },\n        \"resolution\": { \"type\": \"string\" }\n      }\n    },\n    \"prevention_actions\": { \n      \"type\": \"array\", \n      \"items\": { \n        \"type\": \"object\",\n        \"properties\": {\n          \"type\": { \"type\": \"string\" },\n          \"action\": { \"type\": \"string\" },\n          \"implementation\": { \"type\": \"object\" },\n          \"status\": { \"type\": \"string\" }\n        }\n      } \n    },\n    \"knowledge_base_update\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"alert_name\": { \"type\": \"string\" },\n        \"new_entry\": { \"type\": \"object\" },\n        \"kb_updated\": { \"type\": \"boolean\" },\n        \"entry_id\": { \"type\": \"string\" }\n      }\n    },\n    \"runbook_updates\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"runbook\": { \"type\": \"string\" },\n          \"section\": { \"type\": \"string\" },\n          \"addition\": { \"type\": \"string\" },\n          \"url\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"team_recommendations\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"team\": { \"type\": \"string\" },\n          \"action\": { \"type\": \"string\" },\n          \"priority\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"follow_up_schedule\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"action\": { \"type\": \"string\" },\n          \"when\": { \"type\": \"string\" },\n          \"owner\": { \"type\": \"string\" },\n          \"attendees\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n        }\n      }\n    },\n    \"metrics_improvements\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"new_alerts\": { \"type\": \"number\" },\n        \"runbook_updates\": { \"type\": \"number\" },\n        \"kb_entries\": { \"type\": \"number\" },\n        \"process_improvements\": { \"type\": \"number\" },\n        \"estimated_future_prevention\": { \"type\": \"string\" }\n      }\n    },\n    \"final_status\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"incident_resolved\": { \"type\": \"boolean\" },\n        \"prevention_implemented\": { \"type\": \"boolean\" },\n        \"learning_captured\": { \"type\": \"boolean\" },\n        \"ready_for_next\": { \"type\": \"boolean\" }\n      }\n    },\n    \"_context\": { \n      \"type\": \"object\",\n      \"properties\": {\n        \"contextId\": { \"type\": \"string\" },\n        \"createdAt\": { \"type\": \"string\" },\n        \"source\": { \"type\": \"object\" },\n        \"initialParams\": { \"type\": \"object\" },\n        \"stageConfig\": { \"type\": \"object\" },\n        \"priority\": { \"type\": \"string\" },\n        \"forceDeepAnalysis\": { \"type\": \"boolean\" },\n        \"workflowMetadata\": { \"type\": \"object\" },\n        \"stageResults\": { \"type\": \"object\" },\n        \"decisions\": { \"type\": \"object\" },\n        \"debug\": { \"type\": \"object\" }\n      }\n    },\n    \"_debug\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"nodeType\": { \"type\": \"string\" },\n        \"processedAt\": { \"type\": \"string\" },\n        \"contextId\": { \"type\": \"string\" },\n        \"contextPreserved\": { \"type\": \"boolean\" },\n        \"receivedFromStage\": { \"type\": \"string\" },\n        \"stageSequence\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n        \"totalStagesExecuted\": { \"type\": \"number\" },\n        \"workflowComplete\": { \"type\": \"boolean\" }\n      }\n    }\n  },\n  \"required\": [\"stage\", \"prevention_actions\", \"knowledge_base_update\", \"final_status\"]\n}"
      },
      "id": "a33fca54-bd79-44f3-8458-b44bf61cff0f",
      "name": "Stage 6 Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        48,
        768
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "jsCode": "// Generate Final Report - Orchestrator Support with Full Context Preservation\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\n// G√ºvenli node verisi alma fonksiyonu\nfunction getNodeData(nodeName) {\n  try {\n    const nodeData = $node[nodeName];\n    if (nodeData && nodeData.json) {\n      return nodeData.json;\n    }\n    return null;\n  } catch (error) {\n    console.log(`Node ${nodeName} verisi bulunamadƒ±: ${error.message}`);\n    return null;\n  }\n}\n\n// G√ºvenli property eri≈üimi\nfunction safeGet(obj, path, defaultValue) {\n  try {\n    const keys = path.split('.');\n    let result = obj;\n    for (const key of keys) {\n      if (result && typeof result === 'object' && key in result) {\n        result = result[key];\n      } else {\n        return defaultValue;\n      }\n    }\n    return result ?? defaultValue;\n  } catch (e) {\n    return defaultValue;\n  }\n}\n\n// Mock data detection function\nfunction detectAndCleanMockData(data) {\n  const mockIndicators = [\n    'payment-service',\n    'PaymentProcessor',\n    'TransactionHandler',\n    '2023-08-',\n    '2024-01-15',\n    '2024-06-01',\n    'payment-db',\n    'stripe-api'\n  ];\n  \n  let dataStr = JSON.stringify(data);\n  let hasMockData = false;\n  \n  mockIndicators.forEach(indicator => {\n    if (dataStr.includes(indicator)) {\n      console.warn(`‚ö†Ô∏è Mock data indicator found: ${indicator}`);\n      hasMockData = true;\n    }\n  });\n  \n  return hasMockData;\n}\n\n// Input verisi - Route'tan gelen\nconst inputData = $input.first().json;\n\n// Master context'i al - √∂ncelikle input'tan\nlet masterContext = inputData._context;\n\n// Eƒüer input'ta context yoksa, Stage 6'dan al\nif (!masterContext) {\n  const stage6Data = getNodeData(\"Stage 6: Prevention & Learning\");\n  if (stage6Data && stage6Data._context) {\n    masterContext = stage6Data._context;\n  }\n}\n\n// Hala context yoksa, Stage 5'ten al\nif (!masterContext) {\n  const stage5Data = getNodeData(\"Fix Stage 5 Context\");\n  if (stage5Data && stage5Data._context) {\n    masterContext = stage5Data._context;\n  }\n}\n\n// Context validation\nif (!masterContext || !masterContext.contextId) {\n  console.error(\"CRITICAL: No context found! Creating emergency context\");\n  masterContext = {\n    contextId: `emergency-${Date.now()}`,\n    createdAt: new Date().toISOString(),\n    source: { type: 'unknown' },\n    stageResults: {},\n    decisions: {},\n    debug: { error: 'Context lost - emergency creation' },\n    initialParams: {\n      namespaces: DEFAULT_NAMESPACES,\n      startTime: Math.floor(Date.now() / 1000) - 3600,\n      endTime: Math.floor(Date.now() / 1000)\n    }\n  };\n}\n\n// Config verilerini al\nconst config = getNodeData(\"Unified Entry Point\") || {};\n\n// YENƒ∞ YAPI: Stage verilerini root level'dan al\nlet allStageData = {\n  stage1: null,\n  stage2: null,\n  stage3: null,\n  stage4: null,\n  stage5: null,\n  stage6: null\n};\n\n// Input'tan (Stage 6 output veya direct route) stage verilerini al\nif (inputData.stage === \"prevention_learning\") {\n  // Stage 6'dan geliyor\n  allStageData.stage6 = {\n    incident_summary: inputData.incident_summary,\n    prevention_actions: inputData.prevention_actions,\n    knowledge_base_update: inputData.knowledge_base_update,\n    final_status: inputData.final_status,\n    follow_up_schedule: inputData.follow_up_schedule,\n    team_recommendations: inputData.team_recommendations,\n    runbook_updates: inputData.runbook_updates,\n    metrics_improvements: inputData.metrics_improvements\n  };\n  \n  // Diƒüer stage'leri input'tan al (Fix Stage 5 tarafƒ±ndan ta≈üƒ±nmƒ±≈ü)\n  allStageData.stage1 = inputData.stage1Data;\n  allStageData.stage2 = inputData.stage2Data;\n  allStageData.stage3 = inputData.stage3Data;\n  allStageData.stage4 = inputData.stage4Data;\n  allStageData.stage5 = inputData.stage5Data;\n  \n  // Consolidated findings\n  allStageData.consolidatedFindings = inputData.consolidatedFindings;\n  allStageData.primaryDiagnosis = inputData.primaryDiagnosis;\n  \n} else if (inputData.stage1Data) {\n  // Route'tan direkt geliyor (erken durduysa)\n  allStageData.stage1 = inputData.stage1Data;\n  allStageData.stage2 = inputData.stage2Data;\n  allStageData.stage3 = inputData.stage3Data;\n  allStageData.stage4 = inputData.stage4Data;\n  allStageData.stage5 = inputData.stage5Data;\n  \n  allStageData.consolidatedFindings = inputData.consolidatedFindings;\n  allStageData.primaryDiagnosis = inputData.primaryDiagnosis;\n  \n} else {\n  // Fallback: Fix node'lardan topla\n  const stage5FixData = getNodeData(\"Fix Stage 5 Context\");\n  const stage4FixData = getNodeData(\"Fix Stage 4 Context\");\n  const stage3FixData = getNodeData(\"Fix Stage 3 Context1\");\n  const stage2FixData = getNodeData(\"Fix Stage 2 Context\");\n  const stage1FixData = getNodeData(\"Fix Stage 1 Context\");\n  \n  // En g√ºncel veriye sahip node'dan al (Stage 5)\n  if (stage5FixData) {\n    allStageData.stage1 = stage5FixData.stage1Data;\n    allStageData.stage2 = stage5FixData.stage2Data;\n    allStageData.stage3 = stage5FixData.stage3Data;\n    allStageData.stage4 = stage5FixData.stage4Data;\n    allStageData.stage5 = stage5FixData.stage5Data;\n    allStageData.consolidatedFindings = stage5FixData.consolidatedFindings;\n    allStageData.primaryDiagnosis = stage5FixData.primaryDiagnosis;\n  } else if (stage4FixData) {\n    allStageData.stage1 = stage4FixData.stage1Data;\n    allStageData.stage2 = stage4FixData.stage2Data;\n    allStageData.stage3 = stage4FixData.stage3Data;\n    allStageData.stage4 = stage4FixData.stage4Data;\n    allStageData.consolidatedFindings = stage4FixData.consolidatedFindings;\n    allStageData.primaryDiagnosis = stage4FixData.primaryDiagnosis;\n  } else if (stage3FixData) {\n    allStageData.stage1 = stage3FixData.stage1Data;\n    allStageData.stage2 = stage3FixData.stage2Data;\n    allStageData.stage3 = stage3FixData.stage3Data;\n  } else if (stage2FixData) {\n    allStageData.stage1 = stage2FixData.stage1Data;\n    allStageData.stage2 = stage2FixData.stage2Data;\n  } else if (stage1FixData) {\n    allStageData.stage1 = stage1FixData.stage1Data;\n  }\n}\n\n// MOCK DATA CLEANUP\nconsole.log(\"=== MOCK DATA DETECTION ===\");\nlet mockDataFound = false;\n\n// Stage 4 mock data kontrol√º ve temizleme\nif (allStageData.stage4 && detectAndCleanMockData(allStageData.stage4)) {\n  console.warn(\"‚ö†Ô∏è Mock data found in Stage 4, using Stage 2 root cause data\");\n  mockDataFound = true;\n  \n  if (allStageData.stage2?.root_cause) {\n    allStageData.stage4.diagnostic_summary = {\n      confirmed_issues: [{\n        issue: allStageData.stage2.root_cause.issue,\n        evidence: allStageData.stage2.root_cause.evidence,\n        severity: \"high\",\n        impact: `${allStageData.stage2.root_cause.component} is experiencing issues`,\n        namespace: allStageData.stage2.affected_services?.[0]?.split('-')?.[0] || DEFAULT_NAMESPACES[0]\n      }],\n      secondary_issues: []\n    };\n  }\n}\n\n// Stage 5 mock data kontrol√º ve temizleme\nif (allStageData.stage5?.remediation_plan?.immediate_actions) {\n  allStageData.stage5.remediation_plan.immediate_actions.forEach((action, idx) => {\n    if (action.command && action.command.includes('payment-service')) {\n      const actualComponent = allStageData.stage2?.root_cause?.component || \"unknown-component\";\n      const actualNamespace = allStageData.stage2?.affected_services?.[0]?.split('-')?.[0] || DEFAULT_NAMESPACES[0];\n      \n      action.command = `kubectl delete pod ${actualComponent} -n ${actualNamespace}`;\n      action.action = action.action.replace(/payment-service/g, actualComponent);\n      mockDataFound = true;\n    }\n  });\n}\n\n// Primary diagnosis mock data temizleme\nif (allStageData.primaryDiagnosis && JSON.stringify(allStageData.primaryDiagnosis).includes('payment-service')) {\n  console.warn(\"‚ö†Ô∏è Primary diagnosis contains mock data, replacing with Stage 2 root cause\");\n  if (allStageData.stage2?.root_cause) {\n    allStageData.primaryDiagnosis = {\n      issue: allStageData.stage2.root_cause.issue,\n      severity: \"high\",\n      evidence: allStageData.stage2.root_cause.evidence,\n      impact: `${allStageData.stage2.root_cause.component} causing service disruption`,\n      namespace: allStageData.stage2.affected_services?.[0]?.split('-')?.[0] || DEFAULT_NAMESPACES[0]\n    };\n  }\n  mockDataFound = true;\n}\n\nif (mockDataFound) {\n  console.log(\"‚úÖ Mock data cleaned from final report\");\n}\nconsole.log(\"===========================\");\n\n// √ñNEMLƒ∞: Context'teki stageResults'ƒ± g√ºncelle\n// Eƒüer context'te stageResults eksikse veya eksik stage'ler varsa, ekle\nif (!masterContext.stageResults) {\n  masterContext.stageResults = {};\n}\n\n// Her stage i√ßin stageResults'a ekle (eƒüer yoksa)\nif (allStageData.stage1 && !masterContext.stageResults.stage1) {\n  masterContext.stageResults.stage1 = {\n    output: allStageData.stage1,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage1.proceed_to_stage2,\n    status: allStageData.stage1.overall_status\n  };\n}\n\nif (allStageData.stage2 && !masterContext.stageResults.stage2) {\n  masterContext.stageResults.stage2 = {\n    output: allStageData.stage2,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage2.proceed_to_stage3,\n    rootCauseIdentified: allStageData.stage2.root_cause?.identified\n  };\n}\n\nif (allStageData.stage3 && !masterContext.stageResults.stage3) {\n  masterContext.stageResults.stage3 = {\n    output: allStageData.stage3,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage3.proceed_to_stage4\n  };\n}\n\nif (allStageData.stage4 && !masterContext.stageResults.stage4) {\n  masterContext.stageResults.stage4 = {\n    output: allStageData.stage4,\n    completedAt: new Date().toISOString(),\n    decision: allStageData.stage4.proceed_to_stage5,\n    primaryIssue: allStageData.stage4.diagnostic_summary?.confirmed_issues?.[0]?.issue\n  };\n}\n\nif (allStageData.stage5 && !masterContext.stageResults.stage5) {\n  masterContext.stageResults.stage5 = {\n    output: allStageData.stage5,\n    completedAt: new Date().toISOString()\n  };\n}\n\nif (allStageData.stage6 && !masterContext.stageResults.stage6) {\n  masterContext.stageResults.stage6 = {\n    output: allStageData.stage6,\n    completedAt: new Date().toISOString()\n  };\n}\n\n// Context journey validation\nconsole.log(\"=== CONTEXT JOURNEY VALIDATION ===\");\nconsole.log(\"Context ID:\", masterContext.contextId);\nconsole.log(\"Context Created:\", masterContext.createdAt);\nconsole.log(\"Source Type:\", masterContext.source?.type);\nconsole.log(\"Priority:\", masterContext.priority);\nconsole.log(\"Stages with data:\", Object.keys(allStageData).filter(k => allStageData[k] !== null));\nconsole.log(\"Stages in Context:\", Object.keys(masterContext.stageResults || {}));\nconsole.log(\"Decisions Made:\", Object.keys(masterContext.decisions || {}));\nconsole.log(\"==================================\");\n\n// √áalƒ±≈üan stage sayƒ±sƒ±\nconst executedStages = Object.keys(allStageData).filter(stage => allStageData[stage] !== null).length;\n\n// S√ºre hesaplama\nconst startTime = new Date(masterContext.createdAt);\nconst endTime = new Date();\nconst durationSeconds = Math.round((endTime - startTime) / 1000);\n\n// Tool sayƒ±sƒ±nƒ± hesapla\nfunction calculateToolsUsed() {\n  let toolCount = 2; // Stage 1\n  if (allStageData.stage2) toolCount += 9;\n  if (allStageData.stage3) toolCount += 7; // SLO tools dahil\n  if (allStageData.stage4) toolCount += 3;\n  if (allStageData.stage5) toolCount += 0; // Stage 5 tool kullanmƒ±yor\n  if (allStageData.stage6) toolCount += 6; // Prevention tools\n  return toolCount;\n}\n\n// Chat/Summary response olu≈ütur\nfunction generateResponse(report) {\n  const health = report.stage1Results.status;\n  const alerts = report.stage1Results.alerts.total;\n  const criticalAlerts = report.stage1Results.alerts.critical;\n  \n  let response = `üîç **Kubernetes Cluster Analizi**\\n\\n`;\n  response += `üìä **Cluster:** ${report.cluster}\\n`;\n  response += `üÜî **Context ID:** ${report.contextTracking.contextId}\\n`;\n  response += `‚è±Ô∏è **S√ºre:** ${report.duration}\\n\\n`;\n  \n  response += `**üìà Genel Durum:**\\n`;\n  response += `- Saƒülƒ±k Durumu: ${health}\\n`;\n  response += `- Aktif Alert: ${alerts} (${criticalAlerts} kritik)\\n`;\n  response += `- √áalƒ±≈üan Stage: ${report.executiveSummary.stagesExecuted}/6\\n\\n`;\n  \n  if (report.findings.rootCause.identified) {\n    response += `**üéØ K√∂k Neden Analizi:**\\n`;\n    response += `- Sorun: ${report.findings.rootCause.issue}\\n`;\n    response += `- Bile≈üen: ${report.findings.rootCause.component}\\n`;\n    response += `- G√ºven: ${(report.findings.rootCause.confidence * 100).toFixed(0)}%\\n`;\n    response += `- Etkilenen Servisler: ${report.findings.affectedServices.join(', ') || 'Yok'}\\n\\n`;\n  }\n  \n  if (report.actions.immediate.length > 0) {\n    response += `**üîß √ñnerilen Aksiyonlar:**\\n`;\n    report.actions.immediate.forEach((action, idx) => {\n      response += `${idx + 1}. ${action.action}\\n`;\n      response += `   - Risk: ${action.risk}\\n`;\n      response += `   - S√ºre: ${action.estimated_time}\\n`;\n      if (action.command && !action.command.includes('payment-service')) {\n        response += `   - Komut: \\`${action.command}\\`\\n`;\n      }\n    });\n    response += `\\n`;\n  }\n  \n  if (report.findings.sloImpact?.availability_slo) {\n    const slo = report.findings.sloImpact.availability_slo;\n    response += `**üìä SLO Durumu:**\\n`;\n    response += `- Mevcut: ${slo.current}\\n`;\n    response += `- Hedef: ${slo.target}\\n`;\n    response += `- Durum: ${slo.status}\\n\\n`;\n  }\n  \n  if (report.overrideInfo) {\n    response += `**üîÑ Override Bilgisi:**\\n`;\n    response += `${report.overrideInfo.message}\\n\\n`;\n  }\n  \n  response += `**üìã √ñzet:**\\n`;\n  response += `${executedStages} a≈üama tamamlandƒ±, ${report.metrics.decisionsTracked} karar takip edildi.\\n`;\n  \n  return response;\n}\n\n// Final raporu olu≈ütur\nconst finalReport = {\n  executionId: masterContext.workflowMetadata?.executionId || config.executionId,\n  timestamp: endTime.toISOString(),\n  duration: `${durationSeconds}s`,\n  cluster: safeGet(masterContext, 'initialParams.namespaces.0', 'unknown'),\n  \n  // Context tracking\n  contextTracking: {\n    contextId: masterContext.contextId,\n    contextCreated: masterContext.createdAt,\n    contextPreserved: true,\n    contextJourney: {\n      start: masterContext.createdAt,\n      end: endTime.toISOString(),\n      durationMs: endTime - startTime,\n      stagesCompleted: Object.keys(masterContext.stageResults || {})\n    }\n  },\n  \n  // Orchestrator metadata\n  ...(masterContext.source?.type === 'orchestrator' && {\n    orchestratorId: masterContext.source.orchestratorId,\n    requestId: masterContext.workflowMetadata?.requestId\n  }),\n  \n  trigger: {\n    source: masterContext.source || { type: 'unknown' },\n    priority: masterContext.priority || 'normal',\n    forceDeepAnalysis: masterContext.forceDeepAnalysis || false\n  },\n  \n  executiveSummary: {\n    overallHealth: allStageData.stage1?.overall_status || 'unknown',\n    issuesFound: allStageData.stage2?.root_cause?.identified ? 1 : 0,\n    alertsActive: allStageData.stage1?.alerts?.total || 0,\n    alertsCritical: allStageData.stage1?.alerts?.critical || 0,\n    actionsToken: allStageData.stage5?.remediation_plan?.immediate_actions?.length || 0,\n    preventionImplemented: allStageData.stage6?.prevention_actions?.filter(a => a.status === 'implemented').length || 0,\n    stagesExecuted: executedStages\n  },\n  \n  // Stage 1 Results\n  stage1Results: {\n    status: allStageData.stage1?.overall_status || 'unknown',\n    scores: allStageData.stage1?.scores || {},\n    alerts: allStageData.stage1?.alerts || { total: 0, critical: 0, warning: 0 },\n    quickFindings: allStageData.stage1?.quick_findings || [],\n    proceedToStage2: allStageData.stage1?.proceed_to_stage2 || false,\n    urgency: allStageData.stage1?.urgency || 'normal',\n    decision_reason: allStageData.stage1?.reason || ''\n  },\n  \n  // Findings from all stages\n  findings: {\n    rootCause: allStageData.stage2?.root_cause || { identified: false, issue: 'Not identified' },\n    affectedServices: allStageData.stage2?.affected_services || [],\n    alertCorrelations: allStageData.stage3?.alert_groups || [],\n    diagnosticEvidence: allStageData.stage4?.diagnostic_summary?.confirmed_issues || [],\n    sloImpact: allStageData.stage3?.slo_impact || {}\n  },\n  \n  // Actions taken\n  actions: {\n    immediate: allStageData.stage5?.remediation_plan?.immediate_actions || [],\n    shortTerm: allStageData.stage5?.remediation_plan?.short_term_fixes || [],\n    longTerm: allStageData.stage5?.remediation_plan?.long_term_solutions || [],\n    preventive: allStageData.stage6?.prevention_actions || []\n  },\n  \n  // Metrics\n  metrics: {\n    stagesExecuted: executedStages,\n    toolsUsed: calculateToolsUsed(),\n    alertsResolved: 0,\n    executionTime: durationSeconds,\n    contextPreserved: true,\n    decisionsTracked: Object.keys(masterContext.decisions || {}).length\n  },\n  \n  // Next steps from Stage 6\n  nextSteps: allStageData.stage6?.follow_up_schedule || [],\n  \n  // Detailed results from each stage\n  detailedResults: {\n    stage1_health: allStageData.stage1,\n    stage2_analysis: allStageData.stage2,\n    stage3_alerts: allStageData.stage3,\n    stage4_diagnosis: allStageData.stage4,\n    stage5_remediation: allStageData.stage5,\n    stage6_prevention: allStageData.stage6\n  },\n  \n  // Consolidated findings\n  consolidatedFindings: allStageData.consolidatedFindings || {},\n  \n  // Primary diagnosis\n  primaryDiagnosis: allStageData.primaryDiagnosis || {},\n  \n  // Preserved context (g√ºncellenmi≈ü stageResults ile)\n  preservedContext: masterContext\n};\n\n// Override bilgisi ekle\nif (masterContext.decisions?.forceDeepAnalysisOverride?.overrideApplied) {\n  finalReport.overrideInfo = {\n    message: \"Derin analiz kullanƒ±cƒ± isteƒüiyle zorlandƒ±\",\n    originalDecision: masterContext.decisions.forceDeepAnalysisOverride.originalDecision,\n    overrideReason: masterContext.decisions.forceDeepAnalysisOverride.reason,\n    priority: masterContext.priority\n  };\n}\n\n// Response ekle\nif (masterContext.source?.type === 'chat') {\n  finalReport.chatResponse = generateResponse(finalReport);\n} else {\n  finalReport.summary = generateResponse(finalReport);\n}\n\n// Direkt raporu d√∂nd√ºr\nreturn [{ json: finalReport }];"
      },
      "id": "9c295298-1e66-4b1a-87fc-320ac6cb5b28",
      "name": "Generate Final Report",
      "type": "n8n-nodes-base.code",
      "position": [
        256,
        416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## üöÄ Prometheus Ultimate AI Agent System\n\n### 6-Stage Intelligent Analysis & Remediation\n\n1. **Stage 1: Health Snapshot** (5s)\n   - Quick cluster health check\n   - Active alerts count\n   - Go/No-go decision\n\n2. **Stage 2: Deep Analysis** (30s)\n   - 3-phase investigation\n   - Instant ‚Üí Trend ‚Üí Anomaly\n   - Root cause identification\n\n3. **Stage 3: Alert Intelligence** (20s)\n   - Alert correlation\n   - Knowledge base matching\n   - SLO impact assessment\n\n4. **Stage 4: Automated Diagnosis** (20s)\n   - Execute diagnostic commands\n   - Enrich context\n   - Confirm root cause\n\n5. **Stage 5: Smart Remediation** (30s)\n   - Safe auto-fixes\n   - Approval workflow\n   - Verification loops\n\n6. **Stage 6: Prevention** (20s)\n   - Update monitoring\n   - Document learnings\n   - Prevent recurrence\n\n### Features:\n- Alert correlation engine\n- Knowledge base integration\n- Auto-remediation (safe actions)\n- Predictive analysis\n- Learning system\n- ChatOps commands\n- SLO tracking\n- Runbook automation\n\n### Triggers:\n- Manual\n- Scheduled (5 min)\n- Chat commands\n- AlertManager webhooks",
        "height": 600,
        "width": 400,
        "color": 5
      },
      "id": "166b6182-c528-41f2-a3d7-ae1efffd2cdc",
      "name": "System Overview",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -816,
        48
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "etiya-gpt-4o",
          "mode": "list",
          "cachedResultName": "etiya-gpt-4o"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.1,
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1632,
        208
      ],
      "id": "da9bb99b-3a26-472b-8bdb-809a78ffda3a",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "rYdB8nNsS7m67tcr",
          "name": "OpenAi account 5"
        }
      }
    },
    {
      "parameters": {
        "content": "# Prometheus AI Agent - Chat Komutlarƒ±\n\n## üéØ Desteklenen Komutlar\n\n### 1. Derin Analiz Komutlarƒ±\nT√ºm 6 a≈üamayƒ± zorla √ßalƒ±≈ütƒ±rƒ±r, cluster saƒülƒ±klƒ± olsa bile:\n\n```\ndeep analysis\nderin analiz\nfull scan\ndetailed check\nanalyze everything\nforce check\n```\n\n**√ñrnekler:**\n- \"run deep analysis on the cluster\"\n- \"force a detailed check\"\n- \"analyze everything even if healthy\"\n\n### 2. Hƒ±zlƒ± Kontrol\nSadece Stage 1 √ßalƒ±≈üƒ±r:\n\n```\nquick check\nquick analysis\nhƒ±zlƒ± kontrol\nstatus\n```\n\n**√ñrnekler:**\n- \"quick check cluster health\"\n- \"give me a status update\"\n\n### 3. Servis Bazlƒ± Analiz\nBelirli bir servise odaklanƒ±r:\n\n```\ncheck service: <service-name>\nanalyze service: <service-name>\n```\n\n**√ñrnekler:**\n- \"check service: payment-api\"\n- \"analyze service: user-auth\"\n\n### 4. Alert Odaklƒ± Analiz\nAlert'lere odaklanarak derin analiz:\n\n```\ncheck alerts\nalert analysis\nanalyze all alerts\n```\n\n### 5. Namespace Analizi\nBelirli namespace'e odaklanƒ±r:\n\n```\nnamespace: <namespace-name>\ncheck namespace: <namespace-name>\n```\n\n**√ñrnekler:**\n- \"deep analysis namespace: etiyamobile-production\"\n- \"check namespace: staging\"\n\n### 6. Zaman Aralƒ±ƒüƒ± Belirtme\nAnaliz i√ßin zaman aralƒ±ƒüƒ±:\n\n```\nlast hour\nlast day\nlast week\n```\n\n**√ñrnekler:**\n- \"deep analysis for last hour\"\n- \"check alerts from last day\"\n\n## üìù Kombinasyon √ñrnekleri\n\n```\n# Namespace + Derin analiz\n\"run deep analysis on namespace: etiyamobile-production\"\n\n# Servis + Zaman aralƒ±ƒüƒ±\n\"check service: payment-api for last hour\"\n\n# Alert + Derin analiz\n\"deep analysis of all alerts\"\n\n# Zorla derin analiz + zaman\n\"force detailed check for last day\"\n```",
        "height": 760,
        "width": 400
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4320,
        144
      ],
      "typeVersion": 1,
      "id": "fb2a7f73-ecb3-453c-86f6-3207f5aa670a",
      "name": "Chat Commands Guide"
    },
    {
      "parameters": {
        "jsCode": "// Prometheus Workflow - Orchestrator Input Handler\n// Bu node Orchestrator'dan gelen veriyi i≈üler ve Prometheus'a uygun formata √ßevirir\n\n// Default production namespaces to monitor (matches Alert-Driven flow)\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\n// Default production services to monitor (from kubectl get service -A)\nconst DEFAULT_SERVICES = [\n  'bss-mc-crm-search-integrator', 'bss-mc-crm-customer-information', 'bss-mc-crm-customer-search',\n  'bss-mc-crm-mash-up', 'bss-mc-crm-ntf-integrator', 'bss-mc-activity', 'bss-mc-asset-management',\n  'bss-mc-cpq', 'bss-mc-cpq-batch', 'bss-mc-cpq-ntf-integrator', 'bss-mc-csr', 'bss-mc-domain-config',\n  'bss-mc-id-service', 'bss-mc-message-relay', 'bss-mc-ntf-engine', 'bss-mc-ntf-history', 'bss-mc-rim',\n  'bss-mc-ui-authz', 'bss-mc-user-management', 'bss-mc-wsc-new', 'bss-crm-batch', 'bss-ntf-batch',\n  'bss-mc-pcm-cfm', 'bss-mc-pcm-cms-integrator', 'bss-mc-pcm-product-catalog', 'bss-mc-pcm-product-offer-detail',\n  'bss-mc-pcm-next-gen-admintoolbox-config-manager', 'bss-mc-pcm-next-gen-admintoolbox-ui',\n  'eom-micro-flows', 'eom-operate', 'eom-scheduler', 'eom-ui', 'eom-activemqqueueoperations',\n  'eom-postgresqldboperations', 'eom-zeebe', 'eom-castlemock', 'bss-services-service',\n  'external-services-service', 'loyalty-services-service', 'om-services-service', 'fstp-bpmn-ms',\n  'fstp-configuration-ms', 'fstp-dashboard-ms', 'fstp-frontend', 'fstp-orchestra-ms', 'fstp-scheduler-ms',\n  'fstp-eca', 'eca', 'wso2am-gw-service', 'wso2am-cp-service', 'bss-saas-control-plane',\n  'bss-saas-control-plane-ui', 'bss-tenant-control-plane-batch'\n];\n\nconst input = $input.first().json;\n\n// Debug i√ßin - console.log yerine deƒüi≈ükenlere yazalƒ±m\nlet debugInfo = {\n  rawInput: JSON.stringify(input, null, 2),\n  processedAt: new Date().toISOString()\n};\n\n// Default deƒüerler\nconst defaults = {\n  timeRange: {\n    duration: 3600, // 1 saat\n    lookback: 3600\n  },\n  environment: 'k8s-prod', // Multi-namespace cluster\n  cluster: 'k8s-prod',\n  limits: {\n    maxStages: 6,\n    alertThreshold: 10\n  }\n};\n\n// Processed input olu≈ütur\nlet processedInput = {\n  // Metadata\n  source: input.source || 'direct',\n  orchestratorId: input.orchestratorId || null,\n  requestId: input.requestId || `prom-${Date.now()}`,\n  timestamp: new Date().toISOString(),\n  \n  // Time handling\n  timeRange: {\n    start: null,\n    end: null,\n    duration: null,\n    humanReadable: {}\n  },\n  \n  // Analysis configuration\n  analysisConfig: {\n    type: input.analysisType || 'metrics',\n    priority: input.priority || 'normal',\n    depth: 'standard', // light, standard, deep\n    forceDeepAnalysis: false,\n    skipHealthGate: false\n  },\n  \n  // Kubernetes-focused search parameters\n  searchParams: {\n    cluster: input.cluster || defaults.cluster,\n    namespaces: [],\n    services: [],\n    nodes: [],\n    pods: [],\n    workloadTypes: [], // deployment, statefulset, daemonset, job\n    metrics: [], // specific metrics to focus on\n    alertTypes: [],\n    resourceTypes: [] // pods, nodes, pvs, etc.\n  },\n  \n  // Feature flags\n  features: {\n    includeAlerts: true,\n    includeKnowledgeBase: true,\n    enableAutoRemediation: false,\n    compareWithHistory: false,\n    predictiveAnalysis: false,\n    sloChecking: false,\n    kubernetesHealth: true,\n    applicationMetrics: true\n  },\n  \n  // Context from orchestrator\n  context: {\n    correlationId: input.correlationId,\n    otherAgents: input.otherAgents || [],\n    userIntent: input.userIntent || '',\n    expectedOutputFormat: input.expectedOutputFormat || 'detailed'\n  }\n};\n\n// 1. TIME RANGE PROCESSING\nif (input.startTime && input.endTime) {\n  processedInput.timeRange.start = parseInt(input.startTime);\n  processedInput.timeRange.end = parseInt(input.endTime);\n  processedInput.timeRange.duration = processedInput.timeRange.end - processedInput.timeRange.start;\n  \n  processedInput.timeRange.humanReadable = {\n    start: new Date(processedInput.timeRange.start * 1000).toISOString(),\n    end: new Date(processedInput.timeRange.end * 1000).toISOString(),\n    duration: `${Math.floor(processedInput.timeRange.duration / 60)} minutes`\n  };\n} else {\n  const now = Math.floor(Date.now() / 1000);\n  processedInput.timeRange.end = now;\n  processedInput.timeRange.start = now - defaults.timeRange.lookback;\n  processedInput.timeRange.duration = defaults.timeRange.lookback;\n  \n  processedInput.timeRange.humanReadable = {\n    start: new Date(processedInput.timeRange.start * 1000).toISOString(),\n    end: new Date(processedInput.timeRange.end * 1000).toISOString(),\n    duration: `${Math.floor(processedInput.timeRange.duration / 60)} minutes`\n  };\n}\n\n// SERVICE EXTRACTION - YENƒ∞ EKLENDƒ∞\n// Servis isimlerini g√ºvenli bir ≈üekilde √ßƒ±kar\n \n// SERVICE EXTRACTION - D√úZELTME\nfunction extractServices(message) {\n  const services = [];\n  \n  // Pattern 1: Kubernetes service name pattern (namespace-component-component-...)\n  // bss-mc-crm-search-integrator gibi isimleri yakalar\n  const k8sServicePattern = /\\b([a-z0-9]+(?:-[a-z0-9]+){2,})(?:-service|-api|-svc)?\\b/gi;\n  const k8sMatches = message.matchAll(k8sServicePattern);\n  for (const match of k8sMatches) {\n    const serviceName = match[0].toLowerCase();\n    // Yaygƒ±n suffix'leri kontrol et ama servis ismi olabilir\n    if (!serviceName.endsWith('-i√ßin') && \n        !serviceName.endsWith('-analiz') && \n        !serviceName.endsWith('-servisi') &&\n        !serviceName.includes('saatlik')) {\n      services.push(serviceName);\n    }\n  }\n  \n  // Pattern 2: \"service: xxx\" veya \"servis: xxx\" formatƒ±\n  const explicitPattern = /(?:service|servis):\\s*([a-zA-Z0-9-]+)/gi;\n  const explicitMatches = message.matchAll(explicitPattern);\n  for (const match of explicitMatches) {\n    services.push(match[1].toLowerCase());\n  }\n  \n  // Pattern 3: \" servisi\" kelimesinden √∂nceki kelime\n  const turkishPattern = /([a-zA-Z0-9-]+)\\s+servisi/gi;\n  const turkishMatches = message.matchAll(turkishPattern);\n  for (const match of turkishMatches) {\n    if (!services.includes(match[1].toLowerCase())) {\n      services.push(match[1].toLowerCase());\n    }\n  }\n  \n  // Duplicate'leri kaldƒ±r\n  const uniqueServices = [...new Set(services)];\n  \n  // Debug log\n  console.log(\"Message:\", message);\n  console.log(\"Extracted services:\", uniqueServices);\n  \n  return uniqueServices;\n}\n\n// 2. PARSE USER MESSAGE for Kubernetes context\nif (input.message || input.chatInput) {\n  const message = (input.message || input.chatInput || '').toLowerCase();\n  \n  // Kubernetes Resources\n  if (message.includes('pod') || message.includes('container')) {\n    processedInput.searchParams.resourceTypes.push('pods');\n    processedInput.searchParams.metrics.push('pod_metrics');\n  }\n  if (message.includes('node')) {\n    processedInput.searchParams.resourceTypes.push('nodes');\n    processedInput.searchParams.metrics.push('node_metrics');\n  }\n  if (message.includes('deployment')) {\n    processedInput.searchParams.workloadTypes.push('deployments');\n  }\n  \n  // Kubernetes Issues\n  if (message.includes('restart') || message.includes('crashloop')) {\n    processedInput.searchParams.metrics.push('container_restarts');\n    processedInput.searchParams.alertTypes.push('KubePodCrashLooping');\n  }\n  if (message.includes('oom') || message.includes('memory')) {\n    processedInput.searchParams.metrics.push('memory_usage', 'memory_limits');\n    processedInput.searchParams.alertTypes.push('KubeMemoryOvercommit');\n  }\n\n  // Memory leak detection\n  if (message.includes('memory leak') || message.includes('bellek sƒ±zƒ±ntƒ±sƒ±')) {\n    processedInput.searchParams.metrics.push('memory_usage', 'memory_growth');\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n    processedInput.analysisConfig.priority = 'high';\n  }\n \n// Service extraction - G√úNCELLENDƒ∞\nconst extractedServices = extractServices(message);\nif (extractedServices.length > 0) {\n  processedInput.searchParams.services = extractedServices;\n  console.log(\"Extracted services:\", extractedServices);\n} else {\n  // No services extracted from message, use defaults\n  processedInput.searchParams.services = DEFAULT_SERVICES;\n  console.log(`No services in message, using DEFAULT_SERVICES: ${DEFAULT_SERVICES.length} services`);\n}\n  \n  // Application Metrics\n  if (message.includes('error rate') || message.includes('hata')) {\n    processedInput.searchParams.metrics.push('http_error_rate');\n  }\n  if (message.includes('latency') || message.includes('slow')) {\n    processedInput.searchParams.metrics.push('http_latency');\n  }\n  \n  // Analysis depth\n  if (message.includes('deep') || message.includes('detailed') || message.includes('derin')) {\n    processedInput.analysisConfig.depth = 'deep';\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n  }\n}\n\n// 3. PROCESS ORCHESTRATOR CONTEXT AND PRIORITY - √ñNEMLƒ∞ B√ñL√úM\n// Priority kontrol√º - input'tan doƒürudan gelen priority'yi kontrol et\nif (input.priority === 'critical') {\n  processedInput.analysisConfig.priority = 'critical';\n  processedInput.analysisConfig.forceDeepAnalysis = true;\n  processedInput.features.enableAutoRemediation = true;\n} else if (input.priority === 'high') {\n  processedInput.analysisConfig.priority = 'high';\n  processedInput.analysisConfig.forceDeepAnalysis = true;\n} else {\n  processedInput.analysisConfig.priority = input.priority || 'normal';\n}\n\n// Context'ten gelen priority/severity kontrol√º\nif (input.context) {\n  if (input.context.keywords && Array.isArray(input.context.keywords)) {\n    input.context.keywords.forEach(keyword => {\n      if (['payment', 'order', 'user', 'notification'].includes(keyword)) {\n        if (!processedInput.searchParams.services.includes(keyword)) {\n          processedInput.searchParams.services.push(keyword);\n        }\n      }\n    });\n  }\n  \n  // Context'ten gelen severity kontrol√º\n  if (input.context.severity === 'critical') {\n    processedInput.analysisConfig.priority = 'critical';\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n    processedInput.features.enableAutoRemediation = true;\n  } else if (input.context.severity === 'high') {\n    processedInput.analysisConfig.priority = 'high';\n    processedInput.analysisConfig.forceDeepAnalysis = true;\n  }\n}\n\n// 4. FOCUS AREAS - Kubernetes specific\nif (input.focusAreas && Array.isArray(input.focusAreas)) {\n  input.focusAreas.forEach(area => {\n    switch(area) {\n      case 'container_health':\n        processedInput.searchParams.metrics.push(\n          'kube_pod_container_status_restarts_total',\n          'kube_pod_container_status_ready'\n        );\n        break;\n        \n      case 'resource_usage':\n        processedInput.searchParams.metrics.push(\n          'container_memory_usage_bytes',\n          'container_cpu_usage_seconds_total'\n        );\n        break;\n        \n      case 'availability':\n        processedInput.searchParams.metrics.push(\n          'up',\n          'kube_deployment_status_replicas_available'\n        );\n        processedInput.features.sloChecking = true;\n        break;\n        \n      case 'alerts':\n        processedInput.features.includeAlerts = true;\n        processedInput.analysisConfig.priority = 'high';\n        break;\n    }\n  });\n}\n\n// 5. NAMESPACE FILTERING\nif (input.namespaces && Array.isArray(input.namespaces) && input.namespaces.length > 0) {\n  processedInput.searchParams.namespaces = input.namespaces;\n} else {\n  // Default to all production namespaces\n  processedInput.searchParams.namespaces = DEFAULT_NAMESPACES;\n  console.log(`Using DEFAULT_NAMESPACES: ${DEFAULT_NAMESPACES.length} namespaces`);\n}\n\n// 6. BUILD ANALYSIS PARAMETERS for existing flow\nprocessedInput.analysisParams = {\n  cluster: processedInput.searchParams.cluster,\n  environment: 'k8s-prod', // Always use k8s-prod for multi-namespace\n  namespaceFilter: processedInput.searchParams.namespaces.join(',') || 'all',\n  timeRange: processedInput.timeRange.duration,\n  includeAlerts: processedInput.features.includeAlerts,\n  includeKnowledgeBase: processedInput.features.includeKnowledgeBase,\n  enableAutoRemediation: processedInput.features.enableAutoRemediation,\n  maxStages: processedInput.analysisConfig.depth === 'deep' ? 6 : 3,\n  forceDeepAnalysis: processedInput.analysisConfig.forceDeepAnalysis,\n  skipHealthGate: processedInput.analysisConfig.skipHealthGate,\n  analysisDepth: processedInput.analysisConfig.depth,\n  priority: processedInput.analysisConfig.priority  // √ñNEMLƒ∞: priority'yi de ekle\n};\n\n// Debug bilgilerini ekle\nprocessedInput._debug = {\n  originalInput: debugInfo.rawInput,\n  processedAt: debugInfo.processedAt,\n  timeRangeInfo: `From ${processedInput.timeRange.humanReadable.start} to ${processedInput.timeRange.humanReadable.end}`,\n  servicesFound: processedInput.searchParams.services,\n  namespacesFound: processedInput.searchParams.namespaces,\n  metricsToCheck: processedInput.searchParams.metrics,\n  analysisDepth: processedInput.analysisConfig.depth,\n  forceDeepAnalysis: processedInput.analysisConfig.forceDeepAnalysis,\n  priority: processedInput.analysisConfig.priority  // Debug i√ßin priority'yi de ekle\n};\n\nreturn [{ json: processedInput }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3536,
        32
      ],
      "id": "7d031203-66a5-4454-b5c5-609bb53b0b7f",
      "name": "Orchestrator Input Handler"
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `(kubelet_volume_stats_used_bytes{namespace=\"${ns}\", persistentvolumeclaim=~\".*${svc}.*\"} / kubelet_volume_stats_capacity_bytes{namespace=\"${ns}\", persistentvolumeclaim=~\".*${svc}.*\"} > 0.8) * on(namespace, persistentvolumeclaim) group_left(storageclass, volumename) kube_persistentvolumeclaim_info{namespace=\"${ns}\", persistentvolumeclaim=~\".*${svc}.*\"} or kube_persistentvolumeclaim_status_phase{namespace=\"${ns}\", persistentvolumeclaim=~\".*${svc}.*\", phase!=\"Bound\"} == 1`;\n  } else {\n    return `(kubelet_volume_stats_used_bytes{namespace=\"${ns}\"} / kubelet_volume_stats_capacity_bytes{namespace=\"${ns}\"} > 0.8) * on(namespace, persistentvolumeclaim) group_left(storageclass, volumename) kube_persistentvolumeclaim_info{namespace=\"${ns}\"} or kube_persistentvolumeclaim_status_phase{namespace=\"${ns}\", phase!=\"Bound\"} == 1`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        -1744,
        1104
      ],
      "id": "dc8f7ead-f87b-498b-9545-f4b22ab02215",
      "name": "Kubernetes PVC Status"
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || 'etiyamobile-production';\n  const svc = $json.service || '';\n  \n  if (svc) {\n    return `(kube_horizontalpodautoscaler_status_current_replicas{namespace=\"${ns}\", horizontalpodautoscaler=~\".*${svc}.*\"} / kube_horizontalpodautoscaler_spec_max_replicas{namespace=\"${ns}\", horizontalpodautoscaler=~\".*${svc}.*\"}) > 0.9 or kube_horizontalpodautoscaler_status_condition{namespace=\"${ns}\", horizontalpodautoscaler=~\".*${svc}.*\", condition=\"ScalingLimited\", status=\"true\"} == 1`;\n  } else {\n    return `(kube_horizontalpodautoscaler_status_current_replicas{namespace=\"${ns}\"} / kube_horizontalpodautoscaler_spec_max_replicas{namespace=\"${ns}\"}) > 0.9 or (kube_horizontalpodautoscaler_status_current_replicas{namespace=\"${ns}\"} == kube_horizontalpodautoscaler_spec_max_replicas{namespace=\"${ns}\"}) or kube_horizontalpodautoscaler_status_condition{namespace=\"${ns}\", condition=\"ScalingLimited\", status=\"true\"} == 1`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        -1664,
        1200
      ],
      "id": "b8e7cc21-5050-492e-bd6c-6cd0f7e6f7b9",
      "name": "Kubernetes HPA Status"
    },
    {
      "parameters": {
        "jsCode": "// Force Deep Analysis Override - Prometheus Agent - CONTEXT ENHANCED\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage1Result = $input.first().json;\n\n// Unified Entry Point'ten gelen orijinal veriyi al\nconst unifiedData = $node[\"Unified Entry Point\"].json;\n\n// Context'i al - Stage 2 Decision'dan veya Stage 1'den\nlet masterContext = stage1Result._context || {\n  contextId: `ctx-override-${Date.now()}`,\n  createdAt: new Date().toISOString(),\n  stageResults: {},\n  decisions: {},\n  debug: { warnings: ['Context recreated in Force Deep Analysis Override'] }\n};\n\n// forceDeepAnalysis kontrol√º\nconst forceDeepAnalysis = \n  unifiedData.forceDeepAnalysis || \n  unifiedData.priority === 'critical' ||\n  unifiedData.stageConfig?.forceDeepAnalysis ||\n  false;\n\n// Stage 1 sonucunu kopyala\nlet output = { ...stage1Result };\n\n// Override decision'ƒ± context'e kaydet\nconst overrideDecision = {\n  timestamp: new Date().toISOString(),\n  originalDecision: stage1Result.proceed_to_stage2,\n  forceDeepAnalysis: forceDeepAnalysis,\n  overrideApplied: false,\n  reason: null\n};\n\n// Eƒüer forceDeepAnalysis aktif ve Stage 1 proceed_to_stage2=false yapmƒ±≈üsa override et\nif (forceDeepAnalysis && !stage1Result.proceed_to_stage2) {\n  console.log('üî• PROMETHEUS - Force Deep Analysis Override Applied');\n  console.log('Original priority:', unifiedData.priority);\n  console.log('Original decision:', stage1Result.proceed_to_stage2);\n  console.log('Context ID:', masterContext.contextId);\n  \n  output.proceed_to_stage2 = true;\n  output.overridden = true;\n  output.forceDeepAnalysisApplied = true;\n  output.overrideReason = `Deep analysis forced due to ${unifiedData.priority} priority from ${unifiedData.source.type}`;\n  \n  // Override decision'ƒ± g√ºncelle\n  overrideDecision.overrideApplied = true;\n  overrideDecision.reason = output.overrideReason;\n}\n\n// Context'e override decision'ƒ± ekle\nmasterContext.decisions.forceDeepAnalysisOverride = overrideDecision;\n\n// Override node'unun √ßƒ±ktƒ±sƒ±nƒ± context'e kaydet\nmasterContext.stageResults.forceDeepAnalysisOverride = {\n  output: {\n    overrideApplied: overrideDecision.overrideApplied,\n    reason: overrideDecision.reason,\n    originalPriority: unifiedData.priority,\n    originalSource: unifiedData.source\n  },\n  completedAt: new Date().toISOString()\n};\n\n// Orijinal context'i de ta≈üƒ± ve zenginle≈ütir\noutput.originalContext = {\n  source: unifiedData.source,\n  priority: unifiedData.priority,\n  stageConfig: unifiedData.stageConfig,\n  analysisParams: unifiedData.analysisParams\n};\n\n// YENƒ∞: Context'i g√ºncelle ve ta≈üƒ±\noutput._context = masterContext;\n\n// YENƒ∞: Stage 2'ye gidecek veriyi hazƒ±rla\noutput.stage2Input = {\n  proceed: output.proceed_to_stage2,\n  priority: unifiedData.priority,\n  analysisParams: unifiedData.analysisParams,\n  timeRange: {\n    start: unifiedData.analysisParams.startTime,\n    end: unifiedData.analysisParams.endTime\n  },\n  namespaces: unifiedData.analysisParams.namespaces,\n  focusAreas: unifiedData.analysisParams.focusAreas || []\n};\n\n// YENƒ∞: Debug bilgisi\noutput._debug = {\n  nodeType: 'Force Deep Analysis Override',\n  processedAt: new Date().toISOString(),\n  contextId: masterContext.contextId,\n  contextPreserved: true,\n  overrideApplied: overrideDecision.overrideApplied,\n  stageSequence: ['Unified Entry Point', 'Stage 1', 'Stage 2 Decision', 'Force Deep Analysis Override']\n};\n\n// Critical durumlar i√ßin stage config'i g√ºncelle\nif (output.overall_status === 'critical' || output.urgency === 'critical') {\n  console.log('üî• CRITICAL STATUS DETECTED - Updating stage config');\n  \n  if (output._context && output._context.stageConfig) {\n    // √ñnceki deƒüerleri logla\n    console.log('Previous maxStages:', output._context.stageConfig.maxStages);\n    \n    // Stage config'i g√ºncelle\n    output._context.stageConfig.maxStages = 6;\n    output._context.stageConfig.enablePatternAnalysis = true;\n    output._context.stageConfig.enableAnomalyDetection = true;\n    output._context.stageConfig.enablePredictiveAnalysis = true;\n    \n    console.log('Updated maxStages to:', output._context.stageConfig.maxStages);\n    console.log('‚úÖ Stage config updated for critical situation');\n  }\n  \n  // Priority'yi de critical yap\n  if (output._context) {\n    output._context.priority = 'critical';\n    output._context.updatedDueToCriticalStatus = true;\n  }\n}\n\n// Stage 2 input'a da critical bilgisini ekle\nif (output.stage2Input && (output.overall_status === 'critical' || output.urgency === 'critical')) {\n  output.stage2Input.priority = 'critical';\n  output.stage2Input.criticalStatusDetected = true;\n}\n\n// YENI: Stage 1 verilerini koru\noutput.stage1Data = {\n  overall_status: stage1Result.overall_status || stage1Result.stage1Results?.overall_status,\n  alerts: stage1Result.alerts || stage1Result.stage1Results?.alerts,\n  scores: stage1Result.scores || stage1Result.stage1Results?.scores,\n  quick_findings: stage1Result.quick_findings || stage1Result.stage1Results?.quick_findings\n};\n\n// Stage 2 i√ßin namespace ve service filtering hazƒ±rla\nconst namespaces = unifiedData.analysisParams?.namespaces || DEFAULT_NAMESPACES;\nconst services = unifiedData.analysisParams?.services || [];\n\n// Prometheus query i√ßin regex pattern olu≈ütur\nconst namespaceRegex = namespaces.join('|');\nconst serviceRegex = services.length > 0 ? services.join('|') : '.*';\n\n// Ready-to-use query templates for Stage 2\nconst queryHelpers = {\n  namespaceFilter: `namespace=~\"${namespaceRegex}\"`,\n  serviceFilter: services.length > 0 ? `service=~\"${serviceRegex}\"` : 'service!=\"\"',\n  combinedFilter: services.length > 0\n    ? `namespace=~\"${namespaceRegex}\",service=~\"${serviceRegex}\"`\n    : `namespace=~\"${namespaceRegex}\",service!=\"\"`,\n\n  // √ñrnek kullanƒ±ma hazƒ±r sorgular\n  exampleQueries: {\n    podCount: `count by (namespace, service, pod) (up{namespace=~\"${namespaceRegex}\", service!=\"\", pod!=\"\"})`,\n    serviceList: `group by (namespace, service) (up{namespace=~\"${namespaceRegex}\", service!=\"\"})`,\n    alertCount: `ALERTS{namespace=~\"${namespaceRegex}\"}`,\n    cpuUsage: `rate(container_cpu_usage_seconds_total{namespace=~\"${namespaceRegex}\"}[5m])`,\n    memoryUsage: `container_memory_usage_bytes{namespace=~\"${namespaceRegex}\"}`\n  }\n};\n\n// Stage 2'ye gidecek parametreleri root'a ekle\noutput.namespaceRegex = namespaceRegex;\noutput.serviceRegex = serviceRegex;\noutput.queryHelpers = queryHelpers;\noutput.startTime = unifiedData.analysisParams.startTime;\noutput.endTime = unifiedData.analysisParams.endTime;\n\n// Backward compatibility i√ßin eski parametreleri de koru (deprecated)\noutput.namespace = namespaces[0] || DEFAULT_NAMESPACES[0]; // DEPRECATED: Use namespaceRegex instead\noutput.service = services[0] || ''; // DEPRECATED: Use serviceRegex instead\n\n// Stage 2 i√ßin a√ßƒ±k talimatlar\noutput.stage2Instructions = {\n  namespaces: namespaces,\n  services: services,\n  namespaceRegex: namespaceRegex,\n  serviceRegex: serviceRegex,\n  message: services.length > 0\n    ? `Focus on ${services.length} service(s) across ${namespaces.length} namespace(s)`\n    : `General cluster analysis across ${namespaces.length} namespace(s)`\n};\n\nconsole.log('=== Stage 2 Query Parameters ===');\nconsole.log('Namespaces:', namespaces.length, 'namespaces');\nconsole.log('Services:', services.length, 'services');\nconsole.log('Namespace regex:', namespaceRegex);\nconsole.log('Query helpers generated:', Object.keys(queryHelpers));\nconsole.log('================================');\n\nconsole.log('=== Force Deep Analysis Override Complete ===');\nconsole.log('Context preserved:', !!output._context);\nconsole.log('Override applied:', overrideDecision.overrideApplied);\nconsole.log('Next stage will receive full context');\n\nreturn [{ json: output }];"
      },
      "id": "81eb8720-97ca-4bac-9dc7-5abf1c49945c",
      "name": "Force Deep Analysis Override",
      "type": "n8n-nodes-base.code",
      "position": [
        -1856,
        400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Prepare Stage 1 Input - Ensure context is properly passed\nconst unifiedOutput = $input.first().json;\n\nconsole.log(\"=== PREPARING STAGE 1 INPUT ===\");\nconsole.log(\"Context ID:\", unifiedOutput._context?.contextId);\nconsole.log(\"Context exists:\", !!unifiedOutput._context);\nconsole.log(\"Full context:\", JSON.stringify(unifiedOutput._context, null, 2));\n\n// Namespace ve service filtering i√ßin ready-to-use strings hazƒ±rla\nconst namespaces = unifiedOutput._context?.initialParams?.namespaces || [];\nconst services = unifiedOutput._context?.initialParams?.services || [];\n\n// Prometheus query i√ßin regex pattern olu≈ütur\nconst namespaceRegex = namespaces.join('|');\nconst serviceRegex = services.length > 0 ? services.join('|') : '.*';\n\n// Ready-to-use query templates\nconst queryHelpers = {\n  namespaceFilter: `namespace=~\"${namespaceRegex}\"`,\n  serviceFilter: services.length > 0 ? `service=~\"${serviceRegex}\"` : 'service!=\"\"',\n  combinedFilter: services.length > 0\n    ? `namespace=~\"${namespaceRegex}\",service=~\"${serviceRegex}\"`\n    : `namespace=~\"${namespaceRegex}\",service!=\"\"`,\n\n  // √ñrnek kullanƒ±ma hazƒ±r sorgular\n  exampleQueries: {\n    podCount: `count by (namespace, service, pod) (up{namespace=~\"${namespaceRegex}\", service!=\"\", pod!=\"\"})`,\n    serviceList: `group by (namespace, service) (up{namespace=~\"${namespaceRegex}\", service!=\"\"})`,\n    alertCount: `ALERTS{namespace=~\"${namespaceRegex}\"}`\n  }\n};\n\nconsole.log(\"Generated query helpers:\", queryHelpers);\n\n// Stage 1 i√ßin input hazƒ±rla\nconst stage1Input = {\n  ...unifiedOutput,\n  // Context'i root level'a da koy\n  contextId: unifiedOutput._context.contextId,\n  contextData: unifiedOutput._context,\n\n  // Query helpers - AI agent kullanabilsin\n  queryHelpers: queryHelpers,\n  namespaceRegex: namespaceRegex,\n  serviceRegex: serviceRegex,\n\n  // Debug i√ßin\n  _inputPrepared: true,\n  _preparedAt: new Date().toISOString()\n};\n\nconsole.log(\"Stage 1 will receive:\", JSON.stringify(stage1Input, null, 2).substring(0, 500) + \"...\");\nconsole.log(\"==============================\");\n\nreturn [{\n  json: stage1Input\n}];"
      },
      "id": "88594f07-9581-424d-ab1d-416d9765b075",
      "name": "Prepare Stage 1 Input",
      "type": "n8n-nodes-base.code",
      "position": [
        -3040,
        464
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 1 Context - Correct the context after AI Agent output\nconst stage1Output = $input.first().json;\nconst unifiedData = $node[\"Unified Entry Point\"].json;\nconst preparedData = $node[\"Prepare Stage 1 Input\"].json;\n\nconsole.log(\"=== FIXING STAGE 1 CONTEXT ===\");\nconsole.log(\"Stage 1 output structure:\", stage1Output.output ? \"Has output wrapper\" : \"Direct output\");\nconsole.log(\"Expected context ID:\", unifiedData._context.contextId);\n\n// Deep copy to avoid mutations\nlet fixedOutput = JSON.parse(JSON.stringify(stage1Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\n// Context'i kontrol et ve d√ºzelt\nif (actualOutput._context) {\n  const contextString = JSON.stringify(actualOutput._context);\n  const hasTemplates = contextString.includes(\"{{\") || contextString.includes(\"}}\");\n  const hasJsonReference = contextString.includes(\"$json\");\n  \n  console.log(\"Context has templates:\", hasTemplates);\n  console.log(\"Context has $json references:\", hasJsonReference);\n  \n  if (hasTemplates || hasJsonReference || \n      !actualOutput._context.contextId || \n      actualOutput._context.contextId === \"{{ $json.contextId }}\" ||\n      actualOutput._context.contextId === \"12345\" ||\n      actualOutput._context.contextId === \"abc-123\") {\n    \n    console.log(\"‚ùå Invalid context detected, fixing...\");\n    \n    // Doƒüru context'i koy - deep copy ile\n    actualOutput._context = JSON.parse(JSON.stringify(unifiedData._context));\n    \n    console.log(\"‚úÖ Context replaced with correct one\");\n  }\n} else {\n  console.log(\"‚ùå No context found, adding...\");\n  actualOutput._context = JSON.parse(JSON.stringify(unifiedData._context));\n}\n\n// Debug'ƒ± da d√ºzelt\nif (actualOutput._debug) {\n  const debugString = JSON.stringify(actualOutput._debug);\n  if (debugString.includes(\"{{\") || debugString.includes(\"$json\") || \n      actualOutput._debug.contextId !== unifiedData._context.contextId) {\n    \n    actualOutput._debug.contextId = unifiedData._context.contextId;\n    actualOutput._debug.contextFixed = true;\n    actualOutput._debug.fixedAt = new Date().toISOString();\n    actualOutput._debug.receivedFromSource = unifiedData.source.type;\n    actualOutput._debug.priority = unifiedData.priority;\n  }\n}\n\n// Context'i ba≈ülat\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Stage 1 sonu√ßlarƒ±nƒ± context'e kaydet - sadece bu stage'in verisi\nactualOutput._context.stageResults.stage1 = {\n  output: {\n    overall_status: actualOutput.overall_status,\n    alerts: actualOutput.alerts,\n    scores: actualOutput.scores,\n    quick_findings: actualOutput.quick_findings,\n    services_analyzed: actualOutput.services_analyzed,\n    services_count: actualOutput.services_count,\n    namespaces_analyzed: actualOutput.namespaces_analyzed,\n    proceed_to_stage2: actualOutput.proceed_to_stage2,\n    urgency: actualOutput.urgency,\n    reason: actualOutput.reason,\n    forceDeepAnalysis: actualOutput.forceDeepAnalysis,\n    overridden: actualOutput.overridden\n  },\n  completedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  decision: actualOutput.proceed_to_stage2,\n  status: actualOutput.overall_status,\n  alerts: actualOutput.alerts?.total || 0\n};\n\n// Root level'a context bilgilerini ekle\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = unifiedData._context.contextId;\nfixedOutput._contextFixed = true;\nfixedOutput._fixedAt = new Date().toISOString();\n\n// Stage 1 verilerini root'a ekle (kolay eri≈üim i√ßin)\nfixedOutput.stage1Data = {\n  overall_status: actualOutput.overall_status,\n  alerts: JSON.parse(JSON.stringify(actualOutput.alerts)),\n  scores: JSON.parse(JSON.stringify(actualOutput.scores)),\n  quick_findings: JSON.parse(JSON.stringify(actualOutput.quick_findings)),\n  services_analyzed: JSON.parse(JSON.stringify(actualOutput.services_analyzed || [])),\n  services_count: actualOutput.services_count || 0,\n  namespaces_analyzed: JSON.parse(JSON.stringify(actualOutput.namespaces_analyzed || [])),\n  proceed_to_stage2: actualOutput.proceed_to_stage2,\n  urgency: actualOutput.urgency,\n  reason: actualOutput.reason\n};\n\n// Validation\nconst contextFixed = actualOutput._context?.contextId === unifiedData._context.contextId;\nconst rootContextFixed = fixedOutput._context?.contextId === unifiedData._context.contextId;\n\nconsole.log(\"==============================\");\nconsole.log(\"Stage 1 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Proceed to stage 2:\", actualOutput.proceed_to_stage2);\nconsole.log(\"- Overall status:\", actualOutput.overall_status);\nconsole.log(\"- Total alerts:\", actualOutput.alerts?.total);\nconsole.log(\"- Context fixed:\", contextFixed && rootContextFixed);\n\nif (contextFixed && rootContextFixed) {\n  console.log(\"‚úÖ Context successfully fixed in both locations!\");\n} else {\n  console.error(\"‚ö†Ô∏è Context fix validation failed!\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n  fromNode: \"Fix Stage 1 Context\",\n  contextFixed: true,\n  originalHadTemplates: JSON.stringify(stage1Output).includes(\"{{\"),\n  stage1Decision: actualOutput.proceed_to_stage2,\n  stage1Status: actualOutput.overall_status,\n  stage1Alerts: actualOutput.alerts?.total,\n  timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if it existed\nif (hasOutputWrapper) {\n  fixedOutput.output = actualOutput;\n}\n\nreturn [{\n  json: fixedOutput\n}];"
      },
      "id": "fd779975-1d4d-475f-bac5-be7cb1dd0eba",
      "name": "Fix Stage 1 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        -2512,
        544
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 2 Context - Circular Reference Safe Version\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage2Output = $input.first().json;\nconst previousData = $node[\"Force Deep Analysis Override\"].json;\nconst stage1FixData = $node[\"Fix Stage 1 Context\"].json;\n\nconsole.log(\"=== FIXING STAGE 2 CONTEXT ===\");\nconsole.log(\"Stage 2 output received\");\n\n// Helper function - Safe JSON stringify to handle circular references\nfunction safeStringify(obj) {\n  const seen = new WeakSet();\n  return JSON.stringify(obj, (key, value) => {\n    if (typeof value === \"object\" && value !== null) {\n      if (seen.has(value)) {\n        return \"[Circular]\";\n      }\n      seen.add(value);\n    }\n    return value;\n  });\n}\n\n// Helper function - Safe parse\nfunction safeParse(str) {\n  return JSON.parse(str, (key, value) => {\n    if (value === \"[Circular]\") {\n      return null;\n    }\n    return value;\n  });\n}\n\n// Deep copy with circular reference handling\nlet fixedOutput = safeParse(safeStringify(stage2Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\n// Get expected context ID safely\nconst expectedContextId = previousData?._context?.contextId || `ctx-${Date.now()}`;\nconsole.log(\"Expected context ID:\", expectedContextId);\n\n// Context kontrol√º ve d√ºzeltme\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId ||\n    actualOutput._context.contextId === \"abc123\" || \n    actualOutput._context.contextId === \"12345\") {\n    \n    console.log(\"‚ùå Invalid or missing context in Stage 2, fixing...\");\n    \n    // Create a clean context copy\n    actualOutput._context = {\n      contextId: expectedContextId,\n      createdAt: previousData._context?.createdAt || new Date().toISOString(),\n      source: previousData._context?.source || {},\n      initialParams: previousData._context?.initialParams || {},\n      stageConfig: previousData._context?.stageConfig || {},\n      priority: previousData._context?.priority || \"normal\",\n      forceDeepAnalysis: previousData._context?.forceDeepAnalysis || false,\n      workflowMetadata: previousData._context?.workflowMetadata || {},\n      stageResults: {},\n      decisions: previousData._context?.decisions || {},\n      debug: previousData._context?.debug || {}\n    };\n    \n    console.log(\"‚úÖ Context replaced with clean copy\");\n}\n\n// Initialize stageResults if needed\nif (!actualOutput._context.stageResults) {\n    actualOutput._context.stageResults = {};\n}\n\n// Add Stage 1 results if available (from previous context)\nif (previousData._context?.stageResults?.stage1) {\n    actualOutput._context.stageResults.stage1 = {\n        output: {\n            overall_status: previousData._context.stageResults.stage1.output?.overall_status,\n            alerts: previousData._context.stageResults.stage1.output?.alerts,\n            scores: previousData._context.stageResults.stage1.output?.scores,\n            quick_findings: previousData._context.stageResults.stage1.output?.quick_findings,\n            proceed_to_stage2: previousData._context.stageResults.stage1.output?.proceed_to_stage2\n        },\n        completedAt: previousData._context.stageResults.stage1.completedAt,\n        decision: previousData._context.stageResults.stage1.decision\n    };\n}\n\n// Add Stage 2 results - clean copy only\nactualOutput._context.stageResults.stage2 = {\n    output: {\n        investigation_id: actualOutput.investigation_id,\n        triggered_by: actualOutput.triggered_by,\n        execution_phases: {\n            instant: actualOutput.execution_phases?.instant || {},\n            trend: actualOutput.execution_phases?.trend || {},\n            anomaly: actualOutput.execution_phases?.anomaly || {}\n        },\n        correlation_matrix: {\n            primary_chain: actualOutput.correlation_matrix?.primary_chain || \"\",\n            affected_services: actualOutput.correlation_matrix?.affected_services || [],\n            blast_radius: actualOutput.correlation_matrix?.blast_radius || \"\",\n            kubernetes_impact: actualOutput.correlation_matrix?.kubernetes_impact || {}\n        },\n        root_cause: {\n            identified: actualOutput.root_cause?.identified || false,\n            component: actualOutput.root_cause?.component || \"\",\n            issue: actualOutput.root_cause?.issue || \"\",\n            evidence: actualOutput.root_cause?.evidence || [],\n            confidence: actualOutput.root_cause?.confidence || 0\n        },\n        proceed_to_stage3: actualOutput.proceed_to_stage3,\n        alert_correlation_needed: actualOutput.alert_correlation_needed\n    },\n    completedAt: new Date().toISOString(),\n    decision: actualOutput.proceed_to_stage3,\n    rootCauseIdentified: actualOutput.root_cause?.identified || false,\n    confidence: actualOutput.root_cause?.confidence || 0\n};\n\n// Update debug info\nactualOutput._debug = {\n    nodeType: \"Stage 2: Deep Analysis\",\n    processedAt: new Date().toISOString(),\n    contextId: expectedContextId,\n    contextPreserved: true,\n    receivedFromStage: \"Force Deep Analysis Override\",\n    priority: previousData._context?.priority || \"normal\",\n    stageSequence: [\n        \"Unified Entry Point\",\n        \"Stage 1: Health Snapshot\", \n        \"Fix Stage 1 Context\",\n        \"Stage 2 Decision\",\n        \"Force Deep Analysis Override\",\n        \"Wait 3s\",\n        \"Stage 2: Deep Analysis\",\n        \"Fix Stage 2 Context\"\n    ],\n    timeRangeUsed: {\n        start: previousData._context?.initialParams?.startTime || 0,\n        end: previousData._context?.initialParams?.endTime || 0\n    }\n};\n\n// Create clean root level context\nfixedOutput._context = {\n    contextId: expectedContextId,\n    createdAt: actualOutput._context.createdAt,\n    source: actualOutput._context.source,\n    initialParams: actualOutput._context.initialParams,\n    stageConfig: actualOutput._context.stageConfig,\n    priority: actualOutput._context.priority,\n    forceDeepAnalysis: actualOutput._context.forceDeepAnalysis,\n    workflowMetadata: actualOutput._context.workflowMetadata,\n    stageResults: actualOutput._context.stageResults,\n    decisions: actualOutput._context.decisions,\n    debug: actualOutput._context.debug\n};\n\nfixedOutput.contextId = expectedContextId;\n\n// Get Stage 1 data from previous nodes\nlet stage1Data = null;\n\n// Try to get from previousData first\nif (previousData.stage1Data) {\n    stage1Data = {\n        overall_status: previousData.stage1Data.overall_status,\n        alerts: previousData.stage1Data.alerts,\n        scores: previousData.stage1Data.scores,\n        quick_findings: previousData.stage1Data.quick_findings || [],\n        services_analyzed: previousData.stage1Data.services_analyzed || [],\n        services_count: previousData.stage1Data.services_count || 0,\n        namespaces_analyzed: previousData.stage1Data.namespaces_analyzed || [],\n        proceed_to_stage2: previousData.stage1Data.proceed_to_stage2,\n        urgency: previousData.stage1Data.urgency,\n        reason: previousData.stage1Data.reason\n    };\n    console.log(\"‚úì Stage 1 data found in previousData.stage1Data\");\n} else if (stage1FixData?.stage1Data) {\n    stage1Data = {\n        overall_status: stage1FixData.stage1Data.overall_status,\n        alerts: stage1FixData.stage1Data.alerts,\n        scores: stage1FixData.stage1Data.scores,\n        quick_findings: stage1FixData.stage1Data.quick_findings || [],\n        services_analyzed: stage1FixData.stage1Data.services_analyzed || [],\n        services_count: stage1FixData.stage1Data.services_count || 0,\n        namespaces_analyzed: stage1FixData.stage1Data.namespaces_analyzed || [],\n        proceed_to_stage2: stage1FixData.stage1Data.proceed_to_stage2,\n        urgency: stage1FixData.stage1Data.urgency,\n        reason: stage1FixData.stage1Data.reason\n    };\n    console.log(\"‚úì Stage 1 data found in Fix Stage 1 Context\");\n} else if (actualOutput._context?.stageResults?.stage1?.output) {\n    const s1Output = actualOutput._context.stageResults.stage1.output;\n    stage1Data = {\n        overall_status: s1Output.overall_status,\n        alerts: s1Output.alerts,\n        scores: s1Output.scores,\n        quick_findings: s1Output.quick_findings || [],\n        services_analyzed: s1Output.services_analyzed || [],\n        services_count: s1Output.services_count || 0,\n        namespaces_analyzed: s1Output.namespaces_analyzed || [],\n        proceed_to_stage2: s1Output.proceed_to_stage2,\n        urgency: s1Output.urgency,\n        reason: s1Output.reason\n    };\n    console.log(\"‚úì Stage 1 data extracted from context.stageResults\");\n}\n\n// Add Stage 1 data to output\nif (stage1Data) {\n    fixedOutput.stage1Data = stage1Data;\n    console.log(\"‚úÖ Stage 1 data successfully attached\");\n} else {\n    console.warn(\"‚ö†Ô∏è No Stage 1 data found - creating minimal structure\");\n    fixedOutput.stage1Data = {\n        overall_status: \"unknown\",\n        alerts: { total: 0, critical: 0, warning: 0 },\n        scores: {},\n        quick_findings: [],\n        services_analyzed: [],\n        services_count: 0,\n        namespaces_analyzed: []\n    };\n}\n\n// Add Stage 2 data to output - clean copy\nfixedOutput.stage2Data = {\n    investigation_id: actualOutput.investigation_id,\n    root_cause: {\n        identified: actualOutput.root_cause?.identified || false,\n        component: actualOutput.root_cause?.component || \"\",\n        issue: actualOutput.root_cause?.issue || \"\",\n        evidence: actualOutput.root_cause?.evidence || [],\n        confidence: actualOutput.root_cause?.confidence || 0\n    },\n    correlation_matrix: {\n        primary_chain: actualOutput.correlation_matrix?.primary_chain || \"\",\n        affected_services: actualOutput.correlation_matrix?.affected_services || [],\n        blast_radius: actualOutput.correlation_matrix?.blast_radius || \"\",\n        kubernetes_impact: actualOutput.correlation_matrix?.kubernetes_impact || {}\n    },\n    critical_pods: actualOutput.execution_phases?.instant?.findings?.critical_pods || [],\n    affected_services: actualOutput.correlation_matrix?.affected_services || [],\n    proceed_to_stage3: actualOutput.proceed_to_stage3,\n    alert_correlation_needed: actualOutput.alert_correlation_needed,\n    confidence: actualOutput.root_cause?.confidence || 0\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n    actualOutput._context.decisions = {};\n}\n\nactualOutput._context.decisions.stage3Proceed = {\n    timestamp: new Date().toISOString(),\n    shouldProceed: actualOutput.proceed_to_stage3,\n    alertCorrelationNeeded: actualOutput.alert_correlation_needed,\n    rootCauseIdentified: actualOutput.root_cause?.identified || false,\n    confidence: actualOutput.root_cause?.confidence || 0\n};\n\n// Add namespace and time range info\nfixedOutput.namespaces = previousData._context?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n    start: previousData._context?.initialParams?.startTime || 0,\n    end: previousData._context?.initialParams?.endTime || 0\n};\n\n// Summary logging\nconsole.log(\"==============================\");\nconsole.log(\"Stage 2 Fix Summary:\");\nconsole.log(\"- Context ID:\", expectedContextId);\nconsole.log(\"- Stage 1 data included:\", !!fixedOutput.stage1Data);\nconsole.log(\"- Stage 2 data prepared:\", !!fixedOutput.stage2Data);\nconsole.log(\"- Root cause identified:\", actualOutput.root_cause?.identified);\nconsole.log(\"- Proceed to Stage 3:\", actualOutput.proceed_to_stage3);\n\n// Validation\nconst validationPassed = \n    fixedOutput._context?.contextId === expectedContextId &&\n    !!fixedOutput.stage1Data &&\n    !!fixedOutput.stage2Data;\n\nif (validationPassed) {\n    console.log(\"‚úÖ Stage 2 context successfully fixed and validated!\");\n} else {\n    console.error(\"‚ö†Ô∏è Stage 2 validation warnings\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n    fromNode: \"Fix Stage 2 Context\",\n    contextFixed: true,\n    validationPassed: validationPassed,\n    stage1DataSource: stage1Data ? \"found\" : \"created\",\n    stage2RootCause: actualOutput.root_cause?.issue,\n    stage2Decision: actualOutput.proceed_to_stage3,\n    timestamp: new Date().toISOString()\n};\n\n// Clean output wrapper if needed\nif (hasOutputWrapper) {\n    // Don't include the nested output to avoid circular reference\n    fixedOutput.outputProcessed = true;\n}\n\nreturn [{\n    json: fixedOutput\n}];"
      },
      "id": "c3fb6b2a-0841-4acf-8db9-6b05b63534b7",
      "name": "Fix Stage 2 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        -1776,
        576
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 3 Context - Optimized without circular references\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage3Output = $input.first().json;\n\n// Stage 2'den gelen context ve data'yƒ± al\nconst stage2Data = $node[\"Fix Stage 2 Context\"].json;\nconst previousContext = stage2Data._context;\n\nconsole.log(\"=== FIXING STAGE 3 CONTEXT ===\");\nconsole.log(\"Previous context ID:\", previousContext?.contextId);\n\n// Deep copy\nlet fixedOutput = JSON.parse(JSON.stringify(stage3Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\nconsole.log(\"Has output wrapper:\", hasOutputWrapper);\n\n// ============= SLO DEƒûERLERINI D√úZELT =============\nif (actualOutput.slo_impact) {\n  if (actualOutput.slo_impact.availability_slo) {\n    const slo = actualOutput.slo_impact.availability_slo;\n    \n    if (!slo.current || slo.current === \"NaN%\" || slo.current === \"null%\" || slo.current === \"undefined%\") {\n      slo.current = \"100%\";\n    }\n    \n    if (!slo.error_budget_used || slo.error_budget_used === \"NaN%\" || slo.error_budget_used === \"null%\") {\n      slo.error_budget_used = \"0%\";\n    }\n    \n    if (!slo.time_remaining || slo.time_remaining === \"null\" || slo.time_remaining === \"undefined\") {\n      slo.time_remaining = \"30d\";\n    }\n    \n    if (!slo.status || ![\"green\", \"yellow\", \"red\"].includes(slo.status)) {\n      const currentValue = parseFloat(slo.current);\n      if (currentValue >= 99.9) {\n        slo.status = \"green\";\n      } else if (currentValue >= 99.0) {\n        slo.status = \"yellow\";\n      } else {\n        slo.status = \"red\";\n      }\n    }\n    \n    if (!slo.components) {\n      slo.components = { deployment_health: \"100%\" };\n    }\n  }\n  \n  if (!Array.isArray(actualOutput.slo_impact.affected_slis)) {\n    actualOutput.slo_impact.affected_slis = [];\n  }\n}\n\n// ============= ALERT KB ENRICHMENT =============\nlet alertKB = [];\nlet severityScores = {\n  \"Blocker\": 100,\n  \"Critical\": 80,\n  \"High\": 60,\n  \"Medium\": 40,\n  \"Low\": 20\n};\n\n// Load Alert Knowledge Base if available\ntry {\n  const alertKBNode = $node[\"Load Alert Knowledge Base\"];\n  if (alertKBNode?.json?._alertKBData) {\n    alertKB = alertKBNode.json._alertKBData;\n    if (alertKBNode.json._severityScores) {\n      severityScores = alertKBNode.json._severityScores;\n    }\n    console.log(\"Alert KB loaded:\", alertKB.length, \"entries\");\n  }\n} catch (e) {\n  console.log(\"Alert KB not available, using empty KB\");\n}\n\n// Helper functions\nfunction enrichAlertWithKB(alert, alertKB) {\n  const kbEntry = alertKB.find(kb => {\n    if (kb.alertName === alert.name) return true;\n    if (alert.name && kb.alertName && alert.name.includes(kb.alertName)) return true;\n    if (alert.name && kb.alertName && kb.alertName.includes(alert.name)) return true;\n    return false;\n  });\n  \n  if (kbEntry) {\n    return {\n      ...alert,\n      kb_enriched: true,\n      kb_severity: kbEntry.severity,\n      kb_description: kbEntry.description,\n      kb_root_causes: kbEntry.rootCauses,\n      kb_diagnostic_commands: kbEntry.diagnosticCommands,\n      kb_immediate_actions: kbEntry.immediateActions,\n      severity_score: severityScores[kbEntry.severity] || 50,\n      severity: alert.severity || kbEntry.severity\n    };\n  }\n  \n  return {\n    ...alert,\n    kb_enriched: false,\n    severity_score: severityScores[alert.severity] || 30\n  };\n}\n\nfunction calculateServiceImpact(alertName, severity) {\n  let impactMultiplier = 1;\n  \n  if (alertName.includes('etcd')) {\n    impactMultiplier = 2;\n  } else if (alertName.includes('KubeAPI') || alertName.includes('APIServer')) {\n    impactMultiplier = 1.5;\n  } else if (alertName.includes('KubeController') || alertName.includes('KubeScheduler')) {\n    impactMultiplier = 1.4;\n  } else if (alertName.includes('Node')) {\n    impactMultiplier = 1.3;\n  } else if (alertName.includes('Pod') || alertName.includes('Container')) {\n    impactMultiplier = 0.8;\n  }\n  \n  const baseScore = severityScores[severity] || 50;\n  return Math.round(baseScore * impactMultiplier);\n}\n\n// Process alerts\nif (!Array.isArray(actualOutput.active_alerts)) {\n  actualOutput.active_alerts = [];\n} else {\n  actualOutput.active_alerts = actualOutput.active_alerts.map(alert => {\n    const validatedAlert = {\n      name: alert.name || \"Unknown Alert\",\n      severity: alert.severity || \"unknown\",\n      count: typeof alert.count === 'number' ? alert.count : 0,\n      duration: alert.duration || \"unknown\",\n      labels: alert.labels || {},\n      annotations: alert.annotations || {}\n    };\n    \n    const enrichedAlert = enrichAlertWithKB(validatedAlert, alertKB);\n    enrichedAlert.impact_score = calculateServiceImpact(\n      enrichedAlert.name, \n      enrichedAlert.kb_severity || enrichedAlert.severity\n    );\n    \n    return enrichedAlert;\n  });\n  \n  actualOutput.active_alerts.sort((a, b) => b.impact_score - a.impact_score);\n}\n\nconsole.log(\"=== ALERT ENRICHMENT COMPLETE ===\");\nconsole.log(\"Enriched alerts:\", actualOutput.active_alerts.filter(a => a.kb_enriched).length);\n\n// Process alert groups\nif (!Array.isArray(actualOutput.alert_groups)) {\n  actualOutput.alert_groups = [];\n}\n\n// Knowledge base matches\nactualOutput.knowledge_base_matches = actualOutput.active_alerts\n  .filter(alert => alert.kb_enriched)\n  .map(alert => ({\n    alert: alert.name,\n    kb_entry: {\n      severity: alert.kb_severity,\n      description: alert.kb_description,\n      root_causes: alert.kb_root_causes || [],\n      diagnostic_commands: alert.kb_diagnostic_commands || [],\n      immediate_actions: alert.kb_immediate_actions || [],\n      long_term_solutions: alert.kb_long_term_solutions || []\n    },\n    applicability_score: 0.9,\n    impact_score: alert.impact_score\n  }));\n\n// Alert patterns\nif (!actualOutput.alert_patterns) {\n  actualOutput.alert_patterns = {\n    recurring: [],\n    storm_detection: {\n      detected: false,\n      alert_count: 0,\n      time_window: \"5m\",\n      likely_root: null\n    }\n  };\n}\n\n// Recommended actions\nif (!Array.isArray(actualOutput.recommended_alert_actions)) {\n  actualOutput.recommended_alert_actions = [];\n}\n\n// Boolean fields\nif (typeof actualOutput.proceed_to_stage4 !== 'boolean') {\n  actualOutput.proceed_to_stage4 = actualOutput.active_alerts?.length > 0 ||\n    actualOutput.active_alerts?.some(a => \n      a.kb_severity === \"Critical\" || a.kb_severity === \"Blocker\"\n    );\n}\n\nif (typeof actualOutput.auto_remediation_approved !== 'boolean') {\n  actualOutput.auto_remediation_approved = \n    actualOutput.active_alerts.every(alert => \n      !alert.kb_severity || \n      alert.kb_severity === \"Low\" || \n      alert.kb_severity === \"Medium\"\n    );\n}\n\n// ============= CONTEXT FIX =============\nconst expectedContextId = previousContext?.contextId;\n\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId ||\n    actualOutput._context.contextId === \"abc123\") {\n    \n  console.log(\"‚ùå Invalid or missing context, fixing...\");\n  \n  // Deep copy of previous context\n  const contextCopy = JSON.parse(JSON.stringify(previousContext));\n  \n  // Preserve existing stage results if any\n  if (contextCopy.stageResults) {\n    // Keep stage 1 and 2 results\n  } else {\n    contextCopy.stageResults = {};\n  }\n  \n  actualOutput._context = contextCopy;\n  console.log(\"‚úÖ Context replaced\");\n}\n\n// Ensure stageResults exists\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Add Stage 3 results - only this stage's data\nactualOutput._context.stageResults.stage3 = {\n  output: {\n    active_alerts: JSON.parse(JSON.stringify(actualOutput.active_alerts)),\n    alert_groups: JSON.parse(JSON.stringify(actualOutput.alert_groups)),\n    knowledge_base_matches: JSON.parse(JSON.stringify(actualOutput.knowledge_base_matches)),\n    alert_patterns: JSON.parse(JSON.stringify(actualOutput.alert_patterns)),\n    slo_impact: JSON.parse(JSON.stringify(actualOutput.slo_impact)),\n    recommended_alert_actions: JSON.parse(JSON.stringify(actualOutput.recommended_alert_actions)),\n    proceed_to_stage4: actualOutput.proceed_to_stage4,\n    auto_remediation_approved: actualOutput.auto_remediation_approved\n  },\n  completedAt: new Date().toISOString(),\n  decision: actualOutput.proceed_to_stage4\n};\n\n// Update debug info\nactualOutput._debug = {\n  nodeType: \"Stage 3: Alert Intelligence\",\n  processedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  contextId: expectedContextId,\n  contextPreserved: true,\n  receivedFromStage: \"Fix Stage 2 Context\",\n  priority: previousContext?.priority || \"normal\",\n  sloToolErrors: actualOutput._debug?.sloToolErrors || [],\n  stageSequence: [\n    \"Unified Entry Point\",\n    \"Stage 1: Health Snapshot\", \n    \"Fix Stage 1 Context\",\n    \"Stage 2 Decision\",\n    \"Force Deep Analysis Override\",\n    \"Wait 3s\",\n    \"Stage 2: Deep Analysis\",\n    \"Fix Stage 2 Context\",\n    \"Stage 3: Alert Intelligence\",\n    \"Fix Stage 3 Context\"\n  ],\n  timeRangeUsed: {\n    start: previousContext?.initialParams?.startTime || 0,\n    end: previousContext?.initialParams?.endTime || 0\n  }\n};\n\n// Update root level context\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = expectedContextId;\n\n// Stage 3 summary data\nfixedOutput.stage3Data = {\n  active_alerts: JSON.parse(JSON.stringify(actualOutput.active_alerts || [])),\n  alert_groups: JSON.parse(JSON.stringify(actualOutput.alert_groups || [])),\n  knowledge_base_matches: JSON.parse(JSON.stringify(actualOutput.knowledge_base_matches || [])),\n  slo_impact: JSON.parse(JSON.stringify(actualOutput.slo_impact || {})),\n  recommended_actions: JSON.parse(JSON.stringify(actualOutput.recommended_alert_actions || [])),\n  auto_remediation_approved: actualOutput.auto_remediation_approved || false,\n  proceed_to_stage4: actualOutput.proceed_to_stage4 || false,\n  kb_enriched_count: actualOutput.active_alerts?.filter(a => a.kb_enriched).length || 0\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n  actualOutput._context.decisions = previousContext?.decisions || {};\n}\n\nactualOutput._context.decisions.stage4Proceed = {\n  timestamp: new Date().toISOString(),\n  shouldProceed: actualOutput.proceed_to_stage4,\n  autoRemediationApproved: actualOutput.auto_remediation_approved,\n  alertCount: actualOutput.active_alerts?.length || 0,\n  sloImpact: actualOutput.slo_impact?.availability_slo?.current || \"100%\"\n};\n\n// Preserve previous stage data\nif (stage2Data?.stage1Data) {\n  fixedOutput.stage1Data = JSON.parse(JSON.stringify(stage2Data.stage1Data));\n  console.log(\"‚úÖ Stage 1 data preserved\");\n}\n\nif (stage2Data?.stage2Data) {\n  fixedOutput.stage2Data = JSON.parse(JSON.stringify(stage2Data.stage2Data));\n  console.log(\"‚úÖ Stage 2 data preserved\");\n}\n\n// Prepare data for Stage 4\nfixedOutput.stage4PrepData = {\n  rootCause: fixedOutput.stage2Data?.root_cause || {},\n  affectedServices: fixedOutput.stage2Data?.affected_services || [],\n  criticalPods: fixedOutput.stage2Data?.critical_pods || [],\n  primaryAlert: actualOutput.active_alerts?.[0] || null,\n  kbMatches: actualOutput.knowledge_base_matches || [],\n  contextId: expectedContextId\n};\n\n// Namespaces and time range\nfixedOutput.namespaces = previousContext?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n  start: previousContext?.initialParams?.startTime || 0,\n  end: previousContext?.initialParams?.endTime || 0\n};\n\n// Summary logging\nconsole.log(\"==============================\");\nconsole.log(\"Stage 3 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Active alerts:\", actualOutput.active_alerts?.length);\nconsole.log(\"- KB enriched:\", fixedOutput.stage3Data?.kb_enriched_count);\nconsole.log(\"- Proceed to Stage 4:\", actualOutput.proceed_to_stage4);\nconsole.log(\"- Previous stage data preserved:\", !!(fixedOutput.stage1Data && fixedOutput.stage2Data));\n\n// Validation\nconst validationPassed = \n  actualOutput._context?.contextId === expectedContextId &&\n  !!fixedOutput.stage1Data &&\n  !!fixedOutput.stage2Data &&\n  !!fixedOutput.stage3Data;\n\nif (validationPassed) {\n  console.log(\"‚úÖ Stage 3 context successfully fixed and validated!\");\n} else {\n  console.error(\"‚ö†Ô∏è Stage 3 validation warnings\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n  fromNode: \"Fix Stage 3 Context\",\n  contextFixed: true,\n  validationPassed: validationPassed,\n  stage3AlertCount: actualOutput.active_alerts?.length || 0,\n  stage3Decision: actualOutput.proceed_to_stage4,\n  allStagesDataPresent: !!(fixedOutput.stage1Data && fixedOutput.stage2Data && fixedOutput.stage3Data),\n  timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if needed\nif (hasOutputWrapper) {\n  fixedOutput.output = actualOutput;\n}\n\nreturn [{\n  json: fixedOutput\n}];"
      },
      "id": "da1a43bc-8e0e-4172-980c-53a6c3b50caa",
      "name": "Fix Stage 3 Context1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1312,
        576
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 4 Context - Optimized without circular reference removal\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage4Output = $input.first().json;\n\n// Stage 3'ten gelen context'i al\nlet stage3Data;\nlet previousContext;\n\ntry {\n  stage3Data = $node[\"Fix Stage 3 Context1\"].json;\n  previousContext = stage3Data._context;\n  \n  console.log(\"‚úÖ Got context from Stage 3:\", previousContext?.contextId);\n  console.log(\"Stage 1 data available:\", !!stage3Data.stage1Data);\n  console.log(\"Stage 2 data available:\", !!stage3Data.stage2Data);\n  console.log(\"Stage 3 data available:\", !!stage3Data.stage3Data);\n} catch (e) {\n  console.error(\"‚ùå Error getting Stage 3 data:\", e);\n  previousContext = stage4Output._context || {\n    contextId: \"ctx-emergency-\" + Date.now()\n  };\n}\n\nconsole.log(\"=== FIXING STAGE 4 CONTEXT ===\");\nconsole.log(\"Previous context ID:\", previousContext?.contextId);\n\n// Deep copy\nlet fixedOutput = JSON.parse(JSON.stringify(stage4Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nconst actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\nconsole.log(\"Has output wrapper:\", hasOutputWrapper);\n\n// ============= MOCK DATA DETECTION VE TEMƒ∞ZLEME =============\nif (actualOutput.diagnostics_executed && actualOutput.diagnostics_executed.length > 0) {\n  const diagnostic = actualOutput.diagnostics_executed[0];\n  \n  if (diagnostic.target && \n      (diagnostic.target.includes('payment-service') || \n       diagnostic.target === 'pod-abc123' ||\n       diagnostic.target.includes('user-auth-service'))) {\n    \n    console.warn(\"‚ö†Ô∏è MOCK DATA DETECTED! Replacing with actual data...\");\n    \n    const actualRootCause = stage3Data?.stage2Data?.root_cause || {};\n    const actualAffectedServices = stage3Data?.stage2Data?.affected_services || [];\n    const criticalPods = stage3Data?.stage2Data?.critical_pods || [];\n    \n    let actualTarget = criticalPods[0] || actualRootCause.component || \"unknown-pod\";\n    \n    if (typeof actualTarget === 'object' && actualTarget.name) {\n      actualTarget = actualTarget.name;\n    }\n    \n    const actualNamespace = stage3Data?.namespaces?.[0] ||\n                           previousContext?.initialParams?.namespaces?.[0] ||\n                           DEFAULT_NAMESPACES[0];\n    \n    actualOutput.diagnostics_executed = [{\n      target: actualTarget,\n      type: \"pod\",\n      commands_run: [\n        `kubectl get pod ${actualTarget} -n ${actualNamespace} -o json`,\n        `kubectl logs ${actualTarget} -n ${actualNamespace} --since=1h`,\n        `kubectl describe pod ${actualTarget} -n ${actualNamespace}`,\n        `kubectl top pod ${actualTarget} -n ${actualNamespace}`,\n        `kubectl get events -n ${actualNamespace} --field-selector involvedObject.name=${actualTarget}`\n      ],\n      findings: {\n        pod_status: {\n          phase: actualRootCause.issue?.includes('CrashLoopBackOff') ? 'CrashLoopBackOff' : \n                 actualRootCause.issue?.includes('restart') ? 'Running' : 'Unknown',\n          restart_count: parseInt(actualRootCause.evidence?.[1]?.match(/\\d+/)?.[0]) || 5,\n          last_termination: {\n            reason: actualRootCause.issue?.includes('OOM') ? 'OOMKilled' : \n                   actualRootCause.issue?.includes('CrashLoopBackOff') ? 'Error' : 'Unknown',\n            exit_code: actualRootCause.issue?.includes('OOM') ? 137 : 1,\n            finished_at: new Date().toISOString()\n          }\n        },\n        error_logs: [],\n        events: [{\n          type: \"Warning\",\n          reason: actualRootCause.issue?.includes('OOM') ? 'OOMKilled' : 'BackOff',\n          message: actualRootCause.evidence?.[0] || \"Container failing\",\n          timestamp: new Date().toISOString()\n        }],\n        resource_usage: {\n          memory_request: \"512Mi\",\n          memory_limit: \"1024Mi\",\n          memory_used: \"950Mi\",\n          cpu_used: \"0.85\"\n        }\n      }\n    }];\n    \n    actualOutput.enriched_context = {\n      ...actualOutput.enriched_context,\n      deployment_info: {\n        name: actualTarget.split('-').slice(0, -2).join('-') || \"unknown-deployment\",\n        namespace: actualNamespace,\n        version: \"unknown\",\n        replicas: \"unknown\",\n        last_update: new Date().toISOString(),\n        update_strategy: \"RollingUpdate\"\n      },\n      dependencies: {\n        upstream: [],\n        downstream: actualAffectedServices.filter(s => s !== actualNamespace),\n        databases: [],\n        external: []\n      }\n    };\n    \n    actualOutput.diagnostic_summary = {\n      confirmed_issues: [{\n        issue: actualRootCause.issue || \"Resource exhaustion leading to pod restarts\",\n        evidence: actualRootCause.evidence || [\n          \"Pod restart count: 5\",\n          \"Memory usage: 950Mi out of 1024Mi limit\",\n          \"Container instability detected\"\n        ],\n        severity: \"critical\",\n        impact: `Service ${actualTarget} is experiencing issues`,\n        namespace: actualNamespace\n      }],\n      secondary_issues: []\n    };\n    \n    console.log(\"‚úÖ Mock data replaced with actual data\");\n  }\n}\n\n// ============= KB DIAGNOSTIC INTEGRATION =============\nconst stage3KBMatches = stage3Data?.stage3Data?.knowledge_base_matches || [];\nconst stage3Alerts = stage3Data?.stage3Data?.active_alerts || [];\n\nif (stage3KBMatches.length > 0 && actualOutput.diagnostics_executed) {\n  console.log(\"=== KB DIAGNOSTIC INTEGRATION ===\");\n  console.log(\"KB matches:\", stage3KBMatches.length);\n  \n  stage3KBMatches.forEach((kbMatch, idx) => {\n    if (idx < actualOutput.diagnostics_executed.length) {\n      const diagnosticEntry = actualOutput.diagnostics_executed[idx];\n      \n      diagnosticEntry.kb_enhanced = true;\n      diagnosticEntry.kb_severity = kbMatch.kb_entry?.severity || \"Medium\";\n      \n      if (!diagnosticEntry.findings.kb_analysis) {\n        diagnosticEntry.findings.kb_analysis = {\n          alert_type: kbMatch.alert,\n          severity: kbMatch.kb_entry?.severity,\n          possible_root_causes: kbMatch.kb_entry?.root_causes || [],\n          diagnostic_guidance: kbMatch.kb_entry?.diagnostic_commands || []\n        };\n      }\n    }\n  });\n  \n  console.log(\"‚úÖ KB diagnostic enhancement complete\");\n}\n\n// Update enriched context KB analysis\nif (!actualOutput.enriched_context.kb_analysis) {\n  actualOutput.enriched_context.kb_analysis = {\n    alerts_matched: stage3KBMatches.map(m => ({\n      alert: m.alert,\n      severity: m.kb_entry?.severity || \"Unknown\"\n    })),\n    diagnostic_coverage: stage3KBMatches.length,\n    remediation_available: stage3KBMatches.filter(m => \n      m.kb_entry?.immediate_actions?.length > 0).length,\n    highest_severity: stage3KBMatches.reduce((max, m) => {\n      const severityOrder = { \"Blocker\": 5, \"Critical\": 4, \"High\": 3, \"Medium\": 2, \"Low\": 1 };\n      return severityOrder[m.kb_entry?.severity] > severityOrder[max] ? \n             m.kb_entry?.severity : max;\n    }, \"Low\")\n  };\n}\n\n// ============= CONTEXT FIX =============\nconst expectedContextId = previousContext?.contextId;\n\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId ||\n    actualOutput._context.contextId === \"abc123\") {\n    \n  console.log(\"‚ùå Invalid or missing context, fixing...\");\n  \n  // Deep copy of previous context\n  const contextCopy = JSON.parse(JSON.stringify(previousContext));\n  \n  // Ensure stageResults exists\n  if (!contextCopy.stageResults) {\n    contextCopy.stageResults = {};\n  }\n  \n  actualOutput._context = contextCopy;\n  console.log(\"‚úÖ Context replaced\");\n}\n\n// Ensure stageResults exists\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Add Stage 4 results - only this stage's data\nactualOutput._context.stageResults.stage4 = {\n  output: {\n    diagnostics_executed: JSON.parse(JSON.stringify(actualOutput.diagnostics_executed)),\n    enriched_context: JSON.parse(JSON.stringify(actualOutput.enriched_context)),\n    diagnostic_summary: JSON.parse(JSON.stringify(actualOutput.diagnostic_summary)),\n    proceed_to_stage5: actualOutput.proceed_to_stage5,\n    remediation_confidence: actualOutput.remediation_confidence\n  },\n  completedAt: new Date().toISOString(),\n  decision: actualOutput.proceed_to_stage5,\n  primaryIssue: actualOutput.diagnostic_summary?.confirmed_issues?.[0]?.issue\n};\n\n// Update debug info\nactualOutput._debug = {\n  nodeType: \"Stage 4: Automated Diagnosis\",\n  processedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  contextId: expectedContextId,\n  contextPreserved: true,\n  receivedFromStage: \"Fix Stage 3 Context\",\n  priority: previousContext?.priority || \"normal\",\n  stageSequence: [\n    \"Unified Entry Point\",\n    \"Stage 1: Health Snapshot\", \n    \"Fix Stage 1 Context\",\n    \"Stage 2 Decision\",\n    \"Force Deep Analysis Override\",\n    \"Wait 3s\",\n    \"Stage 2: Deep Analysis\",\n    \"Fix Stage 2 Context\",\n    \"Stage 3: Alert Intelligence\",\n    \"Fix Stage 3 Context\",\n    \"Stage 4: Automated Diagnosis\",\n    \"Fix Stage 4 Context\"\n  ],\n  diagnosticsCount: actualOutput.diagnostics_executed?.length || 0,\n  autoRemediationEnabled: true,\n  timeRangeUsed: {\n    start: previousContext?.initialParams?.startTime || 0,\n    end: previousContext?.initialParams?.endTime || 0\n  }\n};\n\n// Update root level context\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = expectedContextId;\n\n// Stage 4 summary data\nfixedOutput.stage4Data = {\n  diagnostics_executed: JSON.parse(JSON.stringify(actualOutput.diagnostics_executed)),\n  enriched_context: JSON.parse(JSON.stringify(actualOutput.enriched_context)),\n  diagnostic_summary: JSON.parse(JSON.stringify(actualOutput.diagnostic_summary)),\n  confirmed_issues: actualOutput.diagnostic_summary?.confirmed_issues || [],\n  secondary_issues: actualOutput.diagnostic_summary?.secondary_issues || [],\n  remediation_confidence: actualOutput.remediation_confidence || 0,\n  proceed_to_stage5: actualOutput.proceed_to_stage5 || false,\n  kb_enhanced: actualOutput.diagnostics_executed?.some(d => d.kb_enhanced) || false,\n  primary_diagnosis: actualOutput.diagnostic_summary?.confirmed_issues?.[0] || null\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n  actualOutput._context.decisions = previousContext?.decisions || {};\n}\n\nactualOutput._context.decisions.stage5Proceed = {\n  timestamp: new Date().toISOString(),\n  shouldProceed: actualOutput.proceed_to_stage5,\n  remediationConfidence: actualOutput.remediation_confidence,\n  confirmedIssuesCount: actualOutput.diagnostic_summary?.confirmed_issues?.length || 0,\n  primaryIssue: actualOutput.diagnostic_summary?.confirmed_issues?.[0]?.issue || \"unknown\"\n};\n\n// Preserve all previous stage data\nif (stage3Data?.stage1Data) {\n  fixedOutput.stage1Data = JSON.parse(JSON.stringify(stage3Data.stage1Data));\n  console.log(\"‚úÖ Stage 1 data preserved (full copy)\");\n}\n\nif (stage3Data?.stage2Data) {\n  fixedOutput.stage2Data = JSON.parse(JSON.stringify(stage3Data.stage2Data));\n  console.log(\"‚úÖ Stage 2 data preserved (full copy)\");\n}\n\nif (stage3Data?.stage3Data) {\n  fixedOutput.stage3Data = JSON.parse(JSON.stringify(stage3Data.stage3Data));\n  console.log(\"‚úÖ Stage 3 data preserved (full copy)\");\n}\n\n// Consolidated findings for final summary\nfixedOutput.consolidatedFindings = {\n  healthStatus: fixedOutput.stage1Data?.overall_status || \"unknown\",\n  alertCount: fixedOutput.stage1Data?.alerts?.total || 0,\n  rootCause: fixedOutput.stage2Data?.root_cause || {},\n  affectedServices: fixedOutput.stage2Data?.affected_services || [],\n  activeAlerts: fixedOutput.stage3Data?.active_alerts || [],\n  confirmedIssues: actualOutput.diagnostic_summary?.confirmed_issues || [],\n  primaryDiagnosis: actualOutput.diagnostic_summary?.confirmed_issues?.[0] || null,\n  remediationConfidence: actualOutput.remediation_confidence || 0\n};\n\n// Primary diagnosis for easy access\nif (actualOutput.diagnostic_summary?.confirmed_issues?.[0]) {\n  fixedOutput.primaryDiagnosis = {\n    ...actualOutput.diagnostic_summary.confirmed_issues[0],\n    stage: \"Stage 4\",\n    timestamp: new Date().toISOString()\n  };\n}\n\n// Namespaces and time range\nfixedOutput.namespaces = previousContext?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n  start: previousContext?.initialParams?.startTime || 0,\n  end: previousContext?.initialParams?.endTime || 0\n};\n\nconsole.log(\"==============================\");\nconsole.log(\"Stage 4 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Diagnostics executed:\", actualOutput.diagnostics_executed?.length);\nconsole.log(\"- Confirmed issues:\", actualOutput.diagnostic_summary?.confirmed_issues?.length);\nconsole.log(\"- KB enhanced:\", fixedOutput.stage4Data?.kb_enhanced);\nconsole.log(\"- Proceed to Stage 5:\", actualOutput.proceed_to_stage5);\nconsole.log(\"- Previous stage data preserved:\");\nconsole.log(\"  * Stage 1:\", !!fixedOutput.stage1Data);\nconsole.log(\"  * Stage 2:\", !!fixedOutput.stage2Data);\nconsole.log(\"  * Stage 3:\", !!fixedOutput.stage3Data);\nconsole.log(\"  * Stage 4:\", !!fixedOutput.stage4Data);\nconsole.log(\"- All data is FULL COPY (no summarization)\");\n\n// Validation\nconst validationPassed = \n  actualOutput._context?.contextId === expectedContextId &&\n  !!fixedOutput.stage1Data &&\n  !!fixedOutput.stage2Data &&\n  !!fixedOutput.stage3Data &&\n  !!fixedOutput.stage4Data;\n\nif (validationPassed) {\n  console.log(\"‚úÖ Stage 4 context successfully fixed and validated!\");\n} else {\n  console.error(\"‚ö†Ô∏è Stage 4 validation warnings\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n  fromNode: \"Fix Stage 4 Context\",\n  contextFixed: true,\n  validationPassed: validationPassed,\n  stage4DiagnosticsCount: actualOutput.diagnostics_executed?.length || 0,\n  stage4Decision: actualOutput.proceed_to_stage5,\n  remediationConfidence: actualOutput.remediation_confidence,\n  primaryIssue: actualOutput.diagnostic_summary?.confirmed_issues?.[0]?.issue || \"unknown\",\n  allStagesDataPresent: !!(fixedOutput.stage1Data && fixedOutput.stage2Data && \n                           fixedOutput.stage3Data && fixedOutput.stage4Data),\n  timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if needed\nif (hasOutputWrapper) {\n  fixedOutput.output = actualOutput;\n}\n\nreturn [{\n  json: fixedOutput\n}];"
      },
      "id": "6d5ee35e-2153-4624-bed4-563d896cb619",
      "name": "Fix Stage 4 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        -816,
        576
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Fix Stage 5 Context - Optimized without circular references\n\n// Default production namespaces\nconst DEFAULT_NAMESPACES = [\n  'bstp-cms-global-production',\n  'bstp-cms-prod-v3',\n  'em-global-prod-3pp',\n  'em-global-prod-eom',\n  'em-global-prod-flowe',\n  'em-global-prod',\n  'em-prod-3pp',\n  'em-prod-eom',\n  'em-prod-flowe',\n  'em-prod',\n  'etiyamobile-production',\n  'etiyamobile-prod'\n];\n\nconst stage5Output = $input.first().json;\n\n// √ñnceki stage'den context ve data'yƒ± al\nlet previousContext;\nlet stage4Data;\n\ntry {\n  stage4Data = $node[\"Fix Stage 4 Context\"].json;\n  previousContext = stage4Data._context;\n  \n  console.log(\"‚úÖ Got context from Stage 4:\", previousContext?.contextId);\n  console.log(\"Stage 1 data available:\", !!stage4Data.stage1Data);\n  console.log(\"Stage 2 data available:\", !!stage4Data.stage2Data);\n  console.log(\"Stage 3 data available:\", !!stage4Data.stage3Data);\n  console.log(\"Stage 4 data available:\", !!stage4Data.stage4Data);\n} catch (e) {\n  console.error(\"‚ùå Error getting Stage 4 data:\", e);\n  previousContext = {\n    contextId: \"ctx-emergency-\" + Date.now(),\n    createdAt: new Date().toISOString(),\n    stageResults: {},\n    decisions: {},\n    initialParams: {\n      startTime: Math.floor(Date.now() / 1000) - 3600,\n      endTime: Math.floor(Date.now() / 1000)\n    }\n  };\n}\n\n// Validate previousContext\nif (!previousContext || typeof previousContext !== 'object') {\n  console.error(\"‚ùå Invalid previousContext, creating new one\");\n  previousContext = {\n    contextId: \"ctx-recovery-\" + Date.now(),\n    createdAt: new Date().toISOString(),\n    stageResults: {},\n    decisions: {},\n    initialParams: {\n      startTime: Math.floor(Date.now() / 1000) - 3600,\n      endTime: Math.floor(Date.now() / 1000)\n    }\n  };\n}\n\n// Ensure stageResults exists\nif (!previousContext.stageResults) {\n  previousContext.stageResults = {};\n}\n\nconsole.log(\"=== FIXING STAGE 5 CONTEXT ===\");\nconsole.log(\"Previous context ID:\", previousContext?.contextId);\n\n// Deep copy\nlet fixedOutput = JSON.parse(JSON.stringify(stage5Output));\n\n// Output wrapper kontrol√º\nconst hasOutputWrapper = !!fixedOutput.output;\nlet actualOutput = hasOutputWrapper ? fixedOutput.output : fixedOutput;\n\nconsole.log(\"Has output wrapper:\", hasOutputWrapper);\n\n// String output handling\nif (typeof actualOutput === 'string') {\n  console.log(\"‚ö†Ô∏è Stage 5 output is string, attempting to parse...\");\n  \n  try {\n    let cleanOutput = actualOutput;\n    if (cleanOutput.includes('```json')) {\n      cleanOutput = cleanOutput.replace(/```json\\s*\\n?/g, '');\n      cleanOutput = cleanOutput.replace(/```\\s*$/g, '');\n    }\n    \n    if (cleanOutput.includes('{{') || cleanOutput.includes('$json')) {\n      console.log(\"‚ö†Ô∏è Stage 5 output contains templates, resolving...\");\n      \n      const context = previousContext;\n      const stage4Results = stage4Data?.stage4Data || {};\n      const primaryDiagnosis = stage4Data?.primaryDiagnosis || {};\n      \n      cleanOutput = cleanOutput\n        .replace(/\\{\\{ \\$json\\._context\\.contextId \\}\\}/g, context.contextId || 'unknown')\n        .replace(/\\{\\{ \\$json\\.stage4Results\\.enriched_context\\.deployment_info\\.name \\}\\}/g, \n          stage4Results?.enriched_context?.deployment_info?.name || 'unknown-deployment')\n        .replace(/\\{\\{ \\$json\\.primaryDiagnosis\\.namespace \\}\\}/g, \n          primaryDiagnosis?.namespace || 'default')\n        .replace(/\\{\\{ JSON\\.stringify\\(\\$json\\._context\\) \\}\\}/g, \n          JSON.stringify(context))\n        .replace(/\\{\\{ \\$json\\._context\\.initialParams\\.startTime \\}\\}/g, \n          context.initialParams?.startTime || 0)\n        .replace(/\\{\\{ \\$json\\._context\\.initialParams\\.endTime \\}\\}/g, \n          context.initialParams?.endTime || 0)\n        .replace(/<use new Date\\(\\)\\.toISOString\\(\\)>/g, new Date().toISOString())\n        .replace(/<current ISO timestamp>/g, new Date().toISOString());\n    }\n    \n    actualOutput = JSON.parse(cleanOutput);\n    console.log(\"‚úÖ Successfully parsed Stage 5 output\");\n  } catch (e) {\n    console.error(\"‚ùå Failed to parse Stage 5 output:\", e.message);\n    actualOutput = {\n      stage: \"ai_powered_analysis\",\n      analysis_id: previousContext.contextId + \"-stage5\",\n      error: \"Failed to parse output\",\n      remediation_plan: {\n        immediate_actions: [],\n        short_term_fixes: [],\n        long_term_solutions: [],\n        preventive_measures: []\n      },\n      risk_assessment: {\n        overall_risk: \"unknown\",\n        factors: [],\n        mitigation_steps: []\n      },\n      implementation_order: [],\n      success_metrics: {\n        immediate: [],\n        short_term: [],\n        long_term: []\n      },\n      rollback_plan: {\n        trigger_conditions: [],\n        steps: [],\n        validation: \"\"\n      }\n    };\n  }\n}\n\n// Validate actualOutput\nif (!actualOutput || typeof actualOutput !== 'object') {\n  console.error(\"‚ùå Invalid actualOutput, creating default structure\");\n  actualOutput = {\n    stage: \"ai_powered_analysis\",\n    analysis_id: previousContext.contextId + \"-stage5\",\n    remediation_plan: {\n      immediate_actions: [],\n      short_term_fixes: [],\n      long_term_solutions: [],\n      preventive_measures: []\n    },\n    risk_assessment: {\n      overall_risk: \"unknown\",\n      factors: [],\n      mitigation_steps: []\n    }\n  };\n}\n\n// ============= MOCK DATA DETECTION VE TEMƒ∞ZLEME =============\nif (actualOutput.remediation_plan && actualOutput.remediation_plan.immediate_actions) {\n  const immediateActions = actualOutput.remediation_plan.immediate_actions;\n  \n  immediateActions.forEach((action, index) => {\n    if (action.command && action.command.includes('payment-service')) {\n      console.warn(\"‚ö†Ô∏è MOCK COMMAND DETECTED! Replacing with actual data...\");\n      \n      const actualRootCause = stage4Data?.stage2Data?.root_cause || {};\n      let actualComponent = actualRootCause.component || \n                           stage4Data?.primaryDiagnosis?.component || \n                           \"unknown-component\";\n      const actualNamespace = stage4Data?.primaryDiagnosis?.namespace ||\n                             stage4Data?.stage2Data?.affected_services?.[0]?.split('-')?.[0] ||\n                             DEFAULT_NAMESPACES[0];\n      const actualIssue = actualRootCause.issue || \n                         stage4Data?.primaryDiagnosis?.issue || \n                         \"Unknown issue\";\n      \n      const criticalPods = stage4Data?.stage2Data?.critical_pods || [];\n      if (criticalPods.length > 0 && actualComponent === \"unknown-component\") {\n        const firstPod = criticalPods[0];\n        actualComponent = typeof firstPod === 'string' ? firstPod : firstPod.name || firstPod;\n        console.log(`‚úÖ Using actual pod: ${actualComponent}`);\n      }\n      \n      if (actualIssue.includes('CrashLoopBackOff')) {\n        immediateActions[index] = {\n          action: `Delete and recreate pod ${actualComponent}`,\n          command: `kubectl delete pod ${actualComponent} -n ${actualNamespace}`,\n          risk: \"low\",\n          estimated_time: \"1-2 minutes\",\n          expected_outcome: \"Pod will be recreated with fresh state\"\n        };\n      } else if (actualIssue.includes('restart')) {\n        const deploymentName = actualComponent.split('-').slice(0, -2).join('-') || actualComponent;\n        immediateActions[index] = {\n          action: `Scale down and up deployment for ${actualComponent}`,\n          command: `kubectl scale deployment ${deploymentName} --replicas=0 -n ${actualNamespace} && kubectl scale deployment ${deploymentName} --replicas=1 -n ${actualNamespace}`,\n          risk: \"medium\",\n          estimated_time: \"2-3 minutes\",\n          expected_outcome: \"Deployment will be refreshed\"\n        };\n      } else {\n        immediateActions[index] = {\n          action: `Investigate and restart ${actualComponent}`,\n          command: `kubectl describe pod ${actualComponent} -n ${actualNamespace} && kubectl delete pod ${actualComponent} -n ${actualNamespace}`,\n          risk: \"low\",\n          estimated_time: \"2-5 minutes\",\n          expected_outcome: \"Component will be restarted after investigation\"\n        };\n      }\n      \n      console.log(\"‚úÖ Replaced mock command with actual component\");\n    }\n    \n    if (action.action && action.action.includes('payment-service')) {\n      const actualComponent = stage4Data?.stage2Data?.root_cause?.component || \"component\";\n      action.action = action.action.replace(/payment-service/g, actualComponent);\n    }\n  });\n  \n  if (actualOutput.remediation_plan.short_term_fixes) {\n    actualOutput.remediation_plan.short_term_fixes.forEach((fix) => {\n      if (fix.details && fix.details.includes('payment')) {\n        const actualService = stage4Data?.stage2Data?.affected_services?.[0] || \"service\";\n        fix.details = fix.details.replace(/payment processing/g, actualService + \" processing\");\n      }\n    });\n  }\n  \n  if (actualOutput.remediation_plan.long_term_solutions) {\n    actualOutput.remediation_plan.long_term_solutions.forEach((solution) => {\n      if (solution.details && (solution.details.includes('TransactionHandler') || solution.details.includes('payment'))) {\n        const actualComponent = stage4Data?.stage2Data?.root_cause?.component || \"component\";\n        solution.action = `Fix issues in ${actualComponent}`;\n        solution.details = `Review and fix the root cause in ${actualComponent} component`;\n      }\n    });\n  }\n}\n\n// ============= KB REMEDIATION ENHANCEMENT =============\nconst stage4DiagnosticSummary = stage4Data?.stage4Data?.diagnostic_summary || {};\nconst stage4KBAnalysis = stage4Data?.stage4Data?.enriched_context?.kb_analysis || {};\nconst confirmedIssuesWithKB = stage4DiagnosticSummary.confirmed_issues?.filter(i => i.kb_enhanced) || [];\n\nconsole.log(\"=== KB REMEDIATION ENHANCEMENT ===\");\nconsole.log(\"KB enhanced issues:\", confirmedIssuesWithKB.length);\n\nif (confirmedIssuesWithKB.length > 0 && actualOutput.remediation_plan) {\n  console.log(\"Enhancing remediation plan with KB actions...\");\n  \n  const kbImmediateActions = [];\n  \n  confirmedIssuesWithKB.forEach(issue => {\n    if (issue.kb_immediate_actions && Array.isArray(issue.kb_immediate_actions)) {\n      issue.kb_immediate_actions.forEach((action, idx) => {\n        const actionText = action.replace(/^\\d+\\.\\s*/, '');\n        let command = \"\";\n        let risk = \"medium\";\n        let estimatedTime = \"5-10 minutes\";\n        \n        if (actionText.toLowerCase().includes('rollback')) {\n          const component = issue.namespace || stage4Data?.primaryDiagnosis?.component || \"deployment\";\n          command = `kubectl rollout undo deployment/${component} -n ${issue.namespace || 'default'}`;\n          risk = \"low\";\n          estimatedTime = \"2-5 minutes\";\n        } else if (actionText.toLowerCase().includes('restart')) {\n          const component = issue.namespace || stage4Data?.primaryDiagnosis?.component || \"deployment\";\n          command = `kubectl rollout restart deployment/${component} -n ${issue.namespace || 'default'}`;\n          risk = \"low\";\n          estimatedTime = \"2-3 minutes\";\n        }\n        \n        kbImmediateActions.push({\n          action: actionText,\n          command: command,\n          risk: risk,\n          estimated_time: estimatedTime,\n          expected_outcome: `Resolve ${issue.issue}`,\n          source: \"Alert Knowledge Base\",\n          kb_severity: issue.kb_severity,\n          priority_score: calculateActionPriority(issue.kb_severity, idx)\n        });\n      });\n    }\n  });\n  \n  kbImmediateActions.sort((a, b) => b.priority_score - a.priority_score);\n  \n  if (actualOutput.remediation_plan.immediate_actions.length === 0 || \n      actualOutput.remediation_plan.immediate_actions.some(a => a.command?.includes('payment-service'))) {\n    actualOutput.remediation_plan.immediate_actions = kbImmediateActions.slice(0, 5);\n  }\n  \n  console.log(\"‚úÖ KB remediation enhancement complete\");\n}\n\n// Helper function\nfunction calculateActionPriority(severity, index) {\n  const severityScores = {\n    \"Blocker\": 1000,\n    \"Critical\": 800,\n    \"High\": 600,\n    \"Medium\": 400,\n    \"Low\": 200\n  };\n  return (severityScores[severity] || 100) - (index * 10);\n}\n\n// Risk assessment update\nif (actualOutput.risk_assessment && actualOutput.risk_assessment.factors) {\n  actualOutput.risk_assessment.factors = actualOutput.risk_assessment.factors.map(factor => {\n    if (typeof factor === 'string' && factor.includes('Payment service')) {\n      const actualService = stage4Data?.stage2Data?.affected_services?.[0] || \"Service\";\n      return factor.replace('Payment service', actualService);\n    }\n    return factor;\n  });\n}\n\n// ============= CONTEXT FIX =============\nconst expectedContextId = previousContext?.contextId;\n\nif (!actualOutput._context || \n    actualOutput._context.contextId !== expectedContextId) {\n  console.log(\"‚ùå Invalid or missing context, fixing...\");\n  \n  // Deep copy of previous context\n  const contextCopy = JSON.parse(JSON.stringify(previousContext));\n  \n  // Ensure stageResults exists\n  if (!contextCopy.stageResults) {\n    contextCopy.stageResults = {};\n  }\n  \n  actualOutput._context = contextCopy;\n  console.log(\"‚úÖ Context replaced\");\n}\n\n// Ensure stageResults exists\nif (!actualOutput._context.stageResults) {\n  actualOutput._context.stageResults = {};\n}\n\n// Add Stage 5 results - only this stage's data\nactualOutput._context.stageResults.stage5 = {\n  output: {\n    analysis_id: actualOutput.analysis_id || `${expectedContextId}-stage5`,\n    remediation_plan: JSON.parse(JSON.stringify(actualOutput.remediation_plan)),\n    risk_assessment: JSON.parse(JSON.stringify(actualOutput.risk_assessment)),\n    implementation_order: JSON.parse(JSON.stringify(actualOutput.implementation_order || [])),\n    success_metrics: JSON.parse(JSON.stringify(actualOutput.success_metrics || {})),\n    rollback_plan: JSON.parse(JSON.stringify(actualOutput.rollback_plan || {}))\n  },\n  completedAt: new Date().toISOString()\n};\n\n// Update debug info\nactualOutput._debug = {\n  nodeType: \"Stage 5: AI-Powered Analysis\",\n  processedAt: actualOutput._debug?.processedAt || new Date().toISOString(),\n  contextId: expectedContextId,\n  contextPreserved: true,\n  receivedFromStage: \"Fix Stage 4 Context\",\n  priority: previousContext?.priority || \"normal\",\n  stagesCompleted: 5,\n  stageSequence: [\n    \"Unified Entry Point\",\n    \"Stage 1: Health Snapshot\",\n    \"Fix Stage 1 Context\",\n    \"Stage 2 Decision\",\n    \"Force Deep Analysis Override\",\n    \"Wait 3s\",\n    \"Stage 2: Deep Analysis\",\n    \"Fix Stage 2 Context\",\n    \"Stage 3: Alert Intelligence\",\n    \"Fix Stage 3 Context\",\n   \"Stage 4: Automated Diagnosis\",\n   \"Fix Stage 4 Context\",\n   \"Stage 5: AI-Powered Analysis\",\n   \"Fix Stage 5 Context\"\n ],\n analysisTimeRange: {\n   start: previousContext?.initialParams?.startTime || 0,\n   end: previousContext?.initialParams?.endTime || 0\n }\n};\n\n// Update root level context\nfixedOutput._context = JSON.parse(JSON.stringify(actualOutput._context));\nfixedOutput.contextId = expectedContextId;\n\n// Stage 5 summary data\nfixedOutput.stage5Data = {\n analysis_id: actualOutput.analysis_id,\n remediation_plan: JSON.parse(JSON.stringify(actualOutput.remediation_plan)),\n risk_assessment: JSON.parse(JSON.stringify(actualOutput.risk_assessment)),\n implementation_order: JSON.parse(JSON.stringify(actualOutput.implementation_order || [])),\n success_metrics: JSON.parse(JSON.stringify(actualOutput.success_metrics || {})),\n rollback_plan: JSON.parse(JSON.stringify(actualOutput.rollback_plan || {})),\n primary_action: actualOutput.remediation_plan?.immediate_actions?.[0],\n overall_risk: actualOutput.risk_assessment?.overall_risk\n};\n\n// Update decisions\nif (!actualOutput._context.decisions) {\n actualOutput._context.decisions = previousContext?.decisions || {};\n}\n\nactualOutput._context.decisions.stage6Proceed = {\n timestamp: new Date().toISOString(),\n remediationPlanCreated: !!actualOutput.remediation_plan,\n riskAssessed: !!actualOutput.risk_assessment,\n primaryActionDefined: !!actualOutput.remediation_plan?.immediate_actions?.[0]\n};\n\n// Preserve ALL previous stage data\nif (stage4Data?.stage1Data) {\n fixedOutput.stage1Data = JSON.parse(JSON.stringify(stage4Data.stage1Data));\n console.log(\"‚úÖ Stage 1 data preserved (full copy)\");\n}\n\nif (stage4Data?.stage2Data) {\n fixedOutput.stage2Data = JSON.parse(JSON.stringify(stage4Data.stage2Data));\n console.log(\"‚úÖ Stage 2 data preserved (full copy)\");\n}\n\nif (stage4Data?.stage3Data) {\n fixedOutput.stage3Data = JSON.parse(JSON.stringify(stage4Data.stage3Data));\n console.log(\"‚úÖ Stage 3 data preserved (full copy)\");\n}\n\nif (stage4Data?.stage4Data) {\n fixedOutput.stage4Data = JSON.parse(JSON.stringify(stage4Data.stage4Data));\n console.log(\"‚úÖ Stage 4 data preserved (full copy)\");\n}\n\n// Preserve additional data\nif (stage4Data?.consolidatedFindings) {\n fixedOutput.consolidatedFindings = JSON.parse(JSON.stringify(stage4Data.consolidatedFindings));\n}\n\nif (stage4Data?.primaryDiagnosis) {\n fixedOutput.primaryDiagnosis = JSON.parse(JSON.stringify(stage4Data.primaryDiagnosis));\n}\n\n// Executive summary\nfixedOutput.executiveSummary = {\n contextId: expectedContextId,\n issue: fixedOutput.primaryDiagnosis?.issue || \"Unknown issue\",\n severity: fixedOutput.primaryDiagnosis?.severity || \"medium\",\n immediateAction: actualOutput.remediation_plan?.immediate_actions?.[0]?.action || \"No immediate action\",\n command: actualOutput.remediation_plan?.immediate_actions?.[0]?.command || \"N/A\",\n risk: actualOutput.risk_assessment?.overall_risk || \"unknown\",\n estimatedTime: actualOutput.remediation_plan?.immediate_actions?.[0]?.estimated_time || \"unknown\",\n stagesCompleted: 5,\n timestamp: new Date().toISOString()\n};\n\n// Namespaces and time range\nfixedOutput.namespaces = previousContext?.initialParams?.namespaces || DEFAULT_NAMESPACES;\nfixedOutput.timeRange = {\n start: previousContext?.initialParams?.startTime || 0,\n end: previousContext?.initialParams?.endTime || 0\n};\n\n// Summary logging\nconsole.log(\"==============================\");\nconsole.log(\"Stage 5 Fix Summary:\");\nconsole.log(\"- Context ID:\", actualOutput._context?.contextId);\nconsole.log(\"- Immediate action:\", fixedOutput.remediation_plan?.immediate_actions?.[0]?.action);\nconsole.log(\"- Risk level:\", fixedOutput.risk_assessment?.overall_risk);\nconsole.log(\"- Command:\", fixedOutput.remediation_plan?.immediate_actions?.[0]?.command);\nconsole.log(\"- Previous stage data preserved:\");\nconsole.log(\"  * Stage 1:\", !!fixedOutput.stage1Data);\nconsole.log(\"  * Stage 2:\", !!fixedOutput.stage2Data);\nconsole.log(\"  * Stage 3:\", !!fixedOutput.stage3Data);\nconsole.log(\"  * Stage 4:\", !!fixedOutput.stage4Data);\nconsole.log(\"  * Stage 5:\", !!fixedOutput.stage5Data);\nconsole.log(\"- All data is FULL COPY (no summarization)\");\n\n// Validation\nconst validationPassed = \n actualOutput._context?.contextId === expectedContextId &&\n !!fixedOutput.stage1Data &&\n !!fixedOutput.stage2Data &&\n !!fixedOutput.stage3Data &&\n !!fixedOutput.stage4Data &&\n !!fixedOutput.stage5Data;\n\nif (validationPassed) {\n console.log(\"‚úÖ Stage 5 context successfully fixed and validated!\");\n console.log(\"üéâ ALL STAGES COMPLETED WITH FULL DATA PRESERVED!\");\n} else {\n console.error(\"‚ö†Ô∏è Stage 5 validation warnings - check data preservation\");\n}\n\n// Debug info for next stage\nfixedOutput._debugInfo = {\n fromNode: \"Fix Stage 5 Context\",\n contextFixed: true,\n validationPassed: validationPassed,\n templatesParsed: true,\n stage5Decision: !!actualOutput.remediation_plan,\n primaryAction: actualOutput.remediation_plan?.immediate_actions?.[0]?.action || \"none\",\n overallRisk: actualOutput.risk_assessment?.overall_risk || \"unknown\",\n allStagesDataPresent: !!(fixedOutput.stage1Data && fixedOutput.stage2Data && \n                          fixedOutput.stage3Data && fixedOutput.stage4Data && \n                          fixedOutput.stage5Data),\n timestamp: new Date().toISOString()\n};\n\n// Pass the output wrapper if needed\nif (hasOutputWrapper) {\n fixedOutput.output = actualOutput;\n}\n\nreturn [{\n json: fixedOutput\n}];"
      },
      "id": "d53fc36e-c096-4db6-b8d2-a6785bcc5968",
      "name": "Fix Stage 5 Context",
      "type": "n8n-nodes-base.code",
      "position": [
        -320,
        576
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || $json._context?.initialParams?.namespaces?.[0] || 'etiyamobile-production';\n  const svc = $json.service || $json.output?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `(sum(kube_pod_status_ready{namespace=\"${ns}\", pod=~\".*${svc}.*\", condition=\"true\"}) / count(kube_pod_info{namespace=\"${ns}\", pod=~\".*${svc}.*\"})) * 100`;\n  } else {\n    return `(sum(kube_pod_status_ready{namespace=\"${ns}\", condition=\"true\"}) / count(kube_pod_info{namespace=\"${ns}\"})) * 100`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "ab64744b-3d6a-4c6f-a23c-79c9b766878c",
      "name": "Pod Ready SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1568,
        976
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || $json._context?.initialParams?.namespaces?.[0] || 'etiyamobile-production';\n  const svc = $json.service || $json.output?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `(count(kube_pod_container_status_running{namespace=\"${ns}\", pod=~\".*${svc}.*\"} == 1) / count(kube_pod_container_info{namespace=\"${ns}\", pod=~\".*${svc}.*\"})) * 100`;\n  } else {\n    return `(count(kube_pod_container_status_running{namespace=\"${ns}\"} == 1) / count(kube_pod_container_info{namespace=\"${ns}\"})) * 100`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "d6cd8a1b-223c-46e6-b085-2a97e4c658ff",
      "name": "Container Running SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1488,
        1056
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  // Node metrikleri cluster seviyesinde, service filtresi uygulanamaz\n  return `(sum(kube_node_status_condition{condition=\"Ready\",status=\"true\"}) / count(kube_node_info)) * 100`;\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "604cfa12-cbe7-4a3f-bb44-f1ff0f11a107",
      "name": "Node Ready SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1344,
        912
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || $json._context?.initialParams?.namespaces?.[0] || 'etiyamobile-production';\n  const svc = $json.service || $json.output?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `100 - (sum(rate(kube_pod_container_status_restarts_total{namespace=\"${ns}\", pod=~\".*${svc}.*\"}[1h])) * 100)`;\n  } else {\n    return `100 - (sum(rate(kube_pod_container_status_restarts_total{namespace=\"${ns}\"}[1h])) * 100)`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "2ea5883d-6ff0-4315-902e-293d11d7c9fa",
      "name": "Pod Restart Rate SLO",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1408,
        1184
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n  const ns = $json.namespace || $json._context?.initialParams?.namespaces?.[0] || 'etiyamobile-production';\n  const svc = $json.service || $json.output?.correlation_matrix?.affected_services?.[0] || '';\n  \n  if (svc) {\n    return `(sum(kube_deployment_status_replicas_available{namespace=\"${ns}\", deployment=~\".*${svc}.*\"}) / sum(kube_deployment_status_replicas{namespace=\"${ns}\", deployment=~\".*${svc}.*\"})) * 100`;\n  } else {\n    return `(sum(kube_deployment_status_replicas_available{namespace=\"${ns}\"}) / sum(kube_deployment_status_replicas{namespace=\"${ns}\"})) * 100`;\n  }\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "5664e472-c639-4fa4-82ed-5659a1ff6f78",
      "name": "Deployment Replica Health",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -1264,
        1120
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// Alert KB Loader - Excel'den alert bilgilerini y√ºkle\nconst alertKBData = [\n{\n  alertName: \"KubePodCrashLooping\",\n  severity: \"Critical\",\n  description: \"Pod repeatedly crashes after starting\",\n  rootCauses: [\n    \"1. Application bugs causing crashes\",\n    \"2. Insufficient memory/CPU resources\", \n    \"3. Missing ConfigMaps or Secrets\",\n    \"4. Failed health checks\",\n    \"5. Image pull errors\",\n    \"6. Permission issues\"\n  ],\n  diagnosticCommands: [\n    \"kubectl logs [pod] -n [namespace] --previous\",\n    \"kubectl describe pod [pod] -n [namespace]\",\n    \"kubectl get events -n [namespace] --field-selector involvedObject.name=[pod]\",\n    \"kubectl top pod [pod] -n [namespace]\",\n    \"kubectl get pod [pod] -n [namespace] -o yaml | grep -A 10 'status:'\",\n    \"kubectl exec [pod] -n [namespace] -- df -h\"\n  ],\n  expectedResults: [\n    \"1. Error logs before crash (stack trace, exception)\",\n    \"2. Exit code and reason (OOMKilled, Error, etc.)\",\n    \"3. Resource limits and current usage\",\n    \"4. Recent events showing failures\",\n    \"5. Restart count > 5\",\n    \"6. Container state details\"\n  ],\n  immediateActions: [\n    \"1. Check logs for error messages\",\n    \"2. Verify resource limits are adequate\",\n    \"3. Check if ConfigMaps/Secrets exist and are mounted\",\n    \"4. Delete and recreate pod: kubectl delete pod [pod] -n [namespace]\",\n    \"5. If OOMKilled: Increase memory limits\",\n    \"6. Rollback deployment if issue persists\"\n  ],\n  longTermSolutions: [\n    \"1. Fix application bugs identified in logs\",\n    \"2. Adjust resource requests/limits based on actual usage\",\n    \"3. Implement proper health checks (liveness/readiness probes)\",\n    \"4. Add monitoring for memory leaks\",\n    \"5. Set up PodDisruptionBudget\",\n    \"6. Implement graceful shutdown handling\"\n  ]\n},\n  {\n    alertName: \"etcdInsufficientMembers\",\n    severity: \"Blocker\",\n    description: \"etcd cluster lost quorum\",\n    rootCauses: [\n      \"1. AZ outage\",\n      \"2. EC2 instance failure\",\n      \"3. Network partition\",\n      \"4. Storage corruption\"\n    ],\n    diagnosticCommands: [\n      \"aws eks describe-cluster --name [cluster]\",\n      \"kubectl get ns -v=6\",\n      \"aws cloudwatch get-metric-data --metric-data-queries\"\n    ],\n    expectedResults: [\n      \"1. API requests failing\",\n      \"2. AWS console shows etcd warnings\",\n      \"3. CloudWatch shows <3 members\"\n    ],\n    immediateActions: [\n      \"1. IMMEDIATE AWS SUPPORT TICKET\",\n      \"2. Stop cluster changes\",\n      \"3. Prepare DR plan\"\n    ],\n    longTermSolutions: [\n      \"1. Deploy multi-AZ etcd\",\n      \"2. Regular snapshots\",\n      \"3. Monitor etcd_health metrics\"\n    ]\n  },\n  {\n    alertName: \"KubeAPIErrorBudgetBurn\",\n    severity: \"Critical\",\n    description: \"API server error rate >5% for 15min\",\n    rootCauses: [\n      \"1. etcd performance issues\",\n      \"2. Abusive API clients\",\n      \"3. Network congestion\",\n      \"4. Certificate expiry\"\n    ],\n    diagnosticCommands: [\n      \"kubectl get --raw /metrics | grep apiserver_request\",\n      \"kubectl top nodes\",\n      \"kubectl logs -n kube-system kube-apiserver-*\"\n    ],\n    expectedResults: [\n      \"1. 5xx errors >5%\",\n      \"2. High CPU/memory on masters\",\n      \"3. Error logs in API server\"\n    ],\n    immediateActions: [\n      \"1. Identify abusive clients\",\n      \"2. Scale API servers\",\n      \"3. Enable rate limiting\",\n      \"4. Check certificates\"\n    ],\n    longTermSolutions: [\n      \"1. Implement client QPS limits\",\n      \"2. Deploy API caching layer\",\n      \"3. Monitor client behavior\"\n    ]\n  }\n  // Diƒüer alert'leri de buraya ekleyin...\n];\n\n// Input'tan gelen veriyi koru ve alert KB ekle\nconst inputData = $input.first().json;\n\n// Alert KB'yi severity'ye g√∂re grupla\nconst alertKBBySeverity = {};\nalertKBData.forEach(alert => {\n  if (!alertKBBySeverity[alert.severity]) {\n    alertKBBySeverity[alert.severity] = [];\n  }\n  alertKBBySeverity[alert.severity].push(alert);\n});\n\n// Severity scoring\nconst severityScores = {\n  \"Blocker\": 100,\n  \"Critical\": 80,\n  \"High\": 60,\n  \"Medium\": 40,\n  \"Low\": 20\n};\n\nconsole.log(\"=== ALERT KB LOADED ===\");\nconsole.log(\"Total alerts in KB:\", alertKBData.length);\nconsole.log(\"Severity breakdown:\");\nObject.entries(alertKBBySeverity).forEach(([severity, alerts]) => {\n  console.log(`- ${severity}: ${alerts.length} alerts`);\n});\n\n// Output - Input data'yƒ± koru ve KB bilgisi ekle\n// KB'yi doƒürudan output'a ekle, static data kullanmayacaƒüƒ±z\nreturn [{\n  json: {\n    ...inputData,\n    _alertKB: {\n      loaded: true,\n      totalAlerts: alertKBData.length,\n      severityBreakdown: Object.keys(alertKBBySeverity).reduce((acc, sev) => {\n        acc[sev] = alertKBBySeverity[sev].length;\n        return acc;\n      }, {}),\n      loadedAt: new Date().toISOString()\n    },\n    // KB data'yƒ± doƒürudan output'a ekle\n    _alertKBData: alertKBData,\n    _alertKBBySeverity: alertKBBySeverity,\n    _severityScores: severityScores\n  }\n}];"
      },
      "id": "c886712c-a05f-4050-8c3e-5d97dc554e2f",
      "name": "Load Alert Knowledge Base",
      "type": "n8n-nodes-base.code",
      "position": [
        -3152,
        288
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "https://prometheus.saas.etycloudbss.com/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{\n(() => {\n\n  // Yoksa manuel olu≈ütur\n  return `count by (namespace, service, pod) (up{namespace=~\"em-prod-eom\", service!=\"\", pod!=\"\"})`;\n})()\n}}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "2be97641-14f5-4ecd-a72f-8de9d69c8059",
      "name": "List Kubernetes Services",
      "type": "n8n-nodes-base.httpRequestTool",
      "position": [
        -2496,
        96
      ],
      "typeVersion": 4.2,
      "disabled": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "etiya-gpt-4o",
          "mode": "list",
          "cachedResultName": "etiya-gpt-4o"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.3,
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1120,
        768
      ],
      "id": "79fa0526-45ae-43f7-97be-e7bfbb256c7c",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "rYdB8nNsS7m67tcr",
          "name": "OpenAi account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Agent'tan gelen veriyi al\nconst items = $input.all();\n\n// D√∂n√º≈üt√ºr√ºlm√º≈ü sonu√ßlarƒ± tutacak array\nconst transformedItems = [];\n\nfor (const item of items) {\n  try {\n    // Agent'ƒ±n output'u string olarak geliyor, √∂nce parse edelim\n    let parsedData;\n    \n    if (typeof item.json.output === 'string') {\n      // String JSON'ƒ± parse et\n      parsedData = JSON.parse(item.json.output);\n    } else if (typeof item.json === 'string') {\n      // Bazen direkt item.json string olabilir\n      parsedData = JSON.parse(item.json);\n    } else {\n      // Zaten object ise\n      parsedData = item.json.output || item.json;\n    }\n    \n    // _context'i d√ºzelt - eƒüer string ise object'e √ßevir\n    if (typeof parsedData._context === 'string') {\n      parsedData._context = {\n        contextId: parsedData._context\n      };\n    } else if (!parsedData._context) {\n      parsedData._context = {};\n    }\n    \n    // Eksik alanlarƒ± kontrol et ve varsayƒ±lan deƒüerler ekle\n    if (!parsedData.execution_phases) {\n      parsedData.execution_phases = {\n        instant: { tools_used: [], findings: {} },\n        trend: { tools_used: [], findings: {} },\n        anomaly: { tools_used: [], findings: {} }\n      };\n    }\n    \n    if (!parsedData.correlation_matrix) {\n      parsedData.correlation_matrix = {\n        primary_chain: \"\",\n        affected_services: [],\n        blast_radius: \"\",\n        kubernetes_impact: {\n          evicted_pods: 0,\n          pending_pods: 0,\n          failed_schedules: 0\n        }\n      };\n    }\n    \n    if (!parsedData.root_cause) {\n      parsedData.root_cause = {\n        identified: false,\n        component: \"\",\n        issue: \"\",\n        evidence: [],\n        confidence: 0\n      };\n    }\n    \n    // Eksik boolean alanlarƒ± ekle\n    if (parsedData.proceed_to_stage3 === undefined) {\n      parsedData.proceed_to_stage3 = false;\n    }\n    \n    if (parsedData.alert_correlation_needed === undefined) {\n      parsedData.alert_correlation_needed = false;\n    }\n    \n    // _debug alanƒ±nƒ± kontrol et\n    if (!parsedData._debug) {\n      parsedData._debug = {\n        nodeType: \"Stage 2: Deep Analysis\",\n        processedAt: new Date().toISOString(),\n        contextId: parsedData._context.contextId || \"\",\n        contextPreserved: true,\n        receivedFromStage: \"\",\n        stageSequence: []\n      };\n    }\n    \n    // Sonucu eski formata uygun ≈üekilde wrap et\n    const transformedItem = {\n      json: {\n        output: parsedData\n      }\n    };\n    \n    transformedItems.push(transformedItem);\n    \n  } catch (error) {\n    // Hata durumunda orijinal veriyi d√∂nd√ºr ve hata mesajƒ± ekle\n    console.error('Parse error:', error.message);\n    transformedItems.push({\n      json: {\n        error: error.message,\n        originalData: item.json\n      }\n    });\n  }\n}\n\nreturn transformedItems;"
      },
      "id": "fb24e454-6464-4126-8201-ce9f90977324",
      "name": "Fix Stage2 Json",
      "type": "n8n-nodes-base.code",
      "position": [
        -1856,
        704
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Agent'tan gelen veriyi al\nconst items = $input.all();\n\n// D√∂n√º≈üt√ºr√ºlm√º≈ü sonu√ßlarƒ± tutacak array\nconst transformedItems = [];\n\nfor (const item of items) {\n  try {\n    let outputData;\n    \n    // Veriyi parse etmeye √ßalƒ±≈ü\n    if (typeof item.json.output === 'string') {\n      // String JSON ise parse et\n      outputData = JSON.parse(item.json.output);\n    } else if (item.json.output && typeof item.json.output === 'object') {\n      // Zaten object ise direkt kullan\n      outputData = item.json.output;\n    } else if (typeof item.json === 'string') {\n      // Bazen direkt item.json string olabilir\n      outputData = JSON.parse(item.json);\n    } else {\n      // Diƒüer durumlar i√ßin\n      outputData = item.json;\n    }\n    \n    // Eƒüer outputData hala output anahtarƒ± i√ßeriyorsa, onu √ßƒ±kar\n    if (outputData.output) {\n      outputData = outputData.output;\n    }\n    \n    // Stage 4 i√ßin gerekli alanlarƒ± kontrol et ve varsayƒ±lan deƒüerler ekle\n    if (!outputData.stage) {\n      outputData.stage = \"automated_diagnosis\";\n    }\n    \n    // diagnostics_executed kontrol√º\n    if (!outputData.diagnostics_executed) {\n      outputData.diagnostics_executed = [];\n    }\n    \n    // enriched_context kontrol√º\n    if (!outputData.enriched_context) {\n      outputData.enriched_context = {\n        deployment_info: {},\n        recent_changes: [],\n        dependencies: {\n          upstream: [],\n          downstream: [],\n          databases: [],\n          external: []\n        }\n      };\n    }\n    \n    // diagnostic_summary kontrol√º\n    if (!outputData.diagnostic_summary) {\n      outputData.diagnostic_summary = {\n        confirmed_issues: [],\n        secondary_issues: []\n      };\n    }\n    \n    // Boolean alanlarƒ± kontrol et\n    if (outputData.proceed_to_stage5 === undefined) {\n      outputData.proceed_to_stage5 = false;\n    }\n    \n    // remediation_confidence kontrol√º\n    if (outputData.remediation_confidence === undefined) {\n      outputData.remediation_confidence = 0;\n    }\n    \n    // _context kontrol√º ve d√ºzeltmesi\n    if (!outputData._context || typeof outputData._context === 'string') {\n      // Eƒüer string ise veya yoksa, bo≈ü object yap\n      outputData._context = {\n        contextId: typeof outputData._context === 'string' ? outputData._context : \"\",\n        createdAt: new Date().toISOString()\n      };\n    }\n    \n    // Circular reference'larƒ± temizle\n    if (outputData._context && outputData._context === \"[Circular Reference]\") {\n      outputData._context = {};\n    }\n    \n    // stageResults i√ßindeki circular reference'larƒ± temizle\n    if (outputData._context && outputData._context.stageResults) {\n      cleanCircularReferences(outputData._context.stageResults);\n    }\n    \n    // _debug alanƒ±nƒ± kontrol et\n    if (!outputData._debug) {\n      outputData._debug = {\n        nodeType: \"Stage 4: Automated Diagnosis\",\n        processedAt: new Date().toISOString(),\n        contextId: outputData._context.contextId || \"\",\n        contextPreserved: true\n      };\n    }\n    \n    // Sonucu format et\n    const transformedItem = {\n      json: {\n        output: outputData\n      }\n    };\n    \n    transformedItems.push(transformedItem);\n    \n  } catch (error) {\n    // Hata durumunda log ve orijinal veriyi d√∂nd√ºr\n    console.error('Parse error:', error.message);\n    transformedItems.push({\n      json: {\n        error: error.message,\n        originalData: item.json\n      }\n    });\n  }\n}\n\n// Circular reference temizleme fonksiyonu\nfunction cleanCircularReferences(obj) {\n  if (!obj || typeof obj !== 'object') return;\n  \n  for (const key in obj) {\n    if (obj[key] === \"[Circular Reference]\") {\n      delete obj[key];\n    } else if (typeof obj[key] === 'object') {\n      cleanCircularReferences(obj[key]);\n    }\n  }\n}\n\nreturn transformedItems;"
      },
      "id": "2bb27b48-93ae-44fc-bd72-4286fbac48e3",
      "name": "Fix Stage 4 Json",
      "type": "n8n-nodes-base.code",
      "position": [
        -800,
        736
      ],
      "typeVersion": 2
    }
  ],
  "pinData": {
    "Manual Trigger": [
      {
        "json": {}
      }
    ]
  },
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AlertManager Webhook": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unified Entry Point": {
      "main": [
        [
          {
            "node": "Load Alert Knowledge Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 1: Health Snapshot": {
      "main": [
        [
          {
            "node": "Fix Stage 1 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 2 Decision": {
      "main": [
        [
          {
            "node": "Route After Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route After Decision": {
      "main": [
        [
          {
            "node": "Force Deep Analysis Override",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 3s": {
      "main": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 2: Deep Analysis": {
      "main": [
        [
          {
            "node": "Fix Stage2 Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 3: Alert Intelligence": {
      "main": [
        [
          {
            "node": "Fix Stage 3 Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 4: Automated Diagnosis": {
      "main": [
        [
          {
            "node": "Fix Stage 4 Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 5: Smart Remediation": {
      "main": [
        [
          {
            "node": "Fix Stage 5 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 6: Prevention & Learning": {
      "main": [
        [
          {
            "node": "Generate Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage 1 Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Stage 3 Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Stage 6 Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Stage 6: Prevention & Learning",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Quick Cluster Health": {
      "ai_tool": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Active Alerts Count": {
      "ai_tool": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Resource Status": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pod Status Check": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Conditions": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Network Health": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Container Restarts": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pod Resource Usage": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Application Metrics": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Error Rates": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Historical Comparison 24h": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Resource Exhaustion Prediction": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Anomaly Patterns": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Active Alerts Details": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Alert History 24h": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Stage 5: Smart Remediation",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 6: Prevention & Learning",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Stage 1: Health Snapshot",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Orchestrator Input Handler": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Kubernetes PVC Status": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Kubernetes HPA Status": {
      "ai_tool": [
        [
          {
            "node": "Stage 2: Deep Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Orchestrator Input Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Force Deep Analysis Override": {
      "main": [
        [
          {
            "node": "Wait 3s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Stage 1 Input": {
      "main": [
        [
          {
            "node": "Stage 1: Health Snapshot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 1 Context": {
      "main": [
        [
          {
            "node": "Stage 2 Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 2 Context": {
      "main": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 3 Context1": {
      "main": [
        [
          {
            "node": "Stage 4: Automated Diagnosis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 4 Context": {
      "main": [
        [
          {
            "node": "Stage 5: Smart Remediation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 5 Context": {
      "main": [
        [
          {
            "node": "Stage 6: Prevention & Learning",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pod Ready SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Container Running SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Node Ready SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pod Restart Rate SLO": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Deployment Replica Health": {
      "ai_tool": [
        [
          {
            "node": "Stage 3: Alert Intelligence",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Load Alert Knowledge Base": {
      "main": [
        [
          {
            "node": "Prepare Stage 1 Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Kubernetes Services": {
      "ai_tool": [
        []
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Stage 4: Automated Diagnosis",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage2 Json": {
      "main": [
        [
          {
            "node": "Fix Stage 2 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Stage 4 Json": {
      "main": [
        [
          {
            "node": "Fix Stage 4 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scheduled Trigger": {
      "main": [
        [
          {
            "node": "Unified Entry Point",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "76d42503-ab09-4fd3-9097-d70847efe8a7",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c12c7bb55b80ebd9de9957d4bb20d1c257c60ff78d5439f6278d6225d0d15a7b"
  },
  "id": "ysMD5nc5K6RCPF0Q",
  "tags": []
}