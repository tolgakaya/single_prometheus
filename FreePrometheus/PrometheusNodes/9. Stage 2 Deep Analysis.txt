# Stage 2: Deep Kubernetes Analysis - CONTEXT AWARE

Execute comprehensive analysis based on Stage 1 findings.

## üïê TIME PARAMETERS:
Use these EXACT timestamps from context:
- Start Time: {{ $json._context.initialParams.startTime }}
- End Time: {{ $json._context.initialParams.endTime }}

IMPORTANT: 
- These are Unix timestamps in seconds
- Convert for display: new Date(timestamp * 1000).toISOString()
- DO NOT use mock dates like "2024-06-01"
- ALL tool calls must use these timestamps

## üéØ NAMESPACE & SERVICE FILTERING:

**CRITICAL: Use these READY-TO-USE query filters in ALL Prometheus queries:**

Namespace regex pattern: {{ $json.namespaceRegex }}
Service regex pattern: {{ $json.serviceRegex }}

**COPY THESE EXACT FILTERS INTO YOUR PROMETHEUS QUERIES:**
1. Namespace filter: {{ $json.queryHelpers?.namespaceFilter }}
2. Combined filter: {{ $json.queryHelpers?.combinedFilter }}

**READY-TO-USE EXAMPLE QUERIES (COPY EXACTLY):**
- Pod count: {{ $json.queryHelpers?.exampleQueries?.podCount }}
- Service list: {{ $json.queryHelpers?.exampleQueries?.serviceList }}
- Alert count: {{ $json.queryHelpers?.exampleQueries?.alertCount }}
- CPU usage: {{ $json.queryHelpers?.exampleQueries?.cpuUsage }}
- Memory usage: {{ $json.queryHelpers?.exampleQueries?.memoryUsage }}

**CRITICAL RULES:**
- NEVER use hardcoded namespaces - use {{ $json.namespaceRegex }} pattern
- COPY the ready-to-use queries shown above
- The filters are pre-validated and ready to use

**Analysis scope:** {{ $json.stage2Instructions?.message }}

## üìã CONTEXT PRESERVATION:
In your JSON output, you MUST include a "_context" field.
Simply copy the _context object from your input WITHOUT modifications.
Stage 1 data is available in $json.stage1Data for your analysis.

## üîß TOOL EXECUTION:

When calling ANY Prometheus tool, use these timestamps and filters:
{
  "start": {{ $json._context.initialParams.startTime }},
  "end": {{ $json._context.initialParams.endTime }},
  "query": "<use ready-to-use queries from above with namespace/service filters>"
}

Example tool call:
{
  "start": {{ $json.startTime }},
  "end": {{ $json.endTime }},
  "query": "{{ $json.queryHelpers?.exampleQueries?.podCount }}"
}

## üéØ ANALYSIS PHASES:

### Phase 1: INSTANT (0-10s)
Execute based on Stage 1 findings:
- If pods failing: Use `Pod Status Check`, `Container Restarts`, `Pod Resource Usage`
- If node issues: Use `Node Status Check`, `Node Resource Usage`
- If network issues: Use `Service Endpoints Health`, `Ingress Status`

### Phase 2: TREND (10-20s)
Historical analysis:
- Use `Historical Comparison 24h` with actual timestamps
- Look for patterns in the time range

### Phase 3: ANOMALY (20-30s)
- Use `Resource Exhaustion Prediction`
- Use `Anomaly Patterns`

## üîß JSON FORMAT VALIDATION RULES:

1. Start your response with { and end with }
2. Do not include any text before or after the JSON
3. Do not use any code block formatting or markdown. No triple backticks before or after the JSON
4. Ensure all string values are in double quotes
5. Ensure all numbers are unquoted (5 not "5")
6. Ensure booleans are unquoted (true not "true")
7. For _context field, copy the exact object from your input (no modification needed)
8. Empty arrays are valid: []
9. All arrays must use square brackets []
10. All objects must use curly braces {}

## ‚úÖ RESPONSE VALIDATION:
Your complete response must:
- Be valid JSON that starts with { and ends with }
- Include all required fields from the template
- Use actual tool response data, not placeholders
- Have proper nesting for execution_phases, correlation_matrix, and root_cause objects
- Contain real timestamps and data from Prometheus

## üìù FINAL REMINDER:
RETURN RAW JSON ONLY - NO EXPLANATIONS, NO MARKDOWN, NO CODE BLOCKS

## üö® CRITICAL OUTPUT REQUIREMENT:
**RETURN ONLY VALID JSON - NO MARKDOWN**

{
  "stage": "deep_analysis",
  "investigation_id": "{{ $json._context.contextId }}-stage2",
  "triggered_by": "Stage 1: {{ $json.stage1Results.alerts.total }} alerts",
  "execution_phases": {
    "instant": {
      "tools_used": ["<actual tools used>"],
      "duration": "<actual duration>",
      "findings": {
        "critical_pods": ["<from actual tool responses>"],
        "resource_pressure": ["<from actual tool responses>"],
        "workload_issues": ["<from actual tool responses>"],
        "scaling_issues": ["<from actual tool responses>"]
      }
    },
    "trend": {
      "tools_used": ["<actual tools used>"],
      "findings": {
        "memory_growth": "<from actual 24h comparison>",
        "restart_pattern": "<from actual data>",
        "peak_times": ["<actual timestamps if found>"],
        "pvc_growth": "<from actual metrics>"
      }
    },
    "anomaly": {
      "tools_used": ["<actual tools used>"],
      "findings": {
        "predictions": ["<from actual analysis>"],
        "anomalies": ["<from actual detection>"]
      }
    }
  },
  "correlation_matrix": {
    "primary_chain": "<actual correlation found>",
    "affected_services": ["<from actual findings>"],
    "blast_radius": "<actual impact>",
    "kubernetes_impact": {
      "evicted_pods": 0,
      "pending_pods": 0,
      "failed_schedules": 0
    }
  },
  "root_cause": {
    "identified": false,
    "component": "<actual component from findings>",
    "issue": "<actual issue description>",
    "evidence": ["<actual evidence from tools>"],
    "confidence": 0.0
  },
  "proceed_to_stage3": false,
  "alert_correlation_needed": false,
  "_context": <copy from input>,
  "_debug": {
    "nodeType": "Stage 2: Deep Analysis",
    "processedAt": "<current ISO timestamp>",
    "contextId": "{{ $json._context.contextId }}",
    "contextPreserved": true,
    "receivedFromStage": "",
    "stageSequence": {{ JSON.stringify($json._debug.stageSequence) }},
    "timeRangeUsed": {
      "start": {{ $json._context.initialParams.startTime }},
      "end": {{ $json._context.initialParams.endTime }}
    }
  }
}

## ‚ö†Ô∏è CRITICAL FINAL INSTRUCTION:
Your ENTIRE response must be ONLY the JSON object above. Do NOT add any text before the opening { or after the closing }. Do NOT use markdown code blocks or backticks. Start with { and end with }