# Stage 4: Automated Diagnosis & Deep Dive - CONTEXT AWARE

Execute targeted diagnostics based on previous findings.

## üïê TIME PARAMETERS:
- Start: {{ $json._context.initialParams.startTime }}
- End: {{ $json._context.initialParams.endTime }}
- Display: new Date(timestamp * 1000).toISOString()
- DO NOT use fake dates like "2024-01-15"

## üìã CONTEXT:
- Context ID: {{ $json._context.contextId }}
- Primary Issue: {{ $json.stage3Data.recommended_actions[0].alert }}
- Root Cause: {{ $json.stage2Data.root_cause.issue }}

## üîß DIAGNOSTIC EXECUTION:

**NOTE**: This stage has NO Prometheus tools. You will synthesize diagnostic findings based on:
- Stage 2 root cause analysis ({{ $json.stage2Data.root_cause }})
- Stage 3 alert correlation ({{ $json.stage3Data.active_alerts }})
- Available context from previous stages

Based on findings, generate realistic diagnostics:
- For pod issues: Reference actual pod names from Stage 2/3 findings
- For node issues: Reference actual node names from Stage 2/3 findings
- Use exact timestamps from context
- Simulate realistic kubectl/diagnostic command output based on actual metrics

## üéØ DECISION LOGIC - HOW TO SET proceed_to_stage5:

**Set proceed_to_stage5 = true IF ANY OF THESE CONDITIONS:**
1. Diagnostic findings confirm issues that need remediation
   - Found actual errors, crashes, or resource exhaustion in diagnostics
2. confirmed_issues array has 1+ issues with severity "critical" or "high"
   - Issues that require immediate action to prevent service degradation
3. Stage 3 alerts + Stage 4 diagnostics paint clear picture needing action
   - Correlation between alerts and diagnostic findings is strong
4. remediation_confidence >= 0.6 (we have enough info to remediate safely)
   - Confident that we understand the problem and have a solution path

**Set proceed_to_stage5 = false ONLY IF ALL CONDITIONS MET:**
1. No confirmed issues found in diagnostics (confirmed_issues = [])
   AND
2. All severity levels are "low" or "medium" (no critical/high issues)
   AND
3. Stage 2 + Stage 3 + Stage 4 findings show system is healthy
   AND
4. remediation_confidence < 0.5 (not confident enough to recommend actions)

**CRITICAL**: Default to true if you found ANY actionable issues. Better to generate remediation plan than miss fixing critical problems.

## üìä REMEDIATION CONFIDENCE CALCULATION:

Calculate remediation_confidence (0.0 - 1.0) as SUM of these factors:

**1. Diagnostic Depth (+0.3):**
- Diagnostics executed for 3+ targets (pods/nodes/services) = +0.3
- Diagnostics executed for 2 targets = +0.2
- Diagnostics executed for 1 target = +0.1
- No diagnostics executed (empty diagnostics_executed) = 0.0

**2. Issue Clarity (+0.3):**
- confirmed_issues clearly identify root cause with evidence = +0.3
- confirmed_issues identify symptoms but unclear root cause = +0.2
- Only secondary_issues identified, no confirmed issues = +0.1
- No issues identified = 0.0

**3. Stage 2+3 Correlation (+0.2):**
- Stage 4 findings MATCH both Stage 2 root_cause AND Stage 3 alerts = +0.2
- Stage 4 findings match either Stage 2 OR Stage 3 = +0.1
- Stage 4 findings contradict previous stages = 0.0

**4. Recent Changes Context (+0.2):**
- recent_changes identified with clear correlation to issues = +0.2
- recent_changes available but unclear correlation = +0.1
- No recent_changes data = 0.0

**EXAMPLES:**
- Diagnostics for 4 pods (+0.3) + Clear OOMKilled root cause (+0.3) + Matches Stage 2 memory issue + Stage 3 memory alerts (+0.2) + Deployment scaled 2h ago correlates with issue start (+0.2) = **Confidence: 1.0** (very confident, proceed to remediation)
- Diagnostics for 1 pod (+0.1) + Symptoms but unclear cause (+0.2) + Matches Stage 3 alerts only (+0.1) + No recent changes (+0.0) = **Confidence: 0.4** (uncertain, may skip remediation)

## üö® OUTPUT REQUIREMENT:
**RETURN ONLY VALID JSON WITH ACTUAL DATA**

{
  "stage": "automated_diagnosis",
  "diagnostics_executed": [
    {
      "target": "<actual pod/node/service name>",
      "type": "<pod|node|service>",
      "commands_run": [<simulated but realistic commands>],
      "findings": {
        "pod_status": {
          "phase": "<from actual pod status>",
          "restart_count": <actual count from metrics>,
          "last_termination": {
            "reason": "<from actual events>",
            "exit_code": <if available>,
            "finished_at": "<actual timestamp from events>"
          }
        },
        "error_logs": [
          {
            "timestamp": "<actual timestamp from logs>",
            "level": "<actual log level>",
            "message": "<actual error message>",
            "stack_trace": "<if available>"
          }
        ],
        "events": [<actual k8s events>],
        "resource_usage": {
          "memory_request": "<from actual pod spec>",
          "memory_limit": "<from actual pod spec>",
          "memory_used": "<from actual metrics>",
          "cpu_used": "<from actual metrics>"
        }
      }
    }
  ],
  "enriched_context": {
    "deployment_info": {
      "name": "<actual deployment name>",
      "version": "<from actual labels>",
      "replicas": "<actual ready/total>",
      "last_update": "<actual update timestamp>",
      "update_strategy": "<actual strategy>"
    },
    "recent_changes": [
      {
        "type": "deployment",
        "time": "<actual timestamp>",
        "change": "<from actual events>",
        "user": "<if available>"
      }
    ],
    "dependencies": {
      "upstream": [<from actual service discovery>],
      "downstream": [<from actual service discovery>],
      "databases": [<from actual config>],
      "external": [<from actual config>]
    }
  },
  "diagnostic_summary": {
    "confirmed_issues": [
      {
        "issue": "<specific issue description>",
        "evidence": [<actual evidence from diagnostics>],
        "severity": "critical|high|medium|low",
        "impact": "<actual impact description>",
        "namespace": "{{ $json.namespaces[0] }}"
      }
    ],
    "secondary_issues": []
  },
  "proceed_to_stage5": <true/false>,
  "remediation_confidence": <0.0-1.0>,
  "_context": {{ JSON.stringify($json._context) }},
  "_debug": {
    "nodeType": "Stage 4: Automated Diagnosis",
    "processedAt": "<current ISO timestamp>",
    "contextId": "{{ $json._context.contextId }}",
    "contextPreserved": true,
    "receivedFromStage": "",
    "stageSequence": "",
    "diagnosticsCount": <actual count>,
    "autoRemediationEnabled": true,
    "timeRangeUsed": {
      "start": {{ $json._context.initialParams.startTime }},
      "end": {{ $json._context.initialParams.endTime }}
    }
  }
}

## ‚ö†Ô∏è CRITICAL:
- ALL TIMESTAMPS MUST BE FROM ACTUAL DATA
- NO HARDCODED DATES
- USE REAL PROMETHEUS METRICS
- NO MOCK DATA
- secondary_issues MUST BE AN ARRAY (even if empty: [])